#
# Configuración de Bacula Director para Sistema Clínica
# Este archivo define las políticas de respaldo automático
#

Director {
  Name = clinica-dir
  DIRport = 9101
  QueryFile = "/opt/bacula/scripts/query.sql"
  WorkingDirectory = "/var/lib/bacula"
  PidDirectory = "/var/run/bacula"
  Maximum Concurrent Jobs = 20
  Password = "TU_PASSWORD_DIRECTOR_AQUI"  # Cambiar por password seguro
  Messages = Daemon
}

# Configuración del catálogo de Bacula (base de datos)
Catalog {
  Name = MyCatalog
  dbname = "bacula"
  dbuser = "bacula"
  dbpassword = "TU_PASSWORD_BD_BACULA"  # Cambiar por password de BD
}

# Mensajes y notificaciones
Messages {
  Name = Standard
  director = clinica-dir = all
  # Enviar alertas por email en caso de error
  mail = admin@clinica.com = all, !skipped
  operator = admin@clinica.com = mount
  console = all, !skipped, !saved
  # Guardar logs en archivo
  append = "/var/log/bacula/bacula.log" = all, !skipped
  catalog = all
}

# =====================================================
# DEFINICIÓN DE TRABAJOS DE RESPALDO (JOBS)
# =====================================================

# Job principal: Respaldo completo de base de datos
Job {
  Name = "BackupBaseDatos"
  Type = Backup
  Level = Full
  Client = clinica-fd
  FileSet = "SetBaseDatos"
  Schedule = "RespaldoDiario"
  Storage = File
  Messages = Standard
  Pool = Daily
  Priority = 10
  Write Bootstrap = "/var/lib/bacula/bootstrap/BaseDatos.bsf"
}

# Job: Respaldo de archivos de configuración
Job {
  Name = "BackupConfiguracion"
  Type = Backup
  Level = Incremental
  Client = clinica-fd
  FileSet = "SetConfiguracion"
  Schedule = "RespaldoDiario"
  Storage = File
  Messages = Standard
  Pool = Daily
  Priority = 8
  Write Bootstrap = "/var/lib/bacula/bootstrap/Configuracion.bsf"
}

# Job: Respaldo de archivos subidos por usuarios
Job {
  Name = "BackupUploads"
  Type = Backup
  Level = Incremental
  Client = clinica-fd
  FileSet = "SetUploads"
  Schedule = "RespaldoDiario"
  Storage = File
  Messages = Standard
  Pool = Daily
  Priority = 7
  Write Bootstrap = "/var/lib/bacula/bootstrap/Uploads.bsf"
}

# Job: Respaldo de logs del sistema
Job {
  Name = "BackupLogs"
  Type = Backup
  Level = Full
  Client = clinica-fd
  FileSet = "SetLogs"
  Schedule = "RespaldoDiario"
  Storage = File
  Messages = Standard
  Pool = Daily
  Priority = 5
  Write Bootstrap = "/var/lib/bacula/bootstrap/Logs.bsf"
}

# Job de restauración
Job {
  Name = "RestoreFiles"
  Type = Restore
  Client = clinica-fd
  FileSet = "Full Set"
  Storage = File
  Pool = Default
  Messages = Standard
  Where = /tmp/bacula-restores
}

# =====================================================
# DEFINICIÓN DE CONJUNTOS DE ARCHIVOS (FILESETS)
# =====================================================

# FileSet para base de datos
FileSet {
  Name = "SetBaseDatos"
  Include {
    Options {
      signature = MD5
      compression = GZIP
    }
    # Directorio donde se guardan los dumps de BD
    File = /var/backups/mysql
  }
}

# FileSet para archivos de configuración
FileSet {
  Name = "SetConfiguracion"
  Include {
    Options {
      signature = MD5
      compression = GZIP
    }
    # Ajustar rutas según tu instalación
    File = /ruta/del/proyecto/.env
    File = /ruta/del/proyecto/config
    File = /etc/nginx/sites-available/clinica
    File = /etc/supervisor/conf.d/clinica.conf
  }
}

# FileSet para archivos subidos
FileSet {
  Name = "SetUploads"
  Include {
    Options {
      signature = MD5
      compression = GZIP
    }
    # Ajustar ruta según tu proyecto
    File = /ruta/del/proyecto/static/uploads
    File = /ruta/del/proyecto/uploads
  }
}

# FileSet para logs
FileSet {
  Name = "SetLogs"
  Include {
    Options {
      signature = MD5
      compression = GZIP
    }
    File = /var/log/clinica
    File = /var/log/nginx
    File = /var/log/bacula
  }
}

# =====================================================
# PROGRAMACIÓN DE RESPALDOS (SCHEDULES)
# =====================================================

Schedule {
  Name = "RespaldoDiario"
  # Ejecutar backup completo diariamente a las 2:00 AM
  # (horario de menor carga del sistema)
  Run = Full daily at 02:00
}

# =====================================================
# DEFINICIÓN DE CLIENTE (CLIENT)
# =====================================================

Client {
  Name = clinica-fd
  Address = localhost
  FDPort = 9102
  Catalog = MyCatalog
  Password = "TU_PASSWORD_CLIENTE_AQUI"  # Cambiar por password seguro
  File Retention = 7 days         # Mantener registros de archivos 7 días
  Job Retention = 7 days          # Mantener registros de jobs 7 días
  AutoPrune = yes                 # Eliminar automáticamente respaldos antiguos
}

# =====================================================
# DEFINICIÓN DE ALMACENAMIENTO (STORAGE)
# =====================================================

Storage {
  Name = File
  Address = localhost
  SDPort = 9103
  Password = "TU_PASSWORD_STORAGE_AQUI"  # Cambiar por password seguro
  Device = FileStorage
  Media Type = File
}

# =====================================================
# DEFINICIÓN DE POOLS
# =====================================================

# Pool para respaldos diarios (retención de 7 días)
Pool {
  Name = Daily
  Pool Type = Backup
  Recycle = yes                   # Reutilizar volúmenes
  AutoPrune = yes                 # Eliminar automáticamente
  Volume Retention = 7 days       # Mantener 7 días
  Maximum Volume Bytes = 10G      # Tamaño máximo por volumen
  Maximum Volumes = 14            # Máximo 14 volúmenes (2 semanas)
  Label Format = "Daily-"
}

# Pool por defecto
Pool {
  Name = Default
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 365 days
  Maximum Volume Bytes = 50G
  Maximum Volumes = 100
}

# =====================================================
# CONSOLA
# =====================================================

Console {
  Name = clinica-mon
  Password = "TU_PASSWORD_CONSOLA_AQUI"
  CommandACL = status, .status
}
