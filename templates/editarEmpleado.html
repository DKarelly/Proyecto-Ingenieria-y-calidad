<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Empleado - Clínica Unión</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="text-gray-700">
    {% include 'header_admin.html' %}

    <div class="max-w-4xl mx-auto p-6 md:p-10">
        <!-- Botón de regreso -->
        <div class="mb-6">
            <a href="{{ url_for('cuentas.gestionar_cuentas_internas') }}" class="inline-flex items-center text-cyan-600 hover:text-cyan-800 font-medium transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Volver a Gestión de Cuentas
            </a>
        </div>

        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Editar Empleado</h1>
            <p class="text-gray-600">Actualiza la información del empleado</p>
        </div>

    <!-- Mensajes flash: deshabilitados en esta plantilla (se eliminaron los toasts) -->

        <!-- Formulario de edición -->
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <form method="POST" class="space-y-6">
                <!-- Información Personal -->
                <div class="border-b pb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-user mr-2 text-cyan-600"></i>
                        Información Personal
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="nombres" class="block text-sm font-semibold text-gray-700 mb-2">
                                Nombres <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="nombres" name="nombres" 
                                   value="{{ empleado.nombres }}" 
                                   required minlength="2" maxlength="60"
                                   class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all">
                        </div>
                        <div>
                            <label for="apellidos" class="block text-sm font-semibold text-gray-700 mb-2">
                                Apellidos <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="apellidos" name="apellidos" 
                                   value="{{ empleado.apellidos }}" 
                                   required minlength="2" maxlength="60"
                                   class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label for="documento" class="block text-sm font-semibold text-gray-700 mb-2">
                                Documento de Identidad <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="documento" name="documento" 
                                   value="{{ empleado.documento_identidad }}" 
                                   required minlength="8" maxlength="12" pattern="[0-9]+"
                                   class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all">
                        </div>
                        <div>
                            <label for="nacimiento" class="block text-sm font-semibold text-gray-700 mb-2">
                                Fecha de Nacimiento
                            </label>
                            <input type="date" id="nacimiento" name="nacimiento"
                                   value="{{ empleado.fecha_nacimiento if empleado.fecha_nacimiento else '' }}"
                                   class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all">
                        </div>
                        <div>
                            <label for="sexo" class="block text-sm font-semibold text-gray-700 mb-2">
                                Sexo <span class="text-red-500">*</span>
                            </label>
                            <select id="sexo" name="sexo" required
                                    class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all">
                                <option value="">Seleccione</option>
                                <option value="Masculino" {% if empleado.sexo == 'M' or empleado.sexo == 'Masculino' %}selected{% endif %}>Masculino</option>
                                <option value="Femenino" {% if empleado.sexo == 'F' or empleado.sexo == 'Femenino' %}selected{% endif %}>Femenino</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Información de Contacto -->
                <div class="border-b pb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-envelope mr-2 text-cyan-600"></i>
                        Información de Contacto
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                                Correo Electrónico <span class="text-red-500">*</span>
                            </label>
                            <input type="email" id="email" name="email" 
                                   value="{{ empleado.correo }}" 
                                   required maxlength="120"
                                   class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all">
                        </div>
                        <div>
                            <label for="telefono" class="block text-sm font-semibold text-gray-700 mb-2">
                                Teléfono <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" id="telefono" name="telefono" 
                                   value="{{ empleado.telefono }}" 
                                   required minlength="6" maxlength="15" pattern="[0-9]+"
                                   class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all">
                        </div>
                    </div>
                </div>

                <!-- Información Laboral -->
                <div class="pb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-briefcase mr-2 text-cyan-600"></i>
                        Información Laboral
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="rol" class="block text-sm font-semibold text-gray-700 mb-2">
                                Rol <span class="text-red-500">*</span>
                            </label>
                            <select id="rol" name="rol" required
                                    class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all">
                                <option value="">Seleccione un rol</option>
                                {% for rol in roles %}
                                <option value="{{ rol.id_rol }}" {% if empleado.id_rol == rol.id_rol %}selected{% endif %}>
                                    {{ rol.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div id="especialidad-container" style="display: none;">
                            <label for="especialidad" class="block text-sm font-semibold text-gray-700 mb-2">
                                Especialidad <span class="text-red-500">*</span>
                            </label>
                            <select id="especialidad" name="especialidad"
                                    class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all">
                                <option value="">Seleccione una especialidad</option>
                            </select>
                        </div>
                        <div>
                            <label for="estado" class="block text-sm font-semibold text-gray-700 mb-2">
                                Estado <span class="text-red-500">*</span>
                            </label>
                            <select id="estado" name="estado" required
                                    class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all">
                                <option value="activo" {% if empleado.estado_usuario == 'activo' %}selected{% endif %}>Activo</option>
                                <option value="inactivo" {% if empleado.estado_usuario == 'inactivo' %}selected{% endif %}>Inactivo</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Ubicación -->
                <div class="border-t pt-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-location-dot mr-2 text-cyan-600"></i>
                        Ubicación
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="departamento" class="block text-sm font-semibold text-gray-700 mb-2">Departamento</label>
                            <select id="departamento" name="departamento"
                                    class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all">
                                <option value="">Seleccione un departamento</option>
                                {% for departamento in departamentos %}
                                <option value="{{ departamento.id_departamento }}"
                                        {% if empleado.id_departamento == departamento.id_departamento %}selected{% endif %}>
                                    {{ departamento.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="provincia" class="block text-sm font-semibold text-gray-700 mb-2">Provincia</label>
                            <select id="provincia" name="provincia"
                                    class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all">
                                <option value="">Seleccione una provincia</option>
                                {% for provincia in provincias %}
                                <option value="{{ provincia.id_provincia }}"
                                        data-departamento="{{ provincia.id_departamento }}"
                                        {% if empleado.id_provincia == provincia.id_provincia %}selected{% endif %}
                                        style="display: none;">
                                    {{ provincia.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="distrito" class="block text-sm font-semibold text-gray-700 mb-2">Distrito</label>
                            <select id="distrito" name="distrito"
                                    class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all">
                                <option value="">Seleccione un distrito</option>
                                {% for distrito in distritos %}
                                <option value="{{ distrito.id_distrito }}"
                                        data-provincia="{{ distrito.id_provincia }}"
                                        {% if empleado.id_distrito == distrito.id_distrito %}selected{% endif %}
                                        style="display: none;">
                                    {{ distrito.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Botones -->
                <div class="flex gap-4 pt-6">
                    <button type="submit" 
                            class="flex-1 bg-cyan-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-cyan-700 transition-colors flex items-center justify-center">
                        <i class="fa-solid fa-save mr-2"></i>
                        Guardar Cambios
                    </button>
                    <a href="{{ url_for('cuentas.gestionar_cuentas_internas') }}" 
                       class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors flex items-center justify-center">
                        <i class="fa-solid fa-times mr-2"></i>
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Validación de sesión
        fetch('/usuarios/api/session')
            .then(response => response.json())
            .then(data => {
                if (!data.logged_in) {
                    window.location.href = '/usuarios/login';
                }
            })
            .catch(error => {
                console.error('Error al verificar la sesión:', error);
            });

        // Flash toasts removed for this template.

        // Variables globales para especialidades
        let especialidadesData = [];

        // Función para cargar especialidades desde la API
        async function cargarEspecialidades() {
            try {
                const response = await fetch('/cuentas/api/especialidades');
                especialidadesData = await response.json();
                
                const especialidadSelect = document.getElementById('especialidad');
                especialidadSelect.innerHTML = '<option value="">Seleccione una especialidad</option>';
                
                especialidadesData.forEach(esp => {
                    const option = document.createElement('option');
                    option.value = esp.id_especialidad;
                    option.textContent = esp.nombre;
                    // Seleccionar la especialidad actual del empleado si existe
                    if (esp.nombre === '{{ empleado.especialidad }}') {
                        option.selected = true;
                    }
                    especialidadSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar especialidades:', error);
            }
        }

        // Función para verificar si el rol es médico y mostrar/ocultar especialidad
        function toggleEspecialidadField() {
            const rolSelect = document.getElementById('rol');
            const especialidadContainer = document.getElementById('especialidad-container');
            const rolOptions = rolSelect.querySelectorAll('option');
            let rolText = '';

            // Obtener el nombre del rol seleccionado
            for (let option of rolOptions) {
                if (option.value === rolSelect.value) {
                    rolText = option.textContent.toLowerCase();
                    break;
                }
            }

            // Mostrar/ocultar especialidad si el rol es médico
            if (rolText.includes('medico') || rolText.includes('médico')) {
                especialidadContainer.style.display = 'block';
                cargarEspecialidades();
            } else {
                especialidadContainer.style.display = 'none';
                document.getElementById('especialidad').value = '';
            }
        }

        // Event listener para cambios en el rol
        document.getElementById('rol').addEventListener('change', toggleEspecialidadField);

        // Manejo de cascada de ubicación (Departamento -> Provincia -> Distrito)
        const departamentoSelect = document.getElementById('departamento');
        const provinciaSelect = document.getElementById('provincia');
        const distritoSelect = document.getElementById('distrito');

        // Función para filtrar provincias según departamento
        function filtrarProvincias() {
            const departamentoId = departamentoSelect.value;
            const provinciaOptions = provinciaSelect.querySelectorAll('option');

            // Limpiar y resetear selects dependientes
            provinciaSelect.value = '';
            distritoSelect.value = '';

            // Ocultar todos los distritos
            const distritoOptions = distritoSelect.querySelectorAll('option');
            distritoOptions.forEach(option => {
                if (option.value !== '') {
                    option.style.display = 'none';
                }
            });

            // Mostrar/ocultar provincias según departamento
            provinciaOptions.forEach(option => {
                if (option.value === '') {
                    option.style.display = 'block';
                    return;
                }

                if (option.dataset.departamento === departamentoId) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        // Función para filtrar distritos según provincia
        function filtrarDistritos() {
            const provinciaId = provinciaSelect.value;
            const distritoOptions = distritoSelect.querySelectorAll('option');

            // Resetear distrito
            distritoSelect.value = '';

            // Mostrar/ocultar distritos según provincia
            distritoOptions.forEach(option => {
                if (option.value === '') {
                    option.style.display = 'block';
                    return;
                }

                if (option.dataset.provincia === provinciaId) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        // Event listeners
        departamentoSelect.addEventListener('change', filtrarProvincias);
        provinciaSelect.addEventListener('change', filtrarDistritos);

        // Inicializar los selects al cargar la página
        window.addEventListener('DOMContentLoaded', () => {
            // Verificar si el rol es médico al cargar
            toggleEspecialidadField();

            // Si hay un departamento seleccionado, filtrar provincias
            if (departamentoSelect.value) {
                const provinciaOptions = provinciaSelect.querySelectorAll('option');
                provinciaOptions.forEach(option => {
                    if (option.value === '') {
                        option.style.display = 'block';
                        return;
                    }

                    if (option.dataset.departamento === departamentoSelect.value) {
                        option.style.display = 'block';
                    } else {
                        option.style.display = 'none';
                    }
                });
            }

            // Si hay una provincia seleccionada, filtrar distritos
            if (provinciaSelect.value) {
                const distritoOptions = distritoSelect.querySelectorAll('option');
                distritoOptions.forEach(option => {
                    if (option.value === '') {
                        option.style.display = 'block';
                        return;
                    }

                    if (option.dataset.provincia === provinciaSelect.value) {
                        option.style.display = 'block';
                    } else {
                        option.style.display = 'none';
                    }
                });
            }
        });
    </script>
</body>
</html>
