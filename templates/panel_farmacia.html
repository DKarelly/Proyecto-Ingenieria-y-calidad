<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Farmacia - Clínica Unión</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    
    <!-- Tailwind CSS compilado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 20
        }
        .material-symbols-outlined.filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 20
        }
        
        /* Animación para el desglose de tiempo */
        .time-breakdown {
            animation: expandIn 0.2s ease-out;
            transform-origin: top;
        }
        
        @keyframes expandIn {
            from {
                opacity: 0;
                transform: scaleY(0.8);
            }
            to {
                opacity: 1;
                transform: scaleY(1);
            }
        }
    </style>
    <script>
        // Configuración personalizada (si es necesaria)
        const customConfig = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#06B6D4',
                            light: '#E0F9FC',
                            dark: '#0891B2'
                        },
                        medical: {
                            cyan: '#06B6D4',
                            teal: '#14B8A6',
                            emerald: '#10B981'
                        },
                        "background-light": "#F8F9FC",
                        "background-dark": "#0A0A0A",
                        "surface-light": "#FFFFFF",
                        "surface-dark": "#141414",
                        "border-light": "#EFF1F4",
                        "border-dark": "#2A2A2A",
                        "text-primary-light": "#1F2937",
                        "text-primary-dark": "#E5E7EB",
                        "text-secondary-light": "#6B7280",
                        "text-secondary-dark": "#9CA3AF",
                    },
                    fontFamily: {
                        display: ["Sora", "sans-serif"],
                        body: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.5rem",
                        lg: "1rem",
                        xl: "1.5rem"
                    },
                    boxShadow: {
                        'subtle': '0 4px 6px -1px rgba(0, 0, 0, 0.03), 0 2px 4px -2px rgba(0, 0, 0, 0.03)',
                        'subtle-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -4px rgba(0, 0, 0, 0.05)',
                        'medical': '0 10px 25px -5px rgba(6, 182, 212, 0.15)'
                    }
                },
            },
        };
    </script>
</head>

<body class="font-body bg-background-light dark:bg-background-dark text-text-secondary-light dark:text-text-secondary-dark antialiased">
    {% include 'header_farmacia.html' %}

    <div class="flex h-[calc(100vh-80px)]">
        <!-- Sidebar Farmacia -->
        <aside class="w-[280px] flex-shrink-0 bg-surface-light dark:bg-surface-dark border-r border-border-light dark:border-border-dark flex flex-col">
            <nav class="flex-1 px-6 py-6 space-y-2">
                <!-- Dashboard -->
                <a href="/farmacia/panel" class="flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl {% if not subsistema %}bg-gradient-to-r from-cyan-50 to-teal-50 text-cyan-700 border border-cyan-200 shadow-sm{% else %}text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-zinc-900/50 hover:text-text-primary-light dark:hover:text-text-primary-dark{% endif %} transition-all duration-300">
                    <span class="material-symbols-outlined text-xl {% if not subsistema %}filled{% endif %}">dashboard</span>
                    <span class="font-semibold">Dashboard</span>
                </a>

                <!-- Recepción de Medicamentos -->
                <a href="/farmacia/panel?subsistema=recepcion" class="flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl {% if subsistema == 'recepcion' %}bg-gradient-to-r from-cyan-50 to-teal-50 text-cyan-700 border border-cyan-200 shadow-sm{% else %}text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-zinc-900/50 hover:text-text-primary-light dark:hover:text-text-primary-dark{% endif %} transition-all duration-300">
                    <span class="material-symbols-outlined text-xl {% if subsistema == 'recepcion' %}filled{% endif %}">inventory_2</span>
                    <span class="font-semibold">Recepción de Medicamentos</span>
                </a>

                <!-- Entrega de Medicamentos -->
                <a href="/farmacia/panel?subsistema=entrega" class="flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl {% if subsistema == 'entrega' %}bg-gradient-to-r from-cyan-50 to-teal-50 text-cyan-700 border border-cyan-200 shadow-sm{% else %}text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-zinc-900/50 hover:text-text-primary-light dark:hover:text-text-primary-dark{% endif %} transition-all duration-300">
                    <span class="material-symbols-outlined text-xl {% if subsistema == 'entrega' %}filled{% endif %}">local_pharmacy</span>
                    <span class="font-semibold">Entrega de Medicamentos</span>
                </a>

                <!-- Inventario -->
                <a href="/farmacia/panel?subsistema=inventario" class="flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl {% if subsistema == 'inventario' %}bg-gradient-to-r from-cyan-50 to-teal-50 text-cyan-700 border border-cyan-200 shadow-sm{% else %}text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-zinc-900/50 hover:text-text-primary-light dark:hover:text-text-primary-dark{% endif %} transition-all duration-300">
                    <span class="material-symbols-outlined text-xl {% if subsistema == 'inventario' %}filled{% endif %}">warehouse</span>
                    <span class="font-semibold">Inventario</span>
                </a>

                <!-- Alertas -->
                <a href="/farmacia/panel?subsistema=alertas" class="flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl {% if subsistema == 'alertas' %}bg-gradient-to-r from-cyan-50 to-teal-50 text-cyan-700 border border-cyan-200 shadow-sm{% else %}text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-zinc-900/50 hover:text-text-primary-light dark:hover:text-text-primary-dark{% endif %} transition-all duration-300">
                    <span class="material-symbols-outlined text-xl {% if subsistema == 'alertas' %}filled{% endif %}">warning</span>
                    <span class="font-semibold">Alertas</span>
                </a>

            </nav>
        </aside>

        <!-- Contenido Principal -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <main class="flex-1 overflow-y-auto p-8">
                {% if not subsistema %}
                <!-- Dashboard Principal -->
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Bienvenido, {{ session.get('nombre_usuario', 'Usuario') }}</h2>
                    <p class="text-gray-600">Aquí está tu resumen del día en Farmacia</p>
                </div>

                <!-- Estadísticas Rápidas -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Medicamentos Recibidos Hoy -->
                    <div class="bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-2xl p-6 text-white shadow-medical">
                        <div class="flex items-center justify-between mb-4">
                            <span class="material-symbols-outlined text-4xl opacity-80">inventory_2</span>
                            <span class="text-3xl font-bold">{{ stats.medicamentos_recibidos or 0 }}</span>
                        </div>
                        <h3 class="text-sm font-medium opacity-90 mb-1">Medicamentos Recibidos Hoy</h3>
                        <p class="text-xs opacity-75">Nuevos ingresos al inventario</p>
                    </div>

                    <!-- Medicamentos Entregados -->
                    <div class="bg-gradient-to-br from-teal-500 to-teal-600 rounded-2xl p-6 text-white shadow-medical">
                        <div class="flex items-center justify-between mb-4">
                            <span class="material-symbols-outlined text-4xl opacity-80">local_pharmacy</span>
                            <span class="text-3xl font-bold">{{ stats.medicamentos_entregados or 0 }}</span>
                        </div>
                        <h3 class="text-sm font-medium opacity-90 mb-1">Medicamentos Entregados</h3>
                        <p class="text-xs opacity-75">Dispensados a pacientes</p>
                    </div>

                    <!-- Alertas de Vencimiento -->
                    <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-6 text-white shadow-medical">
                        <div class="flex items-center justify-between mb-4">
                            <span class="material-symbols-outlined text-4xl opacity-80">warning</span>
                            <span class="text-3xl font-bold">{{ stats.alertas_vencimiento or 0 }}</span>
                        </div>
                        <h3 class="text-sm font-medium opacity-90 mb-1">Alertas de Vencimiento</h3>
                        <p class="text-xs opacity-75">Medicamentos próximos a vencer</p>
                    </div>
                </div>

                <!-- Contenido del Dashboard -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Medicamentos Recientes -->
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Medicamentos Recientes</h3>
                            <a href="/farmacia/panel?subsistema=recepcion" class="text-cyan-600 hover:text-cyan-700 text-sm font-semibold flex items-center gap-1">
                                Ver todos
                                <span class="material-symbols-outlined text-sm">arrow_forward</span>
                            </a>
                        </div>

                        <div class="space-y-4">
                            {% if medicamentos_recientes %}
                                {% for med in medicamentos_recientes %}
                                <div class="flex items-center gap-4 p-4 bg-gradient-to-r from-cyan-50 to-teal-50 border-cyan-100 rounded-xl border hover:shadow-md transition-shadow">
                                    <div class="flex-shrink-0">
                                        <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-teal-500 rounded-full flex items-center justify-center text-white font-bold">
                                            <span class="material-symbols-outlined">medication</span>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-800">{{ med.nombre }}</h4>
                                        <p class="text-sm text-gray-600">Stock: {{ med.stock }} unidades</p>
                                        <p class="text-sm text-gray-600">Vence: {{ med.fecha_vencimiento }}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold text-cyan-600">{{ med.cantidad }} unidades</p>
                                        <span class="inline-block px-2 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded-full mt-1">Recibido</span>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-8 text-gray-500">
                                    <span class="material-symbols-outlined text-5xl mb-2 block text-gray-400">inventory_2</span>
                                    <p class="font-medium">No hay medicamentos recientes</p>
                                    <p class="text-sm mt-1">Los nuevos ingresos aparecerán aquí</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Accesos Rápidos y Alertas -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Accesos Rápidos</h3>

                        <div class="space-y-3 mb-6">
                            <a href="/farmacia/panel?subsistema=recepcion" class="flex items-center gap-3 p-3 rounded-xl hover:bg-cyan-50 transition-colors group">
                                <div class="w-10 h-10 bg-cyan-100 rounded-lg flex items-center justify-center group-hover:bg-cyan-200 transition-colors">
                                    <span class="material-symbols-outlined text-cyan-600">add_box</span>
                                </div>
                                <span class="font-semibold text-gray-700 group-hover:text-cyan-700">Registrar Nuevo Ingreso</span>
                            </a>

                            <a href="/farmacia/panel?subsistema=entrega" class="flex items-center gap-3 p-3 rounded-xl hover:bg-teal-50 transition-colors group">
                                <div class="w-10 h-10 bg-teal-100 rounded-lg flex items-center justify-center group-hover:bg-teal-200 transition-colors">
                                    <span class="material-symbols-outlined text-teal-600">local_pharmacy</span>
                                </div>
                                <span class="font-semibold text-gray-700 group-hover:text-teal-700">Entregar Medicamentos</span>
                            </a>

                            <a href="/farmacia/panel?subsistema=inventario" class="flex items-center gap-3 p-3 rounded-xl hover:bg-blue-50 transition-colors group">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center group-hover:bg-blue-200 transition-colors">
                                    <span class="material-symbols-outlined text-blue-600">warehouse</span>
                                </div>
                                <span class="font-semibold text-gray-700 group-hover:text-blue-700">Ver Inventario</span>
                            </a>
                        </div>

                        <!-- Alertas de Medicamentos -->
                        <div class="border-t border-gray-200 pt-6">
                            <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <span class="material-symbols-outlined text-red-600">warning</span>
                                Alertas de Medicamentos
                            </h4>

                            <div class="space-y-3">
                                <!-- Medicamentos Próximos a Vencer -->
                                {% if medicamentos_por_vencer %}
                                    {% for med in medicamentos_por_vencer[:2] %}
                                    <div class="flex items-center gap-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                        <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center">
                                            <span class="material-symbols-outlined text-amber-600 text-sm">schedule</span>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-semibold text-gray-800 truncate">{{ med.nombre }}</p>
                                            <p class="text-xs text-amber-700">Vence en {{ med.dias_para_vencer }} días</p>
                                        </div>
                                        <span class="text-xs font-bold text-amber-600 bg-amber-100 px-2 py-1 rounded">Por Vencer</span>
                                    </div>
                                    {% endfor %}
                                {% endif %}

                                <!-- Medicamentos Vencidos -->
                                {% if medicamentos_vencidos %}
                                    {% for med in medicamentos_vencidos[:2] %}
                                    <div class="flex items-center gap-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                                        <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                                            <span class="material-symbols-outlined text-red-600 text-sm">error</span>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-semibold text-gray-800 truncate">{{ med.nombre }}</p>
                                            <p class="text-xs text-red-700">Vencido hace {{ med.dias_vencido }} días</p>
                                        </div>
                                        <span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded">Vencido</span>
                                    </div>
                                    {% endfor %}
                                {% endif %}

                                <!-- Medicamentos con Stock Bajo -->
                                {% if medicamentos_stock_bajo %}
                                    {% for med in medicamentos_stock_bajo[:2] %}
                                    <div class="flex items-center gap-3 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                                        <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center">
                                            <span class="material-symbols-outlined text-orange-600 text-sm">inventory</span>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-semibold text-gray-800 truncate">{{ med.nombre }}</p>
                                            <p class="text-xs text-orange-700">Stock: {{ med.stock }} unidades</p>
                                        </div>
                                        <span class="text-xs font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded">Stock Bajo</span>
                                    </div>
                                    {% endfor %}
                                {% endif %}

                                <!-- Mensaje cuando no hay alertas -->
                                {% if not medicamentos_por_vencer and not medicamentos_vencidos and not medicamentos_stock_bajo %}
                                    <div class="text-center py-4 text-gray-500">
                                        <span class="material-symbols-outlined text-3xl mb-1 block text-gray-400">check_circle</span>
                                        <p class="text-xs">No hay alertas activas</p>
                                    </div>
                                {% else %}
                                    <a href="/farmacia/panel?subsistema=alertas" class="text-center block text-cyan-600 hover:text-cyan-700 text-sm font-semibold py-2">
                                        Ver todas las alertas
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if subsistema == 'recepcion' %}
                <!-- Subsistema: Recepción de Medicamentos -->
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Recepción de Medicamentos</h2>
                    <p class="text-gray-600">Registra nuevos ingresos de medicamentos al inventario</p>
                </div>

                <!-- Formulario de Recepción -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Registrar Nuevo Ingreso</h3>

                    <form id="recepcion-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Nombre del Medicamento -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Nombre del Medicamento <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="nombre_medicamento" name="nombre_medicamento" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                   placeholder="Ej: Paracetamol 500mg">
                        </div>
                        
                        <!-- Stock -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Stock <span class="text-red-500">*</span>
                            </label>
                            <input type="number" id="stock" name="stock" required min="1" step="1" pattern="[1-9][0-9]*"
                                   oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/\+/g, '').replace(/-/g, '').replace(/\./g, '').replace(/^0+/, '')"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                   placeholder="Ej: 100">
                        </div>

                        <!-- Fecha de Vencimiento -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Fecha de Vencimiento <span class="text-red-500">*</span>
                            </label>
                            <input type="date" id="fecha_vencimiento" name="fecha_vencimiento" required min="{{ (datetime.datetime.now() + datetime.timedelta(days=1)).date().isoformat() }}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        </div>

                        <!-- Descripción -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Descripción</label>
                            <textarea id="descripcion" name="descripcion" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                      placeholder="Descripción del medicamento..."></textarea>
                        </div>

                        <!-- Botones -->
                        <div class="md:col-span-2 flex gap-4">
                            <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-xl hover:from-cyan-600 hover:to-teal-600 transition-all font-semibold shadow-md">
                                Registrar Ingreso
                            </button>
                            <button type="button" onclick="limpiarFormulario()" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-semibold">
                                Limpiar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Ingresos Recientes -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Ingresos Recientes</h3>

                    {% if ingresos_recientes %}
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Medicamento</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Cantidad</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Fecha Venc.</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Fecha Ingreso</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ingreso in ingresos_recientes %}
                                <tr class="border-b border-gray-100 hover:bg-gray-50">
                                    <td class="py-4 px-4">
                                        <div>
                                            <p class="font-semibold text-gray-800">{{ ingreso.nombre }}</p>
                                            <p class="text-sm text-gray-500">{{ ingreso.descripcion }}</p>
                                        </div>
                                    </td>
                                    <td class="py-4 px-4 text-gray-600">{{ ingreso.cantidad }}</td>
                                    <td class="py-4 px-4 text-gray-600">{{ ingreso.fecha_vencimiento }}</td>
                                    <td class="py-4 px-4 text-gray-600">{{ ingreso.fecha_ingreso }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-12 text-gray-500">
                        <span class="material-symbols-outlined text-6xl mb-4 block text-gray-400">inventory_2</span>
                        <p class="font-medium">No hay ingresos recientes</p>
                        <p class="text-sm mt-1">Los nuevos ingresos aparecerán aquí</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if subsistema == 'entrega' %}
                <!-- Subsistema: Entrega de Medicamentos -->
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Entrega de Medicamentos</h2>
                    <p class="text-gray-600">Gestiona la dispensación de medicamentos a pacientes</p>
                </div>

                <!-- Buscador de Pacientes -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Buscar Paciente</h3>
                    <div class="relative">
                        <input type="text" id="buscar-paciente-farmacia" placeholder="Buscar por nombre o DNI..."
                               oninput="this.value = this.value.replace(/[0-9]/g, '')"
                               class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                    </div>
                    <!-- Resultados de búsqueda -->
                    <div id="resultados-paciente" class="mt-4 space-y-2 hidden">
                        <!-- Los resultados se mostrarán aquí dinámicamente -->
                    </div>
                </div>

                <!-- Formulario de Entrega -->
                <div id="formulario-entrega" class="hidden bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Registrar Entrega</h3>

                    <form id="entrega-form" class="space-y-6">
                        <input type="hidden" id="id_paciente_entrega" name="id_paciente_entrega">
                        <input type="hidden" id="id_medicamento_entrega" name="id_medicamento_entrega">

                        <!-- Información del Paciente -->
                        <div class="bg-gray-50 rounded-xl p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Paciente Seleccionado</h4>
                            <p id="info-paciente-entrega" class="text-gray-600">Selecciona un paciente para continuar</p>
                        </div>

                        <!-- Medicamento y Cantidad -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Medicamento -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Medicamento <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <input type="text" id="buscar-medicamento-entrega" placeholder="      Buscar medicamento..."
                                           class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                                    <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">medication</span>
                                </div>
                                <!-- Resultados de búsqueda -->
                                <div id="resultados-medicamento" class="mt-2 space-y-2 hidden">
                                    <!-- Los resultados se mostrarán aquí dinámicamente -->
                                </div>
                            </div>

                            <!-- Cantidad -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Cantidad a Entregar <span class="text-red-500">*</span>
                                </label>
                                <input type="number" id="cantidad_entrega" name="cantidad_entrega" min="1" required
                                       oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/\+/g, '').replace(/-/g, '').replace(/\./g, '').replace(/^0+/, '')"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                       placeholder="Ej: 30">
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="flex gap-4">
                            <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-xl hover:from-cyan-600 hover:to-teal-600 transition-all font-semibold shadow-md">
                                Registrar Entrega
                            </button>
                            <button type="button" onclick="cerrarFormularioEntrega()" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-semibold">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Entregas Recientes -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Entregas Recientes</h3>

                    {% if entregas_recientes %}
                    <div class="space-y-4">
                        {% for entrega in entregas_recientes %}
                        <div class="flex items-center gap-4 p-4 bg-gradient-to-r from-teal-50 to-emerald-50 border border-teal-100 rounded-xl">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-gradient-to-br from-teal-500 to-emerald-500 rounded-full flex items-center justify-center text-white font-bold">
                                    <span class="material-symbols-outlined">local_pharmacy</span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">{{ entrega.paciente }}</h4>
                                <p class="text-sm text-gray-600">{{ entrega.medicamento }} - {{ entrega.cantidad }} unidades</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-teal-600">{{ entrega.fecha_entrega.strftime('%d/%m/%Y %H:%M') }}</p>
                                <span class="inline-block px-2 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded-full mt-1">Entregado</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-12 text-gray-500">
                        <span class="material-symbols-outlined text-6xl mb-4 block text-gray-400">local_pharmacy</span>
                        <p class="font-medium">No hay entregas recientes</p>
                        <p class="text-sm mt-1">Las entregas aparecerán aquí</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if subsistema == 'inventario' %}
                <!-- Subsistema: Inventario -->
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Inventario de Medicamentos</h2>
                    <p class="text-gray-600">Control y gestión del stock de medicamentos</p>
                </div>

                <!-- Filtros y Búsqueda -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
                    <div class="flex flex-wrap gap-4">
                        <div class="flex-1 min-w-[200px]">
                            <input type="text" id="buscar-inventario" placeholder="Buscar medicamento..."
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        </div>
                        <select id="filtro-stock" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                            <option value="">Todos los niveles</option>
                            <option value="bajo">Stock Bajo (< 10)</option>
                            <option value="medio">Stock Medio (10-50)</option>
                            <option value="alto">Stock Alto (> 50)</option>
                        </select>
                        <select id="filtro-vencimiento" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                            <option value="">Todos los vencimientos</option>
                            <option value="proximo">Próximos a vencer (30 días)</option>
                            <option value="vencido">Vencidos</option>
                        </select>
                    </div>
                </div>

                <!-- Tabla de Inventario -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200 bg-gray-50">
                                    <th class="text-left py-4 px-6 font-semibold text-gray-700">Medicamento</th>
                                    <th class="text-left py-4 px-6 font-semibold text-gray-700">Stock</th>
                                    <th class="text-left py-4 px-6 font-semibold text-gray-700">Vencimiento</th>
                                    <th class="text-left py-4 px-6 font-semibold text-gray-700">Estado</th>
                                    <th class="text-left py-4 px-6 font-semibold text-gray-700">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-inventario">
                                {% for item in inventario %}
                                <tr class="border-b border-gray-100 hover:bg-gray-50">
                                    <td class="py-4 px-6">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-cyan-100 rounded-lg flex items-center justify-center">
                                                <span class="material-symbols-outlined text-cyan-600">medication</span>
                                            </div>
                                            <span class="font-semibold text-gray-800">{{ item.nombre }}</span>
                                        </div>
                                    </td>
                                    <td class="py-4 px-6">
                                        <span class="font-semibold {% if item.stock < 10 %}text-red-600{% elif item.stock < 50 %}text-amber-600{% else %}text-green-600{% endif %}">
                                            {{ item.stock }}
                                        </span>
                                    </td>
                                    <td class="py-4 px-6 text-gray-600">{{ item.fecha_vencimiento }}</td>
                                    <td class="py-4 px-6">
                                        {% if item.dias_para_vencer < 0 %}
                                        <span class="inline-block px-3 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded-full">Vencido</span>
                                        {% elif item.dias_para_vencer <= 30 %}
                                        <span class="inline-block px-3 py-1 bg-amber-100 text-amber-700 text-xs font-semibold rounded-full">Próximo a vencer</span>
                                        {% else %}
                                        <span class="inline-block px-3 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded-full">Vigente</span>
                                        {% endif %}
                                    </td>
                                    <td class="py-4 px-6">
                                        <button onclick="verDetalleMedicamento({{ item.id }})" class="text-cyan-600 hover:text-cyan-700 font-semibold text-sm">
                                            Ver Detalles
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}

                {% if subsistema == 'alertas' %}
                <!-- Subsistema: Alertas y Notificaciones -->
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Alertas y Notificaciones</h2>
                    <p class="text-gray-600">Medicamentos próximos a vencer y otras alertas importantes</p>
                </div>

                <!-- Lista de Alertas -->
                <div class="space-y-6">
                    <!-- Medicamentos Próximos a Vencer -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                            <span class="material-symbols-outlined text-amber-600">warning</span>
                            Medicamentos Próximos a Vencer
                        </h3>

                        {% if medicamentos_por_vencer %}
                        <div class="space-y-4">
                            {% for med in medicamentos_por_vencer %}
                            <div class="flex items-center gap-4 p-4 bg-amber-50 border border-amber-200 rounded-xl">
                                <div class="flex-shrink-0">
                                    <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
                                        <span class="material-symbols-outlined text-amber-600">medication</span>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">{{ med.nombre }}</h4>
                                    <p class="text-sm text-gray-600">{{ med.laboratorio }} - Lote: {{ med.lote }}</p>
                                    <p class="text-sm text-amber-700">Stock actual: {{ med.stock }} unidades</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold text-amber-600">{{ med.fecha_vencimiento }}</p>
                                    <p class="text-sm text-gray-600">{{ med.dias_para_vencer }} días restantes</p>
                                    <span class="inline-block px-3 py-1 bg-amber-100 text-amber-700 text-xs font-semibold rounded-full mt-2">
                                        {% if med.dias_para_vencer <= 7 %}Crítico{% elif med.dias_para_vencer <= 15 %}Alto{% else %}Medio{% endif %}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-12 text-gray-500">
                            <span class="material-symbols-outlined text-6xl mb-4 block text-gray-400">check_circle</span>
                            <p class="font-medium">No hay medicamentos próximos a vencer</p>
                            <p class="text-sm mt-1">¡Excelente gestión del inventario!</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Medicamentos Vencidos -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                            <span class="material-symbols-outlined text-red-600">error</span>
                            Medicamentos Vencidos
                        </h3>

                        {% if medicamentos_vencidos %}
                        <div class="space-y-4">
                            {% for med in medicamentos_vencidos %}
                            <div class="flex items-center gap-4 p-4 bg-red-50 border border-red-200 rounded-xl">
                                <div class="flex-shrink-0">
                                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                        <span class="material-symbols-outlined text-red-600">medication</span>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">{{ med.nombre }}</h4>
                                    <p class="text-sm text-gray-600">{{ med.laboratorio }} - Lote: {{ med.lote }}</p>
                                    <p class="text-sm text-red-700">Stock actual: {{ med.stock }} unidades</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold text-red-600">{{ med.fecha_vencimiento }}</p>
                                    <p class="text-sm text-gray-600">Vencido hace {{ med.dias_vencido }} días</p>
                                    <button onclick="gestionarMedicamentoVencido({{ med.id }})" class="mt-2 px-4 py-2 bg-red-600 text-white text-sm font-semibold rounded-lg hover:bg-red-700 transition-colors">
                                        Gestionar
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-12 text-gray-500">
                            <span class="material-symbols-outlined text-6xl mb-4 block text-gray-400">check_circle</span>
                            <p class="font-medium">No hay medicamentos vencidos</p>
                            <p class="text-sm mt-1">¡Excelente control de calidad!</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Stock Bajo -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                            <span class="material-symbols-outlined text-orange-600">inventory</span>
                            Medicamentos con Stock Bajo
                        </h3>

                        {% if medicamentos_stock_bajo %}
                        <div class="space-y-4">
                            {% for med in medicamentos_stock_bajo %}
                            <div class="flex items-center gap-4 p-4 bg-orange-50 border border-orange-200 rounded-xl">
                                <div class="flex-shrink-0">
                                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                                        <span class="material-symbols-outlined text-orange-600">medication</span>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">{{ med.nombre }}</h4>
                                    <p class="text-sm text-gray-600">{{ med.laboratorio }} - Lote: {{ med.lote }}</p>
                                    <p class="text-sm text-orange-700">Vence: {{ med.fecha_vencimiento.strftime('%d/%m/%Y') if med.fecha_vencimiento is not string else med.fecha_vencimiento }}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold text-orange-600">{{ med.stock }} unidades</p>
                                    <span class="inline-block px-3 py-1 bg-orange-100 text-orange-700 text-xs font-semibold rounded-full mt-1">
                                        {% if med.stock <= 5 %}Crítico{% else %}Bajo{% endif %}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-12 text-gray-500">
                            <span class="material-symbols-outlined text-6xl mb-4 block text-gray-400">inventory_2</span>
                            <p class="font-medium">No hay medicamentos con stock bajo</p>
                            <p class="text-sm mt-1">¡Inventario bien abastecido!</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </main>
        </div>
    </div>

    <!-- JavaScript para funcionalidades dinámicas -->
    <script>
        // Funciones de Farmacia
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar funcionalidades
            inicializarFarmacia();
        });

        function inicializarFarmacia() {
            // Configurar formularios
            configurarFormularioRecepcion();
            configurarBusquedaPacientes();
            configurarBusquedaMedicamentos();
            configurarFormularioEntrega();
            configurarFiltrosInventario();

            // Cargar datos iniciales si es necesario
            cargarDatosIniciales();
        }

        function configurarFormularioRecepcion() {
            const form = document.getElementById('recepcion-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    registrarIngresoMedicamento();
                });
            }
        }

        function configurarBusquedaPacientes() {
            const input = document.getElementById('buscar-paciente-farmacia');
            if (input) {
                input.addEventListener('input', function() {
                    buscarPacientes(this.value);
                });
            }
        }

        function configurarBusquedaMedicamentos() {
            const input = document.getElementById('buscar-medicamento-entrega');
            if (input) {
                input.addEventListener('input', function() {
                    buscarMedicamentos(this.value);
                });
            }
        }

        function configurarFormularioEntrega() {
            const form = document.getElementById('entrega-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    registrarEntregaMedicamento();
                });
            }
        }

        function configurarFiltrosInventario() {
            const buscarInput = document.getElementById('buscar-inventario');
            const filtroStock = document.getElementById('filtro-stock');
            const filtroVencimiento = document.getElementById('filtro-vencimiento');

            if (buscarInput) {
                buscarInput.addEventListener('input', filtrarInventario);
            }
            if (filtroStock) {
                filtroStock.addEventListener('change', filtrarInventario);
            }
            if (filtroVencimiento) {
                filtroVencimiento.addEventListener('change', filtrarInventario);
            }
        }

        function registrarIngresoMedicamento() {
            const formData = new FormData(document.getElementById('recepcion-form'));
            const data = Object.fromEntries(formData);

            // Validar datos
            if (!validarDatosIngreso(data)) {
                return;
            }

            // Enviar datos al servidor
            fetch('/farmacia/api/ingreso', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    mostrarMensaje('Ingreso registrado exitosamente', 'success');
                    limpiarFormulario();
                    // Recargar lista de ingresos recientes
                    location.reload();
                } else {
                    mostrarMensaje(result.message || 'Error al registrar ingreso', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('Error de conexión', 'error');
            });
        }

function buscarPacientes(query) {
    if (query.length < 2) return;

    fetch('/farmacia/api/pacientes/entrega?busqueda=' + encodeURIComponent(query))
    .then(response => response.json())
    .then(data => {
        mostrarResultadosBusqueda(data);
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

        function filtrarInventario() {
            const buscar = document.getElementById('buscar-inventario').value.toLowerCase();
            const filtroStock = document.getElementById('filtro-stock').value;
            const filtroVencimiento = document.getElementById('filtro-vencimiento').value;
            const filas = document.querySelectorAll('#tabla-inventario tr');

            filas.forEach(fila => {
                const nombre = fila.cells[0].textContent.toLowerCase();
                const stock = parseInt(fila.cells[1].textContent);
                const estado = fila.cells[3].textContent.toLowerCase();

                let mostrar = true;

                // Filtro de búsqueda
                if (buscar && !nombre.includes(buscar)) {
                    mostrar = false;
                }

                // Filtro de stock
                if (filtroStock) {
                    if (filtroStock === 'bajo' && stock >= 10) mostrar = false;
                    if (filtroStock === 'medio' && (stock < 10 || stock > 50)) mostrar = false;
                    if (filtroStock === 'alto' && stock <= 50) mostrar = false;
                }

                // Filtro de vencimiento
                if (filtroVencimiento) {
                    if (filtroVencimiento === 'proximo' && !estado.includes('próximo')) mostrar = false;
                    if (filtroVencimiento === 'vencido' && !estado.includes('vencido')) mostrar = false;
                }

                fila.style.display = mostrar ? '' : 'none';
            });
        }

        function validarDatosIngreso(data) {
            if (!data.nombre_medicamento || !data.stock || !data.fecha_vencimiento) {
                mostrarMensaje('Por favor complete todos los campos obligatorios', 'error');
                return false;
            }

            const fechaVencimiento = new Date(data.fecha_vencimiento);
            const hoy = new Date();
            if (fechaVencimiento <= hoy) {
                mostrarMensaje('La fecha de vencimiento debe ser futura', 'error');
                return false;
            }

            return true;
        }

        function limpiarFormulario() {
            document.getElementById('recepcion-form').reset();
        }

        function mostrarMensaje(mensaje, tipo) {
            // Crear elemento de mensaje
            const mensajeDiv = document.createElement('div');
            mensajeDiv.className = 'fixed top-4 right-4 px-6 py-3 rounded-xl text-white font-semibold z-50 ' + (tipo === 'success' ? 'bg-green-500' : 'bg-red-500');
            mensajeDiv.textContent = mensaje;

            document.body.appendChild(mensajeDiv);

            // Remover después de 3 segundos
            setTimeout(() => {
                mensajeDiv.remove();
            }, 3000);
        }

        function cargarDatosIniciales() {
            // Cargar medicamentos para el select de entrega
            cargarMedicamentosDisponibles();
        }

        function cargarMedicamentosDisponibles() {
            fetch('/farmacia/api/medicamentos/disponibles')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('medicamento_entrega');
                if (select) {
                    select.innerHTML = '<option value="">Selecciona un medicamento</option>';
                    data.forEach(med => {
                        const option = document.createElement('option');
                        option.value = med.id;
                        option.textContent = `${med.nombre} (${med.stock} disponibles)`;
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error cargando medicamentos:', error);
            });
        }

        function verDetalleMedicamento(id) {
            // Abrir modal o página de detalles
            window.location.href = '/farmacia/medicamento/' + id;
        }

        function gestionarMedicamentoVencido(id) {
            if (confirm('¿Desea marcar este medicamento como retirado del inventario?')) {
                fetch('/farmacia/api/medicamento/' + id + '/retirar', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        location.reload();
                    } else {
                        mostrarMensaje('Error al retirar medicamento', 'error');
                    }
                });
            }
        }

        function cerrarFormularioEntrega() {
            document.getElementById('formulario-entrega').classList.add('hidden');
        }

        // Funciones de utilidad
        function mostrarResultadosBusqueda(pacientes) {
            const resultadosDiv = document.getElementById('resultados-paciente');
            if (!resultadosDiv) return;

            // Limpiar resultados anteriores
            resultadosDiv.innerHTML = '';

            if (pacientes && pacientes.length > 0) {
                pacientes.forEach(function(paciente) {
                    const pacienteDiv = document.createElement('div');
                    pacienteDiv.className = 'p-3 bg-gray-50 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors';
                    pacienteDiv.onclick = function() { seleccionarPaciente(paciente); };
            pacienteDiv.innerHTML = `<div class="font-semibold text-gray-800">${paciente.nombre} ${paciente.apellido}</div><div class="text-sm text-gray-600">DNI: ${paciente.dni}</div>`;
                    resultadosDiv.appendChild(pacienteDiv);
                });
                resultadosDiv.classList.remove('hidden');
            } else {
                resultadosDiv.classList.add('hidden');
            }
        }

        function seleccionarPaciente(paciente) {
            // Llenar el formulario con la información del paciente seleccionado
            document.getElementById('id_paciente_entrega').value = paciente.id_paciente;
            document.getElementById('info-paciente-entrega').textContent = `${paciente.nombre} ${paciente.apellido} (DNI: ${paciente.dni})`;

            // Mostrar el formulario de entrega
            document.getElementById('formulario-entrega').classList.remove('hidden');

            // Ocultar resultados de búsqueda
            document.getElementById('resultados-paciente').classList.add('hidden');

            // Limpiar el campo de búsqueda
            document.getElementById('buscar-paciente-farmacia').value = '';
        }

        function buscarMedicamentos(query) {
            if (query.length < 2) return;

            fetch('/farmacia/api/medicamentos/entrega?busqueda=' + encodeURIComponent(query))
            .then(response => response.json())
            .then(data => {
                mostrarResultadosMedicamento(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function mostrarResultadosMedicamento(medicamentos) {
            const resultadosDiv = document.getElementById('resultados-medicamento');
            if (!resultadosDiv) return;

            // Limpiar resultados anteriores
            resultadosDiv.innerHTML = '';

            if (medicamentos && medicamentos.length > 0) {
                medicamentos.forEach(function(medicamento) {
                    const medDiv = document.createElement('div');
                    medDiv.className = 'p-3 bg-gray-50 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors';
                    medDiv.onclick = function() { seleccionarMedicamento(medicamento); };
                    medDiv.innerHTML = `<div class="font-semibold text-gray-800">${medicamento.nombre}</div><div class="text-sm text-gray-600">Stock: ${medicamento.stock} unidades</div>`;
                    resultadosDiv.appendChild(medDiv);
                });
                resultadosDiv.classList.remove('hidden');
            } else {
                resultadosDiv.classList.add('hidden');
            }
        }

        function seleccionarMedicamento(medicamento) {
            // Llenar el formulario con el medicamento seleccionado
            document.getElementById('id_medicamento_entrega').value = medicamento.id_medicamento;
            document.getElementById('buscar-medicamento-entrega').value = medicamento.nombre;

            // Ocultar resultados de búsqueda
            document.getElementById('resultados-medicamento').classList.add('hidden');
        }

        function registrarEntregaMedicamento() {
            const formData = new FormData(document.getElementById('entrega-form'));
            const data = Object.fromEntries(formData);

            // Validar datos
            if (!data.id_paciente_entrega || !data.id_medicamento_entrega || !data.cantidad_entrega) {
                mostrarMensaje('Por favor complete todos los campos obligatorios', 'error');
                return;
            }

            // Enviar datos al servidor
            fetch('/farmacia/api/entregas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    mostrarMensaje('Entrega registrada exitosamente', 'success');
                    cerrarFormularioEntrega();
                    // Recargar lista de entregas recientes
                    location.reload();
                } else {
                    mostrarMensaje(result.message || 'Error al registrar entrega', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('Error de conexión', 'error');
            });
        }
    </script>
</body>
</html>
