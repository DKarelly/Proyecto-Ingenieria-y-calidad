<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listar Reservas - Sistema Médico</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .estado-confirmada { background-color: #dbeafe; color: #1e40af; font-weight: 600; }
        .estado-completada { background-color: #d1fae5; color: #065f46; font-weight: 600; }
        .estado-cancelada { background-color: #fee2e2; color: #991b1b; font-weight: 600; }
        .estado-inasistida { background-color: #fef3c7; color: #92400e; font-weight: 600; }
    </style>
</head>
<body class="text-gray-700">
    {% include 'header_admin.html' %}
    
    <div class="max-w-screen-2xl mx-auto p-6 md:p-10">
        <!-- Botón de regreso -->
        <div class="mb-6">
            <a href="/reservas/" class="inline-flex items-center text-gray-600 hover:text-cyan-600 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                <span class="font-medium">Volver al Panel de Reservas</span>
            </a>
        </div>

        <!-- Título -->
        <div class="mb-8">
            <h1 class="text-3xl font-black text-gray-800">
                <i class="fas fa-list text-cyan-600 mr-3"></i>
                Listar Reservas
            </h1>
            <p class="text-gray-600 mt-2">Consulta y gestión de reservas del sistema</p>
        </div>

        <!-- Dashboard de Estadísticas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-500 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-600 text-sm font-semibold uppercase tracking-wide">Total</p>
                        <p class="text-3xl font-bold text-blue-800 mt-2" id="total-reservas">0</p>
                    </div>
                    <div class="bg-blue-500 bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-calendar-alt text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-500 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-600 text-sm font-semibold uppercase tracking-wide">Confirmadas</p>
                        <p class="text-3xl font-bold text-green-800 mt-2" id="total-confirmadas">0</p>
                    </div>
                    <div class="bg-green-500 bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 border-l-4 border-emerald-500 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-emerald-600 text-sm font-semibold uppercase tracking-wide">Completadas</p>
                        <p class="text-3xl font-bold text-emerald-800 mt-2" id="total-completadas">0</p>
                    </div>
                    <div class="bg-emerald-500 bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-clipboard-check text-emerald-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-red-50 to-red-100 border-l-4 border-red-500 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-red-600 text-sm font-semibold uppercase tracking-wide">Canceladas</p>
                        <p class="text-3xl font-bold text-red-800 mt-2" id="total-canceladas">0</p>
                    </div>
                    <div class="bg-red-500 bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros de Búsqueda -->
        <div class="bg-white border border-cyan-200 rounded-lg p-6 shadow-sm mb-8">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <i class="fas fa-filter text-cyan-600 text-xl mr-3"></i>
                    <h2 class="text-lg font-semibold text-gray-800">Filtros de Búsqueda</h2>
                </div>
                <button id="btn-limpiar-filtros" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg inline-flex items-center transition-all">
                    <i class="fas fa-redo mr-2"></i>
                    Limpiar Filtros
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Fecha Desde -->
                <div class="flex flex-col">
                    <label class="text-xs font-bold text-gray-600 tracking-wider mb-2">
                        <i class="fas fa-calendar-day mr-1"></i>FECHA DESDE
                    </label>
                    <input type="date" id="fecha-desde" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 bg-white">
                </div>

                <!-- Fecha Hasta -->
                <div class="flex flex-col">
                    <label class="text-xs font-bold text-gray-600 tracking-wider mb-2">
                        <i class="fas fa-calendar-day mr-1"></i>FECHA HASTA
                    </label>
                    <input type="date" id="fecha-hasta" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 bg-white">
                </div>

                <!-- Tipo de Servicio -->
                <div class="flex flex-col">
                    <label class="text-xs font-bold text-gray-600 tracking-wider mb-2">
                        <i class="fas fa-list mr-1"></i>TIPO DE SERVICIO
                    </label>
                    <select id="tipo-servicio-select" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 bg-white">
                        <option value="">Todos los tipos</option>
                        {% for tipo in tipos_servicio %}
                        <option value="{{ tipo.id_tipo_servicio }}">{{ tipo.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Servicio -->
                <div class="flex flex-col">
                    <label class="text-xs font-bold text-gray-600 tracking-wider mb-2">
                        <i class="fas fa-stethoscope mr-1"></i>SERVICIO
                    </label>
                    <select id="servicio-select" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 bg-white">
                        <option value="">Todos los servicios</option>
                        {% for s in servicios %}
                        <option value="{{ s.id_servicio }}" data-tipo="{{ s.id_tipo_servicio }}">{{ s.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Médico -->
                <div class="flex flex-col relative">
                    <label class="text-xs font-bold text-gray-600 tracking-wider mb-2">
                        <i class="fas fa-user-doctor mr-1"></i>MÉDICO
                    </label>
                    <input type="text" id="medico-input" placeholder="Buscar médico..." autocomplete="off" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 bg-white">
                    <div id="medico-dropdown" class="hidden absolute z-10 w-full mt-1 top-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                        <!-- Opciones se generarán dinámicamente -->
                    </div>
                    <input type="hidden" id="medico-select" value="" />
                </div>

                <!-- DNI Paciente -->
                <div class="flex flex-col">
                    <label class="text-xs font-bold text-gray-600 tracking-wider mb-2">
                        <i class="fas fa-id-card mr-1"></i>DNI PACIENTE
                    </label>
                    <input type="text" id="dni-paciente" maxlength="8" placeholder="8 dígitos" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 bg-white">
                </div>

                <!-- Estado -->
                <div class="flex flex-col">
                    <label class="text-xs font-bold text-gray-600 tracking-wider mb-2">
                        <i class="fas fa-info-circle mr-1"></i>ESTADO
                    </label>
                    <select id="estado-select" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 bg-white">
                        <option value="">Todos los estados</option>
                        {% for estado in estados %}
                        <option value="{{ estado }}">{{ estado }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Botón Buscar -->
                <div class="flex items-end">
                    <button id="btn-buscar" class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-semibold py-3 px-6 rounded-lg inline-flex items-center justify-center transition-all shadow-md hover:shadow-lg">
                        <i class="fas fa-search mr-2"></i>
                        Buscar
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden text-center py-12">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-cyan-500 mx-auto mb-4"></div>
            <p class="text-gray-600 font-medium">Cargando reservas...</p>
        </div>

        <!-- Sin resultados -->
        <div id="sin-resultados" class="hidden text-center py-12 bg-white rounded-lg border border-gray-200">
            <i class="fas fa-calendar-times text-gray-300 text-6xl mb-4"></i>
            <p class="text-gray-600 font-semibold text-lg">No se encontraron reservas</p>
            <p class="text-gray-500 text-sm mt-2">Intente ajustar los filtros de búsqueda</p>
        </div>

        <!-- Tabla de Reservas -->
        <div id="tabla-container" class="hidden bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gradient-to-r from-cyan-500 to-blue-500">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Paciente</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">DNI</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Servicio</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Médico</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Fecha Cita</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Horario</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-body" class="bg-white divide-y divide-gray-200">
                        <!-- Las filas se generarán dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% include 'footer.html' %}

    <!-- Modal de Detalle de Reserva -->
    <div id="modal-detalle" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white p-6 rounded-t-xl flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold">Detalle de Reserva</h2>
                    <p class="text-sm opacity-90 mt-1">ID: <span id="modal-detail-id">#---</span></p>
                </div>
                <button onclick="cerrarModal()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-all">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="p-6">
                <!-- Información General -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                        <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-user text-blue-600 mr-2"></i>
                            Información del Paciente
                        </h3>
                        <div class="space-y-2 text-sm">
                            <p><strong>Nombre:</strong> <span id="detail-paciente">---</span></p>
                            <p><strong>DNI:</strong> <span id="detail-dni">---</span></p>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                        <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-calendar text-green-600 mr-2"></i>
                            Información de la Reserva
                        </h3>
                        <div class="space-y-2 text-sm">
                            <p><strong>Fecha:</strong> <span id="detail-fecha">---</span></p>
                            <p><strong>Horario:</strong> <span id="detail-horario">---</span></p>
                            <p><strong>Estado:</strong> <span id="detail-estado" class="px-2 py-1 rounded text-xs">---</span></p>
                        </div>
                    </div>
                </div>

                <!-- Información del Servicio -->
                <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded mb-6">
                    <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-stethoscope text-purple-600 mr-2"></i>
                        Servicio
                    </h3>
                    <div class="space-y-2 text-sm">
                        <p><strong>Tipo:</strong> <span id="detail-tipo-servicio">---</span></p>
                        <p><strong>Servicio:</strong> <span id="detail-servicio">---</span></p>
                        <p><strong>Médico:</strong> <span id="detail-medico">---</span></p>
                        <p><strong>Especialidad:</strong> <span id="detail-especialidad">---</span></p>
                    </div>
                </div>

                <!-- Información Específica (CITA, EXAMEN, OPERACION) -->
                <div id="detail-especifico" class="hidden">
                    <!-- CITA -->
                    <div id="detail-cita" class="hidden bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded mb-6">
                        <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-notes-medical text-yellow-600 mr-2"></i>
                            Información de la Cita
                        </h3>
                        <div class="space-y-2 text-sm">
                            <p><strong>Diagnóstico:</strong> <span id="detail-cita-diagnostico" class="block mt-1 text-gray-700">---</span></p>
                            <p><strong>Observaciones:</strong> <span id="detail-cita-observaciones" class="block mt-1 text-gray-700">---</span></p>
                            <p><strong>Estado Cita:</strong> <span id="detail-cita-estado">---</span></p>
                        </div>
                    </div>

                    <!-- EXAMEN -->
                    <div id="detail-examen" class="hidden bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded mb-6">
                        <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-vial text-indigo-600 mr-2"></i>
                            Información del Examen
                        </h3>
                        <div class="space-y-2 text-sm">
                            <p><strong>Fecha Examen:</strong> <span id="detail-examen-fecha">---</span></p>
                            <p><strong>Hora:</strong> <span id="detail-examen-hora">---</span></p>
                            <p><strong>Observación:</strong> <span id="detail-examen-observacion" class="block mt-1 text-gray-700">---</span></p>
                            <p><strong>Estado Examen:</strong> <span id="detail-examen-estado">---</span></p>
                        </div>
                    </div>

                    <!-- OPERACION -->
                    <div id="detail-operacion" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded mb-6">
                        <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-procedures text-red-600 mr-2"></i>
                            Información de la Operación
                        </h3>
                        <div class="space-y-2 text-sm">
                            <p><strong>Fecha Operación:</strong> <span id="detail-operacion-fecha">---</span></p>
                            <p><strong>Horario:</strong> <span id="detail-operacion-horario">---</span></p>
                            <p><strong>Observaciones:</strong> <span id="detail-operacion-observaciones" class="block mt-1 text-gray-700">---</span></p>
                            <div id="detail-operacion-recursos" class="mt-3">
                                <strong>Recursos Asignados:</strong>
                                <ul id="detail-operacion-recursos-lista" class="list-disc list-inside mt-2 text-gray-700">
                                    <!-- Se llenará dinámicamente -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="flex gap-3 mt-6">
                    <button id="btn-cancelar-reserva" onclick="cancelarReserva()" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold py-3 px-6 rounded-lg inline-flex items-center justify-center transition-all shadow-md hover:shadow-lg">
                        <i class="fas fa-ban mr-2"></i>
                        Cancelar Reserva
                    </button>
                    <button onclick="cerrarModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg inline-flex items-center justify-center transition-all">
                        <i class="fas fa-times mr-2"></i>
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let reservasData = [];
        let todosLosServicios = [];
        let todosMedicos = [];
        let reservaSeleccionada = null;

        // Elementos del DOM
        let fechaDesde, fechaHasta, tipoServicioSelect, servicioSelect, medicoInput, medicoSelect, medicoDropdown, dniPaciente, estadoSelect;
        let btnBuscar, btnLimpiarFiltros;
        let loading, sinResultados, tablaContainer, tablaBody;
        let totalReservas, totalConfirmadas, totalCompletadas, totalCanceladas;

        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar elementos
            fechaDesde = document.getElementById('fecha-desde');
            fechaHasta = document.getElementById('fecha-hasta');
            tipoServicioSelect = document.getElementById('tipo-servicio-select');
            servicioSelect = document.getElementById('servicio-select');
            medicoInput = document.getElementById('medico-input');
            medicoSelect = document.getElementById('medico-select');
            medicoDropdown = document.getElementById('medico-dropdown');
            dniPaciente = document.getElementById('dni-paciente');
            estadoSelect = document.getElementById('estado-select');
            btnBuscar = document.getElementById('btn-buscar');
            btnLimpiarFiltros = document.getElementById('btn-limpiar-filtros');
            loading = document.getElementById('loading');
            sinResultados = document.getElementById('sin-resultados');
            tablaContainer = document.getElementById('tabla-container');
            tablaBody = document.getElementById('tabla-body');
            totalReservas = document.getElementById('total-reservas');
            totalConfirmadas = document.getElementById('total-confirmadas');
            totalCompletadas = document.getElementById('total-completadas');
            totalCanceladas = document.getElementById('total-canceladas');

            // Guardar servicios originales
            todosLosServicios = Array.from(servicioSelect.options).slice(1);

            // Cargar médicos desde el backend
            todosMedicos = [
                {% for m in medicos %}
                {
                    id: "{{ m.id_empleado }}",
                    nombre: "{{ m.nombres }} {{ m.apellidos }}",
                    especialidad: "{{ m.especialidad if m.especialidad else '' }}",
                    id_especialidad: "{{ m.id_especialidad if m.id_especialidad else '' }}"
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ];

            // Event listeners
            btnBuscar.addEventListener('click', buscarReservas);
            btnLimpiarFiltros.addEventListener('click', limpiarFiltros);
            tipoServicioSelect.addEventListener('change', filtrarServicios);
            
            // Solo números en DNI
            dniPaciente.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });

            // Buscador dinámico de médicos
            medicoInput.addEventListener('input', (e) => {
                const termino = e.target.value.toLowerCase().trim();
                filtrarYMostrarMedicos(termino);
            });

            medicoInput.addEventListener('focus', () => {
                const termino = medicoInput.value.toLowerCase().trim();
                filtrarYMostrarMedicos(termino);
            });

            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!medicoInput.contains(e.target) && !medicoDropdown.contains(e.target)) {
                    medicoDropdown.classList.add('hidden');
                }
            });

            // Cargar todas las reservas al inicio
            buscarReservas();
        });

        // Función para filtrar y mostrar médicos en el dropdown
        function filtrarYMostrarMedicos(termino) {
            let medicosFiltrados = todosMedicos;

            // Filtrar por término de búsqueda
            if (termino) {
                medicosFiltrados = medicosFiltrados.filter(m => 
                    m.nombre.toLowerCase().includes(termino) || 
                    (m.especialidad && m.especialidad.toLowerCase().includes(termino))
                );
            }

            // Mostrar dropdown si hay resultados o término de búsqueda
            if (medicosFiltrados.length === 0 && termino) {
                medicoDropdown.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 text-center">No se encontraron médicos</div>';
                medicoDropdown.classList.remove('hidden');
            } else if (medicosFiltrados.length > 0 || !termino) {
                medicoDropdown.innerHTML = '';
                
                // Opción "Todos los médicos"
                const opcionTodos = document.createElement('div');
                opcionTodos.className = 'px-4 py-3 hover:bg-cyan-50 cursor-pointer border-b border-gray-200 text-sm text-gray-700';
                opcionTodos.innerHTML = '<i class="fas fa-users mr-2 text-gray-400"></i>Todos los médicos';
                opcionTodos.onclick = () => seleccionarMedico(null, '');
                medicoDropdown.appendChild(opcionTodos);

                // Opciones de médicos
                (termino ? medicosFiltrados : medicosFiltrados.slice(0, 10)).forEach(medico => {
                    const opcion = document.createElement('div');
                    opcion.className = 'px-4 py-3 hover:bg-cyan-50 cursor-pointer text-sm';
                    opcion.innerHTML = `
                        <div class="font-medium text-gray-800">${medico.nombre}</div>
                        ${medico.especialidad ? `<div class="text-xs text-gray-500">${medico.especialidad}</div>` : ''}
                    `;
                    opcion.onclick = () => seleccionarMedico(medico.id, medico.nombre);
                    medicoDropdown.appendChild(opcion);
                });

                medicoDropdown.classList.remove('hidden');
            } else {
                medicoDropdown.classList.add('hidden');
            }
        }

        // Función para seleccionar médico
        function seleccionarMedico(id, nombre) {
            medicoInput.value = nombre;
            medicoSelect.value = id || '';
            medicoDropdown.classList.add('hidden');
        }

        // Filtrar servicios por tipo
        function filtrarServicios() {
            const tipoSeleccionado = tipoServicioSelect.value;
            servicioSelect.innerHTML = '<option value="">Todos los servicios</option>';

            if (!tipoSeleccionado) {
                todosLosServicios.forEach(option => {
                    servicioSelect.appendChild(option.cloneNode(true));
                });
            } else {
                const serviciosFiltrados = todosLosServicios.filter(option => {
                    return option.dataset.tipo === tipoSeleccionado;
                });
                serviciosFiltrados.forEach(option => {
                    servicioSelect.appendChild(option.cloneNode(true));
                });
            }
        }

        // Buscar reservas
        async function buscarReservas() {
            // Construir parámetros
            const params = new URLSearchParams();
            
            if (fechaDesde.value) params.append('fecha_desde', fechaDesde.value);
            if (fechaHasta.value) params.append('fecha_hasta', fechaHasta.value);
            if (tipoServicioSelect.value) params.append('id_tipo_servicio', tipoServicioSelect.value);
            if (servicioSelect.value) params.append('id_servicio', servicioSelect.value);
            if (medicoSelect.value) params.append('id_empleado', medicoSelect.value);
            if (dniPaciente.value) params.append('dni_paciente', dniPaciente.value);
            if (estadoSelect.value) params.append('estado', estadoSelect.value);

            // Mostrar loading
            loading.classList.remove('hidden');
            sinResultados.classList.add('hidden');
            tablaContainer.classList.add('hidden');

            try {
                const resp = await fetch(`/reservas/api/listar-reservas?${params.toString()}`);
                const data = await resp.json();

                if (!resp.ok) {
                    throw new Error(data.error || 'Error al cargar reservas');
                }

                reservasData = data.reservas || [];
                mostrarReservas();
                actualizarEstadisticas();

            } catch (err) {
                console.error('Error:', err);
                mostrarNotificacion('Error al cargar reservas', 'error');
                loading.classList.add('hidden');
                sinResultados.classList.remove('hidden');
            }
        }

        // Mostrar reservas en tabla
        function mostrarReservas() {
            loading.classList.add('hidden');

            if (reservasData.length === 0) {
                sinResultados.classList.remove('hidden');
                return;
            }

            sinResultados.classList.add('hidden');
            tablaContainer.classList.remove('hidden');
            tablaBody.innerHTML = '';

            reservasData.forEach(reserva => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors';

                const estadoClass = `estado-${reserva.estado_reserva.toLowerCase()}`;
                const fechaObj = new Date(reserva.fecha_programacion + 'T00:00:00');
                const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${reserva.paciente_nombre}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${reserva.paciente_dni}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        <div class="font-medium">${reserva.servicio_nombre}</div>
                        <div class="text-xs text-gray-500">${reserva.tipo_servicio || '-'}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        <div class="font-medium">${reserva.medico_nombre}</div>
                        ${reserva.especialidad ? `<div class="text-xs text-gray-500">${reserva.especialidad}</div>` : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${fechaFormateada}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${reserva.hora_inicio} - ${reserva.hora_fin}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="${estadoClass} px-3 py-1 rounded-full text-xs">${reserva.estado_reserva}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="verDetalle(${reserva.id_reserva})" class="text-cyan-600 hover:text-cyan-800 font-medium">
                            <i class="fas fa-eye mr-1"></i>Ver
                        </button>
                    </td>
                `;

                tablaBody.appendChild(tr);
            });
        }

        // Actualizar estadísticas
        function actualizarEstadisticas() {
            const confirmadas = reservasData.filter(r => r.estado_reserva === 'Confirmada').length;
            const completadas = reservasData.filter(r => r.estado_reserva === 'Completada').length;
            const canceladas = reservasData.filter(r => r.estado_reserva === 'Cancelada').length;

            totalReservas.textContent = reservasData.length;
            totalConfirmadas.textContent = confirmadas;
            totalCompletadas.textContent = completadas;
            totalCanceladas.textContent = canceladas;
        }

        // Limpiar filtros
        function limpiarFiltros() {
            fechaDesde.value = '';
            fechaHasta.value = '';
            tipoServicioSelect.value = '';
            servicioSelect.value = '';
            medicoInput.value = '';
            medicoSelect.value = '';
            dniPaciente.value = '';
            estadoSelect.value = '';
            medicoDropdown.classList.add('hidden');
            filtrarServicios();
            buscarReservas();
        }

        // Ver detalle (actualizado)
        async function verDetalle(idReserva) {
            reservaSeleccionada = idReserva;
            const modal = document.getElementById('modal-detalle');
            
            // Mostrar loading en el modal
            modal.classList.remove('hidden');
            document.getElementById('modal-detail-id').textContent = `#${idReserva}`;
            
            try {
                const resp = await fetch(`/reservas/api/detalle-reserva/${idReserva}`);
                const data = await resp.json();
                
                if (!resp.ok) {
                    throw new Error(data.error || 'Error al cargar detalle');
                }
                
                // Llenar información general
                document.getElementById('detail-paciente').textContent = data.paciente_nombre;
                document.getElementById('detail-dni').textContent = data.paciente_dni;
                
                const fechaObj = new Date(data.fecha_programacion + 'T00:00:00');
                const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric'
                });
                
                document.getElementById('detail-fecha').textContent = fechaFormateada;
                document.getElementById('detail-horario').textContent = `${data.hora_inicio} - ${data.hora_fin}`;
                
                const estadoEl = document.getElementById('detail-estado');
                estadoEl.textContent = data.estado_reserva;
                estadoEl.className = `px-3 py-1 rounded-full text-xs estado-${data.estado_reserva.toLowerCase()}`;
                
                document.getElementById('detail-tipo-servicio').textContent = data.tipo_servicio || '-';
                document.getElementById('detail-servicio').textContent = data.servicio_nombre;
                document.getElementById('detail-medico').textContent = data.medico_nombre;
                document.getElementById('detail-especialidad').textContent = data.especialidad || '-';
                
                // Ocultar todas las secciones específicas
                document.getElementById('detail-cita').classList.add('hidden');
                document.getElementById('detail-examen').classList.add('hidden');
                document.getElementById('detail-operacion').classList.add('hidden');
                document.getElementById('detail-especifico').classList.add('hidden');
                
                // Mostrar información específica según el tipo
                if (data.cita) {
                    document.getElementById('detail-especifico').classList.remove('hidden');
                    document.getElementById('detail-cita').classList.remove('hidden');
                    document.getElementById('detail-cita-diagnostico').textContent = data.cita.diagnostico || 'Sin diagnóstico';
                    document.getElementById('detail-cita-observaciones').textContent = data.cita.observaciones || 'Sin observaciones';
                    document.getElementById('detail-cita-estado').textContent = data.cita.estado || '-';
                }
                
                if (data.examen) {
                    document.getElementById('detail-especifico').classList.remove('hidden');
                    document.getElementById('detail-examen').classList.remove('hidden');
                    document.getElementById('detail-examen-fecha').textContent = data.examen.fecha_examen || '-';
                    document.getElementById('detail-examen-hora').textContent = data.examen.hora_examen || '-';
                    document.getElementById('detail-examen-observacion').textContent = data.examen.observacion || 'Sin observación';
                    document.getElementById('detail-examen-estado').textContent = data.examen.estado || '-';
                }
                
                if (data.operacion) {
                    document.getElementById('detail-especifico').classList.remove('hidden');
                    document.getElementById('detail-operacion').classList.remove('hidden');
                    document.getElementById('detail-operacion-fecha').textContent = data.operacion.fecha_operacion || '-';
                    document.getElementById('detail-operacion-horario').textContent = 
                        `${data.operacion.hora_inicio} - ${data.operacion.hora_fin}`;
                    document.getElementById('detail-operacion-observaciones').textContent = 
                        data.operacion.observaciones || 'Sin observaciones';
                    
                    // Mostrar recursos
                    const recursosLista = document.getElementById('detail-operacion-recursos-lista');
                    recursosLista.innerHTML = '';
                    if (data.operacion.recursos && data.operacion.recursos.length > 0) {
                        data.operacion.recursos.forEach(recurso => {
                            const li = document.createElement('li');
                            li.textContent = recurso.nombre;
                            recursosLista.appendChild(li);
                        });
                    } else {
                        recursosLista.innerHTML = '<li>No hay recursos asignados</li>';
                    }
                }
                
                // Deshabilitar botón cancelar si ya está cancelada
                const btnCancelar = document.getElementById('btn-cancelar-reserva');
                if (data.estado_reserva === 'Cancelada') {
                    btnCancelar.disabled = true;
                    btnCancelar.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    btnCancelar.disabled = false;
                    btnCancelar.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                
            } catch (err) {
                console.error('Error:', err);
                mostrarNotificacion('Error al cargar detalle de la reserva', 'error');
                cerrarModal();
            }
        }

        // Cerrar modal
        function cerrarModal() {
            document.getElementById('modal-detalle').classList.add('hidden');
            reservaSeleccionada = null;
        }

        // Cancelar reserva
        async function cancelarReserva() {
            if (!reservaSeleccionada) return;
            
            if (!confirm('¿Está seguro de que desea cancelar esta reserva?')) {
                return;
            }
            
            const btnCancelar = document.getElementById('btn-cancelar-reserva');
            btnCancelar.disabled = true;
            btnCancelar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Cancelando...';
            
            try {
                const resp = await fetch(`/reservas/api/cancelar-reserva/${reservaSeleccionada}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await resp.json();
                
                if (!resp.ok) {
                    throw new Error(data.error || 'Error al cancelar reserva');
                }
                
                mostrarNotificacion('Reserva cancelada exitosamente', 'success');
                cerrarModal();
                buscarReservas();
                
            } catch (err) {
                console.error('Error:', err);
                mostrarNotificacion(err.message, 'error');
                btnCancelar.disabled = false;
                btnCancelar.innerHTML = '<i class="fas fa-ban mr-2"></i>Cancelar Reserva';
            }
        }

        // Ver detalle (placeholder) - REEMPLAZAR CON verDetalle
        // function verDetalle(idReserva) {
        //     mostrarNotificacion(`Ver detalle de reserva #${idReserva} (próximamente)`, 'info');
        // }

        // Mostrar notificación
        function mostrarNotificacion(mensaje, tipo) {
            const toast = document.createElement('div');
            const bgColor = tipo === 'success' ? 'bg-green-500' : tipo === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const icon = tipo === 'success' ? 'fa-check-circle' : tipo === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';

            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg z-50 flex items-center animate-fade-in`;
            toast.innerHTML = `
                <i class="fas ${icon} mr-3 text-xl"></i>
                <span>${mensaje}</span>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>

    <style>
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
    </style>
</body>
</html>