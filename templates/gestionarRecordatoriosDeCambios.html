<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recordatorios de Cambios - Clínica Union</title>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;600;700;900&family=Noto+Sans:wght@400;500;700;900">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#f8fafc] font-['Inter']">
    {% include 'header_admin.html' %}
    <div class="max-w-7xl mx-auto p-6 md:p-10">
        <div class="mb-6">
            <a href="/notificaciones" class="inline-flex items-center text-gray-600 hover:text-cyan-600 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                <span class="font-medium">Volver al Panel de Notificaciones</span>
            </a>
        </div>
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Gestionar Recordatorios de Cambios</h1>
            <p class="text-gray-600 mt-2">Envía notificaciones sobre cambios en las citas médicas</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-500 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-600 text-sm font-semibold uppercase tracking-wide">Total Cambios</p>
                        <p class="text-3xl font-bold text-blue-800 mt-2" id="total-cambios">0</p>
                    </div>
                    <div class="bg-blue-500 bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-exchange-alt text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 border-l-4 border-yellow-500 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-yellow-600 text-sm font-semibold uppercase tracking-wide">Pendientes</p>
                        <p class="text-3xl font-bold text-yellow-800 mt-2" id="pendientes">0</p>
                    </div>
                    <div class="bg-yellow-500 bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-clock text-yellow-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-500 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-600 text-sm font-semibold uppercase tracking-wide">Enviados</p>
                        <p class="text-3xl font-bold text-green-800 mt-2" id="enviados">0</p>
                    </div>
                    <div class="bg-green-500 bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 border-l-4 border-purple-500 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-600 text-sm font-semibold uppercase tracking-wide">Reprogramados</p>
                        <p class="text-3xl font-bold text-purple-800 mt-2" id="reprogramados">0</p>
                    </div>
                    <div class="bg-purple-500 bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-calendar-alt text-purple-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha desde</label>
                    <input type="date" id="fecha-desde" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha hasta</label>
                    <input type="date" id="fecha-hasta" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Estado</label>
                    <select id="estado" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500">
                        <option value="">Todos</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="enviado">Enviado</option>
                    </select>
                </div>
                <div class="flex items-end gap-2">
                    <button id="btn-filtrar" class="px-6 py-3 bg-cyan-600 text-white rounded-lg font-semibold hover:bg-cyan-700 transition-colors shadow-md">
                        <i class="fas fa-filter mr-2"></i>Filtrar
                    </button>
                    <button id="btn-enviar-todos" class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors shadow-md">
                        <i class="fas fa-paper-plane mr-2"></i>Enviar Todos
                    </button>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div id="loading" class="flex items-center justify-center py-12">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin text-4xl text-cyan-600 mb-4"></i>
                    <p class="text-gray-600 font-medium">Cargando cambios...</p>
                </div>
            </div>
            <table id="tabla-cambios" class="min-w-full divide-y divide-gray-200 hidden">
                <thead class="bg-gradient-to-r from-cyan-50 to-blue-50">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Paciente</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Fecha Original</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Nueva Fecha</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Tipo Cambio</th>
                        <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Estado</th>
                        <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Acción</th>
                    </tr>
                </thead>
                <tbody id="tbody-cambios" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
            <div id="no-data" class="hidden py-12 text-center">
                <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-lg font-medium">No hay cambios registrados</p>
            </div>
        </div>
    </div>
    <div id="toast" class="hidden fixed top-20 right-6 z-50 px-6 py-4 rounded-lg shadow-2xl border-l-4 transform transition-all duration-300"></div>
    {% include 'footer.html' %}
    <script>
        let cambiosData = [];
        async function cargarCambios() {
            const loading = document.getElementById('loading');
            const tabla = document.getElementById('tabla-cambios');
            const noData = document.getElementById('no-data');
            const tbody = document.getElementById('tbody-cambios');
            loading.classList.remove('hidden');
            tabla.classList.add('hidden');
            noData.classList.add('hidden');
            try {
                const params = new URLSearchParams();
                const desde = document.getElementById('fecha-desde').value;
                const hasta = document.getElementById('fecha-hasta').value;
                const estado = document.getElementById('estado').value;
                if (desde) params.append('fecha_desde', desde);
                if (hasta) params.append('fecha_hasta', hasta);
                if (estado) params.append('estado', estado);
                const resp = await fetch('/notificaciones/api/cambios-citas?' + params);
                if (!resp.ok) throw new Error('Error al cargar');
                cambiosData = await resp.json();
                loading.classList.add('hidden');
                if (cambiosData.length === 0) {
                    noData.classList.remove('hidden');
                    return;
                }
                tabla.classList.remove('hidden');
                tbody.innerHTML = '';
                cambiosData.forEach(c => tbody.appendChild(renderRow(c)));
                actualizarStats();
            } catch (err) {
                loading.classList.add('hidden');
                noData.classList.remove('hidden');
                mostrarNotificacion('Error al cargar: ' + err.message, 'error');
            }
        }
        function renderRow(c) {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-cyan-50 transition-all';
            const horaOrig = c.hora_original ? c.hora_original.substring(0, 5) : '';
            const horaNueva = c.hora_nueva ? c.hora_nueva.substring(0, 5) : '';
            tr.innerHTML = `
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <div class="h-10 w-10 rounded-full bg-purple-100 flex items-center justify-center">
                            <i class="fas fa-user text-purple-600"></i>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-semibold text-gray-900">${c.paciente || '-'}</div>
                            <div class="text-sm text-gray-500">DNI: ${c.documento || '-'}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-900">${c.fecha_original || '-'}</div>
                    <div class="text-sm text-gray-500">${horaOrig}</div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm font-semibold text-cyan-600">${c.fecha_nueva || '-'}</div>
                    <div class="text-sm text-gray-500">${horaNueva}</div>
                </td>
                <td class="px-6 py-4"><span class="text-gray-700">${getTipoBadge(c.tipo_cambio)}</span></td>
                <td class="px-6 py-4 text-center">${getEstadoBadge(c.estado)}</td>
                <td class="px-6 py-4 text-center">${getAccion(c)}</td>
            `;
            return tr;
        }
        function getTipoBadge(tipo) {
            const badges = {
                'reprogramacion': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700"><i class="fas fa-calendar-alt mr-1"></i>Reprogramación</span>',
                'cancelacion': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700"><i class="fas fa-times-circle mr-1"></i>Cancelación</span>',
                'modificacion': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700"><i class="fas fa-edit mr-1"></i>Modificación</span>'
            };
            return badges[tipo] || badges.modificacion;
        }
        function getEstadoBadge(estado) {
            const badges = {
                'pendiente': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700"><i class="fas fa-clock mr-1"></i>Pendiente</span>',
                'enviado': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700"><i class="fas fa-check-circle mr-1"></i>Enviado</span>'
            };
            return badges[estado] || badges.pendiente;
        }
        function getAccion(c) {
            if (c.estado === 'enviado') {
                return `<button onclick="reenviarCambio(${c.id_cambio})" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-semibold hover:bg-blue-200 transition-colors inline-flex items-center text-sm"><i class="fas fa-redo mr-2"></i>Reenviar</button>`;
            }
            return `<button onclick="enviarCambio(${c.id_cambio})" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-semibold hover:bg-green-200 transition-colors inline-flex items-center text-sm"><i class="fas fa-paper-plane mr-2"></i>Enviar</button>`;
        }
        async function enviarCambio(id) {
            if (!confirm('¿Enviar notificación de cambio?')) return;
            try {
                const resp = await fetch('/notificaciones/api/enviar-cambio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id_cambio: id })
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Error al enviar');
                mostrarNotificacion('Notificación enviada', 'success');
                await cargarCambios();
            } catch (err) {
                mostrarNotificacion('Error: ' + err.message, 'error');
            }
        }
        async function reenviarCambio(id) {
            if (!confirm('¿Reenviar notificación de cambio?')) return;
            await enviarCambio(id);
        }
        function actualizarStats() {
            document.getElementById('total-cambios').textContent = cambiosData.length;
            document.getElementById('pendientes').textContent = cambiosData.filter(c => c.estado === 'pendiente').length;
            document.getElementById('enviados').textContent = cambiosData.filter(c => c.estado === 'enviado').length;
            document.getElementById('reprogramados').textContent = cambiosData.filter(c => c.tipo_cambio === 'reprogramacion').length;
        }
        function mostrarNotificacion(mensaje, tipo) {
            const toast = document.getElementById('toast');
            toast.className = 'fixed top-20 right-6 z-50 px-6 py-4 rounded-lg shadow-2xl border-l-4 transform transition-all duration-300';
            if (tipo === 'success') {
                toast.classList.add('bg-green-50', 'border-green-500', 'text-green-800');
                toast.innerHTML = `<div class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-3 text-xl"></i><span class="font-semibold">${mensaje}</span></div>`;
            } else {
                toast.classList.add('bg-red-50', 'border-red-500', 'text-red-800');
                toast.innerHTML = `<div class="flex items-center"><i class="fas fa-exclamation-circle text-red-500 mr-3 text-xl"></i><span class="font-semibold">${mensaje}</span></div>`;
            }
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4000);
        }
        document.getElementById('btn-filtrar').addEventListener('click', cargarCambios);
        document.getElementById('btn-enviar-todos').addEventListener('click', async function() {
            const pendientes = cambiosData.filter(c => c.estado === 'pendiente');
            if (pendientes.length === 0) {
                mostrarNotificacion('No hay notificaciones pendientes', 'error');
                return;
            }
            if (!confirm(`¿Enviar ${pendientes.length} notificación(es)?`)) return;
            let exitosos = 0;
            for (const c of pendientes) {
                try {
                    const resp = await fetch('/notificaciones/api/enviar-cambio', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id_cambio: c.id_cambio })
                    });
                    if (resp.ok) exitosos++;
                } catch (err) {}
            }
            mostrarNotificacion(`Enviados: ${exitosos} de ${pendientes.length}`, 'success');
            await cargarCambios();
        });
        document.addEventListener('DOMContentLoaded', cargarCambios);
    </script>
</body>
</html>
