<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modificar Datos de Cuenta - Clínica Union</title>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;600;700;900&family=Noto+Sans:wght@400;500;700;900">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#f8fafc] font-['Inter']">
    
    {% include 'header_admin.html' %}

    <div class="max-w-7xl mx-auto p-6 md:p-10">
        <!-- Botón de regreso -->
        <div class="mb-6">
            <a href="/cuentas/" class="inline-flex items-center text-gray-600 hover:text-cyan-600 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                <span class="font-medium">Volver al Panel de Cuentas</span>
            </a>
        </div>

        <!-- Título -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Modificar Datos de Cuenta</h1>
            <p class="text-gray-600 mt-2">Actualiza la información del empleado</p>
        </div>

        <!-- Mensajes flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                        <i class="fas {% if category == 'error' %}fa-exclamation-circle{% else %}fa-check-circle{% endif %} mr-2"></i>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Formulario -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-8">
            <form method="POST" enctype="multipart/form-data" class="space-y-6">

                <!-- Foto de Perfil (Opcional - por ahora no funcional) -->
                <!--
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label for="foto_perfil" class="block text-sm font-semibold text-gray-700 mb-2">
                            Foto de Perfil
                        </label>
                        <input
                            type="file"
                            id="foto_perfil"
                            name="foto_perfil"
                            accept="image/*"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 transition-colors"
                        >
                    </div>
                </div>
                -->


                <!-- Nombres y Apellidos -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="nombres" class="block text-sm font-semibold text-gray-700 mb-2">
                            Nombres <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            id="nombres"
                            name="nombres"
                            required
                            value="{{ empleado.nombres if empleado else '' }}"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 transition-colors"
                            placeholder="Ej: Juan Carlos"
                        >
                    </div>
                    <div>
                        <label for="apellidos" class="block text-sm font-semibold text-gray-700 mb-2">
                            Apellidos <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            id="apellidos"
                            name="apellidos"
                            required
                            value="{{ empleado.apellidos if empleado else '' }}"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 transition-colors"
                            placeholder="Ej: Pérez López"
                        >
                    </div>
                </div>

                <!-- Sexo -->
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label for="sexo" class="block text-sm font-semibold text-gray-700 mb-2">
                            Sexo <span class="text-red-500">*</span>
                        </label>
                        <select
                            id="sexo"
                            name="sexo"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 transition-colors"
                        >
                            <option value="">Seleccione un sexo</option>
                            <option value="Masculino" {% if empleado and empleado.sexo == 'Masculino' %}selected{% endif %}>Masculino</option>
                            <option value="Femenino" {% if empleado and empleado.sexo == 'Femenino' %}selected{% endif %}>Femenino</option>
                        </select>
                    </div>
                </div>

                <!-- Documento y Teléfono -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="documento" class="block text-sm font-semibold text-gray-700 mb-2">
                            Documento de Identidad <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            id="documento"
                            name="documento"
                            required
                            maxlength="8"
                            value="{{ empleado.documento_identidad if empleado else '' }}"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 transition-colors"
                            placeholder="DNI (8 dígitos)"
                        >
                    </div>
                    <div>
                        <label for="telefono" class="block text-sm font-semibold text-gray-700 mb-2">
                            Teléfono <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="tel"
                            id="telefono"
                            name="telefono"
                            required
                            maxlength="9"
                            value="{{ empleado.telefono if empleado else '' }}"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 transition-colors"
                            placeholder="Ej: 987654321"
                        >
                    </div>
                </div>

                <!-- Email (Fecha de nacimiento removida para empleados) -->
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                            Correo Electrónico <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="email"
                            id="email"
                            name="email"
                            required
                            value="{{ empleado.correo if empleado else '' }}"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 transition-colors"
                            placeholder="ejemplo@clinica.com"
                        >
                    </div>
                </div>

                <!-- Departamento, Provincia y Distrito -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="departamento" class="block text-sm font-semibold text-gray-700 mb-2">
                            Departamento <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <select
                                id="departamento"
                                name="departamento"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 transition-colors appearance-none cursor-pointer"
                            >
                                <option value="">Seleccione un departamento...</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>
                    <div>
                        <label for="provincia" class="block text-sm font-semibold text-gray-700 mb-2">
                            Provincia <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <select
                                id="provincia"
                                name="provincia"
                                required
                                disabled
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 transition-colors appearance-none cursor-pointer disabled:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-60"
                            >
                                <option value="">Seleccione un departamento primero...</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>
                    <div>
                        <label for="distrito" class="block text-sm font-semibold text-gray-700 mb-2">
                            Distrito <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <select
                                id="distrito"
                                name="distrito"
                                required
                                disabled
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 transition-colors appearance-none cursor-pointer disabled:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-60"
                            >
                                <option value="">Seleccione una provincia primero...</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>
                </div>

                <!-- Rol y Especialidad -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="rol" class="block text-sm font-semibold text-gray-700 mb-2">
                            Rol <span class="text-red-500">*</span>
                        </label>
                        <select
                            id="rol"
                            name="rol"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 transition-colors"
                        >
                            <option value="">Seleccione un rol</option>
                            {% if roles %}
                                {% for rol in roles %}
                                    <option value="{{ rol.id_rol }}" {% if empleado and empleado.id_rol == rol.id_rol %}selected{% endif %}>
                                        {{ rol.nombre }}
                                    </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div id="especialidad-container" style="display: none;">
                        <label for="especialidad" class="block text-sm font-semibold text-gray-700 mb-2">
                            Especialidad <span class="text-red-500">*</span>
                        </label>
                        <select
                            id="especialidad"
                            name="especialidad"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 transition-colors"
                        >
                            <option value="">Seleccione una especialidad</option>
                        </select>
                    </div>
                </div>

                <!-- Botones -->
                <div class="flex flex-col sm:flex-row gap-4 pt-4">
                    <button 
                        type="submit"
                        class="flex-1 bg-cyan-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-cyan-700 transition-colors shadow-md hover:shadow-lg"
                    >
                        <i class="fas fa-save mr-2"></i>
                        Guardar Cambios
                    </button>
                    <a 
                        href="/cuentas/gestionar-cuentas-internas"
                        class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors text-center"
                    >
                        <i class="fas fa-times mr-2"></i>
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>

    {% include 'footer.html' %}

    <!-- Datos del empleado para JS (evitar Jinja dentro del script) -->
    <div id="empleado-data" data-json='{{ {
        "id_departamento": empleado.id_departamento if empleado else 0,
        "id_provincia": empleado.id_provincia if empleado else 0,
        "id_distrito": empleado.id_distrito if empleado else 0,
        "distrito": empleado.distrito if empleado else "",
        "provincia": empleado.provincia if empleado else "",
        "departamento": empleado.departamento if empleado else ""
    } | tojson }}' hidden></div>

    <script>
        // Variable global para especialidades
        let especialidadesData = [];

        // Toggle password visibility
        function togglePasswordField(fieldId) {
            const field = document.getElementById(fieldId);
            const eyeIcon = document.getElementById(fieldId + '-eye');
            
            if (field.type === 'password') {
                field.type = 'text';
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash');
            } else {
                field.type = 'password';
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye');
            }
        }

        // Función para cargar especialidades desde la API
        async function cargarEspecialidades() {
            try {
                const response = await fetch('/cuentas/api/especialidades');
                especialidadesData = await response.json();
                
                const especialidadSelect = document.getElementById('especialidad');
                especialidadSelect.innerHTML = '<option value="">Seleccione una especialidad</option>';
                
                especialidadesData.forEach(esp => {
                    const option = document.createElement('option');
                    option.value = esp.id_especialidad;
                    option.textContent = esp.nombre;
                    // Seleccionar la especialidad actual del empleado si existe
                    if (esp.nombre === '{{ empleado.especialidad }}') {
                        option.selected = true;
                    }
                    especialidadSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar especialidades:', error);
            }
        }

        // Función para mostrar/ocultar especialidad según rol
        function toggleEspecialidadField() {
            const rolSelect = document.getElementById('rol');
            const especialidadContainer = document.getElementById('especialidad-container');
            const rolOptions = rolSelect.querySelectorAll('option');
            let rolText = '';

            // Obtener el nombre del rol seleccionado
            for (let option of rolOptions) {
                if (option.value === rolSelect.value) {
                    rolText = option.textContent.toLowerCase();
                    break;
                }
            }

            // Mostrar/ocultar especialidad si el rol es médico
            if (rolText.includes('medico') || rolText.includes('médico')) {
                especialidadContainer.style.display = 'block';
                cargarEspecialidades();
            } else {
                especialidadContainer.style.display = 'none';
                document.getElementById('especialidad').value = '';
            }
        }

        // Event listener para cambios en el rol
        document.getElementById('rol').addEventListener('change', toggleEspecialidadField);

        // Validación de formulario
        document.querySelector('form').addEventListener('submit', function(e) {
            const documento = document.getElementById('documento').value;
            const telefono = document.getElementById('telefono').value;

            // Validar DNI (8 dígitos)
            if (!/^\d{8}$/.test(documento)) {
                e.preventDefault();
                alert('El DNI debe tener 8 dígitos');
                return;
            }

            // Validar teléfono (9 dígitos)
            if (!/^\d{9}$/.test(telefono)) {
                e.preventDefault();
                alert('El teléfono debe tener 9 dígitos');
                return;
            }
        });

        // Cascading select logic for Departamento -> Provincia -> Distrito
        // Evitar Jinja dentro del script: leer datos preinyectados en un data-json
        const empleadoDataEl = document.getElementById('empleado-data');
        const empleadoData = empleadoDataEl ? JSON.parse(empleadoDataEl.dataset.json || '{}') : {};

        let departamentos = [];
        let provincias = [];
        let distritos = [];

        // Cargar departamentos al inicio
        async function cargarDepartamentos() {
            try {
                const response = await fetch('/usuarios/api/departamentos');
                departamentos = await response.json();

                const selectDepartamento = document.getElementById('departamento');
                selectDepartamento.innerHTML = '<option value="">Seleccione un departamento...</option>';

                departamentos.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id_departamento;
                    option.textContent = dept.nombre_departamento || dept.nombre;
                    selectDepartamento.appendChild(option);
                });

                // Si hay departamento preseleccionado, encontrarlo y seleccionarlo
                if (empleadoData.departamento) {
                    const deptEncontrado = departamentos.find(d => (d.nombre_departamento || d.nombre) === empleadoData.departamento);
                    if (deptEncontrado) {
                        selectDepartamento.value = deptEncontrado.id_departamento;
                        await cargarProvincias(deptEncontrado.id_departamento, true);
                    }
                } else if (empleadoData.id_departamento) {
                    selectDepartamento.value = empleadoData.id_departamento;
                    await cargarProvincias(empleadoData.id_departamento, true);
                }
            } catch (error) {
                console.error('Error al cargar departamentos:', error);
            }
        }

        // Cargar provincias según departamento
        async function cargarProvincias(id_departamento, preseleccionar = false) {
            try {
                const response = await fetch(`/usuarios/api/provincias/${id_departamento}`);
                provincias = await response.json();

                const selectProvincia = document.getElementById('provincia');
                const selectDistrito = document.getElementById('distrito');

                selectProvincia.innerHTML = '<option value="">Seleccione una provincia...</option>';
                selectDistrito.innerHTML = '<option value="">Seleccione una provincia primero...</option>';
                selectDistrito.disabled = true;

                provincias.forEach(prov => {
                    const option = document.createElement('option');
                    option.value = prov.id_provincia;
                    option.textContent = prov.nombre_provincia || prov.nombre;
                    selectProvincia.appendChild(option);
                });

                selectProvincia.disabled = false;

                // Si hay provincia preseleccionada, encontrarla y seleccionarla
                if (preseleccionar && empleadoData.provincia) {
                    const provEncontrada = provincias.find(p => (p.nombre_provincia || p.nombre) === empleadoData.provincia);
                    if (provEncontrada) {
                        selectProvincia.value = provEncontrada.id_provincia;
                        await cargarDistritos(provEncontrada.id_provincia, true);
                    }
                } else if (preseleccionar && empleadoData.id_provincia) {
                    selectProvincia.value = empleadoData.id_provincia;
                    await cargarDistritos(empleadoData.id_provincia, true);
                }
            } catch (error) {
                console.error('Error al cargar provincias:', error);
            }
        }

        // Cargar distritos según provincia
        async function cargarDistritos(id_provincia, preseleccionar = false) {
            try {
                const response = await fetch(`/usuarios/api/distritos/${id_provincia}`);
                distritos = await response.json();

                const selectDistrito = document.getElementById('distrito');
                selectDistrito.innerHTML = '<option value="">Seleccione un distrito...</option>';

                distritos.forEach(dist => {
                    const option = document.createElement('option');
                    option.value = dist.id_distrito;
                    option.textContent = dist.nombre_distrito || dist.nombre;
                    selectDistrito.appendChild(option);
                });

                selectDistrito.disabled = false;

                // Si hay distrito preseleccionado, seleccionarlo
                if (preseleccionar && empleadoData.id_distrito) {
                    selectDistrito.value = empleadoData.id_distrito;
                }
            } catch (error) {
                console.error('Error al cargar distritos:', error);
            }
        }

        // Event Listeners para los cambios
        document.getElementById('departamento').addEventListener('change', function() {
            const id_departamento = this.value;
            const selectProvincia = document.getElementById('provincia');
            const selectDistrito = document.getElementById('distrito');

            if (id_departamento) {
                cargarProvincias(id_departamento);
            } else {
                selectProvincia.innerHTML = '<option value="">Seleccione un departamento primero...</option>';
                selectProvincia.disabled = true;
                selectDistrito.innerHTML = '<option value="">Seleccione una provincia primero...</option>';
                selectDistrito.disabled = true;
            }
        });

        document.getElementById('provincia').addEventListener('change', function() {
            const id_provincia = this.value;
            const selectDistrito = document.getElementById('distrito');

            if (id_provincia) {
                cargarDistritos(id_provincia);
            } else {
                selectDistrito.innerHTML = '<option value="">Seleccione una provincia primero...</option>';
                selectDistrito.disabled = true;
            }
        });

        // Inicializar carga de departamentos
        cargarDepartamentos();

        // Inicializar especialidad al cargar la página
        window.addEventListener('DOMContentLoaded', function() {
            toggleEspecialidadField();
        });
    </script>
</body>
</html>
