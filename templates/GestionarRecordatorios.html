<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Recordatorios - Clínica Unión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-[#f8fafc]">
    {% include 'header_admin.html' %}

    <div class="max-w-7xl mx-auto p-6 md:p-10">
        <div class="mb-6">
            <a href="/notificaciones" class="inline-flex items-center text-gray-600 hover:text-cyan-600 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Volver a Notificaciones
            </a>
        </div>

        <div class="mb-8">
            <h1 class="text-3xl font-black text-gray-800">
                <i class="fas fa-bell text-cyan-600 mr-3"></i>Gestionar Recordatorios
            </h1>
            <p class="text-gray-600 mt-2">Configura y envía recordatorios automáticos antes de la fecha de cita</p>
        </div>

        <!-- Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-500 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-600 text-sm font-semibold uppercase tracking-wide">Total</p>
                        <p class="text-3xl font-bold text-blue-800 mt-2" id="total-recordatorios">0</p>
                    </div>
                    <div class="bg-blue-500 bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-calendar-alt text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 border-l-4 border-yellow-500 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-yellow-600 text-sm font-semibold uppercase tracking-wide">Pendientes</p>
                        <p class="text-3xl font-bold text-yellow-800 mt-2" id="total-pendientes">0</p>
                    </div>
                    <div class="bg-yellow-500 bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-clock text-yellow-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-500 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-600 text-sm font-semibold uppercase tracking-wide">Enviados</p>
                        <p class="text-3xl font-bold text-green-800 mt-2" id="total-enviados">0</p>
                    </div>
                    <div class="bg-green-500 bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-paper-plane text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 border-l-4 border-purple-500 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-600 text-sm font-semibold uppercase tracking-wide">Programados</p>
                        <p class="text-3xl font-bold text-purple-800 mt-2" id="total-programados">0</p>
                    </div>
                    <div class="bg-purple-500 bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-calendar-check text-purple-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="bg-white border border-cyan-200 rounded-lg p-6 shadow-sm mb-8">
            <div class="flex items-center mb-4">
                <i class="fas fa-filter text-cyan-600 text-xl mr-3"></i>
                <h2 class="text-lg font-semibold text-gray-800">Filtros</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="flex flex-col">
                    <label class="text-xs font-bold text-gray-600 tracking-wider mb-2">
                        <i class="fas fa-calendar mr-1"></i>FECHA
                    </label>
                    <input type="date" id="fecha-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 bg-white">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-bold text-gray-600 tracking-wider mb-2">
                        <i class="fas fa-info-circle mr-1"></i>ESTADO
                    </label>
                    <select id="estado-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 bg-white">
                        <option value="">Todos</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="enviado">Enviado</option>
                        <option value="programado">Programado</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 flex gap-4">
                <button id="btn-buscar" class="flex-1 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-semibold py-3 px-6 rounded-lg inline-flex items-center justify-center transition-all shadow-md">
                    <i class="fas fa-search mr-2"></i>Buscar
                </button>
                <button id="btn-enviar-todos" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg inline-flex items-center justify-center transition-all shadow-md disabled:opacity-50" disabled>
                    <i class="fas fa-paper-plane mr-2"></i>Enviar Todos
                </button>
                <button id="btn-limpiar" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg inline-flex items-center justify-center transition-all shadow-sm">
                    <i class="fas fa-eraser mr-2"></i>Limpiar
                </button>
            </div>
        </div>

        <!-- Tabla -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div class="flex items-center">
                    <i class="fas fa-list text-cyan-600 text-2xl mr-3"></i>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Recordatorios</h2>
                        <p class="text-sm text-gray-500 mt-1" id="subtitulo">Busca recordatorios</p>
                    </div>
                </div>
                <div id="loading" class="hidden">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-4 border-cyan-500"></div>
                </div>
            </div>
            <div id="placeholder" class="text-center py-16">
                <i class="fas fa-search text-gray-300 text-6xl mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">Busca recordatorios</h3>
                <p class="text-gray-500">Selecciona una fecha y presiona "Buscar"</p>
            </div>
            <div id="no-resultados" class="hidden text-center py-16">
                <i class="fas fa-inbox text-gray-300 text-6xl mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay recordatorios</h3>
            </div>
            <div id="tabla-container" class="hidden overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-cyan-50 to-blue-50 border-b-2 border-cyan-300">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider"><i class="fas fa-calendar-day mr-2 text-cyan-600"></i>Fecha/Hora</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider"><i class="fas fa-user mr-2 text-cyan-600"></i>Paciente</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider"><i class="fas fa-stethoscope mr-2 text-cyan-600"></i>Servicio</th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider"><i class="fas fa-info-circle mr-2 text-cyan-600"></i>Estado</th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider"><i class="fas fa-cog mr-2 text-cyan-600"></i>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="recordatorios-body" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    {% include 'footer.html' %}

    <script>
        const btnBuscar = document.getElementById('btn-buscar');
        const btnEnviarTodos = document.getElementById('btn-enviar-todos');
        const btnLimpiar = document.getElementById('btn-limpiar');
        const fechaSelect = document.getElementById('fecha-select');
        const estadoSelect = document.getElementById('estado-select');
        const recordatoriosBody = document.getElementById('recordatorios-body');
        const loading = document.getElementById('loading');
        const placeholder = document.getElementById('placeholder');
        const noResultados = document.getElementById('no-resultados');
        const tablaContainer = document.getElementById('tabla-container');
        const subtitulo = document.getElementById('subtitulo');
        let recordatoriosData = [];

        const hoy = new Date();
        fechaSelect.value = hoy.toISOString().split('T')[0];

        btnBuscar.addEventListener('click', () => cargarRecordatorios());
        btnLimpiar.addEventListener('click', function() {
            fechaSelect.value = hoy.toISOString().split('T')[0];
            estadoSelect.value = '';
            placeholder.classList.remove('hidden');
            noResultados.classList.add('hidden');
            tablaContainer.classList.add('hidden');
            btnEnviarTodos.disabled = true;
            actualizarEstadisticas([]);
        });

        btnEnviarTodos.addEventListener('click', async function() {
            const pendientes = recordatoriosData.filter(r => r.estado === 'pendiente');
            if (!confirm(`¿Enviar ${pendientes.length} recordatorio(s)?`)) return;
            let exitosos = 0;
            for (const r of pendientes) {
                try {
                    const resp = await fetch('/notificaciones/api/enviar-recordatorio', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id_recordatorio: r.id_recordatorio })
                    });
                    if (resp.ok) exitosos++;
                } catch (err) {}
            }
            mostrarNotificacion(`Enviados: ${exitosos}`, 'success');
            await cargarRecordatorios();
        });

        async function cargarRecordatorios() {
            const fecha = fechaSelect.value;
            const estado = estadoSelect.value;
            if (!fecha) return mostrarNotificacion('Selecciona una fecha', 'error');

            const params = new URLSearchParams();
            params.set('fecha', fecha);
            if (estado) params.set('estado', estado);

            loading.classList.remove('hidden');
            placeholder.classList.add('hidden');
            noResultados.classList.add('hidden');
            tablaContainer.classList.add('hidden');

            try {
                const resp = await fetch(`/notificaciones/api/recordatorios?${params.toString()}`);
                if (!resp.ok) throw new Error('Error');
                const data = await resp.json();
                recordatoriosData = data.recordatorios || [];
                loading.classList.add('hidden');

                if (recordatoriosData.length === 0) {
                    noResultados.classList.remove('hidden');
                    btnEnviarTodos.disabled = true;
                    actualizarEstadisticas([]);
                    return;
                }

                tablaContainer.classList.remove('hidden');
                const pendientes = recordatoriosData.filter(r => r.estado === 'pendiente');
                btnEnviarTodos.disabled = pendientes.length === 0;
                actualizarEstadisticas(recordatoriosData);
                subtitulo.textContent = `Mostrando ${recordatoriosData.length} recordatorio(s)`;
                recordatoriosBody.innerHTML = '';
                recordatoriosData.forEach(r => recordatoriosBody.appendChild(renderRow(r)));
                mostrarNotificacion(`Se encontraron ${recordatoriosData.length} recordatorio(s)`, 'success');
            } catch (err) {
                loading.classList.add('hidden');
                noResultados.classList.remove('hidden');
                mostrarNotificacion('Error al cargar', 'error');
            }
        }

        function renderRow(r) {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-cyan-50 transition-all';
            const hora = r.hora_inicio ? r.hora_inicio.substring(0, 5) : '';
            tr.innerHTML = `
                <td class="px-6 py-4"><div class="text-sm font-semibold text-gray-800">${r.fecha || '-'}</div><div class="text-xs text-gray-600">${hora}</div></td>
                <td class="px-6 py-4"><span class="text-gray-800">${r.paciente || '-'}</span></td>
                <td class="px-6 py-4"><span class="text-gray-700">${r.servicio || '-'}</span></td>
                <td class="px-6 py-4 text-center">${getBadge(r.estado)}</td>
                <td class="px-6 py-4 text-center">${getAccion(r)}</td>
            `;
            return tr;
        }

        function getBadge(estado) {
            const badges = {
                'pendiente': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700"><i class="fas fa-clock mr-1"></i>Pendiente</span>',
                'enviado': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700"><i class="fas fa-check-circle mr-1"></i>Enviado</span>',
                'programado': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700"><i class="fas fa-calendar-check mr-1"></i>Programado</span>'
            };
            return badges[estado] || badges.pendiente;
        }

        function getAccion(r) {
            if (r.estado === 'pendiente') {
                return `<button onclick="enviarRecordatorio(${r.id_recordatorio})" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg inline-flex items-center transition-all shadow-sm"><i class="fas fa-paper-plane mr-2"></i>Enviar</button>`;
            }
            return '<span class="text-gray-400 text-sm">-</span>';
        }

        async function enviarRecordatorio(id) {
            if (!confirm('¿Enviar este recordatorio?')) return;
            try {
                const resp = await fetch('/notificaciones/api/enviar-recordatorio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id_recordatorio: id })
                });
                if (!resp.ok) throw new Error('Error');
                mostrarNotificacion('Recordatorio enviado', 'success');
                await cargarRecordatorios();
            } catch (err) {
                mostrarNotificacion('Error al enviar', 'error');
            }
        }

        function actualizarEstadisticas(data) {
            document.getElementById('total-recordatorios').textContent = data.length;
            document.getElementById('total-pendientes').textContent = data.filter(r => r.estado === 'pendiente').length;
            document.getElementById('total-enviados').textContent = data.filter(r => r.estado === 'enviado').length;
            document.getElementById('total-programados').textContent = data.filter(r => r.estado === 'programado').length;
        }

        function mostrarNotificacion(mensaje, tipo) {
            const toast = document.createElement('div');
            const bgColor = tipo === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = tipo === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg z-50 flex items-center animate-fade-in`;
            toast.innerHTML = `<i class="fas ${icon} mr-3 text-xl"></i><span>${mensaje}</span>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        (function() {
            if (window.usuario) {
                const u = window.usuario;
                const nameEl = document.getElementById('admin-username');
                const roleEl = document.getElementById('admin-role');
                if (nameEl && u.nombre) nameEl.textContent = u.nombre;
                if (roleEl && u.rol) roleEl.textContent = u.rol;
            }
        })();
    </script>

    <style>
        @keyframes fade-in { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
    </style>
</body>
</html>
