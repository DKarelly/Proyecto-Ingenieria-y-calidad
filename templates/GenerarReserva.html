<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar Nueva Reserva - Clínica Unión</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="text-gray-700">
    <div class="container mx-auto">
        {% include 'header_admin.html' %}

    <div class="max-w-7xl mx-auto p-6 md:p-10">
        <!-- Botón de regreso -->
        <div class="mb-6">
            <a href="/reservas" class="inline-flex items-center text-cyan-600 hover:text-cyan-800 font-medium transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Volver a Reservas
            </a>
        </div>

        <!-- Título principal -->
        <h1 class="text-3xl font-bold text-gray-800 mb-8">
            <i class="fas fa-calendar-plus text-cyan-600 mr-3"></i>
            Generar Nueva Reserva
        </h1>

        <!-- Dashboard de Estadísticas -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Total Servicios -->
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-500 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-600 text-sm font-semibold uppercase tracking-wide">Servicios</p>
                        <p class="text-3xl font-bold text-blue-800 mt-2" id="servicios-count">{{ servicios|length }}</p>
                    </div>
                    <div class="bg-blue-500 bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-stethoscope text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Total Médicos -->
            <div class="bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-500 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-600 text-sm font-semibold uppercase tracking-wide">Médicos</p>
                        <p class="text-3xl font-bold text-green-800 mt-2" id="medicos-count">{{ medicos|length }}</p>
                    </div>
                    <div class="bg-green-500 bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-user-md text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paso 1: Buscar Paciente -->
        <div class="bg-white border border-cyan-200 rounded-lg p-6 shadow-sm mb-6">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center bg-cyan-500 text-white rounded-full font-bold mr-3">1</div>
                <h2 class="text-lg font-semibold text-gray-800">Buscar Paciente</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="dni-paciente" class="block text-xs font-bold text-gray-600 tracking-wider mb-2">
                        <i class="fas fa-id-card mr-1"></i>
                        DNI DEL PACIENTE
                    </label>
                    <div class="flex gap-2">
                        <input
                            id="dni-paciente"
                            type="text"
                            maxlength="8"
                            placeholder="Ingrese 8 dígitos"
                            pattern="[0-9]*"
                            inputmode="numeric"
                            class="flex-1 px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 rounded-lg transition-all"
                        />
                        <button
                            id="btn-buscar-paciente"
                            class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-semibold py-3 px-6 rounded-lg inline-flex items-center transition-all shadow-md hover:shadow-lg">
                            <i class="fas fa-search mr-2"></i>
                            Buscar
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-600 tracking-wider mb-2">
                        <i class="fas fa-user mr-1"></i>
                        INFORMACIÓN DEL PACIENTE
                    </label>
                    <div id="paciente-info" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-lg min-h-[60px] flex items-center justify-center">
                        <p class="text-sm text-gray-500 text-center">
                            <i class="fas fa-user-circle text-3xl text-gray-400 mb-2 block"></i>
                            Busque un paciente por DNI
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paso 2: Seleccionar Tipo, Servicio y Médico -->
        <div class="bg-white border border-cyan-200 rounded-lg p-6 shadow-sm mb-6">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center bg-cyan-500 text-white rounded-full font-bold mr-3">2</div>
                <h2 class="text-lg font-semibold text-gray-800">Seleccionar Tipo, Servicio y Médico</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Tipo de Servicio -->
                <div>
                    <label for="select-tipo-servicio" class="block text-xs font-bold text-gray-600 tracking-wider mb-2">
                        <i class="fas fa-list mr-1"></i>
                        TIPO DE SERVICIO
                    </label>
                    <select
                        id="select-tipo-servicio"
                        class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all"
                    >
                        <option value="">Todos los tipos</option>
                        {% for tipo in tipos_servicio %}
                        <option value="{{ tipo.id_tipo_servicio }}">{{ tipo.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Servicio -->
                <div>
                    <label for="select-service" class="block text-xs font-bold text-gray-600 tracking-wider mb-2">
                        <i class="fas fa-stethoscope mr-1"></i>
                        SERVICIO
                    </label>
                    <select
                        id="select-service"
                        class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all"
                    >
                        <option value="">Seleccione un servicio</option>
                        {% for s in servicios %}
                        <option value="{{ s.id_servicio }}" data-tipo="{{ s.id_tipo_servicio }}" data-especialidad="{{ s.id_especialidad }}">{{ s.nombre }}{% if s.especialidad %} — {{ s.especialidad }}{% endif %}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Médico -->
                <div class="relative">
                    <label for="input-medic" class="block text-xs font-bold text-gray-600 tracking-wider mb-2">
                        <i class="fas fa-user-doctor mr-1"></i>
                        MÉDICO (OPCIONAL)
                    </label>
                    <input
                        id="input-medic"
                        type="text"
                        placeholder="Buscar médico..."
                        autocomplete="off"
                        class="w-full px-4 py-3 border border-gray-300 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 text-gray-700 bg-white rounded-lg transition-all"
                    />
                    <div id="medicos-dropdown" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                        <!-- Opciones de médicos se generarán dinámicamente -->
                    </div>
                    <input type="hidden" id="select-medic" value="" />
                </div>

                <!-- Botón Buscar -->
                <div class="flex items-end">
                    <button
                        id="btn-buscar-horarios"
                        class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-lg inline-flex items-center justify-center transition-all shadow-md hover:shadow-lg">
                        <i class="fas fa-clock mr-2"></i>
                        Buscar Horarios
                    </button>
                </div>
            </div>
        </div>

        <!-- Paso 3: Seleccionar Horario -->
        <div class="bg-white border border-cyan-200 rounded-lg p-6 shadow-sm mb-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center bg-cyan-500 text-white rounded-full font-bold mr-3">3</div>
                    <h2 class="text-lg font-semibold text-gray-800">Seleccionar Horario</h2>
                </div>
                <button
                    id="btn-limpiar-todo"
                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg inline-flex items-center transition-all">
                    <i class="fas fa-redo mr-2"></i>
                    Limpiar Todo
                </button>
            </div>

            <!-- Mensaje inicial -->
            <div id="horarios-placeholder" class="text-center py-12">
                <i class="fas fa-clock text-gray-300 text-6xl mb-4"></i>
                <p class="text-gray-600 font-semibold text-lg">Busque horarios disponibles</p>
                <p class="text-gray-500 text-sm mt-2">Seleccione un servicio y haga clic en "Buscar Horarios"</p>
            </div>

            <!-- Loading -->
            <div id="horarios-loading" class="hidden text-center py-12">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-cyan-500 mx-auto mb-4"></div>
                <p class="text-gray-600 font-medium">Cargando horarios disponibles...</p>
            </div>

            <!-- Sin resultados -->
            <div id="horarios-vacio" class="hidden text-center py-12">
                <i class="fas fa-calendar-times text-gray-300 text-6xl mb-4"></i>
                <p class="text-gray-600 font-semibold text-lg">No hay horarios disponibles</p>
                <p class="text-gray-500 text-sm mt-2">Intente con otro servicio o médico</p>
            </div>

            <!-- Contenedor dinámico de horarios agrupados por fecha -->
            <div id="horarios-container" class="hidden space-y-4"></div>
        </div>

        <!-- Paso 4: Confirmar Reserva -->
        <div class="bg-white border border-cyan-200 rounded-lg p-6 shadow-sm mb-6">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center bg-cyan-500 text-white rounded-full font-bold mr-3">4</div>
                <h2 class="text-lg font-semibold text-gray-800">Confirmar y Crear Reserva</h2>
            </div>

            <!-- Resumen de la reserva -->
            <div id="resumen-reserva" class="hidden mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h3 class="font-semibold text-gray-800 mb-3">
                    <i class="fas fa-clipboard-check mr-2 text-blue-600"></i>
                    Resumen de la Reserva
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-gray-600"><strong>Paciente:</strong> <span id="resumen-paciente">-</span></p>
                        <p class="text-gray-600"><strong>DNI:</strong> <span id="resumen-dni">-</span></p>
                    </div>
                    <div>
                        <p class="text-gray-600"><strong>Servicio:</strong> <span id="resumen-servicio">-</span></p>
                        <p class="text-gray-600"><strong>Horario:</strong> <span id="resumen-horario">-</span></p>
                    </div>
                </div>
            </div>

            <button
                id="btn-crear-reserva"
                disabled
                class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed text-white font-semibold py-4 px-6 rounded-lg inline-flex items-center justify-center transition-all shadow-md hover:shadow-lg">
                <i class="fas fa-check-circle mr-2 text-xl"></i>
                <span class="text-lg">Crear Reserva</span>
            </button>
        </div>
    </div>

    {% include 'footer.html' %}

    </div>

    <!-- Modal de Confirmación de Reserva -->
    <div id="modal-confirmacion" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full animate-fade-in">
            <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-t-xl">
                <div class="flex items-center justify-center mb-2">
                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                        <i class="fas fa-check-circle text-4xl"></i>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-center">¡Reserva Creada Exitosamente!</h2>
            </div>
            
            <div class="p-6">
                <div class="space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                        <h3 class="font-semibold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-calendar-check text-blue-600 mr-2"></i>
                            Detalles de la Reserva
                        </h3>
                        <div class="text-sm space-y-2">
                            <p><strong>ID Reserva:</strong> <span id="modal-id-reserva" class="text-blue-600 font-mono">#---</span></p>
                            <p><strong>Paciente:</strong> <span id="modal-paciente">---</span></p>
                            <p><strong>DNI:</strong> <span id="modal-dni">---</span></p>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                        <h3 class="font-semibold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-stethoscope text-green-600 mr-2"></i>
                            Servicio Programado
                        </h3>
                        <div class="text-sm space-y-2">
                            <p><strong>Tipo:</strong> <span id="modal-tipo-servicio">---</span></p>
                            <p><strong>Servicio:</strong> <span id="modal-servicio">---</span></p>
                            <p><strong>Fecha:</strong> <span id="modal-fecha">---</span></p>
                            <p><strong>Horario:</strong> <span id="modal-horario">---</span></p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex gap-3">
                    <button
                        id="btn-ver-reservas"
                        class="flex-1 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-semibold py-3 px-6 rounded-lg inline-flex items-center justify-center transition-all shadow-md hover:shadow-lg">
                        <i class="fas fa-list mr-2"></i>
                        Ver Mis Reservas
                    </button>
                    <button
                        id="btn-nueva-reserva"
                        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg inline-flex items-center justify-center transition-all">
                        <i class="fas fa-plus mr-2"></i>
                        Nueva Reserva
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AlpineJS para interactividad del dropdown -->
    <script src="//unpkg.com/alpinejs" defer></script>

    <script>
        // Variables globales
        let pacienteSeleccionado = null;
        let horarioSeleccionado = null;
        let horarioData = null;
        let todosLosServicios = []; // Array para almacenar todos los servicios
        let todosMedicos = []; // Array para almacenar todos los médicos
        let medicoSeleccionadoId = null; // ID del médico seleccionado

        // Elementos del DOM (se inicializarán cuando el DOM esté listo)
        let dniInput, btnBuscarPaciente, pacienteInfo;
        let tipoServicioSelect, servicioSelect, medicoInput, medicoSelect, medicoDropdown, btnBuscarHorarios;
        let horariosPlaceholder, horariosLoading, horariosVacio, horariosContainer;
        let btnCrearReserva, btnLimpiarTodo;
        let serviciosCount, medicosCount, resumenReserva;

        // Esperar a que el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar referencias a elementos del DOM
            dniInput = document.getElementById('dni-paciente');
            btnBuscarPaciente = document.getElementById('btn-buscar-paciente');
            pacienteInfo = document.getElementById('paciente-info');

            tipoServicioSelect = document.getElementById('select-tipo-servicio');
            servicioSelect = document.getElementById('select-service');
            medicoInput = document.getElementById('input-medic');
            medicoSelect = document.getElementById('select-medic');
            medicoDropdown = document.getElementById('medicos-dropdown');
            btnBuscarHorarios = document.getElementById('btn-buscar-horarios');

            horariosPlaceholder = document.getElementById('horarios-placeholder');
            horariosLoading = document.getElementById('horarios-loading');
            horariosVacio = document.getElementById('horarios-vacio');
            horariosContainer = document.getElementById('horarios-container');

            btnCrearReserva = document.getElementById('btn-crear-reserva');
            btnLimpiarTodo = document.getElementById('btn-limpiar-todo');

            serviciosCount = document.getElementById('servicios-count');
            medicosCount = document.getElementById('medicos-count');
            resumenReserva = document.getElementById('resumen-reserva');

            // Guardar todos los servicios y médicos originales
            todosLosServicios = Array.from(servicioSelect.options).slice(1); // Excluir la primera opción
            
            // Cargar médicos desde el backend
            todosMedicos = [
                {% for m in medicos %}
                {
                    id: "{{ m.id_empleado }}",
                    nombre: "{{ m.nombres }} {{ m.apellidos }}",
                    especialidad: "{{ m.especialidad if m.especialidad else '' }}",
                    id_especialidad: "{{ m.id_especialidad if m.id_especialidad else '' }}"
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ];

            // Verificar que todos los elementos existan
            if (!dniInput || !btnBuscarPaciente || !servicioSelect || !medicoInput) {
                console.error('[GenerarReserva] ERROR: Algunos elementos del DOM no se encontraron');
                return;
            }

            // Event listeners
            btnBuscarPaciente.addEventListener('click', buscarPaciente);
            btnBuscarHorarios.addEventListener('click', buscarHorarios);
            btnCrearReserva.addEventListener('click', crearReserva);
            btnLimpiarTodo.addEventListener('click', limpiarTodo);

            // Filtrar servicios cuando cambia el tipo de servicio
            tipoServicioSelect.addEventListener('change', filtrarServicios);

            // Filtrar médicos cuando cambia el servicio
            servicioSelect.addEventListener('change', filtrarMedicos);

            // Enter en DNI
            dniInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') buscarPaciente();
            });

            // Solo permitir números en DNI
            dniInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });

            // Buscador dinámico de médicos
            medicoInput.addEventListener('input', (e) => {
                const termino = e.target.value.toLowerCase().trim();
                filtrarYMostrarMedicos(termino);
            });

            medicoInput.addEventListener('focus', () => {
                const termino = medicoInput.value.toLowerCase().trim();
                filtrarYMostrarMedicos(termino);
            });

            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!medicoInput.contains(e.target) && !medicoDropdown.contains(e.target)) {
                    medicoDropdown.classList.add('hidden');
                }
            });
        }); // Fin de DOMContentLoaded

        // Función para filtrar y mostrar médicos en el dropdown
        function filtrarYMostrarMedicos(termino) {
            // Obtener especialidad del servicio seleccionado si existe
            let especialidadServicio = null;
            if (servicioSelect.value) {
                const opcionServicio = servicioSelect.options[servicioSelect.selectedIndex];
                especialidadServicio = opcionServicio.dataset.especialidad;
            }

            // Filtrar médicos
            let medicosFiltrados = todosMedicos;

            // Filtrar por especialidad si el servicio la tiene
            if (especialidadServicio) {
                medicosFiltrados = medicosFiltrados.filter(m => m.id_especialidad === especialidadServicio);
            }

            // Filtrar por término de búsqueda
            if (termino) {
                medicosFiltrados = medicosFiltrados.filter(m => 
                    m.nombre.toLowerCase().includes(termino) || 
                    (m.especialidad && m.especialidad.toLowerCase().includes(termino))
                );
            }

            // Actualizar contador
            medicosCount.textContent = medicosFiltrados.length;

            // Mostrar dropdown si hay resultados o término de búsqueda
            if (medicosFiltrados.length === 0 && termino) {
                medicoDropdown.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 text-center">No se encontraron médicos</div>';
                medicoDropdown.classList.remove('hidden');
            } else if (medicosFiltrados.length > 0) {
                medicoDropdown.innerHTML = '';
                
                // Opción "Cualquier médico"
                const opcionTodos = document.createElement('div');
                opcionTodos.className = 'px-4 py-3 hover:bg-cyan-50 cursor-pointer border-b border-gray-200 text-sm text-gray-700';
                opcionTodos.innerHTML = '<i class="fas fa-users mr-2 text-gray-400"></i>Cualquier médico disponible';
                opcionTodos.onclick = () => seleccionarMedico(null, 'Cualquier médico disponible');
                medicoDropdown.appendChild(opcionTodos);

                // Opciones de médicos
                medicosFiltrados.forEach(medico => {
                    const opcion = document.createElement('div');
                    opcion.className = 'px-4 py-3 hover:bg-cyan-50 cursor-pointer text-sm';
                    opcion.innerHTML = `
                        <div class="font-medium text-gray-800">${medico.nombre}</div>
                        ${medico.especialidad ? `<div class="text-xs text-gray-500">${medico.especialidad}</div>` : ''}
                    `;
                    opcion.onclick = () => seleccionarMedico(medico.id, medico.nombre);
                    medicoDropdown.appendChild(opcion);
                });

                medicoDropdown.classList.remove('hidden');
            } else if (!termino) {
                // Mostrar todos al hacer focus sin búsqueda
                medicoDropdown.innerHTML = '';
                
                const opcionTodos = document.createElement('div');
                opcionTodos.className = 'px-4 py-3 hover:bg-cyan-50 cursor-pointer border-b border-gray-200 text-sm text-gray-700';
                opcionTodos.innerHTML = '<i class="fas fa-users mr-2 text-gray-400"></i>Cualquier médico disponible';
                opcionTodos.onclick = () => seleccionarMedico(null, 'Cualquier médico disponible');
                medicoDropdown.appendChild(opcionTodos);

                medicosFiltrados.forEach(medico => {
                    const opcion = document.createElement('div');
                    opcion.className = 'px-4 py-3 hover:bg-cyan-50 cursor-pointer text-sm';
                    opcion.innerHTML = `
                        <div class="font-medium text-gray-800">${medico.nombre}</div>
                        ${medico.especialidad ? `<div class="text-xs text-gray-500">${medico.especialidad}</div>` : ''}
                    `;
                    opcion.onclick = () => seleccionarMedico(medico.id, medico.nombre);
                    medicoDropdown.appendChild(opcion);
                });

                medicoDropdown.classList.remove('hidden');
            } else {
                medicoDropdown.classList.add('hidden');
            }
        }

        // Función para seleccionar médico
        function seleccionarMedico(id, nombre) {
            medicoSeleccionadoId = id;
            medicoInput.value = nombre;
            medicoSelect.value = id || '';
            medicoDropdown.classList.add('hidden');
            console.log('[GenerarReserva] Médico seleccionado:', id, nombre);
        }

        // Función para filtrar servicios según el tipo seleccionado
        function filtrarServicios() {
            const tipoSeleccionado = tipoServicioSelect.value;
            
            // Limpiar el select de servicios
            servicioSelect.innerHTML = '<option value="">Seleccione un servicio</option>';
            
            // Si no hay tipo seleccionado, mostrar todos los servicios
            if (!tipoSeleccionado) {
                todosLosServicios.forEach(option => {
                    servicioSelect.appendChild(option.cloneNode(true));
                });
                serviciosCount.textContent = todosLosServicios.length;
            } else {
                // Filtrar servicios por tipo
                const serviciosFiltrados = todosLosServicios.filter(option => {
                    return option.dataset.tipo === tipoSeleccionado;
                });
                
                serviciosFiltrados.forEach(option => {
                    servicioSelect.appendChild(option.cloneNode(true));
                });
                
                serviciosCount.textContent = serviciosFiltrados.length;
            }
            
            // Resetear médicos cuando cambian los servicios
            medicoSelect.value = '';
            resetearMedicos();
        }

        // Función para filtrar médicos según el servicio seleccionado
        function filtrarMedicos() {
            const servicioSeleccionado = servicioSelect.value;
            
            if (!servicioSeleccionado) {
                medicoInput.value = '';
                medicoSelect.value = '';
                medicoSeleccionadoId = null;
                medicosCount.textContent = todosMedicos.length;
                return;
            }
            
            // Obtener la especialidad del servicio seleccionado
            const opcionServicio = servicioSelect.options[servicioSelect.selectedIndex];
            const especialidadServicio = opcionServicio.dataset.especialidad;
            
            // Limpiar selección de médico
            medicoInput.value = '';
            medicoSelect.value = '';
            medicoSeleccionadoId = null;
            
            // Si el servicio no tiene especialidad, mostrar todos los médicos
            if (!especialidadServicio) {
                medicosCount.textContent = todosMedicos.length;
            } else {
                // Contar médicos por especialidad
                const medicosFiltrados = todosMedicos.filter(m => m.id_especialidad === especialidadServicio);
                medicosCount.textContent = medicosFiltrados.length;
            }
        }

        // Función para buscar paciente
        async function buscarPaciente() {
            const dni = dniInput.value.trim();

            if (!dni) {
                mostrarNotificacion('Ingrese un DNI', 'error');
                return;
            }

            if (dni.length !== 8 || !/^\d+$/.test(dni)) {
                mostrarNotificacion('El DNI debe tener 8 dígitos numéricos', 'error');
                return;
            }

            pacienteInfo.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin text-2xl text-cyan-500"></i><p class="text-sm text-gray-600 mt-2">Buscando...</p></div>';

            try {
                const resp = await fetch(`/reservas/api/paciente-por-dni?dni=${encodeURIComponent(dni)}`);
                const data = await resp.json();

                if (!data.paciente) {
                    pacienteInfo.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-user-slash text-3xl text-red-400 mb-2 block"></i>
                            <p class="text-sm text-red-600 font-semibold">Paciente no encontrado</p>
                            <a href="/cuentas/registrar-cuenta-paciente" class="text-xs text-blue-600 hover:underline">Registrar nuevo paciente</a>
                        </div>
                    `;
                    pacienteSeleccionado = null;
                    actualizarBotonCrear();
                } else {
                    pacienteSeleccionado = data.paciente;
                    pacienteInfo.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-user-check text-3xl text-green-500 mb-2 block"></i>
                            <p class="text-sm font-semibold text-gray-800">${data.paciente.nombres} ${data.paciente.apellidos}</p>
                            <p class="text-xs text-gray-500">DNI: ${data.paciente.documento_identidad} | ID: ${data.paciente.id_paciente}</p>
                        </div>
                    `;
                    mostrarNotificacion('Paciente encontrado correctamente', 'success');
                    actualizarResumen();
                    actualizarBotonCrear();
                }
            } catch (err) {
                pacienteInfo.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-3xl text-red-400 mb-2 block"></i>
                        <p class="text-sm text-red-600">Error al buscar paciente</p>
                    </div>
                `;
                pacienteSeleccionado = null;
                mostrarNotificacion('Error al buscar paciente', 'error');
            }
        }

        // Función para buscar horarios
        async function buscarHorarios() {
            const id_servicio = servicioSelect.value;

            if (!id_servicio) {
                mostrarNotificacion('Seleccione un servicio', 'error');
                return;
            }

            const id_empleado = medicoSelect.value;

            console.log('[GenerarReserva] Buscando horarios para servicio:', id_servicio, 'médico:', id_empleado || 'todos');

            // Resetear selección de horario
            horarioSeleccionado = null;
            horarioData = null;
            resumenReserva.classList.add('hidden');
            actualizarBotonCrear();

            // Mostrar loading
            horariosPlaceholder.classList.add('hidden');
            horariosVacio.classList.add('hidden');
            horariosContainer.classList.add('hidden');
            horariosLoading.classList.remove('hidden');

            try {
                // SIEMPRE usar el endpoint que devuelve PROGRAMACION correctamente
                let url = `/reservas/api/buscar-horarios-disponibles?id_servicio=${id_servicio}`;
                
                // Si hay médico seleccionado, agregar filtro
                if (id_empleado) {
                    url += `&id_empleado=${id_empleado}`;
                }

                console.log('[GenerarReserva] Consultando:', url);
                const resp = await fetch(url);
                
                if (!resp.ok) {
                    throw new Error('Error al cargar horarios');
                }

                const data = await resp.json();
                const horarios = data.horarios || [];

                console.log('[GenerarReserva] Horarios recibidos:', horarios.length);

                horariosLoading.classList.add('hidden');

                if (horarios.length === 0) {
                    horariosVacio.classList.remove('hidden');
                    return;
                }

                // Agrupar horarios por fecha
                const horariosPorFecha = {};
                horarios.forEach(h => {
                    const fecha = h.fecha;
                    if (!horariosPorFecha[fecha]) {
                        horariosPorFecha[fecha] = [];
                    }
                    horariosPorFecha[fecha].push(h);
                });

                horariosContainer.innerHTML = '';
                horariosContainer.classList.remove('hidden');

                // Crear cards por día
                Object.keys(horariosPorFecha).sort().forEach(fecha => {
                    const horariosDelDia = horariosPorFecha[fecha];
                    const fechaObj = new Date(fecha + 'T00:00:00');
                    
                    const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                    const diaSemana = diasSemana[fechaObj.getDay()];
                    
                    const fechaFormateada = fechaObj.toLocaleDateString('es-ES', { 
                        day: '2-digit', 
                        month: 'long', 
                        year: 'numeric' 
                    });

                    const diaCard = document.createElement('div');
                    diaCard.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50';
                    diaCard.innerHTML = `
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-calendar-day text-cyan-600 mr-2"></i>
                            ${diaSemana}, ${fechaFormateada}
                        </h4>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3" data-fecha="${fecha}">
                        </div>
                    `;

                    const horariosGrid = diaCard.querySelector('[data-fecha]');

                    horariosDelDia.forEach(h => {
                        const esDisponible = h.estado_programacion === 'Disponible';
                        
                        console.log('>>> Horario:', h.hora_inicio, 'Estado:', h.estado_programacion, 'Disponible:', esDisponible);
                        
                        const horarioBtn = document.createElement('button');
                        horarioBtn.type = 'button';
                        
                        // Estilos según disponibilidad
                        if (esDisponible) {
                            horarioBtn.className = 'border-2 border-gray-300 bg-white rounded-lg p-3 text-sm hover:border-cyan-500 hover:bg-cyan-50 transition-all horario-card cursor-pointer';
                        } else {
                            horarioBtn.className = 'border-2 border-gray-300 bg-gray-100 rounded-lg p-3 text-sm cursor-not-allowed opacity-60';
                            horarioBtn.disabled = true;
                        }
                        
                        const profesional = h.profesional || h.medico_nombre || 'Profesional disponible';

                        horarioBtn.innerHTML = `
                            <div class="font-semibold ${esDisponible ? 'text-gray-800' : 'text-gray-500'}">${h.hora_inicio} - ${h.hora_fin}</div>
                            ${profesional !== 'Profesional disponible' ? `<div class="text-xs ${esDisponible ? 'text-gray-600' : 'text-gray-400'} mt-1">${profesional}</div>` : ''}
                            <div class="text-xs mt-1 ${esDisponible ? 'text-green-600' : 'text-red-500'}">
                                <i class="fas ${esDisponible ? 'fa-check-circle' : 'fa-times-circle'} mr-1"></i>${esDisponible ? 'Disponible' : 'Ocupado'}
                            </div>
                        `;
                        
                        // Solo asignar click si está disponible
                        if (esDisponible) {
                            horarioBtn.addEventListener('click', function() {
                                console.log('>>> CLICK en horario disponible');
                                seleccionarHorario(horarioBtn, h);
                            });
                        }

                        horariosGrid.appendChild(horarioBtn);
                    });

                    horariosContainer.appendChild(diaCard);
                });

                // Contar disponibles vs ocupados
                const disponibles = horarios.filter(h => h.estado_programacion === 'Disponible').length;
                const ocupados = horarios.length - disponibles;
                const mensajeSemana = data.inicio_semana && data.fin_semana 
                    ? ` (Semana: ${data.inicio_semana} al ${data.fin_semana})` 
                    : '';

                console.log('[GenerarReserva] ✓ Horarios renderizados:', disponibles, 'disponibles,', ocupados, 'ocupados');
                mostrarNotificacion(`${disponibles} disponibles, ${ocupados} ocupados${mensajeSemana}`, 'success');

            } catch (err) {
                console.error('[GenerarReserva] Error:', err);
                horariosLoading.classList.add('hidden');
                horariosVacio.classList.remove('hidden');
                mostrarNotificacion('Error al cargar horarios', 'error');
            }
        }

        // Función ULTRA SIMPLE para seleccionar horario
        function seleccionarHorario(elemento, data) {
            console.log('CLICK - Data recibida:', data);
            
            // Validación simple
            if (!data.id_programacion) {
                console.error('FALTA id_programacion en:', data);
                alert('Error: No se puede seleccionar este horario (falta id_programacion)');
                return;
            }
            
            // Limpiar selección anterior
            document.querySelectorAll('.horario-card').forEach(card => {
                card.style.border = '2px solid #D1D5DB';
                card.style.backgroundColor = 'white';
            });

            // Marcar este
            elemento.style.border = '4px solid #10B981';
            elemento.style.backgroundColor = '#D1FAE5';

            // Guardar
            horarioSeleccionado = data.id_programacion;
            horarioData = data;
            
            console.log('✓ Seleccionado id_programacion:', horarioSeleccionado);

            // Actualizar UI
            actualizarResumen();
            actualizarBotonCrear();
        }

        // Actualizar resumen
        function actualizarResumen() {
            if (pacienteSeleccionado && horarioSeleccionado) {
                document.getElementById('resumen-paciente').textContent =
                    `${pacienteSeleccionado.nombres} ${pacienteSeleccionado.apellidos}`;
                document.getElementById('resumen-dni').textContent = pacienteSeleccionado.documento_identidad;

                const servicioText = servicioSelect.options[servicioSelect.selectedIndex]?.text || '-';
                document.getElementById('resumen-servicio').textContent = servicioText;

                const fecha = horarioData?.fecha || '';
                const horaInicio = horarioData?.hora_inicio?.substring(0, 5) || '';
                const horaFin = horarioData?.hora_fin?.substring(0, 5) || '';
                document.getElementById('resumen-horario').textContent =
                    fecha ? `${fecha} de ${horaInicio} a ${horaFin}` : `${horaInicio} a ${horaFin}`;

                resumenReserva.classList.remove('hidden');
            } else {
                resumenReserva.classList.add('hidden');
            }
        }

        // Actualizar botón crear
        function actualizarBotonCrear() {
            const tieneServicio = servicioSelect.value;
            const tienePaciente = pacienteSeleccionado !== null;
            const tieneHorario = horarioSeleccionado !== null;
            
            console.log('Actualizar botón:', {
                tieneServicio,
                tienePaciente, 
                tieneHorario,
                servicioValue: servicioSelect.value,
                paciente: pacienteSeleccionado,
                horario: horarioSeleccionado
            });
            
            if (tienePaciente && tieneHorario && tieneServicio) {
                btnCrearReserva.disabled = false;
                btnCrearReserva.classList.remove('opacity-50', 'cursor-not-allowed');
                btnCrearReserva.classList.add('hover:bg-green-700');
                // Asegurar que el HTML esté correcto
                if (btnCrearReserva.innerHTML.includes('Creando')) {
                    btnCrearReserva.innerHTML = '<i class="fas fa-check-circle mr-2 text-xl"></i><span class="text-lg">Crear Reserva</span>';
                }
            } else {
                btnCrearReserva.disabled = true;
                btnCrearReserva.classList.add('opacity-50', 'cursor-not-allowed');
                btnCrearReserva.classList.remove('hover:bg-green-700');
            }
        }

        // Crear reserva
        async function crearReserva() {
            if (!pacienteSeleccionado) {
                mostrarNotificacion('Seleccione un paciente', 'error');
                return;
            }

            if (!horarioSeleccionado) {
                mostrarNotificacion('Seleccione un horario', 'error');
                return;
            }

            const id_servicio = servicioSelect.value;
            if (!id_servicio) {
                mostrarNotificacion('Seleccione un servicio', 'error');
                return;
            }

            btnCrearReserva.disabled = true;
            btnCrearReserva.innerHTML = '<i class="fas fa-spinner fa-spin mr-2 text-xl"></i><span class="text-lg">Creando...</span>';

            const payload = {
                id_paciente: pacienteSeleccionado.id_paciente,
                id_programacion: horarioSeleccionado,
                id_servicio: id_servicio
            };

            try {
                const resp = await fetch('/reservas/api/crear-reserva', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await resp.json();

                if (!resp.ok) {
                    throw new Error(data.error || 'No se pudo crear la reserva');
                }

                // Mostrar modal de confirmación
                mostrarModalConfirmacion(data.id_reserva);

            } catch (err) {
                btnCrearReserva.disabled = false;
                btnCrearReserva.innerHTML = '<i class="fas fa-check-circle mr-2 text-xl"></i><span class="text-lg">Crear Reserva</span>';
                mostrarNotificacion(err.message, 'error');
            }
        }

        // Mostrar modal de confirmación
        function mostrarModalConfirmacion(idReserva) {
            const modal = document.getElementById('modal-confirmacion');
            
            // Obtener datos para el modal
            const servicioText = servicioSelect.options[servicioSelect.selectedIndex]?.text || '-';
            const tipoText = tipoServicioSelect.options[tipoServicioSelect.selectedIndex]?.text || 'Servicio';
            
            // Llenar información del modal
            document.getElementById('modal-id-reserva').textContent = `#${idReserva}`;
            document.getElementById('modal-paciente').textContent = `${pacienteSeleccionado.nombres} ${pacienteSeleccionado.apellidos}`;
            document.getElementById('modal-dni').textContent = pacienteSeleccionado.documento_identidad;
            document.getElementById('modal-tipo-servicio').textContent = tipoText !== 'Todos los tipos' ? tipoText : 'Servicio General';
            document.getElementById('modal-servicio').textContent = servicioText;
            
            const fecha = horarioData?.fecha || '';
            const fechaObj = fecha ? new Date(fecha + 'T00:00:00') : null;
            const fechaFormateada = fechaObj ? fechaObj.toLocaleDateString('es-ES', { 
                weekday: 'long',
                day: '2-digit', 
                month: 'long', 
                year: 'numeric' 
            }) : '-';
            
            const horaInicio = horarioData?.hora_inicio?.substring(0, 5) || '';
            const horaFin = horarioData?.hora_fin?.substring(0, 5) || '';
            
            document.getElementById('modal-fecha').textContent = fechaFormateada;
            document.getElementById('modal-horario').textContent = `${horaInicio} - ${horaFin}`;
            
            // Mostrar modal
            modal.classList.remove('hidden');
            
            // Event listeners para botones del modal
            document.getElementById('btn-ver-reservas').onclick = () => {
                window.location.href = '/reservas/listar-reservas';
            };
            
            document.getElementById('btn-nueva-reserva').onclick = () => {
                modal.classList.add('hidden');
                window.location.reload();
            };
        }

        // Limpiar todo
        function limpiarTodo() {
            dniInput.value = '';
            tipoServicioSelect.value = '';
            servicioSelect.value = '';
            medicoInput.value = '';
            medicoSelect.value = '';
            medicoSeleccionadoId = null;

            pacienteInfo.innerHTML = '<p class="text-sm text-gray-500 text-center"><i class="fas fa-user-circle text-3xl text-gray-400 mb-2 block"></i>Busque un paciente por DNI</p>';

            horariosContainer.innerHTML = '';
            horariosContainer.classList.add('hidden');
            horariosPlaceholder.classList.remove('hidden');
            horariosVacio.classList.add('hidden');
            horariosLoading.classList.add('hidden');
            resumenReserva.classList.add('hidden');
            medicoDropdown.classList.add('hidden');

            pacienteSeleccionado = null;
            horarioSeleccionado = null;
            horarioData = null;

            // Resetear contadores
            medicosCount.textContent = todosMedicos.length;
            filtrarServicios();

            actualizarBotonCrear();
            mostrarNotificacion('Formulario limpiado', 'success');
        }

        // Mostrar notificación
        function mostrarNotificacion(mensaje, tipo) {
            const toast = document.createElement('div');
            const bgColor = tipo === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = tipo === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg z-50 flex items-center animate-fade-in`;
            toast.innerHTML = `
                <i class="fas ${icon} mr-3 text-xl"></i>
                <span>${mensaje}</span>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Sesión provista por servidor
        (function(){
            if (window.usuario) {
                const u = window.usuario;
                const nameEl = document.getElementById('admin-username');
                const roleEl = document.getElementById('admin-role');
                if (nameEl && u.nombre) nameEl.textContent = u.nombre;
                if (roleEl && u.rol) roleEl.textContent = u.rol;
            }
        })();
    </script>

    <style>
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }

        /* Transición suave para horario seleccionado */
        .horario-card {
            transition: all 0.3s ease;
            position: relative;
        }

        .horario-card:hover {
            transform: translateY(-2px);
        }

        .scale-105 {
            transform: scale(1.05) !important;
        }

        .selected-check {
            animation: checkBounce 0.3s ease;
        }

        @keyframes checkBounce {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }
    </style>

</body>
</html>
