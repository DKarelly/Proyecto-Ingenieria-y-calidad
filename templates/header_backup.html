<link rel="stylesheet" href="{{ url_for('static', filename='css/forms.css') }}">
<!-- Exponer usuario en JSON seguro: ponemos el objeto en un <script type="application/json"> y lo parseamos desde JS.
     Esto evita que el linter de JS intente parsear las expresiones Jinja dentro de un bloque <script> normal. -->
<script id="initial-usuario" type="application/json">{% if usuario %}{{ usuario|tojson }}{% else %}null{% endif %}</script>
<script>
    (function(){
        try {
            const el = document.getElementById('initial-usuario');
            if (el && el.textContent && el.textContent.trim() !== 'null') {
                window.usuario = JSON.parse(el.textContent);
            } else {
                window.usuario = null;
            }
        } catch (e) {
            // Fallback en caso de error de parsing
            window.usuario = null;
            console.error('Error parsing initial usuario JSON', e);
        }
    })();
</script>
<!-- Header Fijo -->
<header id="main-header" class="sticky top-0 z-40 bg-white border-b border-gray-200 shadow-sm transition-shadow duration-300">
    <!-- L√≠nea de acento superior -->
    <div class="h-1 bg-gradient-to-r from-cyan-500 via-blue-500 to-indigo-500"></div>
    
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <!-- Logo y T√≠tulo -->
            <div class="flex items-center gap-4">
                <a href="/" class="inline-flex items-center justify-center p-2 bg-gray-50 hover:bg-cyan-50 border border-gray-200 rounded-xl transition-all duration-200 hover:shadow-sm">
                    <img src="{{ url_for('static', filename='images/logo1.png') }}" alt="Cl√≠nica Uni√≥n" class="h-10 w-auto">
                </a>
                <div class="hidden sm:block">
                    <h1 class="text-lg font-bold text-gray-800 leading-tight">Cl√≠nica Uni√≥n</h1>
                    <p class="text-xs text-gray-500">Sistema de Atenci√≥n M√©dica</p>
                </div>
            </div>

            <!-- Navegaci√≥n Desktop -->
            <nav class="hidden md:flex items-center gap-2">
                <a href="/#nosotros" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-cyan-600 hover:bg-gray-50 rounded-lg transition-all duration-200">
                    Nosotros
                </a>
                <a href="/#servicios" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-cyan-600 hover:bg-gray-50 rounded-lg transition-all duration-200">
                    Servicios
                </a>
                <a href="/#especialidades" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-cyan-600 hover:bg-gray-50 rounded-lg transition-all duration-200">
                    Especialidades
                </a>
                <a href="/#contacto" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-cyan-600 hover:bg-gray-50 rounded-lg transition-all duration-200">
                    Cont√°ctanos
                </a>
            </nav>

            <!-- Controles de Usuario -->
            <!-- Controles de Usuario -->
            <div class="flex items-center gap-3">
                {% if session.get('usuario_id') %}
                
                <!-- Men√∫ de Usuario -->
                <div class="relative">
                    <button id="userMenuBtn" aria-haspopup="true" aria-expanded="false" 
                            class="flex items-center gap-3 px-3 py-2 bg-gray-50 hover:bg-cyan-50 border border-gray-200 rounded-lg transition-all duration-200 hover:shadow-sm group">
                        <div class="w-8 h-8 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold shadow-sm">
                            {{ (session.get('nombre_usuario', 'U') or 'U')[0].upper() }}
                        </div>
                        <span class="hidden lg:block text-sm font-medium text-gray-700 group-hover:text-cyan-600">
                            {{ session.get('nombre_usuario', 'Usuario') }}
                        </span>
                        <svg class="hidden lg:block w-4 h-4 text-gray-400 group-hover:text-cyan-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>

                    <!-- Dropdown del Men√∫ de Usuario -->
                    <div id="userMenuDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-100 py-2 z-50 animate-fade-in">
                        <a href="/usuarios/perfil" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-cyan-50 transition-colors duration-200">
                            <div class="w-8 h-8 bg-cyan-50 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                            </div>
                            <div>
                                <div class="font-medium">Mi Perfil</div>
                                <div class="text-xs text-gray-500">Ver informaci√≥n personal</div>
                            </div>
                        </a>

                        {% if session.get('tipo_usuario') == 'paciente' %}
                        <!-- Opciones espec√≠ficas para Pacientes -->
                        <div class="border-t border-gray-100 my-2"></div>

                        <a href="/reservas/paciente/historial" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-cyan-50 transition-colors duration-200">
                            <div class="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <div>
                                <div class="font-medium">Mis Reservas</div>
                                <div class="text-xs text-gray-500">Historial de citas</div>
                            </div>
                        </a>

                        <a href="/paciente/historial-clinico" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-cyan-50 transition-colors duration-200">
                            <div class="w-8 h-8 bg-green-50 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <div>
                                <div class="font-medium">Historial Cl√≠nico</div>
                                <div class="text-xs text-gray-500">Consultas y ex√°menes</div>
                            </div>
                        </a>

                        <!-- Submen√∫ de Incidencias -->
                        <div class="relative">
                            <button id="incidenciasMenuBtn" class="w-full flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-cyan-50 transition-colors duration-200">
                                <div class="w-8 h-8 bg-amber-50 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                    </svg>
                                </div>
                                <div class="flex-1 text-left">
                                    <div class="font-medium">Incidencias</div>
                                    <div class="text-xs text-gray-500">Reportes y seguimiento</div>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 transform transition-transform duration-200" id="incidenciasChevron" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>
                            <div id="incidenciasSubmenu" class="hidden bg-gray-50 border-l-2 border-cyan-500 ml-4">
                            <div id="incidenciasSubmenu" class="hidden bg-gray-50 border-l-2 border-cyan-500 ml-4">
                                <a href="/paciente/incidencias/generar" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-600 hover:bg-cyan-50 hover:text-cyan-700 transition-colors duration-200">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                    </svg>
                                    <span>Generar Incidencia</span>
                                </a>
                                <a href="/paciente/incidencias/historial" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-600 hover:bg-cyan-50 hover:text-cyan-700 transition-colors duration-200">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                    </svg>
                                    <span>Historial</span>
                                </a>
                            </div>
                        </div>
                        {% endif %}

                        {% if session.get('tipo_usuario') == 'empleado' and session.get('id_rol') in [1, 2, 3, 4, 5] %}
                        <!-- Opciones para Empleados -->
                        <div class="border-t border-gray-100 my-2"></div>
                        <a href="/admin/panel" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-cyan-50 transition-colors duration-200">
                            <div class="w-8 h-8 bg-indigo-50 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2 2z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"/>
                                </svg>
                            </div>
                            <div>
                                <div class="font-medium">Panel Admin</div>
                                <div class="text-xs text-gray-500">Acceso al dashboard</div>
                            </div>
                        </a>
                        {% endif %}

                        <div class="border-t border-gray-100 my-2"></div>
                        <a href="/logout" class="flex items-center gap-3 px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition-colors duration-200">
                            <div class="w-8 h-8 bg-red-50 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                </svg>
                            </div>
                            <div>
                                <div class="font-medium">Cerrar Sesi√≥n</div>
                                <div class="text-xs text-gray-500">Salir del sistema</div>
                            </div>
                        </a>
                    </div>
                </div>
                {% else %}
                <!-- Usuario No Autenticado -->
                <div id="user-auth-button" class="relative cursor-pointer">
                    <button class="flex items-center gap-2 px-4 py-2 bg-gray-50 hover:bg-cyan-50 border border-gray-200 rounded-lg transition-all duration-200 hover:shadow-sm">
                        <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                        </div>
                        <span class="hidden lg:block text-sm font-medium text-gray-700">Ingresar</span>
                    </button>
                </div>
                {% endif %}
                
                <!-- Bot√≥n Men√∫ M√≥vil -->
                <button id="mobile-menu-button" class="md:hidden p-2 bg-gray-50 hover:bg-cyan-50 border border-gray-200 rounded-lg transition-all duration-200" aria-controls="mobile-menu" aria-expanded="false">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</header>

<!-- Men√∫ M√≥vil (se muestra/oculta con JavaScript) -->
<div id="mobile-menu" class="hidden md:hidden bg-white border-b border-gray-200 shadow-sm">
    <nav class="container mx-auto px-4 py-4 space-y-2">
        <a href="/#nosotros" class="block px-4 py-2 text-sm font-medium text-gray-700 hover:text-cyan-600 hover:bg-gray-50 rounded-lg transition-all duration-200">Nosotros</a>
        <a href="/#servicios" class="block px-4 py-2 text-sm font-medium text-gray-700 hover:text-cyan-600 hover:bg-gray-50 rounded-lg transition-all duration-200">Servicios</a>
        <a href="/#especialidades" class="block px-4 py-2 text-sm font-medium text-gray-700 hover:text-cyan-600 hover:bg-gray-50 rounded-lg transition-all duration-200">Especialidades</a>
        <a href="/#contacto" class="block px-4 py-2 text-sm font-medium text-gray-700 hover:text-cyan-600 hover:bg-gray-50 rounded-lg transition-all duration-200">Cont√°ctanos</a>
    </nav>
</div>

<style>
@keyframes fade-in {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-fade-in {
    animation: fade-in 0.2s ease-out;
}

/* Efecto de sombra al hacer scroll */
#main-header.scrolled {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}
</style>

<script>
    // Men√∫s desplegables en header
    document.addEventListener('DOMContentLoaded', function() {
        // Men√∫ de usuario
        const userMenuBtn = document.getElementById('userMenuBtn');
        const userMenuDropdown = document.getElementById('userMenuDropdown');

        if (userMenuBtn && userMenuDropdown) {
            userMenuBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                userMenuDropdown.classList.toggle('hidden');
                const expanded = userMenuBtn.getAttribute('aria-expanded') === 'true';
                userMenuBtn.setAttribute('aria-expanded', String(!expanded));
            });

            // Cerrar el men√∫ al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!userMenuBtn.contains(e.target) && !userMenuDropdown.contains(e.target)) {
                    userMenuDropdown.classList.add('hidden');
                    userMenuBtn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        // Men√∫ m√≥vil
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');

        if (mobileMenuButton && mobileMenu) {
            mobileMenuButton.addEventListener('click', function(e) {
                e.stopPropagation();
                mobileMenu.classList.toggle('hidden');
                const expanded = mobileMenuButton.getAttribute('aria-expanded') === 'true';
                mobileMenuButton.setAttribute('aria-expanded', String(!expanded));
            });
        }

        // Submen√∫ de incidencias
        const incidenciasMenuBtn = document.getElementById('incidenciasMenuBtn');
        const incidenciasSubmenu = document.getElementById('incidenciasSubmenu');
        const incidenciasChevron = document.getElementById('incidenciasChevron');

        if (incidenciasMenuBtn && incidenciasSubmenu) {
            incidenciasMenuBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                incidenciasSubmenu.classList.toggle('hidden');
                if (incidenciasChevron) {
                    incidenciasChevron.classList.toggle('rotate-90');
                }
            });
        }

        // Efecto scroll en header
        const header = document.getElementById('main-header');
        if (header) {
            let lastScroll = 0;
            window.addEventListener('scroll', function() {
                const currentScroll = window.pageYOffset;
                if (currentScroll > 20) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
                lastScroll = currentScroll;
            });
        }
    });

    // Funci√≥n unificada: obtiene la "B√≥vedaDeNotificaciones" y sincroniza Sello y Pergamino
    async function cargarBovedaNotificaciones() {
        try {
            const response = await fetch('/notificaciones/api/recientes');
            const data = await response.json();

            const lista = document.getElementById('notificacionesLista');
            const badge = document.getElementById('notificacionesBadge');

            if (!badge) return;

            const boveda = Array.isArray(data.notificaciones) ? data.notificaciones : [];

            // Modo demo opcional: agrega una notificaci√≥n "Completada" solo para visualizaci√≥n
            // Activar con ?demo_notif=completada en la URL. No persiste en BD ni intenta marcar como le√≠da.
            try {
                const params = new URLSearchParams(window.location.search);
                if ((params.get('demo_notif') || '').toLowerCase() === 'completada') {
                    const ahora = new Date();
                    const fechaISO = ahora.toISOString().slice(0,10);
                    const timeStr = ahora.toTimeString().slice(0,8);
                    boveda.unshift({
                        id_notificacion: 'demo-completada',
                        titulo: 'Estado de Reserva',
                        mensaje: 'Tu reserva ha sido completada. ¬°Gracias por elegirnos!',
                        tipo: 'estado',
                        fecha_envio: fechaISO,
                        hora_envio: timeStr,
                        fecha_creacion: ahora.toISOString(),
                        leida: false,
                        estado_reserva: 'Completada'
                    });
                }
            } catch(_) { /* no-op */ }
            
            // Contar SOLO las notificaciones NO LE√çDAS para el badge
            const noLeidas = boveda.filter(n => !n.leida);
            const count = noLeidas.length;

            // Regla del Sello: mostrar u ocultar el badge seg√∫n notificaciones NO LE√çDAS
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            // Si no existe la lista (dropdown), solo actualizamos el badge
            if (!lista) return;

            // Regla del Pergamino: mostrar TODAS las notificaciones con estilos por tipo
            if (boveda.length > 0) {
                lista.innerHTML = boveda.map(notif => {
                    // Configuraci√≥n de colores por tipo de notificaci√≥n
                    const estilos = obtenerEstilosNotificacion(notif);
                    
                    return `
                        <div class="notif-item ${notif.leida ? 'opacity-70' : ''} cursor-pointer transition-all duration-200 hover:scale-[1.01]" 
                             data-id="${notif.id_notificacion}" 
                             data-leida="${notif.leida}"
                             style="border-left: 4px solid ${estilos.borderColor};">
                            <div class="px-4 py-3 hover:bg-gray-50">
                                <div class="flex items-start gap-3">
                                    <!-- Icono seg√∫n tipo -->
                                    <div class="flex-shrink-0 mt-0.5">
                                        ${estilos.icono}
                                    </div>
                                    
                                    <div class="flex-1 min-w-0">
                                        <!-- T√≠tulo con badge de tipo -->
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${estilos.badgeClass}">
                                                ${estilos.tipoBadge}
                                            </span>
                                            ${!notif.leida ? '<span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>' : ''}
                                        </div>
                                        
                                        <p class="text-sm font-semibold text-gray-900 mb-1">${notif.titulo}</p>
                                        <p class="text-xs text-gray-600 leading-relaxed">${notif.mensaje}</p>
                                        
                                        <!-- Fecha y hora -->
                                        <div class="flex items-center gap-2 mt-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <p class="text-xs text-gray-400">${formatearFecha(notif.fecha_creacion)}</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Bot√≥n marcar como le√≠da -->
                                    ${!notif.leida ? `
                                    <button class="marcar-leida-btn flex-shrink-0 p-1.5 rounded-full hover:bg-cyan-100 transition-colors duration-200 group" 
                                            data-id="${notif.id_notificacion}" 
                                            title="Marcar como le√≠da">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-600 group-hover:text-cyan-700">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </button>
                                    ` : `
                                    <div class="flex-shrink-0 p-1.5">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                    </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Agregar event listeners
                document.querySelectorAll('.notif-item').forEach(item => {
                    const leida = item.dataset.leida === 'true';
                    const id = item.dataset.id;
                    // Evitar acciones para elementos demo o sin id v√°lido
                    const esDemo = !id || id.startsWith('demo');
                    if (!leida && !esDemo) {
                        item.addEventListener('click', async function(e) {
                            if (e.target.closest('.marcar-leida-btn')) return;
                            const id = this.dataset.id;
                            if (!id || id.startsWith('demo')) return;
                            await marcarComoLeida(id);
                        });
                    }
                });

                document.querySelectorAll('.marcar-leida-btn').forEach(btn => {
                    btn.addEventListener('click', async function(e) {
                        e.stopPropagation();
                        const id = this.dataset.id;
                        if (!id || id.startsWith('demo')) return;
                        await marcarComoLeida(id);
                    });
                });
            } else {
                lista.innerHTML = `
                    <div class="px-4 py-12 text-center text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-300 mb-3">
                            <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                            <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
                        </svg>
                        <p class="text-sm font-medium text-gray-600">No tienes notificaciones</p>
                        <p class="text-xs text-gray-400 mt-1">Aqu√≠ aparecer√°n tus notificaciones importantes</p>
                    </div>
                `;
            }

        } catch (error) {
            console.error('Error al cargar la B√≥vedaDeNotificaciones:', error);
        }
    }

    // Funci√≥n para obtener estilos seg√∫n el tipo de notificaci√≥n
    function obtenerEstilosNotificacion(notif) {
        const tipo = (notif.tipo || '').toString();
        const estadoReserva = notif.estado_reserva;
        let estado = (estadoReserva || '').toString().trim().toLowerCase();
        // Heur√≠stica: si no viene estado_reserva, intentar inferirlo del t√≠tulo o mensaje
        if (!estado) {
            const t = (notif.titulo || '').toString().toLowerCase();
            const m = (notif.mensaje || '').toString().toLowerCase();
            if (t.includes('pendiente') || m.includes('pendiente')) estado = 'pendiente';
            else if (t.includes('confirmada') || m.includes('confirmada')) estado = 'confirmada';
            else if (t.includes('cancelada') || m.includes('cancelada')) estado = 'cancelada';
            else if (t.includes('completada') || m.includes('completada')) estado = 'completada';
        }
        
    const configs = {
            'confirmacion': {
                borderColor: '#10b981',
                badgeClass: 'bg-green-100 text-green-800',
                tipoBadge: '‚úì Confirmaci√≥n',
                icono: `<div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>`
            },
            'estado': {
                borderColor: estado === 'completada' ? '#10b981' :
                             estado === 'confirmada' ? '#3b82f6' : 
                             estado === 'pendiente' ? '#f59e0b' : 
                             estado === 'cancelada' ? '#ef4444' : '#6b7280',
                badgeClass: estado === 'completada' ? 'bg-green-100 text-green-800' :
                           estado === 'confirmada' ? 'bg-blue-100 text-blue-800' :
                           estado === 'pendiente' ? 'bg-amber-100 text-amber-800' :
                           estado === 'cancelada' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800',
                tipoBadge: estado === 'completada' ? '‚úì Completada' :
                          estado === 'confirmada' ? '‚óè Confirmada' :
                          estado === 'pendiente' ? '‚óê Pendiente' :
                          estado === 'cancelada' ? '‚úï Cancelada' : '‚óè Estado',
                icono: `<div class="w-8 h-8 rounded-full ${
                    estado === 'completada' ? 'bg-green-100' :
                    estado === 'confirmada' ? 'bg-blue-100' :
                    estado === 'pendiente' ? 'bg-amber-100' :
                    estado === 'cancelada' ? 'bg-red-100' : 'bg-gray-100'
                } flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ${
                        estado === 'completada' ? 'text-green-600' :
                        estado === 'confirmada' ? 'text-blue-600' :
                        estado === 'pendiente' ? 'text-amber-600' :
                        estado === 'cancelada' ? 'text-red-600' : 'text-gray-600'
                    }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>`
            },
            'recordatorio': {
                borderColor: '#8b5cf6',
                badgeClass: 'bg-purple-100 text-purple-800',
                tipoBadge: 'üîî Recordatorio',
                icono: `<div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                </div>`
            },
            'reprogramacion': {
                borderColor: '#06b6d4',
                badgeClass: 'bg-cyan-100 text-cyan-800',
                tipoBadge: '‚Üª Reprogramaci√≥n',
                icono: `<div class="w-8 h-8 rounded-full bg-cyan-100 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </div>`
            },
            'seguridad': {
                borderColor: '#dc2626',
                badgeClass: 'bg-red-100 text-red-800',
                tipoBadge: 'üîí Seguridad',
                icono: `<div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>`
            },
            'cancelacion': {
                borderColor: '#ef4444',
                badgeClass: 'bg-red-100 text-red-800',
                tipoBadge: '‚úï Cancelaci√≥n',
                icono: `<div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>`
            }
        };

        // Selecci√≥n del estilo: s√≥lo las notificaciones de tipo 'estado' usan el mapa por estado.
        // Las de 'confirmacion' SIEMPRE son verdes (como en el dise√±o de referencia).
        let seleccionado = null;
        if (tipo === 'estado') {
            seleccionado = configs['estado'];
        } else if (configs[tipo]) {
            seleccionado = configs[tipo];
        }

        return seleccionado || {
            borderColor: '#6b7280',
            badgeClass: 'bg-gray-100 text-gray-800',
            tipoBadge: '‚óè Notificaci√≥n',
            icono: `<div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>`
        };
    }

    // Funci√≥n para marcar una notificaci√≥n como le√≠da
    async function marcarComoLeida(idNotificacion) {
        try {
            const response = await fetch(`/notificaciones/api/marcar-leida/${idNotificacion}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                // Recargar la b√≥veda para actualizar la UI
                await cargarBovedaNotificaciones();
            } else {
                console.error('Error al marcar notificaci√≥n como le√≠da');
            }
        } catch (error) {
            console.error('Error al marcar notificaci√≥n como le√≠da:', error);
        }
    }

    // Funci√≥n auxiliar para formatear fechas
    function formatearFecha(fechaStr) {
        const fecha = new Date(fechaStr);
        const ahora = new Date();
        const diff = Math.floor((ahora - fecha) / 1000); // diferencia en segundos

        if (diff < 60) return 'Hace un momento';
        if (diff < 3600) return `Hace ${Math.floor(diff / 60)} minutos`;
        if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} horas`;
        if (diff < 604800) return `Hace ${Math.floor(diff / 86400)} d√≠as`;

        return fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
    }
</script>

<!-- Men√∫ M√≥vil -->
<div id="mobile-menu" class="fixed top-0 right-0 h-full w-64 bg-white shadow-lg z-[60] p-6 transform translate-x-full transition-transform duration-300 md:hidden">
    <div class="flex justify-between items-center mb-8">
        <h2 class="text-xl font-bold">Men√∫</h2>
        <button id="mobile-menu-close" aria-label="Cerrar men√∫ m√≥vil" class="focus:outline-none focus-visible:ring-2 focus-visible:ring-cyan-500/40 rounded">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
    </div>
    <nav class="flex flex-col gap-6">
        <a href="/#nosotros" class="text-lg hover:text-cyan-600 transition-colors duration-200 mobile-link">Nosotros</a>
        <a href="/#servicios" class="text-lg hover:text-cyan-600 transition-colors duration-200 mobile-link">Servicios</a>
        <a href="/#especialidades" class="text-lg hover:text-cyan-600 transition-colors duration-200 mobile-link">Especialidades</a>
        <a href="/#contacto" class="text-lg hover:text-cyan-600 transition-colors duration-200 mobile-link">Cont√°ctanos</a>
    </nav>
</div>
