<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autorizaciones Médicas - Clínica Unión</title>

    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 20;
        }
    </style>
</head>
<body class="bg-gray-50">

    {% include 'header.html' %}

    <div class="container mx-auto px-4 pt-24 pb-12">

        <!-- Header Section -->
        <div class="max-w-6xl mx-auto mb-8">
            <a href="/" class="inline-flex items-center text-cyan-600 hover:text-cyan-700 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
                </svg>
                Volver al inicio
            </a>

            <div class="bg-white rounded-2xl shadow-lg p-8">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-2xl flex items-center justify-center">
                        <span class="material-symbols-outlined text-white text-4xl">verified</span>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Autorizaciones Médicas</h1>
                        <p class="text-gray-600">Exámenes y operaciones autorizados por tu médico</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="max-w-6xl mx-auto">
            <!-- Loading State -->
            <div id="loadingState" class="bg-white rounded-2xl shadow-lg p-12 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto mb-4"></div>
                <p class="text-gray-600">Cargando autorizaciones...</p>
            </div>

            <!-- Content Container -->
            <div id="contentContainer" class="hidden space-y-6">
                <!-- Autorizaciones de Exámenes -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="material-symbols-outlined text-blue-600 text-3xl">laboratory</span>
                        <h2 class="text-2xl font-bold text-gray-800">Exámenes Autorizados</h2>
                    </div>
                    <div id="examenesContainer" class="space-y-4">
                        <!-- Se llenarán dinámicamente -->
                    </div>
                </div>

                <!-- Autorizaciones de Operaciones -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="material-symbols-outlined text-purple-600 text-3xl">surgical</span>
                        <h2 class="text-2xl font-bold text-gray-800">Operaciones Autorizadas</h2>
                    </div>
                    <div id="operacionesContainer" class="space-y-4">
                        <!-- Se llenarán dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden bg-white rounded-2xl shadow-lg p-12 text-center">
                <span class="material-symbols-outlined text-gray-300 mx-auto mb-4" style="font-size: 80px;">check_circle</span>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">No tienes autorizaciones pendientes</h3>
                <p class="text-gray-600 mb-6">Tu médico aún no ha autorizado exámenes u operaciones para ti.</p>
                <a href="/paciente/historial-clinico" class="inline-flex items-center gap-2 bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all duration-300">
                    <span class="material-symbols-outlined">history</span>
                    Ver Historial Clínico
                </a>
            </div>
        </div>

    </div>

    <script>
        // Cargar autorizaciones al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            cargarAutorizaciones();
        });

        // Función para cargar las autorizaciones
        async function cargarAutorizaciones() {
            try {
                const response = await fetch('/paciente/api/autorizaciones-pendientes');
                const data = await response.json();

                if (data.error) {
                    mostrarError(data.error);
                    return;
                }

                mostrarAutorizaciones(data.autorizaciones_examenes || [], data.autorizaciones_operaciones || []);

            } catch (error) {
                console.error('Error al cargar autorizaciones:', error);
                mostrarError('Error al cargar las autorizaciones. Por favor, intenta nuevamente.');
            }
        }

        // Función para mostrar las autorizaciones
        function mostrarAutorizaciones(examenes, operaciones) {
            const loadingState = document.getElementById('loadingState');
            const contentContainer = document.getElementById('contentContainer');
            const emptyState = document.getElementById('emptyState');
            const examenesContainer = document.getElementById('examenesContainer');
            const operacionesContainer = document.getElementById('operacionesContainer');

            loadingState.classList.add('hidden');

            if (examenes.length === 0 && operaciones.length === 0) {
                contentContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            contentContainer.classList.remove('hidden');

            // Mostrar exámenes
            if (examenes.length === 0) {
                examenesContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>No tienes exámenes autorizados pendientes</p>
                    </div>
                `;
            } else {
                examenesContainer.innerHTML = examenes.map(examen => {
                    const fechaAutorizacion = new Date(examen.fecha_autorizacion);
                    const fechaFormateada = fechaAutorizacion.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    return `
                        <div class="border border-blue-200 rounded-xl p-6 hover:shadow-lg transition-all duration-300 bg-gradient-to-r from-blue-50 to-white">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="material-symbols-outlined text-blue-600">laboratory</span>
                                        <h3 class="text-lg font-bold text-gray-800">${examen.servicio_nombre}</h3>
                                    </div>
                                    <p class="text-gray-600 mb-3">${examen.servicio_descripcion || ''}</p>
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <p class="text-xs text-gray-500">Autorizado por</p>
                                            <p class="font-semibold text-gray-800">Dr. ${examen.medico_nombres} ${examen.medico_apellidos}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500">Fecha de autorización</p>
                                            <p class="font-semibold text-gray-800">${fechaFormateada}</p>
                                        </div>
                                    </div>
                                    ${examen.observaciones ? `
                                        <div class="bg-blue-100 border-l-4 border-blue-500 p-3 rounded">
                                            <p class="text-sm text-gray-700"><strong>Observaciones:</strong> ${examen.observaciones}</p>
                                        </div>
                                    ` : ''}
                                </div>
                                <div>
                                    <a href="/reservas/paciente/nuevo-examen?autorizacion=${examen.id_autorizacion_examen}" 
                                       class="inline-flex items-center gap-2 bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all duration-300 shadow-md">
                                        <span class="material-symbols-outlined">calendar_add_on</span>
                                        Programar Examen
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Mostrar operaciones
            if (operaciones.length === 0) {
                operacionesContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>No tienes operaciones autorizadas pendientes</p>
                    </div>
                `;
            } else {
                operacionesContainer.innerHTML = operaciones.map(operacion => {
                    const fechaAutorizacion = new Date(operacion.fecha_autorizacion);
                    const fechaFormateada = fechaAutorizacion.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    const medicoAsignado = operacion.es_derivacion 
                        ? `Dr. ${operacion.medico_asignado_nombres} ${operacion.medico_asignado_apellidos}` 
                        : `Dr. ${operacion.medico_autoriza_nombres} ${operacion.medico_autoriza_apellidos}`;

                    return `
                        <div class="border border-purple-200 rounded-xl p-6 hover:shadow-lg transition-all duration-300 bg-gradient-to-r from-purple-50 to-white">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="material-symbols-outlined text-purple-600">surgical</span>
                                        <h3 class="text-lg font-bold text-gray-800">${operacion.servicio_nombre}</h3>
                                        ${operacion.es_derivacion ? '<span class="bg-orange-100 text-orange-700 text-xs font-semibold px-2 py-1 rounded-full">Derivado</span>' : ''}
                                    </div>
                                    <p class="text-gray-600 mb-3">${operacion.servicio_descripcion || ''}</p>
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <p class="text-xs text-gray-500">Autorizado por</p>
                                            <p class="font-semibold text-gray-800">Dr. ${operacion.medico_autoriza_nombres} ${operacion.medico_autoriza_apellidos}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500">Médico asignado</p>
                                            <p class="font-semibold text-gray-800">${medicoAsignado}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500">Fecha de autorización</p>
                                            <p class="font-semibold text-gray-800">${fechaFormateada}</p>
                                        </div>
                                    </div>
                                    ${operacion.observaciones ? `
                                        <div class="bg-purple-100 border-l-4 border-purple-500 p-3 rounded">
                                            <p class="text-sm text-gray-700"><strong>Observaciones:</strong> ${operacion.observaciones}</p>
                                        </div>
                                    ` : ''}
                                </div>
                                <div>
                                    <a href="/reservas/paciente/nueva-operacion?autorizacion=${operacion.id_autorizacion_operacion}" 
                                       class="inline-flex items-center gap-2 bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 transition-all duration-300 shadow-md">
                                        <span class="material-symbols-outlined">calendar_add_on</span>
                                        Programar Operación
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function mostrarError(mensaje) {
            const loadingState = document.getElementById('loadingState');
            const contentContainer = document.getElementById('contentContainer');
            const emptyState = document.getElementById('emptyState');

            loadingState.classList.add('hidden');
            contentContainer.classList.add('hidden');

            emptyState.classList.remove('hidden');
            emptyState.innerHTML = `
                <span class="material-symbols-outlined text-red-300 mx-auto mb-4" style="font-size: 80px;">error</span>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Error</h3>
                <p class="text-gray-600 mb-6">${mensaje}</p>
                <button onclick="location.reload()" class="inline-flex items-center gap-2 bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all duration-300">
                    <span class="material-symbols-outlined">refresh</span>
                    Reintentar
                </button>
            `;
        }
    </script>

</body>
</html>
