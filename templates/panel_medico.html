<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Médico - Clínica Unión</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    
    <!-- Tailwind CSS compilado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    
    <!-- CSS personalizado del panel médico -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/panel_medico.css') }}">
</head>

<body class="font-body bg-background-light dark:bg-background-dark text-text-secondary-light dark:text-text-secondary-dark antialiased">
    {% include 'header_medico.html' %}

    <div class="flex h-[calc(100vh-80px)]">
        <!-- Sidebar Médico -->
        <aside class="w-[280px] flex-shrink-0 bg-surface-light dark:bg-surface-dark border-r border-border-light dark:border-border-dark flex flex-col">
            <nav class="flex-1 px-6 py-6 space-y-2">
                <!-- Dashboard -->
                <a href="/medico/panel" class="flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl {% if not subsistema %}bg-gradient-to-r from-cyan-50 to-teal-50 text-cyan-700 border border-cyan-200 shadow-sm{% else %}text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-zinc-900/50 hover:text-text-primary-light dark:hover:text-text-primary-dark{% endif %} transition-all duration-300">
                    <span class="material-symbols-outlined text-xl {% if not subsistema %}filled{% endif %}">dashboard</span>
                    <span class="font-semibold">Dashboard</span>
                </a>

                <!-- Mi Agenda -->
                <a href="/medico/panel?subsistema=agenda" class="flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl {% if subsistema == 'agenda' %}bg-gradient-to-r from-cyan-50 to-teal-50 text-cyan-700 border border-cyan-200 shadow-sm{% else %}text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-zinc-900/50 hover:text-text-primary-light dark:hover:text-text-primary-dark{% endif %} transition-all duration-300">
                    <span class="material-symbols-outlined text-xl {% if subsistema == 'agenda' %}filled{% endif %}">calendar_month</span>
                    <span class="font-semibold">Mi Agenda</span>
                </a>

                <!-- Mis Pacientes -->
                <a href="/medico/panel?subsistema=pacientes" class="flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl {% if subsistema == 'pacientes' %}bg-gradient-to-r from-cyan-50 to-teal-50 text-cyan-700 border border-cyan-200 shadow-sm{% else %}text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-zinc-900/50 hover:text-text-primary-light dark:hover:text-text-primary-dark{% endif %} transition-all duration-300">
                    <span class="material-symbols-outlined text-xl {% if subsistema == 'pacientes' %}filled{% endif %}">groups</span>
                    <span class="font-semibold">Mis Pacientes</span>
                </a>

                <!-- Diagnósticos -->
                <a href="/medico/panel?subsistema=diagnosticos" class="flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl {% if subsistema == 'diagnosticos' %}bg-gradient-to-r from-cyan-50 to-teal-50 text-cyan-700 border border-cyan-200 shadow-sm{% else %}text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-zinc-900/50 hover:text-text-primary-light dark:hover:text-text-primary-dark{% endif %} transition-all duration-300">
                    <span class="material-symbols-outlined text-xl {% if subsistema == 'diagnosticos' %}filled{% endif %}">clinical_notes</span>
                    <span class="font-semibold">Diagnósticos</span>
                </a>

                <!-- Notificaciones -->
                <a href="/medico/panel?subsistema=notificaciones" class="flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl {% if subsistema == 'notificaciones' %}bg-gradient-to-r from-cyan-50 to-teal-50 text-cyan-700 border border-cyan-200 shadow-sm{% else %}text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-zinc-900/50 hover:text-text-primary-light dark:hover:text-text-primary-dark{% endif %} transition-all duration-300">
                    <span class="material-symbols-outlined text-xl {% if subsistema == 'notificaciones' %}filled{% endif %}">notifications</span>
                    <span class="font-semibold">Notificaciones</span>
                    {% if notificaciones_no_leidas > 0 and subsistema != 'notificaciones' %}
                    <span class="ml-auto w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">{{ notificaciones_no_leidas }}</span>
                    {% endif %}
                </a>
            </nav>
        </aside>

        <!-- Contenido Principal -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <main class="flex-1 overflow-y-auto p-8">
                {% if not subsistema %}
                <!-- Dashboard Principal -->
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Bienvenido, Dr. {{ session.get('nombre_usuario', 'Usuario') }}</h2>
                    <p class="text-gray-600">Aquí está tu resumen del día</p>
                </div>

                <!-- Estadísticas Rápidas -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Citas de Hoy -->
                    <div class="bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-2xl p-6 text-white shadow-medical">
                        <div class="flex items-center justify-between mb-4">
                            <span class="material-symbols-outlined text-4xl opacity-80">event</span>
                            <span class="text-3xl font-bold">{{ stats.citas_hoy }}</span>
                        </div>
                        <h3 class="text-sm font-medium opacity-90 mb-1">Citas de Hoy</h3>
                        <p class="text-xs opacity-75">{{ stats.citas_pendientes }} pendiente(s), {{ stats.citas_completadas }} completada(s)</p>
                    </div>

                    <!-- Pacientes Atendidos -->
                    <div class="bg-gradient-to-br from-teal-500 to-teal-600 rounded-2xl p-6 text-white shadow-medical">
                        <div class="flex items-center justify-between mb-4">
                            <span class="material-symbols-outlined text-4xl opacity-80">groups</span>
                            <span class="text-3xl font-bold">{{ stats.pacientes_semana }}</span>
                        </div>
                        <h3 class="text-sm font-medium opacity-90 mb-1">Pacientes Esta Semana</h3>
                        <p class="text-xs opacity-75">Pacientes únicos atendidos</p>
                    </div>

                    <!-- Diagnósticos Pendientes -->
                    <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-6 text-white shadow-medical">
                        <div class="flex items-center justify-between mb-4">
                            <span class="material-symbols-outlined text-4xl opacity-80">clinical_notes</span>
                            <span class="text-3xl font-bold">{{ stats.diagnosticos_pendientes }}</span>
                        </div>
                        <h3 class="text-sm font-medium opacity-90 mb-1">Diagnósticos Pendientes</h3>
                        <p class="text-xs opacity-75">Requieren atención</p>
                    </div>
                </div>

                <!-- Contenido del Dashboard -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Citas de Hoy -->
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Citas de Hoy</h3>
                            <a href="/medico/panel?subsistema=agenda" class="text-cyan-600 hover:text-cyan-700 text-sm font-semibold flex items-center gap-1">
                                Ver todas
                                <span class="material-symbols-outlined text-sm">arrow_forward</span>
                            </a>
                        </div>

                        <div class="space-y-4">
                            {% if citas_hoy %}
                                {% for cita in citas_hoy %}
                                <div class="flex items-center gap-4 p-4 {% if cita.estado == 'Pendiente' or cita.estado == 'Confirmada' %}bg-gradient-to-r from-cyan-50 to-teal-50 border-cyan-100{% else %}bg-gray-50 border-gray-200{% endif %} rounded-xl border hover:shadow-md transition-shadow">
                                    <div class="flex-shrink-0">
                                        <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-teal-500 rounded-full flex items-center justify-center text-white font-bold">
                                            {{ cita.paciente.split()[0][0] }}{{ cita.paciente.split()[1][0] if cita.paciente.split()|length > 1 else '' }}
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-800">{{ cita.paciente }}</h4>
                                        <p class="text-sm text-gray-600">{{ cita.tipo }}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold {% if cita.estado == 'Pendiente' or cita.estado == 'Confirmada' %}text-cyan-600{% else %}text-gray-600{% endif %}">{{ cita.hora }}</p>
                                        {% if cita.estado == 'Pendiente' %}
                                        <span class="inline-block px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-semibold rounded-full mt-1">Pendiente</span>
                                        {% elif cita.estado == 'Confirmada' %}
                                        <span class="inline-block px-2 py-1 bg-blue-100 text-blue-700 text-xs font-semibold rounded-full mt-1">Confirmada</span>
                                        {% elif cita.estado == 'Completada' %}
                                        <span class="inline-block px-2 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded-full mt-1">Completada</span>
                                        {% elif cita.estado == 'Cancelada' %}
                                        <span class="inline-block px-2 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded-full mt-1">Cancelada</span>
                                        {% else %}
                                        <span class="inline-block px-2 py-1 bg-gray-100 text-gray-700 text-xs font-semibold rounded-full mt-1">{{ cita.estado }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-8 text-gray-500">
                                    <span class="material-symbols-outlined text-5xl mb-2 block text-gray-400">event_busy</span>
                                    <p class="font-medium">No hay citas programadas para hoy</p>
                                    <p class="text-sm mt-1">Revisa tu agenda para ver próximas citas</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Accesos Rápidos -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Accesos Rápidos</h3>

                        <div class="space-y-3">
                            <a href="/medico/panel?subsistema=diagnosticos" class="flex items-center gap-3 p-3 rounded-xl hover:bg-cyan-50 transition-colors group">
                                <div class="w-10 h-10 bg-cyan-100 rounded-lg flex items-center justify-center group-hover:bg-cyan-200 transition-colors">
                                    <span class="material-symbols-outlined text-cyan-600">edit_note</span>
                                </div>
                                <span class="font-semibold text-gray-700 group-hover:text-cyan-700">Registrar Diagnóstico</span>
                            </a>

                            <a href="/medico/panel?subsistema=pacientes" class="flex items-center gap-3 p-3 rounded-xl hover:bg-teal-50 transition-colors group">
                                <div class="w-10 h-10 bg-teal-100 rounded-lg flex items-center justify-center group-hover:bg-teal-200 transition-colors">
                                    <span class="material-symbols-outlined text-teal-600">person_search</span>
                                </div>
                                <span class="font-semibold text-gray-700 group-hover:text-teal-700">Buscar Paciente</span>
                            </a>

                            <a href="/medico/panel?subsistema=agenda" class="flex items-center gap-3 p-3 rounded-xl hover:bg-blue-50 transition-colors group">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center group-hover:bg-blue-200 transition-colors">
                                    <span class="material-symbols-outlined text-blue-600">calendar_month</span>
                                </div>
                                <span class="font-semibold text-gray-700 group-hover:text-blue-700">Ver Agenda</span>
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if subsistema == 'agenda' %}
                <!-- Subsistema: Mi Agenda -->
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Mi Agenda</h2>
                    <p class="text-gray-600">Visualiza tu calendario de citas y eventos de la semana</p>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <!-- Header navegación semana -->
                    <div class="bg-gradient-to-r from-cyan-500 to-teal-500 text-white p-4 md:p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 md:gap-4">
                                <button onclick="cambiarSemana(-1)" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined">chevron_left</span>
                                </button>
                                <h2 class="text-lg md:text-xl font-semibold">
                                    {% if inicio_semana and fin_semana %}
                                    Semana del {{ inicio_semana.strftime('%d') }} al {{ fin_semana.strftime('%d %b %Y') }}
                                    {% else %}
                                    Semana actual
                                    {% endif %}
                                </h2>
                                <button onclick="cambiarSemana(1)" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined">chevron_right</span>
                                </button>
                            </div>
                            <div class="flex gap-2">
                                {% if offset_semana != 0 %}
                                <button onclick="irHoy()" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-md">
                                    <span class="material-symbols-outlined text-lg">today</span>
                                    <span class="hidden md:inline">Hoy</span>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Calendario semanal -->
                    <div class="overflow-x-auto overflow-y-auto max-h-[calc(100vh-280px)]">
                        {% if horarios_medico and horarios_medico.horarios %}
                        {# OPTIMIZACIÓN: Horas pre-calculadas en backend #}
                        {% set hora_min = horarios_medico.hora_min %}
                        {% set hora_max = horarios_medico.hora_max %}
                        {% set horarios = horarios_medico.horarios %}
                        
                        <table class="min-w-full border-collapse">
                            <thead>
                                <tr>
                                    <th class="w-20 p-3 bg-gray-50 border border-gray-200 text-center text-sm font-medium text-gray-600 sticky left-0 z-20">Hora</th>
                                    {% for day in range(7) %}
                                    {% set dia_nombres = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'] %}
                                    <th class="p-3 bg-gray-50 border border-gray-200 text-center text-sm font-medium text-gray-600 min-w-[150px]">
                                        {{ dia_nombres[day] }}
                                        {% if day in horarios %}
                                        <br><span class="text-xs font-normal">{{ horarios[day].fecha.strftime('%d/%m') }}</span>
                                        {% endif %}
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {# OPTIMIZACIÓN: Bucle simplificado sin nested loops #}
                                {% for hour in range(hora_min, hora_max + 1) %}
                                <tr>
                                    <td class="w-20 p-2 bg-gray-50 border border-gray-200 text-sm text-gray-600 font-medium sticky left-0 z-10 text-center">
                                        {{ '%02d:00'|format(hour) }}
                                    </td>
                                    {% for day in range(7) %}
                                    {# OPTIMIZACIÓN: Verificación rápida sin bucles anidados #}
                                    {% set tiene_horario = day in horarios and horarios[day].bloques %}
                                    
                                    {% if tiene_horario %}
                                    <td class="p-0 border border-gray-200 h-20 align-top relative calendar-cell"
                                        data-day="{{ day }}" data-hour="{{ hour }}">
                                        {# OPTIMIZACIÓN: Citas pre-calculadas con estilos en backend #}
                                        {% set clave_cita = day|string + '_' + hour|string %}
                                        {% if citas_semana and clave_cita in citas_semana %}
                                            {% for cita in citas_semana[clave_cita] %}
                                            <div class="cita-event absolute rounded px-2 py-1 text-white overflow-hidden shadow-md z-10 cursor-pointer hover:shadow-lg transition-all"
                                                 style="top: {{ cita.offset }}px; height: {{ cita.altura }}px; background-color: {{ cita.color }}; left: 2px; right: 2px;"
                                                 data-inicio="{{ cita.hora_inicio_str }}" data-fin="{{ cita.hora_fin_str }}" data-dia="{{ day }}" data-hora="{{ hour }}"
                                                 onclick="event.stopPropagation(); verDetalleCita({{ cita.id }})">
                                                <div class="text-xs font-bold line-clamp-1">{{ cita.paciente }}</div>
                                                <div class="text-xs opacity-90 line-clamp-1">{{ cita.tipo }}</div>
                                                <div class="text-xs font-medium mt-1">{{ cita.hora_inicio_str }} - {{ cita.hora_fin_str }}</div>
                                            </div>
                                            {% endfor %}
                                        {% endif %}
                                    </td>
                                    {% else %}
                                    <td class="p-0 border border-gray-200 h-20 bg-gray-100 relative">
                                        <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-xs">
                                            <span class="material-symbols-outlined text-lg opacity-30">block</span>
                                        </div>
                                    </td>
                                    {% endif %}
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <!-- Mensaje cuando no hay horarios -->
                        <div class="text-center py-12">
                            <span class="material-symbols-outlined text-6xl text-gray-300 mb-4 block">schedule</span>
                            <p class="text-gray-500 font-medium">No hay horarios configurados para esta semana</p>
                            <p class="text-gray-400 text-sm mt-2">Contacta con administración para configurar tu agenda</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Lista de citas del día -->
                <div class="mt-6 bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span class="material-symbols-outlined text-cyan-600">event_note</span>
                            Citas de Hoy
                        </h3>
                        <span class="text-sm text-gray-500">{{ citas_hoy|length if citas_hoy else 0 }} cita(s)</span>
                    </div>
                    {% if citas_hoy %}
                    <div class="space-y-3">
                        {% for cita in citas_hoy %}
                        <div class="flex items-center gap-4 p-4 rounded-xl border-2
                            {% if cita.estado == 'Pendiente' %}border-amber-200 bg-amber-50
                            {% elif cita.estado == 'Confirmada' %}border-blue-200 bg-blue-50
                            {% elif cita.estado == 'Completada' %}border-emerald-200 bg-emerald-50
                            {% else %}border-gray-200 bg-gray-50{% endif %} hover:shadow-md transition-all">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 md:w-14 md:h-14 bg-gradient-to-br from-cyan-500 to-teal-500 rounded-xl flex items-center justify-center text-white font-bold text-sm md:text-lg shadow-md">
                                    {{ cita.paciente.split()[0][0] }}{{ cita.paciente.split()[1][0] if cita.paciente.split()|length > 1 else '' }}
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-gray-800 text-sm md:text-lg truncate">{{ cita.paciente }}</h4>
                                <p class="text-xs md:text-sm text-gray-600 mt-1 truncate">{{ cita.tipo }}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-sm md:text-xl {% if cita.estado == 'Pendiente' or cita.estado == 'Confirmada' %}text-cyan-600{% else %}text-gray-600{% endif %}">{{ cita.hora }}</p>
                                <div class="mt-2">
                                    {% if cita.estado == 'Pendiente' %}
                                    <span class="inline-flex items-center gap-1.5 px-2 py-1.5 md:px-3 md:py-1.5 bg-amber-100 text-amber-700 text-[10px] md:text-xs font-bold rounded-lg">
                                        <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span>
                                        Pendiente
                                    </span>
                                    {% elif cita.estado == 'Confirmada' %}
                                    <span class="inline-flex items-center gap-1.5 px-2 py-1.5 md:px-3 md:py-1.5 bg-blue-100 text-blue-700 text-[10px] md:text-xs font-bold rounded-lg">
                                        <span class="material-symbols-outlined text-xs md:text-sm">check_circle</span>
                                        Confirmada
                                    </span>
                                    {% elif cita.estado == 'Completada' %}
                                    <span class="inline-flex items-center gap-1.5 px-2 py-1.5 md:px-3 md:py-1.5 bg-emerald-100 text-emerald-700 text-[10px] md:text-xs font-bold rounded-lg">
                                        <span class="material-symbols-outlined text-xs md:text-sm filled">task_alt</span>
                                        Completada
                                    </span>
                                    {% elif cita.estado == 'Cancelada' %}
                                    <span class="inline-flex items-center gap-1.5 px-2 py-1.5 md:px-3 md:py-1.5 bg-red-100 text-red-700 text-[10px] md:text-xs font-bold rounded-lg">
                                        <span class="material-symbols-outlined text-xs md:text-sm">cancel</span>
                                        Cancelada
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-10 text-gray-500">
                        <div class="w-16 h-16 md:w-20 md:h-20 mx-auto bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mb-4">
                            <span class="material-symbols-outlined text-4xl md:text-5xl text-gray-400">event_busy</span>
                        </div>
                        <p class="font-semibold text-sm md:text-lg">No hay citas programadas para hoy</p>
                        <p class="text-xs md:text-sm mt-2">Tu agenda está libre.</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if subsistema == 'pacientes' %}
                <!-- Subsistema: Mis Pacientes -->
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Mis Pacientes</h2>
                    <p class="text-gray-600">Lista de pacientes asignados</p>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                    <!-- Barra de búsqueda -->
                    <div class="mb-6">
                        <div class="relative">
                            <input type="text" id="buscar-paciente" placeholder="Buscar paciente por nombre o DNI..."
                                   class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                            <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                        </div>
                    </div>

                    <!-- Tabla de pacientes -->
                    {% if mis_pacientes %}
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Paciente</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">DNI</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Última Cita</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Total Citas</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-pacientes">
                                {% for paciente in mis_pacientes %}
                                <tr class="border-b border-gray-100 hover:bg-gray-50 paciente-row" 
                                    data-nombre="{{ paciente.nombre_completo }}" 
                                    data-dni="{{ paciente.dni }}">
                                    <td class="py-4 px-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-teal-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                                {{ paciente.nombre_completo.split()[0][0] }}{{ paciente.nombre_completo.split()[1][0] if paciente.nombre_completo.split()|length > 1 else '' }}
                                            </div>
                                            <div>
                                                <p class="font-semibold text-gray-800">{{ paciente.nombre_completo }}</p>
                                                <p class="text-sm text-gray-500">{{ paciente.edad }} años</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="py-4 px-4 text-gray-600">{{ paciente.dni }}</td>
                                    <td class="py-4 px-4 text-gray-600">{{ paciente.ultima_cita.strftime('%d/%m/%Y') if paciente.ultima_cita else 'N/A' }}</td>
                                    <td class="py-4 px-4 text-gray-600">{{ paciente.total_citas }}</td>
                                    <td class="py-4 px-4">
                                        <button onclick="verHistorialPaciente({{ paciente.id_paciente }})" 
                                                class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-cyan-500 to-teal-500 hover:from-cyan-600 hover:to-teal-600 text-white font-semibold text-sm rounded-lg shadow-sm hover:shadow-md transform hover:scale-105 transition-all duration-200">
                                            <span class="material-symbols-outlined text-base">folder_open</span>
                                            Ver Historial
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginación para pacientes -->
                    <div id="paginacion-pacientes" class="flex justify-center items-center gap-2 mt-6">
                        <!-- Se generará dinámicamente con JavaScript -->
                    </div>
                    {% else %}
                    <div class="text-center py-12 text-gray-500">
                        <span class="material-symbols-outlined text-6xl mb-4 block text-gray-400">groups</span>
                        <p class="font-medium">No hay pacientes registrados</p>
                        <p class="text-sm mt-1">Los pacientes aparecerán aquí después de su primera cita</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Modal Historial -->
                <div id="modal-historial" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 overflow-y-auto" style="background: rgba(0,0,0,0.15); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full my-8 flex flex-col" style="max-height: calc(100vh - 4rem);">
                        <!-- Header fijo -->
                        <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-cyan-50 to-teal-50 rounded-t-2xl flex-shrink-0">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800" id="modal-paciente-nombre">Historial Médico</h3>
                                <p class="text-sm text-gray-600 mt-1" id="modal-paciente-info">DNI: - | Edad: -</p>
                            </div>
                            <button onclick="cerrarModalHistorial()" class="text-gray-500 hover:text-gray-700 hover:bg-white rounded-full p-2 transition-all duration-200">
                                <span class="material-symbols-outlined text-3xl">close</span>
                            </button>
                        </div>
                        <!-- Contenido con scroll -->
                        <div class="p-6 overflow-y-auto flex-1" id="modal-historial-contenido" style="scrollbar-width: thin; scrollbar-color: rgb(6 182 212) rgb(243 244 246);">
                            <!-- El contenido se cargará dinámicamente -->
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if subsistema == 'diagnosticos' %}
                <!-- Subsistema: Diagnósticos -->
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Registrar Diagnóstico</h2>
                    <p class="text-gray-600">Selecciona una cita pendiente y registra el diagnóstico</p>
                </div>

                <!-- Lista de citas pendientes -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Citas Pendientes de Diagnóstico</h3>
                    
                    <!-- Barra de búsqueda para diagnósticos -->
                    <div class="mb-6">
                        <div class="relative">
                            <input type="text" id="buscar-diagnostico" placeholder="Buscar por nombre de paciente o DNI..."
                                   class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                            <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                        </div>
                    </div>
                    
                    {% if citas_pendientes %}
                    <div id="diagnosticos-container" class="space-y-3">
                        {% for cita in citas_pendientes %}
                        <div class="diagnostico-row flex items-center gap-4 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-xl hover:shadow-md transition-shadow" 
                             data-cita-id="{{ cita.id_cita }}"
                             data-cita-fecha="{{ cita.fecha.strftime('%Y-%m-%d') if cita.fecha else '' }}"
                             data-cita-hora="{{ cita.hora }}"
                             data-paciente="{{ cita.paciente }}"
                             data-dni="{{ cita.dni }}">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-yellow-500 rounded-full flex items-center justify-center text-white font-bold">
                                    {{ cita.paciente.split()[0][0] }}{{ cita.paciente.split()[1][0] if cita.paciente.split()|length > 1 else '' }}
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">{{ cita.paciente }}</h4>
                                <p class="text-sm text-gray-600">DNI: {{ cita.dni }} | Fecha: {{ cita.fecha.strftime('%d/%m/%Y') if cita.fecha else 'N/A' }} - {{ cita.hora }}</p>
                                {% if cita.diagnostico %}
                                <div class="mt-2 text-xs">
                                    <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded">Diagnóstico registrado</span>
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex gap-2">
                                {% if cita.diagnostico %}
                                <button onclick="abrirFormularioModificacion({{ cita.id_cita }}, '{{ cita.paciente }}', '{{ cita.dni }}', {{ cita.id_paciente }}, '{{ cita.fecha.strftime('%Y-%m-%d') if cita.fecha else '' }}', '{{ cita.hora }}')" 
                                        class="px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg hover:from-blue-600 hover:to-indigo-600 transition-all font-semibold text-sm flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm">edit</span>
                                    Modificar Diagnóstico
                                </button>
                                {% else %}
                                <button onclick="abrirFormularioDiagnostico({{ cita.id_cita }}, '{{ cita.paciente }}', '{{ cita.dni }}', {{ cita.id_paciente }}, '{{ cita.fecha.strftime('%Y-%m-%d') if cita.fecha else '' }}', '{{ cita.hora }}')" 
                                        class="px-4 py-2 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg hover:from-cyan-600 hover:to-teal-600 transition-all font-semibold text-sm flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm">edit_note</span>
                                    Registrar Diagnóstico
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Paginación para diagnósticos -->
                    <div id="paginacion-diagnosticos" class="flex justify-center items-center gap-2 mt-6">
                        <!-- Se generará dinámicamente con JavaScript -->
                    </div>
                    {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <span class="material-symbols-outlined text-5xl mb-2 block text-gray-400">task_alt</span>
                        <p class="font-medium">No hay citas pendientes de diagnóstico</p>
                        <p class="text-sm mt-1">Todas las citas han sido completadas</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Modal Formulario de diagnóstico -->
                <div id="form-diagnostico" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 overflow-y-auto" style="background: rgba(0,0,0,0.15); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full my-8 flex flex-col" style="max-height: calc(100vh - 4rem);">
                        <!-- Header fijo -->
                        <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-cyan-50 to-teal-50 rounded-t-2xl flex-shrink-0">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800">Registrar Diagnóstico</h3>
                                <p class="text-sm text-gray-600 mt-1" id="form-paciente-info">Paciente: -</p>
                            </div>
                            <button type="button" onclick="cerrarFormularioDiagnostico()" class="text-gray-500 hover:text-gray-700 hover:bg-white rounded-full p-2 transition-all duration-200">
                                <span class="material-symbols-outlined text-3xl">close</span>
                            </button>
                        </div>
                        
                        <!-- Contenido con scroll -->
                        <div class="p-6 overflow-y-auto flex-1" style="scrollbar-width: thin; scrollbar-color: rgb(6 182 212) rgb(243 244 246);">
                            <form id="diagnostico-form" class="space-y-6">
                        <input type="hidden" id="id_cita" name="id_cita">
                        <input type="hidden" id="id_paciente" name="id_paciente">

                        <!-- Diagnóstico -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Diagnóstico <span class="text-red-500">*</span>
                            </label>
                            <textarea id="diagnostico" name="diagnostico" rows="4" required
                                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent" 
                                      placeholder="Ingresa el diagnóstico médico..."></textarea>
                        </div>

                        <!-- Observaciones -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Observaciones</label>
                            <textarea id="observaciones" name="observaciones" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent" 
                                      placeholder="Observaciones adicionales, indicaciones, etc..."></textarea>
                        </div>

                        <!-- Sección de Autorizaciones -->
                        <div class="border-t border-gray-200 pt-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">Autorizar Procedimientos</h4>
                            
                            <!-- Autorizar Examen -->
                            <div class="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-200">
                                <div class="flex items-center gap-3 mb-3">
                                    <input type="checkbox" id="check_autorizar_examen" 
                                           class="w-5 h-5 text-cyan-600 rounded focus:ring-2 focus:ring-cyan-500"
                                           onchange="toggleAutorizacionExamen()">
                                    <label for="check_autorizar_examen" class="font-semibold text-gray-800 cursor-pointer">
                                        <span class="material-symbols-outlined text-lg align-middle mr-1">biotech</span>
                                        Autorizar Examen Médico
                                    </label>
                                </div>
                                
                                <div id="fields_examen" class="hidden space-y-3 ml-8">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Tipo de Examen <span class="text-red-500">*</span>
                                        </label>
                                        <select id="servicio_examen" name="id_servicio_examen"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent text-sm">
                                            <option value="">-- Seleccione el tipo de examen --</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">Seleccione el examen que el paciente debe realizarse</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Autorizar Operación -->
                            <div class="p-4 bg-orange-50 rounded-xl border border-orange-200">
                                <div class="flex items-center gap-3 mb-3">
                                    <input type="checkbox" id="check_autorizar_operacion" 
                                           class="w-5 h-5 text-cyan-600 rounded focus:ring-2 focus:ring-cyan-500"
                                           onchange="toggleAutorizacionOperacion()">
                                    <label for="check_autorizar_operacion" class="font-semibold text-gray-800 cursor-pointer">
                                        <span class="material-symbols-outlined text-lg align-middle mr-1">surgical</span>
                                        Autorizar Operación
                                    </label>
                                </div>
                                
                                <div id="fields_operacion" class="hidden space-y-3 ml-8">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Tipo de Operación <span class="text-red-500">*</span>
                                        </label>
                                        <select id="servicio_operacion" name="id_servicio_operacion"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent text-sm"
                                                onchange="onServicioOperacionChange()">
                                            <option value="">-- Seleccione el tipo de operación --</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">Puede realizar la operación usted mismo o derivarla a otro médico</p>
                                    </div>
                                    <div id="div_derivar_operacion" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Derivar a otro médico (opcional)</label>
                                        <select id="medico_derivar_operacion" name="id_medico_derivar_operacion" 
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 text-sm">
                                            <option value="">-- Yo realizaré la operación --</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">Solo se muestran médicos de su especialidad</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                                <!-- Botones -->
                                <div class="flex gap-4 pt-4">
                                    <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-xl hover:from-cyan-600 hover:to-teal-600 transition-all font-semibold shadow-md">
                                        Guardar Diagnóstico
                                    </button>
                                    <button type="button" onclick="cerrarFormularioDiagnostico()" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-semibold">
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if subsistema == 'notificaciones' %}
                <!-- Subsistema: Notificaciones -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">Historial de Notificaciones</h2>
                            <p class="text-gray-600">Aquí aparecen todas las notificaciones enviadas a tu cuenta.</p>
                        </div>
                        <div>
                            <button id="btn-marcar-todas" onclick="marcarTodasComoLeidas()" 
                                    class="px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 transition-colors font-medium flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                                Marcar todas como leídas
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lista de notificaciones -->
                {% if notificaciones and notificaciones|length > 0 %}
                <div class="space-y-3" id="historialNotificaciones">
                    {% for n in notificaciones %}
                    <div class="notificacion-item bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200 p-4 border border-gray-100 {% if n.leida %}opacity-70{% endif %}" 
                         data-tipo="{{ n.tipo }}" 
                         data-estado="{{ n.estado_reserva or '' }}"
                         data-leida="{{ n.leida }}"
                         data-id="{{ n.id_notificacion }}">
                        <div class="flex gap-3">
                            <!-- Icono dinámico -->
                            <div class="flex-shrink-0">
                                {% if n.tipo == 'nueva_cita' or n.tipo == 'confirmacion' %}
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white text-xl">event_available</span>
                                </div>
                                {% elif n.tipo == 'operacion_asignada' %}
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white text-xl">medical_services</span>
                                </div>
                                {% elif n.tipo == 'cancelacion' %}
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white text-xl">event_busy</span>
                                </div>
                                {% else %}
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-500 to-teal-600 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white text-xl">info</span>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Contenido -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between gap-2">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <h3 class="font-semibold text-gray-900">{{ n.titulo }}</h3>
                                            {% if n.tipo == 'nueva_cita' %}
                                            <span class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-700">Nueva Cita</span>
                                            {% elif n.tipo == 'operacion_asignada' %}
                                            <span class="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700">Operación</span>
                                            {% endif %}
                                        </div>
                                        <p class="text-sm text-gray-600 leading-relaxed">{{ n.mensaje }}</p>
                                    </div>
                                    
                                    <!-- Estado leída y botón marcar como leído -->
                                    <div class="flex items-center gap-2 flex-shrink-0">
                                        {% if n.leida %}
                                        <div class="text-green-500" title="Leída">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                            </svg>
                                        </div>
                                        {% else %}
                                        <div class="flex items-center gap-2">
                                            <span class="inline-block w-2 h-2 bg-red-500 rounded-full animate-pulse" title="No leída"></span>
                                            <button onclick="marcarComoLeida({{ n.id_notificacion }})" 
                                                    class="btn-marcar-leida text-xs px-3 py-1.5 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 transition-colors font-medium flex items-center gap-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                                </svg>
                                                Marcar como leída
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-4 mt-2 text-xs text-gray-500">
                                    <span class="flex items-center gap-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <polyline points="12 6 12 12 16 14"></polyline>
                                        </svg>
                                        {{ n.fecha_envio }} {{ n.hora_envio }}
                                    </span>
                                    <span class="text-gray-400">•</span>
                                    <span>ID: #{{ n.id_notificacion }}</span>
                                    {% if n.leida and n.fecha_leida %}
                                    <span class="text-gray-400">•</span>
                                    <span class="text-green-600">Leída: {{ n.fecha_leida[:10] if n.fecha_leida else '—' }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <!-- Mensaje vacío -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-12 text-center">
                    <div class="w-20 h-20 mx-auto bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mb-4">
                        <span class="material-symbols-outlined text-4xl text-gray-400">notifications_off</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">No hay notificaciones</h3>
                    <p class="text-gray-600">No tienes notificaciones en este momento</p>
                </div>
                {% endif %}
                {% endif %}

                <!-- Modal Detalle de Cita -->
                <div id="modal-detalle-cita" class="hidden fixed inset-0 z-50 flex items-start justify-center px-4" style="padding-top: calc(7rem - 50px); background: rgba(0,0,0,0.03); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);">
                    <div class="bg-white rounded-2xl shadow-lg max-w-lg w-full overflow-hidden border border-gray-100">
                        <div class="flex items-center justify-between p-4 border-b border-gray-100 bg-gradient-to-r from-white to-blue-50">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 bg-blue-100 rounded-full flex items-center justify-center">
                                    <span class="material-symbols-outlined text-blue-500 text-lg">event</span>
                                </div>
                                <h3 class="text-base font-semibold text-gray-700">Información de la Cita</h3>
                            </div>
                            <button onclick="cerrarModalDetalleCita()" class="text-gray-400 hover:text-gray-600 transition-colors">
                                <span class="material-symbols-outlined text-xl">close</span>
                            </button>
                        </div>
                        
                        <div class="p-5">
                            <!-- Título de la Cita -->
                            <h4 class="text-lg font-semibold text-gray-800 mb-3" id="modal-cita-titulo">-</h4>

                            <!-- Fecha y Hora -->
                            <div class="space-y-2 mb-2 text-gray-600">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-base text-gray-400">calendar_today</span>
                                    <p id="modal-cita-fecha" class="text-sm">-</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-base text-gray-400">schedule</span>
                                    <p id="modal-cita-horario" class="text-sm">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Footer removed (no aceptar button as requested) -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Script del panel médico -->
    <script src="{{ url_for('static', filename='js/panel_medico.js') }}?v=20251125-001"></script>
    
    {% if subsistema == 'notificaciones' %}
    <script>
        // Función para marcar notificación como leída (sin recargar página - optimizada)
        async function marcarComoLeida(idNotificacion) {
            const notificacionItem = document.querySelector(`.notificacion-item[data-id="${idNotificacion}"]`);
            if (!notificacionItem) {
                console.error('No se encontró la notificación con ID:', idNotificacion);
                return;
            }
            
            if (notificacionItem.dataset.leida === 'True' || notificacionItem.dataset.leida === '1') {
                return;
            }
            
            const boton = notificacionItem.querySelector('button.btn-marcar-leida');
            if (!boton) return;
            
            const estadoDiv = boton.closest('.flex.items-center.gap-2');
            if (!estadoDiv) return;
            
            const htmlOriginal = estadoDiv.innerHTML;
            
            // Actualizar visualmente INMEDIATAMENTE
            estadoDiv.innerHTML = `
                <div class="text-green-500" title="Leída">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                </div>
            `;
            
            notificacionItem.style.opacity = '0.7';
            notificacionItem.dataset.leida = 'True';
            
            // Agregar fecha de leída si no existe
            const fechaContainer = notificacionItem.querySelector('.flex.items-center.gap-4.mt-2');
            if (fechaContainer) {
                const yaTieneFechaLeida = fechaContainer.querySelector('.text-green-600');
                if (!yaTieneFechaLeida) {
                    const fechaActual = new Date().toLocaleDateString('es-ES');
                    const separador = document.createElement('span');
                    separador.className = 'text-gray-400';
                    separador.textContent = '•';
                    fechaContainer.appendChild(separador);
                    
                    const leidaSpan = document.createElement('span');
                    leidaSpan.className = 'text-green-600';
                    leidaSpan.textContent = `Leída: ${fechaActual}`;
                    fechaContainer.appendChild(leidaSpan);
                }
            }
            
            // Hacer la petición en segundo plano
            try {
                const response = await fetch(`/notificaciones/api/marcar-leida-medico/${idNotificacion}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data.success) {
                    // Actualizar badge en el header
                    if (typeof window.cargarNotificacionesHeader === 'function') {
                        window.cargarNotificacionesHeader();
                    }
                } else {
                    notificacionItem.style.opacity = '1';
                    notificacionItem.dataset.leida = 'False';
                    estadoDiv.innerHTML = htmlOriginal;
                    alert('Error al marcar la notificación como leída: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                notificacionItem.style.opacity = '1';
                notificacionItem.dataset.leida = 'False';
                estadoDiv.innerHTML = htmlOriginal;
                alert('Error al marcar la notificación como leída');
            }
        }

        // Función para marcar todas las notificaciones como leídas
        async function marcarTodasComoLeidas() {
            const boton = document.getElementById('btn-marcar-todas');
            if (!boton) return;
            
            const todasLasNotificaciones = document.querySelectorAll('.notificacion-item');
            const notificacionesNoLeidas = Array.from(todasLasNotificaciones).filter(item => {
                const btnIndividual = item.querySelector('button.btn-marcar-leida');
                return btnIndividual !== null;
            });
            
            if (notificacionesNoLeidas.length === 0) {
                boton.style.display = 'none';
                return;
            }
            
            const fechaActual = new Date().toLocaleDateString('es-ES');
            const cambiosOriginales = [];
            
            // Actualizar visualmente INMEDIATAMENTE
            notificacionesNoLeidas.forEach(item => {
                const btnIndividual = item.querySelector('button.btn-marcar-leida');
                if (!btnIndividual) return;
                
                const estadoDiv = btnIndividual.closest('.flex.items-center.gap-2');
                if (!estadoDiv) return;
                
                cambiosOriginales.push({
                    item: item,
                    htmlOriginal: estadoDiv.innerHTML,
                    fechaContainer: item.querySelector('.flex.items-center.gap-4.mt-2')
                });
                
                estadoDiv.innerHTML = `
                    <div class="text-green-500" title="Leída">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                `;
                
                item.style.opacity = '0.7';
                item.dataset.leida = 'True';
                
                const fechaContainer = item.querySelector('.flex.items-center.gap-4.mt-2');
                if (fechaContainer) {
                    const yaTieneFechaLeida = fechaContainer.querySelector('.text-green-600');
                    if (!yaTieneFechaLeida) {
                        const separador = document.createElement('span');
                        separador.className = 'text-gray-400';
                        separador.textContent = '•';
                        fechaContainer.appendChild(separador);
                        
                        const leidaSpan = document.createElement('span');
                        leidaSpan.className = 'text-green-600';
                        leidaSpan.textContent = `Leída: ${fechaActual}`;
                        fechaContainer.appendChild(leidaSpan);
                    }
                }
            });
            
            boton.style.display = 'none';
            
            // Hacer la petición en segundo plano
            try {
                const response = await fetch('/notificaciones/api/marcar-todas-leidas-medico', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data.success) {
                    // Actualizar badge en el header
                    if (typeof window.cargarNotificacionesHeader === 'function') {
                        window.cargarNotificacionesHeader();
                    }
                } else {
                    cambiosOriginales.forEach(cambio => {
                        cambio.item.style.opacity = '1';
                        cambio.item.dataset.leida = 'False';
                        const estadoDiv = cambio.item.querySelector('.flex.items-center.gap-2');
                        if (estadoDiv) estadoDiv.innerHTML = cambio.htmlOriginal;
                        if (cambio.fechaContainer) {
                            const fechaLeida = cambio.fechaContainer.querySelector('.text-green-600');
                            if (fechaLeida) {
                                const separador = fechaLeida.previousElementSibling;
                                if (separador && separador.classList.contains('text-gray-400')) separador.remove();
                                fechaLeida.remove();
                            }
                        }
                    });
                    boton.style.display = 'inline-flex';
                    alert('Error al marcar todas las notificaciones como leídas: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                cambiosOriginales.forEach(cambio => {
                    cambio.item.style.opacity = '1';
                    cambio.item.dataset.leida = 'False';
                    const estadoDiv = cambio.item.querySelector('.flex.items-center.gap-2');
                    if (estadoDiv) estadoDiv.innerHTML = cambio.htmlOriginal;
                    if (cambio.fechaContainer) {
                        const fechaLeida = cambio.fechaContainer.querySelector('.text-green-600');
                        if (fechaLeida) {
                            const separador = fechaLeida.previousElementSibling;
                            if (separador && separador.classList.contains('text-gray-400')) separador.remove();
                            fechaLeida.remove();
                        }
                    }
                });
                boton.style.display = 'inline-flex';
                alert('Error al marcar todas las notificaciones como leídas');
            }
        }
    </script>
    {% endif %}
</body>
</html>
