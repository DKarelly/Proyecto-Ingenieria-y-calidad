<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Médico - Clínica Unión</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    
    <!-- Tailwind CSS compilado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 20
        }
        .material-symbols-outlined.filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 20
        }
        
        /* Animación para el desglose de tiempo */
        .time-breakdown {
            animation: expandIn 0.2s ease-out;
            transform-origin: top;
        }
        
        @keyframes expandIn {
            from {
                opacity: 0;
                transform: scaleY(0.8);
            }
            to {
                opacity: 1;
                transform: scaleY(1);
            }
        }
        
        /* Indicador de que la celda es clickeable */
        .calendar-cell:not(:has(.absolute.inset-1))::after {
            content: '⏱';
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 10px;
            opacity: 0.3;
            pointer-events: none;
        }
    </style>
    <script>
        // Configuración personalizada (si es necesaria)
        const customConfig = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#06B6D4',
                            light: '#E0F9FC',
                            dark: '#0891B2'
                        },
                        medical: {
                            cyan: '#06B6D4',
                            teal: '#14B8A6',
                            emerald: '#10B981'
                        },
                        "background-light": "#F8F9FC",
                        "background-dark": "#0A0A0A",
                        "surface-light": "#FFFFFF",
                        "surface-dark": "#141414",
                        "border-light": "#EFF1F4",
                        "border-dark": "#2A2A2A",
                        "text-primary-light": "#1F2937",
                        "text-primary-dark": "#E5E7EB",
                        "text-secondary-light": "#6B7280",
                        "text-secondary-dark": "#9CA3AF",
                    },
                    fontFamily: {
                        display: ["Sora", "sans-serif"],
                        body: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.5rem",
                        lg: "1rem",
                        xl: "1.5rem"
                    },
                    boxShadow: {
                        'subtle': '0 4px 6px -1px rgba(0, 0, 0, 0.03), 0 2px 4px -2px rgba(0, 0, 0, 0.03)',
                        'subtle-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -4px rgba(0, 0, 0, 0.05)',
                        'medical': '0 10px 25px -5px rgba(6, 182, 212, 0.15)'
                    }
                },
            },
        };
    </script>
</head>

<body class="font-body bg-background-light dark:bg-background-dark text-text-secondary-light dark:text-text-secondary-dark antialiased">
    {% include 'header_medico.html' %}

    <div class="flex h-[calc(100vh-80px)]">
        <!-- Sidebar Médico -->
        <aside class="w-[280px] flex-shrink-0 bg-surface-light dark:bg-surface-dark border-r border-border-light dark:border-border-dark flex flex-col">
            <nav class="flex-1 px-6 py-6 space-y-2">
                <!-- Dashboard -->
                <a href="/medico/panel" class="flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl {% if not subsistema %}bg-gradient-to-r from-cyan-50 to-teal-50 text-cyan-700 border border-cyan-200 shadow-sm{% else %}text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-zinc-900/50 hover:text-text-primary-light dark:hover:text-text-primary-dark{% endif %} transition-all duration-300">
                    <span class="material-symbols-outlined text-xl {% if not subsistema %}filled{% endif %}">dashboard</span>
                    <span class="font-semibold">Dashboard</span>
                </a>

                <!-- Mi Agenda -->
                <a href="/medico/panel?subsistema=agenda" class="flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl {% if subsistema == 'agenda' %}bg-gradient-to-r from-cyan-50 to-teal-50 text-cyan-700 border border-cyan-200 shadow-sm{% else %}text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-zinc-900/50 hover:text-text-primary-light dark:hover:text-text-primary-dark{% endif %} transition-all duration-300">
                    <span class="material-symbols-outlined text-xl {% if subsistema == 'agenda' %}filled{% endif %}">calendar_month</span>
                    <span class="font-semibold">Mi Agenda</span>
                </a>

                <!-- Mis Pacientes -->
                <a href="/medico/panel?subsistema=pacientes" class="flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl {% if subsistema == 'pacientes' %}bg-gradient-to-r from-cyan-50 to-teal-50 text-cyan-700 border border-cyan-200 shadow-sm{% else %}text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-zinc-900/50 hover:text-text-primary-light dark:hover:text-text-primary-dark{% endif %} transition-all duration-300">
                    <span class="material-symbols-outlined text-xl {% if subsistema == 'pacientes' %}filled{% endif %}">groups</span>
                    <span class="font-semibold">Mis Pacientes</span>
                </a>

                <!-- Diagnósticos -->
                <a href="/medico/panel?subsistema=diagnosticos" class="flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl {% if subsistema == 'diagnosticos' %}bg-gradient-to-r from-cyan-50 to-teal-50 text-cyan-700 border border-cyan-200 shadow-sm{% else %}text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-zinc-900/50 hover:text-text-primary-light dark:hover:text-text-primary-dark{% endif %} transition-all duration-300">
                    <span class="material-symbols-outlined text-xl {% if subsistema == 'diagnosticos' %}filled{% endif %}">clinical_notes</span>
                    <span class="font-semibold">Diagnósticos</span>
                </a>
            </nav>
        </aside>

        <!-- Contenido Principal -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <main class="flex-1 overflow-y-auto p-8">
                {% if not subsistema %}
                <!-- Dashboard Principal -->
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Bienvenido, Dr. {{ session.get('nombre_usuario', 'Usuario') }}</h2>
                    <p class="text-gray-600">Aquí está tu resumen del día</p>
                </div>

                <!-- Estadísticas Rápidas -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Citas de Hoy -->
                    <div class="bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-2xl p-6 text-white shadow-medical">
                        <div class="flex items-center justify-between mb-4">
                            <span class="material-symbols-outlined text-4xl opacity-80">event</span>
                            <span class="text-3xl font-bold">{{ stats.citas_hoy }}</span>
                        </div>
                        <h3 class="text-sm font-medium opacity-90 mb-1">Citas de Hoy</h3>
                        <p class="text-xs opacity-75">{{ stats.citas_pendientes }} pendiente(s), {{ stats.citas_completadas }} completada(s)</p>
                    </div>

                    <!-- Pacientes Atendidos -->
                    <div class="bg-gradient-to-br from-teal-500 to-teal-600 rounded-2xl p-6 text-white shadow-medical">
                        <div class="flex items-center justify-between mb-4">
                            <span class="material-symbols-outlined text-4xl opacity-80">groups</span>
                            <span class="text-3xl font-bold">{{ stats.pacientes_semana }}</span>
                        </div>
                        <h3 class="text-sm font-medium opacity-90 mb-1">Pacientes Esta Semana</h3>
                        <p class="text-xs opacity-75">Pacientes únicos atendidos</p>
                    </div>

                    <!-- Diagnósticos Pendientes -->
                    <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-6 text-white shadow-medical">
                        <div class="flex items-center justify-between mb-4">
                            <span class="material-symbols-outlined text-4xl opacity-80">clinical_notes</span>
                            <span class="text-3xl font-bold">{{ stats.diagnosticos_pendientes }}</span>
                        </div>
                        <h3 class="text-sm font-medium opacity-90 mb-1">Diagnósticos Pendientes</h3>
                        <p class="text-xs opacity-75">Requieren atención</p>
                    </div>
                </div>

                <!-- Contenido del Dashboard -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Citas de Hoy -->
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Citas de Hoy</h3>
                            <a href="/medico/panel?subsistema=agenda" class="text-cyan-600 hover:text-cyan-700 text-sm font-semibold flex items-center gap-1">
                                Ver todas
                                <span class="material-symbols-outlined text-sm">arrow_forward</span>
                            </a>
                        </div>

                        <div class="space-y-4">
                            {% if citas_hoy %}
                                {% for cita in citas_hoy %}
                                <div class="flex items-center gap-4 p-4 {% if cita.estado == 'Pendiente' or cita.estado == 'Confirmada' %}bg-gradient-to-r from-cyan-50 to-teal-50 border-cyan-100{% else %}bg-gray-50 border-gray-200{% endif %} rounded-xl border hover:shadow-md transition-shadow">
                                    <div class="flex-shrink-0">
                                        <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-teal-500 rounded-full flex items-center justify-center text-white font-bold">
                                            {{ cita.paciente.split()[0][0] }}{{ cita.paciente.split()[1][0] if cita.paciente.split()|length > 1 else '' }}
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-800">{{ cita.paciente }}</h4>
                                        <p class="text-sm text-gray-600">{{ cita.tipo }}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold {% if cita.estado == 'Pendiente' or cita.estado == 'Confirmada' %}text-cyan-600{% else %}text-gray-600{% endif %}">{{ cita.hora }}</p>
                                        {% if cita.estado == 'Pendiente' %}
                                        <span class="inline-block px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-semibold rounded-full mt-1">Pendiente</span>
                                        {% elif cita.estado == 'Confirmada' %}
                                        <span class="inline-block px-2 py-1 bg-blue-100 text-blue-700 text-xs font-semibold rounded-full mt-1">Confirmada</span>
                                        {% elif cita.estado == 'Completada' %}
                                        <span class="inline-block px-2 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded-full mt-1">Completada</span>
                                        {% elif cita.estado == 'Cancelada' %}
                                        <span class="inline-block px-2 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded-full mt-1">Cancelada</span>
                                        {% else %}
                                        <span class="inline-block px-2 py-1 bg-gray-100 text-gray-700 text-xs font-semibold rounded-full mt-1">{{ cita.estado }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-8 text-gray-500">
                                    <span class="material-symbols-outlined text-5xl mb-2 block text-gray-400">event_busy</span>
                                    <p class="font-medium">No hay citas programadas para hoy</p>
                                    <p class="text-sm mt-1">Revisa tu agenda para ver próximas citas</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Accesos Rápidos -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Accesos Rápidos</h3>

                        <div class="space-y-3">
                            <a href="/medico/panel?subsistema=diagnosticos" class="flex items-center gap-3 p-3 rounded-xl hover:bg-cyan-50 transition-colors group">
                                <div class="w-10 h-10 bg-cyan-100 rounded-lg flex items-center justify-center group-hover:bg-cyan-200 transition-colors">
                                    <span class="material-symbols-outlined text-cyan-600">edit_note</span>
                                </div>
                                <span class="font-semibold text-gray-700 group-hover:text-cyan-700">Registrar Diagnóstico</span>
                            </a>

                            <a href="/medico/panel?subsistema=pacientes" class="flex items-center gap-3 p-3 rounded-xl hover:bg-teal-50 transition-colors group">
                                <div class="w-10 h-10 bg-teal-100 rounded-lg flex items-center justify-center group-hover:bg-teal-200 transition-colors">
                                    <span class="material-symbols-outlined text-teal-600">person_search</span>
                                </div>
                                <span class="font-semibold text-gray-700 group-hover:text-teal-700">Buscar Paciente</span>
                            </a>

                            <a href="/medico/panel?subsistema=agenda" class="flex items-center gap-3 p-3 rounded-xl hover:bg-blue-50 transition-colors group">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center group-hover:bg-blue-200 transition-colors">
                                    <span class="material-symbols-outlined text-blue-600">calendar_month</span>
                                </div>
                                <span class="font-semibold text-gray-700 group-hover:text-blue-700">Ver Agenda</span>
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if subsistema == 'agenda' %}
                <!-- Subsistema: Mi Agenda -->
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Mi Agenda</h2>
                    <p class="text-gray-600">Visualiza tu calendario de citas y eventos de la semana</p>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <!-- Header navegación semana -->
                    <div class="bg-gradient-to-r from-cyan-500 to-teal-500 text-white p-4 md:p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 md:gap-4">
                                <button onclick="cambiarSemana(-1)" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined">chevron_left</span>
                                </button>
                                <h2 class="text-lg md:text-xl font-semibold">
                                    Semana del 4 al 10 nov 2025
                                </h2>
                                <button onclick="cambiarSemana(1)" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined">chevron_right</span>
                                </button>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="irHoy()" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-md">
                                    <span class="material-symbols-outlined text-lg">today</span>
                                    <span class="hidden md:inline">Hoy</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Calendario semanal -->
                    <div class="overflow-x-auto overflow-y-auto max-h-[calc(100vh-280px)]">
                        {% if horarios_medico %}
                        {# Calcular horas mínimas y máximas de todos los horarios #}
                        {% set ns = namespace(hora_min=23, hora_max=0) %}
                        {% for day, data in horarios_medico.items() %}
                            {% for bloque in data.bloques %}
                                {% set hora_inicio = bloque.hora_inicio.hour %}
                                {% set hora_fin = bloque.hora_fin.hour %}
                                {% if hora_inicio < ns.hora_min %}
                                    {% set ns.hora_min = hora_inicio %}
                                {% endif %}
                                {% if hora_fin > ns.hora_max %}
                                    {% set ns.hora_max = hora_fin %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        
                        <table class="min-w-full border-collapse">
                            <thead>
                                <tr>
                                    <th class="w-20 p-3 bg-gray-50 border border-gray-200 text-center text-sm font-medium text-gray-600 sticky left-0 z-20">Hora</th>
                                    {% for day in range(7) %}
                                    <th class="p-3 bg-gray-50 border border-gray-200 text-center text-sm font-medium text-gray-600 min-w-[150px]">
                                        {% if day == 0 %}Lun
                                        {% elif day == 1 %}Mar
                                        {% elif day == 2 %}Mié
                                        {% elif day == 3 %}Jue
                                        {% elif day == 4 %}Vie
                                        {% elif day == 5 %}Sáb
                                        {% elif day == 6 %}Dom
                                        {% endif %}
                                        {% if day in horarios_medico %}
                                        <br><span class="text-xs font-normal">{{ horarios_medico[day].fecha.strftime('%d/%m') }}</span>
                                        {% endif %}
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Mostrar solo las horas donde el médico trabaja -->
                                {% for hour in range(ns.hora_min, ns.hora_max + 1) %}
                                <tr>
                                    <td class="w-20 p-2 bg-gray-50 border border-gray-200 text-sm text-gray-600 font-medium sticky left-0 z-10 text-center">
                                        {{ '%02d:00'|format(hour) }}
                                    </td>
                                    {% for day in range(7) %}
                                    {% set tiene_horario = namespace(value=false) %}
                                    {% if day in horarios_medico %}
                                        {% for bloque in horarios_medico[day].bloques %}
                                            {% if hour >= bloque.hora_inicio.hour and hour < bloque.hora_fin.hour %}
                                                {% set tiene_horario.value = true %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% if tiene_horario.value %}
                                    <td class="p-0 border border-gray-200 h-20 align-top relative hover:bg-blue-50 cursor-pointer transition-colors calendar-cell"
                                        data-day="{{ day }}" data-hour="{{ hour }}">
                                        <!-- Desglose de 15 minutos (oculto por defecto) -->
                                        <div class="time-breakdown hidden w-full bg-white border-2 border-blue-400 shadow-xl rounded flex flex-col my-1">
                                            {% for minute in [0, 15, 30, 45] %}
                                            <div class="flex-1 px-3 py-3 text-sm text-gray-700 hover:bg-blue-200 cursor-pointer border-b border-blue-200 last:border-b-0 font-semibold flex items-center justify-center transition-colors"
                                                 data-minute="{{ minute }}"
                                                 onclick="event.stopPropagation(); abrirFormularioEvento({{ day }}, {{ hour }}, {{ minute }})">
                                                {{ '%02d:%02d'|format(hour, minute) }}
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <!-- Mostrar citas programadas -->
                                        {% set clave_cita = day|string + '_' + hour|string %}
                                        {% if citas_semana and clave_cita in citas_semana %}
                                            {% for cita in citas_semana[clave_cita] %}
                                            {% if cita.es_hora_inicio %}
                                            {# Solo mostrar la cita en la primera hora, pero que se extienda visualmente #}
                                            {% set altura_cita = (cita.duracion_horas * 80)|int %}
                                            <div class="absolute left-1 right-1 rounded px-2 py-1 text-white overflow-hidden shadow-md z-10"
                                                 style="top: 4px; height: {{ altura_cita - 8 }}px; {% if cita.estado == 'Pendiente' %}background-color: #f59e0b;{% elif cita.estado == 'Confirmada' %}background-color: #3b82f6;{% else %}background-color: #10b981;{% endif %}">
                                                <div class="text-xs font-bold line-clamp-1">{{ cita.paciente }}</div>
                                                <div class="text-xs opacity-90 line-clamp-1">{{ cita.tipo }}</div>
                                                <div class="text-xs font-medium mt-1">{{ cita.hora_inicio.strftime('%H:%M') }} - {{ cita.hora_fin.strftime('%H:%M') }}</div>
                                            </div>
                                            {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    </td>
                                    {% else %}
                                    <!-- Celda sin horario (médico no trabaja) -->
                                    <td class="p-0 border border-gray-200 h-20 bg-gray-100 relative">
                                        <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-xs">
                                            <span class="material-symbols-outlined text-lg opacity-30">block</span>
                                        </div>
                                    </td>
                                    {% endif %}
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <!-- Mensaje cuando no hay horarios -->
                        <div class="text-center py-12">
                            <span class="material-symbols-outlined text-6xl text-gray-300 mb-4 block">schedule</span>
                            <p class="text-gray-500 font-medium">No hay horarios configurados para esta semana</p>
                            <p class="text-gray-400 text-sm mt-2">Contacta con administración para configurar tu agenda</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Lista de citas del día -->
                <div class="mt-6 bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span class="material-symbols-outlined text-cyan-600">event_note</span>
                            Citas de Hoy
                        </h3>
                        <span class="text-sm text-gray-500">{{ citas_hoy|length if citas_hoy else 0 }} cita(s)</span>
                    </div>
                    {% if citas_hoy %}
                    <div class="space-y-3">
                        {% for cita in citas_hoy %}
                        <div class="flex items-center gap-4 p-4 rounded-xl border-2
                            {% if cita.estado == 'Pendiente' %}border-amber-200 bg-amber-50
                            {% elif cita.estado == 'Confirmada' %}border-blue-200 bg-blue-50
                            {% elif cita.estado == 'Completada' %}border-emerald-200 bg-emerald-50
                            {% else %}border-gray-200 bg-gray-50{% endif %} hover:shadow-md transition-all">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 md:w-14 md:h-14 bg-gradient-to-br from-cyan-500 to-teal-500 rounded-xl flex items-center justify-center text-white font-bold text-sm md:text-lg shadow-md">
                                    {{ cita.paciente.split()[0][0] }}{{ cita.paciente.split()[1][0] if cita.paciente.split()|length > 1 else '' }}
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-gray-800 text-sm md:text-lg truncate">{{ cita.paciente }}</h4>
                                <p class="text-xs md:text-sm text-gray-600 mt-1 truncate">{{ cita.tipo }}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-sm md:text-xl {% if cita.estado == 'Pendiente' or cita.estado == 'Confirmada' %}text-cyan-600{% else %}text-gray-600{% endif %}">{{ cita.hora }}</p>
                                <div class="mt-2">
                                    {% if cita.estado == 'Pendiente' %}
                                    <span class="inline-flex items-center gap-1.5 px-2 py-1.5 md:px-3 md:py-1.5 bg-amber-100 text-amber-700 text-[10px] md:text-xs font-bold rounded-lg">
                                        <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span>
                                        Pendiente
                                    </span>
                                    {% elif cita.estado == 'Confirmada' %}
                                    <span class="inline-flex items-center gap-1.5 px-2 py-1.5 md:px-3 md:py-1.5 bg-blue-100 text-blue-700 text-[10px] md:text-xs font-bold rounded-lg">
                                        <span class="material-symbols-outlined text-xs md:text-sm">check_circle</span>
                                        Confirmada
                                    </span>
                                    {% elif cita.estado == 'Completada' %}
                                    <span class="inline-flex items-center gap-1.5 px-2 py-1.5 md:px-3 md:py-1.5 bg-emerald-100 text-emerald-700 text-[10px] md:text-xs font-bold rounded-lg">
                                        <span class="material-symbols-outlined text-xs md:text-sm filled">task_alt</span>
                                        Completada
                                    </span>
                                    {% elif cita.estado == 'Cancelada' %}
                                    <span class="inline-flex items-center gap-1.5 px-2 py-1.5 md:px-3 md:py-1.5 bg-red-100 text-red-700 text-[10px] md:text-xs font-bold rounded-lg">
                                        <span class="material-symbols-outlined text-xs md:text-sm">cancel</span>
                                        Cancelada
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-10 text-gray-500">
                        <div class="w-16 h-16 md:w-20 md:h-20 mx-auto bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mb-4">
                            <span class="material-symbols-outlined text-4xl md:text-5xl text-gray-400">event_busy</span>
                        </div>
                        <p class="font-semibold text-sm md:text-lg">No hay citas programadas para hoy</p>
                        <p class="text-xs md:text-sm mt-2">Tu agenda está libre.</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if subsistema == 'pacientes' %}
                <!-- Subsistema: Mis Pacientes -->
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Mis Pacientes</h2>
                    <p class="text-gray-600">Lista de pacientes asignados</p>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                    <!-- Barra de búsqueda -->
                    <div class="mb-6">
                        <div class="relative">
                            <input type="text" id="buscar-paciente" placeholder="Buscar paciente por nombre o DNI..."
                                   class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                            <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                        </div>
                    </div>

                    <!-- Tabla de pacientes -->
                    {% if mis_pacientes %}
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Paciente</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">DNI</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Última Cita</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Total Citas</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-pacientes">
                                {% for paciente in mis_pacientes %}
                                <tr class="border-b border-gray-100 hover:bg-gray-50 paciente-row" 
                                    data-nombre="{{ paciente.nombre_completo }}" 
                                    data-dni="{{ paciente.dni }}">
                                    <td class="py-4 px-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-teal-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                                {{ paciente.nombre_completo.split()[0][0] }}{{ paciente.nombre_completo.split()[1][0] if paciente.nombre_completo.split()|length > 1 else '' }}
                                            </div>
                                            <div>
                                                <p class="font-semibold text-gray-800">{{ paciente.nombre_completo }}</p>
                                                <p class="text-sm text-gray-500">{{ paciente.edad }} años</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="py-4 px-4 text-gray-600">{{ paciente.dni }}</td>
                                    <td class="py-4 px-4 text-gray-600">{{ paciente.ultima_cita.strftime('%d/%m/%Y') if paciente.ultima_cita else 'N/A' }}</td>
                                    <td class="py-4 px-4 text-gray-600">{{ paciente.total_citas }}</td>
                                    <td class="py-4 px-4">
                                        <button onclick="verHistorialPaciente({{ paciente.id_paciente }})" 
                                                class="text-cyan-600 hover:text-cyan-700 font-semibold text-sm flex items-center gap-1">
                                            <span class="material-symbols-outlined text-sm">folder_open</span>
                                            Ver Historial
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-12 text-gray-500">
                        <span class="material-symbols-outlined text-6xl mb-4 block text-gray-400">groups</span>
                        <p class="font-medium">No hay pacientes registrados</p>
                        <p class="text-sm mt-1">Los pacientes aparecerán aquí después de su primera cita</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Modal Historial -->
                <div id="modal-historial" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div class="flex items-center justify-between p-6 border-b border-gray-200">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800" id="modal-paciente-nombre">Historial Médico</h3>
                                <p class="text-sm text-gray-600 mt-1" id="modal-paciente-info">DNI: - | Edad: -</p>
                            </div>
                            <button onclick="cerrarModalHistorial()" class="text-gray-400 hover:text-gray-600">
                                <span class="material-symbols-outlined text-3xl">close</span>
                            </button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[calc(90vh-150px)]" id="modal-historial-contenido">
                            <!-- El contenido se cargará dinámicamente -->
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if subsistema == 'diagnosticos' %}
                <!-- Subsistema: Diagnósticos -->
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Registrar Diagnóstico</h2>
                    <p class="text-gray-600">Selecciona una cita pendiente y registra el diagnóstico</p>
                </div>

                <!-- Lista de citas pendientes -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Citas Pendientes de Diagnóstico</h3>
                    
                    {% if citas_pendientes %}
                    <div class="space-y-3">
                        {% for cita in citas_pendientes %}
                        <div class="flex items-center gap-4 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-xl hover:shadow-md transition-shadow">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-yellow-500 rounded-full flex items-center justify-center text-white font-bold">
                                    {{ cita.paciente.split()[0][0] }}{{ cita.paciente.split()[1][0] if cita.paciente.split()|length > 1 else '' }}
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">{{ cita.paciente }}</h4>
                                <p class="text-sm text-gray-600">DNI: {{ cita.dni }} | Fecha: {{ cita.fecha.strftime('%d/%m/%Y') if cita.fecha else 'N/A' }} - {{ cita.hora }}</p>
                            </div>
                            <div>
                                <button onclick="abrirFormularioDiagnostico({{ cita.id_cita }}, '{{ cita.paciente }}', '{{ cita.dni }}')" 
                                        class="px-4 py-2 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg hover:from-cyan-600 hover:to-teal-600 transition-all font-semibold text-sm flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm">edit_note</span>
                                    Registrar Diagnóstico
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <span class="material-symbols-outlined text-5xl mb-2 block text-gray-400">task_alt</span>
                        <p class="font-medium">No hay citas pendientes de diagnóstico</p>
                        <p class="text-sm mt-1">Todas las citas han sido completadas</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Formulario de diagnóstico (oculto por defecto) -->
                <div id="form-diagnostico" class="hidden bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Registrar Diagnóstico</h3>
                        <p class="text-sm text-gray-600 mt-1" id="form-paciente-info">Paciente: -</p>
                    </div>

                    <form id="diagnostico-form" class="space-y-6">
                        <input type="hidden" id="id_cita" name="id_cita">

                        <!-- Diagnóstico -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Diagnóstico <span class="text-red-500">*</span>
                            </label>
                            <textarea id="diagnostico" name="diagnostico" rows="4" required
                                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent" 
                                      placeholder="Ingresa el diagnóstico médico..."></textarea>
                        </div>

                        <!-- Observaciones -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Observaciones</label>
                            <textarea id="observaciones" name="observaciones" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent" 
                                      placeholder="Observaciones adicionales, indicaciones, etc..."></textarea>
                        </div>

                        <!-- Botones -->
                        <div class="flex gap-4">
                            <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-xl hover:from-cyan-600 hover:to-teal-600 transition-all font-semibold shadow-md">
                                Guardar Diagnóstico
                            </button>
                            <button type="button" onclick="cerrarFormularioDiagnostico()" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-semibold">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
                {% endif %}

                {% if subsistema == 'notificaciones' %}
                <!-- Subsistema: Notificaciones -->
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Notificaciones</h2>
                    <p class="text-gray-600">Centro de notificaciones y alertas</p>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                    <div class="space-y-4">
                        <div class="p-4 bg-cyan-50 border border-cyan-200 rounded-xl flex items-start gap-4">
                            <span class="material-symbols-outlined text-cyan-600">notifications</span>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">Nueva cita asignada</h4>
                                <p class="text-sm text-gray-600 mt-1">Paciente: Juan Pérez - 10:00 AM</p>
                                <p class="text-xs text-gray-400 mt-1">Hace 5 minutos</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Panel Médico cargado correctamente');

            // Expandir desglose de tiempo empujando toda la fila hacia abajo (por HORA)
            const calendarCells = document.querySelectorAll('.calendar-cell');
            let activeHour = null;

            function toggleHourRow(hour) {
                const rowCells = document.querySelectorAll(`.calendar-cell[data-hour="${hour}"]`);
                let anyVisible = false;
                rowCells.forEach(c => {
                    const b = c.querySelector('.time-breakdown');
                    if (b && !b.classList.contains('hidden')) anyVisible = true;
                });

                // Ocultar anterior si es distinta
                if (activeHour !== null && activeHour !== String(hour)) {
                    const prevCells = document.querySelectorAll(`.calendar-cell[data-hour="${activeHour}"]`);
                    prevCells.forEach(c => {
                        const b = c.querySelector('.time-breakdown');
                        if (b) b.classList.add('hidden');
                    });
                }

                if (anyVisible) {
                    rowCells.forEach(c => {
                        const b = c.querySelector('.time-breakdown');
                        if (b) b.classList.add('hidden');
                    });
                    activeHour = null;
                } else {
                    rowCells.forEach(c => {
                        const b = c.querySelector('.time-breakdown');
                        if (b) b.classList.remove('hidden');
                    });
                    activeHour = String(hour);
                }
            }

            calendarCells.forEach(cell => {
                cell.addEventListener('click', function(e) {
                    if (e.target.closest('.absolute.inset-1') || e.target.closest('[data-minute]')) return;
                    e.stopPropagation();
                    const hour = this.dataset.hour;
                    toggleHourRow(hour);
                });
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.calendar-cell') && activeHour !== null) {
                    const cells = document.querySelectorAll(`.calendar-cell[data-hour="${activeHour}"]`);
                    cells.forEach(c => {
                        const b = c.querySelector('.time-breakdown');
                        if (b) b.classList.add('hidden');
                    });
                    activeHour = null;
                }
            });

            // Búsqueda de pacientes
            const buscarInput = document.getElementById('buscar-paciente');
            if (buscarInput) {
                buscarInput.addEventListener('input', function(e) {
                    const termino = e.target.value.toLowerCase();
                    const filas = document.querySelectorAll('.paciente-row');

                    filas.forEach(fila => {
                        const nombre = fila.dataset.nombre.toLowerCase();
                        const dni = fila.dataset.dni.toLowerCase();

                        if (nombre.includes(termino) || dni.includes(termino)) {
                            fila.style.display = '';
                        } else {
                            fila.style.display = 'none';
                        }
                    });
                });
            }

            // Formulario de diagnóstico
            const diagnosticoForm = document.getElementById('diagnostico-form');
            if (diagnosticoForm) {
                diagnosticoForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const formData = new FormData(this);

                    try {
                        const response = await fetch('/medico/diagnosticos/guardar', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert('Diagnóstico guardado exitosamente. La cita ha sido marcada como completada.');
                            window.location.reload();
                        } else {
                            alert('Error: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error al guardar el diagnóstico');
                    }
                });
            }

        });

        // Funciones para diagnósticos
        function abrirFormularioDiagnostico(idCita, nombrePaciente, dni) {
            document.getElementById('form-diagnostico').classList.remove('hidden');
            document.getElementById('id_cita').value = idCita;
            document.getElementById('form-paciente-info').textContent = `Paciente: ${nombrePaciente} - DNI: ${dni}`;
            document.getElementById('diagnostico').value = '';
            document.getElementById('observaciones').value = '';
            
            // Scroll al formulario
            document.getElementById('form-diagnostico').scrollIntoView({ behavior: 'smooth' });
        }

        function cerrarFormularioDiagnostico() {
            document.getElementById('form-diagnostico').classList.add('hidden');
        }

        // Funciones para historial de pacientes
        async function verHistorialPaciente(idPaciente) {
            try {
                const response = await fetch(`/medico/historial_paciente/${idPaciente}`);
                const result = await response.json();
                
                if (result.success) {
                    mostrarModalHistorial(result.paciente, result.historial);
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar el historial');
            }
        }

        function mostrarModalHistorial(paciente, historial) {
            const modal = document.getElementById('modal-historial');
            const nombreEl = document.getElementById('modal-paciente-nombre');
            const infoEl = document.getElementById('modal-paciente-info');
            const contenidoEl = document.getElementById('modal-historial-contenido');
            
            nombreEl.textContent = `Historial Médico - ${paciente.nombre}`;
            infoEl.textContent = `DNI: ${paciente.dni} | Edad: ${paciente.edad} años`;
            
            // Construir HTML del historial
            let html = '<div class="space-y-4">';
            
            if (historial.length === 0) {
                html += `
                    <div class="text-center py-8 text-gray-500">
                        <span class="material-symbols-outlined text-5xl mb-2 block text-gray-400">folder_off</span>
                        <p>No hay historial disponible</p>
                    </div>
                `;
            } else {
                historial.forEach(cita => {
                    const estadoClass = cita.estado === 'Completada' ? 'bg-emerald-100 text-emerald-700' : 
                                       cita.estado === 'Pendiente' ? 'bg-amber-100 text-amber-700' : 
                                       cita.estado === 'Confirmada' ? 'bg-blue-100 text-blue-700' :
                                       'bg-gray-100 text-gray-700';
                    
                    html += `
                        <div class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow bg-gradient-to-r from-white to-gray-50">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <span class="material-symbols-outlined text-cyan-600 text-2xl">event</span>
                                    <div>
                                        <p class="font-semibold text-gray-800">${cita.fecha}</p>
                                        <p class="text-sm text-gray-600 flex items-center gap-1">
                                            <span class="material-symbols-outlined text-xs">schedule</span>
                                            ${cita.hora}
                                        </p>
                                    </div>
                                </div>
                                <span class="px-3 py-1 ${estadoClass} rounded-full text-xs font-semibold shadow-sm">
                                    ${cita.estado}
                                </span>
                            </div>
                            ${cita.diagnostico && cita.diagnostico.trim() !== '' ? `
                                <div class="mt-3 pt-3 border-t border-gray-200">
                                    <p class="text-sm font-semibold text-gray-700 mb-1 flex items-center gap-1">
                                        <span class="material-symbols-outlined text-sm">clinical_notes</span>
                                        Diagnóstico:
                                    </p>
                                    <p class="text-sm text-gray-600 pl-5">${cita.diagnostico}</p>
                                </div>
                            ` : ''}
                            ${cita.observaciones && cita.observaciones.trim() !== '' ? `
                                <div class="mt-2 ${cita.diagnostico && cita.diagnostico.trim() !== '' ? '' : 'pt-3 border-t border-gray-200'}">
                                    <p class="text-sm font-semibold text-gray-700 mb-1 flex items-center gap-1">
                                        <span class="material-symbols-outlined text-sm">note</span>
                                        Observaciones:
                                    </p>
                                    <p class="text-sm text-gray-600 pl-5">${cita.observaciones}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            contenidoEl.innerHTML = html;
            
            modal.classList.remove('hidden');
        }

        function cerrarModalHistorial() {
            document.getElementById('modal-historial').classList.add('hidden');
        }

        // Cerrar modal al hacer clic fuera
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('modal-historial');
            if (modal && e.target === modal) {
                cerrarModalHistorial();
            }
        });

        // Funciones para navegación del calendario
        function cambiarSemana(direccion) {
            // Esta función se puede implementar para navegar entre semanas
            console.log(`Cambiar semana: ${direccion > 0 ? 'siguiente' : 'anterior'}`);
            // Aquí se puede hacer una petición al servidor para obtener las citas de otra semana
            alert(`Navegación de semanas: Próximamente disponible. Se mostraría la semana ${direccion > 0 ? 'siguiente' : 'anterior'}.`);
        }

        function irHoy() {
            console.log('Ir a la semana actual');
            // Recargar la página para mostrar la semana actual
            window.location.href = '/medico/panel?subsistema=agenda';
        }

        // Funciones para manejo de eventos en el calendario
        function abrirFormularioEvento(dia, hora, minutos = 0) {
            const dias = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
            const horarioFormato = `${String(hora).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
            console.log(`Crear evento para ${dias[dia]} a las ${horarioFormato}`);
            alert(`Función para crear evento:\nDía: ${dias[dia]}\nHora: ${horarioFormato}\n\nPróximamente disponible.`);
        }

        function nuevoEvento() {
            console.log('Crear nuevo evento');
            alert('Función para crear un nuevo evento.\nPróximamente disponible.');
        }

        function verDetalleEvento(eventId) {
            console.log(`Ver detalles del evento ${eventId}`);
            alert(`Ver detalles del evento ${eventId}.\nPróximamente disponible.`);
        }

        function verDetalleCita(citaId) {
            console.log(`Ver detalles de la cita ${citaId}`);
            alert(`Vista de detalles de la cita ${citaId}.\nAquí podrás ver:\n- Información del paciente\n- Tipo de consulta\n- Diagnóstico (si existe)\n- Estado de la cita\n\nPróximamente disponible.`);
        }
    </script>
</body>
</html>
