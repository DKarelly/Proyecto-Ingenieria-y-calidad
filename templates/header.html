<link rel="stylesheet" href="{{ url_for('static', filename='css/forms.css') }}">
<!-- Exponer usuario en JS (desde sesión) -->
<script>
    window.usuario = {{ usuario|tojson if usuario else 'null' }};
</script>
<!-- Header Fijo -->
<header id="main-header" class="fixed top-0 left-0 w-full z-50 bg-white/80 backdrop-blur-sm transition-shadow duration-300">
    <div class="container mx-auto px-4 flex justify-between items-center py-4">
        <a href="/" class="flex items-center">
            <img src="{{ url_for('static', filename='images/logo1.png') }}" alt="Clínica Unión" class="h-12 w-auto">
        </a>
        <nav class="hidden md:flex items-center gap-8">
            <a href="/#nosotros" class="hover:text-cyan-500 transition-colors duration-300">Nosotros</a>
            <a href="/#servicios" class="hover:text-cyan-500 transition-colors duration-300">Servicios</a>
            <a href="/#especialidades" class="hover:text-cyan-500 transition-colors duration-300">Especialidades</a>
            <a href="/#contacto" class="hover:text-cyan-500 transition-colors duration-300">Contáctanos</a>
        </nav>
        <div class="flex items-center gap-4">
            {% if session.get('usuario_id') %}
            <!-- Botón de Notificaciones (solo para pacientes) -->
            {% if session.get('tipo_usuario') == 'paciente' %}
            <div class="relative">
                <button id="notificacionesBtn" class="relative w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center hover:bg-cyan-50 transition-colors duration-300 group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 group-hover:text-cyan-600">
                        <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                        <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
                    </svg>
                    <!-- Badge de notificaciones no leídas -->
                    <span id="notificacionesBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">0</span>
                </button>

                <!-- Dropdown de Notificaciones -->
                <div id="notificacionesDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-2xl py-2 z-10 border border-gray-100">
                    <div class="px-4 py-3 border-b border-gray-100">
                        <h3 class="font-semibold text-gray-800">Notificaciones</h3>
                    </div>
                    <div id="notificacionesLista" class="max-h-96 overflow-y-auto">
                        <!-- Las notificaciones se cargarán dinámicamente aquí -->
                        <div class="px-4 py-8 text-center text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-300 mb-2">
                                <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                                <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
                            </svg>
                            <p class="text-sm">No tienes notificaciones</p>
                        </div>
                    </div>
                    <div class="px-4 py-2 border-t border-gray-100">
                        <a href="/notificaciones/historial" class="text-sm text-cyan-600 hover:text-cyan-700 font-medium">Ver todas las notificaciones</a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Menú de Usuario -->
            <div class="relative">
                <button id="userMenuBtn" class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-full flex items-center justify-center text-white font-bold hover:from-cyan-600 hover:to-blue-600 transition-all duration-300 shadow-md hover:shadow-lg">
                    {{ (session.get('nombre_usuario', 'U') or 'U')[0].upper() }}
                </button>

                <!-- Dropdown del Menú de Usuario -->
                <div id="userMenuDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-2xl py-2 z-10 border border-gray-100">
                    <a href="/usuarios/perfil" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-cyan-50 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        <span class="font-medium">Perfil</span>
                    </a>

                    {% if session.get('tipo_usuario') == 'paciente' %}
                    <!-- Opciones específicas para Pacientes -->
                    <div class="border-t border-gray-100 my-2"></div>

                    <a href="/reservas/paciente/historial" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-cyan-50 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <span class="font-medium">Historial de Reservas</span>
                    </a>

                    <a href="/paciente/historial-clinico" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-cyan-50 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        <span class="font-medium">Historial Clínico</span>
                    </a>

                    <!-- Submenú de Incidencias -->
                    <div class="relative">
                        <button id="incidenciasMenuBtn" class="w-full flex items-center justify-between gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-cyan-50 transition-colors duration-200">
                            <div class="flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                                <span class="font-medium">Incidencias</span>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 transform transition-transform duration-200" id="incidenciasChevron" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                        <div id="incidenciasSubmenu" class="hidden bg-gray-50 border-l-2 border-cyan-500 ml-4">
                            <a href="/paciente/incidencias/generar" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-600 hover:bg-cyan-50 hover:text-cyan-700 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                <span>Generar Incidencia</span>
                            </a>
                            <a href="/paciente/incidencias/historial" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-600 hover:bg-cyan-50 hover:text-cyan-700 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                                <span>Historial</span>
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    {% if session.get('tipo_usuario') == 'empleado' and session.get('id_rol') in [1, 2, 3, 4, 5] %}
                    <!-- Opciones para Empleados -->
                    <div class="border-t border-gray-100 my-2"></div>
                    <a href="/admin/panel" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-cyan-50 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2 2z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z" /></svg>
                        <span class="font-medium">Dashboard</span>
                    </a>
                    {% endif %}

                    <div class="border-t border-gray-100 my-2"></div>
                    <a href="/logout" class="flex items-center gap-3 px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                        <span class="font-medium">Cerrar Sesión</span>
                    </a>
                </div>
            </div>
            {% else %}
            <div id="user-auth-button" class="relative cursor-pointer">
                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user text-gray-600"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                </div>
            </div>
            {% endif %}
            <button id="mobile-menu-button" class="md:hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
            </button>
        </div>
    </div>
</header>

<script>
    // Menús desplegables en header
    document.addEventListener('DOMContentLoaded', function() {
        // Menú de usuario
        const userMenuBtn = document.getElementById('userMenuBtn');
        const userMenuDropdown = document.getElementById('userMenuDropdown');

        if (userMenuBtn && userMenuDropdown) {
            userMenuBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                userMenuDropdown.classList.toggle('hidden');
                // Cerrar notificaciones si está abierto
                const notificacionesDropdown = document.getElementById('notificacionesDropdown');
                if (notificacionesDropdown) {
                    notificacionesDropdown.classList.add('hidden');
                }
            });

            // Cerrar el menú al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!userMenuBtn.contains(e.target) && !userMenuDropdown.contains(e.target)) {
                    userMenuDropdown.classList.add('hidden');
                }
            });
        }

        // Menú de notificaciones
        const notificacionesBtn = document.getElementById('notificacionesBtn');
        const notificacionesDropdown = document.getElementById('notificacionesDropdown');

        if (notificacionesBtn && notificacionesDropdown) {
            notificacionesBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                notificacionesDropdown.classList.toggle('hidden');
                // Cerrar menú de usuario si está abierto
                if (userMenuDropdown) {
                    userMenuDropdown.classList.add('hidden');
                }
                // Cargar notificaciones al abrir
                if (!notificacionesDropdown.classList.contains('hidden')) {
                    cargarNotificaciones();
                }
            });

            // Cerrar el menú al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!notificacionesBtn.contains(e.target) && !notificacionesDropdown.contains(e.target)) {
                    notificacionesDropdown.classList.add('hidden');
                }
            });
        }

        // Submenú de incidencias
        const incidenciasMenuBtn = document.getElementById('incidenciasMenuBtn');
        const incidenciasSubmenu = document.getElementById('incidenciasSubmenu');
        const incidenciasChevron = document.getElementById('incidenciasChevron');

        if (incidenciasMenuBtn && incidenciasSubmenu) {
            incidenciasMenuBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                incidenciasSubmenu.classList.toggle('hidden');
                // Rotar el chevron
                if (incidenciasChevron) {
                    incidenciasChevron.classList.toggle('rotate-90');
                }
            });
        }

        // Cargar notificaciones iniciales (solo para pacientes)
        if (notificacionesBtn) {
            cargarNotificacionesContador();
            // Actualizar cada 30 segundos
            setInterval(cargarNotificacionesContador, 30000);
        }
    });

    // Función para cargar el contador de notificaciones
    async function cargarNotificacionesContador() {
        try {
            const response = await fetch('/notificaciones/api/no-leidas-count');
            const data = await response.json();

            const badge = document.getElementById('notificacionesBadge');
            if (badge) {
                if (data.count > 0) {
                    badge.textContent = data.count > 99 ? '99+' : data.count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        } catch (error) {
            console.error('Error al cargar contador de notificaciones:', error);
        }
    }

    // Función para cargar la lista de notificaciones
    async function cargarNotificaciones() {
        try {
            const response = await fetch('/notificaciones/api/recientes');
            const data = await response.json();

            const lista = document.getElementById('notificacionesLista');
            if (!lista) return;

            if (data.notificaciones && data.notificaciones.length > 0) {
                lista.innerHTML = data.notificaciones.map(notif => `
                    <div class="px-4 py-3 hover:bg-gray-50 transition-colors duration-200 border-b border-gray-100 ${notif.leida ? '' : 'bg-cyan-50'}">
                        <div class="flex items-start gap-3">
                            <div class="w-2 h-2 rounded-full ${notif.leida ? 'bg-gray-300' : 'bg-cyan-500'} mt-2 flex-shrink-0"></div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800">${notif.titulo}</p>
                                <p class="text-xs text-gray-600 mt-1">${notif.mensaje}</p>
                                <p class="text-xs text-gray-400 mt-1">${formatearFecha(notif.fecha_creacion)}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                lista.innerHTML = `
                    <div class="px-4 py-8 text-center text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-300 mb-2">
                            <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                            <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
                        </svg>
                        <p class="text-sm">No tienes notificaciones</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error al cargar notificaciones:', error);
        }
    }

    // Función auxiliar para formatear fechas
    function formatearFecha(fechaStr) {
        const fecha = new Date(fechaStr);
        const ahora = new Date();
        const diff = Math.floor((ahora - fecha) / 1000); // diferencia en segundos

        if (diff < 60) return 'Hace un momento';
        if (diff < 3600) return `Hace ${Math.floor(diff / 60)} minutos`;
        if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} horas`;
        if (diff < 604800) return `Hace ${Math.floor(diff / 86400)} días`;

        return fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
    }
</script>

<!-- Menú Móvil -->
<div id="mobile-menu" class="fixed top-0 right-0 h-full w-64 bg-white shadow-lg z-[60] p-6 transform translate-x-full md:hidden">
    <div class="flex justify-between items-center mb-8">
        <h2 class="text-xl font-bold">Menú</h2>
        <button id="mobile-menu-close">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
    </div>
    <nav class="flex flex-col gap-6">
        <a href="/#nosotros" class="text-lg hover:text-cyan-500 transition-colors duration-300 mobile-link">Nosotros</a>
        <a href="/#servicios" class="text-lg hover:text-cyan-500 transition-colors duration-300 mobile-link">Servicios</a>
        <a href="/#especialidades" class="text-lg hover:text-cyan-500 transition-colors duration-300 mobile-link">Especialidades</a>
        <a href="/#contacto" class="text-lg hover:text-cyan-500 transition-colors duration-300 mobile-link">Contáctanos</a>
    </nav>
</div>
