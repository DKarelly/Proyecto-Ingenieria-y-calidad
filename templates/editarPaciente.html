<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Paciente - Clínica Unión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/forms.css') }}">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="text-gray-700">
    <div class="container mx-auto">
        {% include 'header_admin.html' %}

    <div class="max-w-4xl mx-auto p-6 md:p-10">
        <!-- Botón de regreso -->
        <div class="mb-6">
            <a href="/usuarios/gestion" class="inline-flex items-center text-cyan-600 hover:text-cyan-800 font-medium transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Volver a Gestión de Pacientes
            </a>
        </div>

        <!-- Título principal -->
        <h1 class="text-3xl font-bold text-gray-800 mb-8">Editar Paciente</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-4 rounded-lg {% if category == 'error' or category == 'danger' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Form Card -->
        <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-8 md:p-10 transform transition-all hover:shadow-2xl">
            <!-- Encabezado del formulario con ícono -->
            <div class="flex items-center gap-4 mb-8 pb-6 border-b border-gray-200">
                <div class="bg-gradient-to-br from-cyan-500 to-blue-600 rounded-2xl p-4 shadow-lg">
                    <i class="fa-solid fa-user-edit text-white text-3xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Datos del Paciente</h2>
                    <p class="text-gray-600 text-sm mt-1">Actualice la información necesaria</p>
                </div>
            </div>

            <form method="POST" action="/cuentas/editar-paciente/{{ paciente.id_paciente }}" class="space-y-6">
                <!-- Nombres y Apellidos -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2" for="nombres">
                            <i class="fa-solid fa-user text-cyan-600"></i>
                            Nombres <span class="text-red-500">*</span>
                        </label>
                        <input
                            class="w-full px-4 py-3 border-2 border-gray-200 focus:border-cyan-500 focus:ring-4 focus:ring-cyan-100 text-gray-700 placeholder-gray-400 bg-white rounded-xl transition-all hover:border-gray-300"
                            id="nombres"
                            name="nombres"
                            value="{{ paciente.nombres }}"
                            type="text"
                            placeholder="Ej: Juan Carlos"
                            required
                        />
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2" for="apellidos">
                            <i class="fa-solid fa-user text-cyan-600"></i>
                            Apellidos <span class="text-red-500">*</span>
                        </label>
                        <input
                            class="w-full px-4 py-3 border-2 border-gray-200 focus:border-cyan-500 focus:ring-4 focus:ring-cyan-100 text-gray-700 placeholder-gray-400 bg-white rounded-xl transition-all hover:border-gray-300"
                            id="apellidos"
                            name="apellidos"
                            value="{{ paciente.apellidos }}"
                            type="text"
                            placeholder="Ej: Pérez López"
                            required
                        />
                    </div>
                </div>

                <!-- Documento de Identidad -->
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2" for="documento_identidad">
                        <i class="fa-solid fa-id-card text-cyan-600"></i>
                        Documento de Identidad (DNI) <span class="text-red-500">*</span>
                    </label>
                    <input
                        class="w-full px-4 py-3 border-2 border-gray-200 focus:border-cyan-500 focus:ring-4 focus:ring-cyan-100 text-gray-700 placeholder-gray-400 bg-white rounded-xl transition-all hover:border-gray-300"
                        id="documento_identidad"
                        name="documento_identidad"
                        value="{{ paciente.documento_identidad }}"
                        type="text"
                        pattern="[0-9]{8}"
                        maxlength="8"
                        placeholder="12345678"
                        required
                    />
                    <p class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                        <i class="fa-solid fa-info-circle"></i>
                        Ingrese 8 dígitos sin espacios
                    </p>
                </div>

                <!-- Teléfono y Fecha de Nacimiento -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2" for="telefono">
                            <i class="fa-solid fa-phone text-cyan-600"></i>
                            Teléfono <span class="text-red-500">*</span>
                        </label>
                        <input
                            class="w-full px-4 py-3 border-2 border-gray-200 focus:border-cyan-500 focus:ring-4 focus:ring-cyan-100 text-gray-700 placeholder-gray-400 bg-white rounded-xl transition-all hover:border-gray-300"
                            id="telefono"
                            name="telefono"
                            value="{{ paciente.telefono }}"
                            type="tel"
                            pattern="[0-9]{9}"
                            maxlength="9"
                            placeholder="987654321"
                            required
                        />
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2" for="fecha_nacimiento">
                            <i class="fa-solid fa-calendar text-cyan-600"></i>
                            Fecha de Nacimiento <span class="text-red-500">*</span>
                        </label>
                        <input
                            class="w-full px-4 py-3 border-2 border-gray-200 focus:border-cyan-500 focus:ring-4 focus:ring-cyan-100 text-gray-700 placeholder-gray-400 bg-white rounded-xl transition-all hover:border-gray-300"
                            id="fecha_nacimiento"
                            name="fecha_nacimiento"
                            value="{{ paciente.fecha_nacimiento }}"
                            type="date"
                            required
                        />
                    </div>
                </div>

                <!-- Correo Electrónico -->
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2" for="correo">
                        <i class="fa-solid fa-envelope text-cyan-600"></i>
                        Correo Electrónico <span class="text-red-500">*</span>
                    </label>
                    <input
                        class="w-full px-4 py-3 border-2 border-gray-200 focus:border-cyan-500 focus:ring-4 focus:ring-cyan-100 text-gray-700 placeholder-gray-400 bg-white rounded-xl transition-all hover:border-gray-300"
                        id="correo"
                        name="correo"
                        value="{{ paciente.correo }}"
                        type="email"
                        placeholder="tu@email.com"
                        required
                    />
                </div>

                <!-- Sexo y Estado -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-venus-mars text-cyan-600"></i>
                            Sexo <span class="text-red-500">*</span>
                        </label>
                        <div class="flex items-center space-x-8">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="sexo" value="Masculino" {% if paciente.sexo == 'Masculino' or paciente.sexo == 'M' %}checked{% endif %} class="h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-300" required>
                                <span class="ml-2 text-gray-700">Masculino</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="sexo" value="Femenino" {% if paciente.sexo == 'Femenino' or paciente.sexo == 'F' %}checked{% endif %} class="h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-300" required>
                                <span class="ml-2 text-gray-700">Femenino</span>
                            </label>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2" for="estado">
                            <i class="fa-solid fa-toggle-on text-cyan-600"></i>
                            Estado <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <select
                                class="w-full px-4 py-3 border-2 border-gray-200 focus:border-cyan-500 focus:ring-4 focus:ring-cyan-100 text-gray-700 bg-white rounded-xl transition-all hover:border-gray-300 appearance-none cursor-pointer"
                                id="estado"
                                name="estado"
                                required
                            >
                                <option value="Activo" {% if paciente.estado == 'Activo' %}selected{% endif %}>Activo</option>
                                <option value="Inactivo" {% if paciente.estado == 'Inactivo' %}selected{% endif %}>Inactivo</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>
                </div>

                <!-- Departamento, Provincia, Distrito -->
                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-6 rounded-2xl border-2 border-blue-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-map-location-dot text-blue-600"></i>
                        Dirección
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2" for="departamento">
                                Departamento <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <select
                                    class="w-full px-4 py-3 border-2 border-gray-200 focus:border-cyan-500 focus:ring-4 focus:ring-cyan-100 text-gray-700 bg-white rounded-xl transition-all hover:border-gray-300 appearance-none cursor-pointer"
                                    id="departamento"
                                    required
                                >
                                    <option value="">Seleccione un departamento...</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2" for="provincia">
                                Provincia <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <select
                                    class="w-full px-4 py-3 border-2 border-gray-200 focus:border-cyan-500 focus:ring-4 focus:ring-cyan-100 text-gray-700 bg-white rounded-xl transition-all hover:border-gray-300 appearance-none cursor-pointer disabled:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-60"
                                    id="provincia"
                                    disabled
                                    required
                                >
                                    <option value="">Seleccione un departamento primero...</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2" for="distrito">
                                Distrito <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <select
                                    class="w-full px-4 py-3 border-2 border-gray-200 focus:border-cyan-500 focus:ring-4 focus:ring-cyan-100 text-gray-700 bg-white rounded-xl transition-all hover:border-gray-300 appearance-none cursor-pointer disabled:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-60"
                                    id="distrito"
                                    name="id_ubicacion"
                                    disabled
                                    required
                                >
                                    <option value="">Seleccione una provincia primero...</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones -->
                <div class="pt-6">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button
                            type="submit"
                            class="flex-1 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 inline-flex items-center justify-center shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            <i class="fa-solid fa-save mr-2 text-xl"></i>
                            Guardar Cambios
                        </button>
                        <a
                            href="/usuarios/gestion"
                            class="flex-1 px-6 py-4 border-2 border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50 font-bold transition-all hover:border-gray-400 text-center inline-flex items-center justify-center">
                            <i class="fa-solid fa-times mr-2 text-xl"></i>
                            Cancelar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
    </div>

<script>
    const pacienteData = {
        id_distrito: {{ paciente.id_ubicacion or 0 }},
        distrito: "{{ paciente.distrito }}",
        provincia: "{{ paciente.provincia }}",
        departamento: "{{ paciente.departamento }}"
    };

    let departamentos = [];
    let provincias = [];
    let distritos = [];

    // Cargar departamentos al inicio
    async function cargarDepartamentos() {
        try {
            const response = await fetch('/usuarios/api/departamentos');
            departamentos = await response.json();

            const selectDepartamento = document.getElementById('departamento');
            selectDepartamento.innerHTML = '<option value="">Seleccione un departamento...</option>';

            departamentos.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id_departamento;
                option.textContent = dept.nombre_departamento || dept.nombre;
                selectDepartamento.appendChild(option);
            });

            // Si hay departamento preseleccionado, encontrarlo y seleccionarlo
            if (pacienteData.departamento) {
                const deptEncontrado = departamentos.find(d => (d.nombre_departamento || d.nombre) === pacienteData.departamento);
                if (deptEncontrado) {
                    selectDepartamento.value = deptEncontrado.id_departamento;
                    await cargarProvincias(deptEncontrado.id_departamento, true);
                }
            }
        } catch (error) {
            console.error('Error al cargar departamentos:', error);
        }
    }

    // Cargar provincias según departamento
    async function cargarProvincias(id_departamento, preseleccionar = false) {
        try {
            const response = await fetch(`/usuarios/api/provincias/${id_departamento}`);
            provincias = await response.json();

            const selectProvincia = document.getElementById('provincia');
            const selectDistrito = document.getElementById('distrito');

            selectProvincia.innerHTML = '<option value="">Seleccione una provincia...</option>';
            selectDistrito.innerHTML = '<option value="">Seleccione una provincia primero...</option>';
            selectDistrito.disabled = true;

            provincias.forEach(prov => {
                const option = document.createElement('option');
                option.value = prov.id_provincia;
                option.textContent = prov.nombre_provincia || prov.nombre;
                selectProvincia.appendChild(option);
            });

            selectProvincia.disabled = false;

            // Si hay provincia preseleccionada, encontrarla y seleccionarla
            if (preseleccionar && pacienteData.provincia) {
                const provEncontrada = provincias.find(p => (p.nombre_provincia || p.nombre) === pacienteData.provincia);
                if (provEncontrada) {
                    selectProvincia.value = provEncontrada.id_provincia;
                    await cargarDistritos(provEncontrada.id_provincia, true);
                }
            }
        } catch (error) {
            console.error('Error al cargar provincias:', error);
        }
    }

    // Cargar distritos según provincia
    async function cargarDistritos(id_provincia, preseleccionar = false) {
        try {
            const response = await fetch(`/usuarios/api/distritos/${id_provincia}`);
            distritos = await response.json();

            const selectDistrito = document.getElementById('distrito');
            selectDistrito.innerHTML = '<option value="">Seleccione un distrito...</option>';

            distritos.forEach(dist => {
                const option = document.createElement('option');
                option.value = dist.id_distrito;
                option.textContent = dist.nombre_distrito || dist.nombre;
                selectDistrito.appendChild(option);
            });

            selectDistrito.disabled = false;

            // Si hay distrito preseleccionado, seleccionarlo
            if (preseleccionar && pacienteData.id_distrito) {
                selectDistrito.value = pacienteData.id_distrito;
            }
        } catch (error) {
            console.error('Error al cargar distritos:', error);
        }
    }

    // Event Listeners
    document.getElementById('departamento').addEventListener('change', function() {
        const id_departamento = this.value;
        const selectProvincia = document.getElementById('provincia');
        const selectDistrito = document.getElementById('distrito');

        if (id_departamento) {
            cargarProvincias(id_departamento);
        } else {
            selectProvincia.innerHTML = '<option value="">Seleccione un departamento primero...</option>';
            selectProvincia.disabled = true;
            selectDistrito.innerHTML = '<option value="">Seleccione una provincia primero...</option>';
            selectDistrito.disabled = true;
        }
    });

    document.getElementById('provincia').addEventListener('change', function() {
        const id_provincia = this.value;
        const selectDistrito = document.getElementById('distrito');

        if (id_provincia) {
            cargarDistritos(id_provincia);
        } else {
            selectDistrito.innerHTML = '<option value="">Seleccione una provincia primero...</option>';
            selectDistrito.disabled = true;
        }
    });

    // Inicializar
    cargarDepartamentos();
</script>
</body>
</html>
