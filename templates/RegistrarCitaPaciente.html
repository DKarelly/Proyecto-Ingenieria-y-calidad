<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Cita - Clínica Unión</title>

    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-active {
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            color: white;
        }
        .step-completed {
            background: #10b981;
            color: white;
        }
        .step-inactive {
            background: #e5e7eb;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-50">

    {% include 'header.html' %}

    <div class="container mx-auto px-4 pt-24 pb-12">

        <!-- Header Section -->
        <div class="max-w-4xl mx-auto mb-8">
            <a href="/" class="inline-flex items-center text-cyan-600 hover:text-cyan-700 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
                </svg>
                Volver al inicio
            </a>

            <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-2xl flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/>
                            <path d="M3 10h18"/><path d="M10 16h4"/><path d="M12 14v4"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Agendar Nueva Cita</h1>
                        <p class="text-gray-600">Completa los pasos para reservar tu consulta médica</p>
                    </div>
                </div>

                <!-- Step Indicators -->
                <div class="flex items-center justify-between mt-8">
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step1-indicator" class="step-indicator step-active w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">1</div>
                        <span id="step1-text" class="text-sm font-medium text-cyan-600">Especialidad</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2" id="line1"></div>
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step2-indicator" class="step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">2</div>
                        <span id="step2-text" class="text-sm font-medium text-gray-400">Médico</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2" id="line2"></div>
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step3-indicator" class="step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">3</div>
                        <span id="step3-text" class="text-sm font-medium text-gray-400">Horario</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2" id="line3"></div>
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step4-indicator" class="step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">4</div>
                        <span id="step4-text" class="text-sm font-medium text-gray-400">Confirmar</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Form Container -->
        <div class="max-w-4xl mx-auto">
            <form id="citaForm" class="bg-white rounded-2xl shadow-lg p-8">

                <!-- Step 1: Seleccionar Especialidad/Servicio -->
                <div id="step1" class="step-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 1: Selecciona la Especialidad</h2>

                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-3">¿Qué especialidad médica necesitas?</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="especialidadesContainer">
                            <!-- Las especialidades se cargarán dinámicamente aquí -->
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button type="button" id="btn-step1-next" disabled class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                            Continuar
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline ml-2">
                                <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Seleccionar Médico -->
                <div id="step2" class="step-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 2: Selecciona tu Médico</h2>

                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-3">Médicos disponibles para <span id="especialidadSeleccionada" class="text-cyan-600"></span></label>
                        <div class="grid grid-cols-1 gap-4" id="medicosContainer">
                            <!-- Los médicos se cargarán dinámicamente aquí -->
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" id="btn-step2-prev" class="bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded-lg hover:bg-gray-300 transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
                            </svg>
                            Atrás
                        </button>
                        <button type="button" id="btn-step2-next" disabled class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                            Continuar
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline ml-2">
                                <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Seleccionar Horario -->
                <div id="step3" class="step-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 3: Selecciona Fecha y Horario</h2>

                    <div class="mb-6">
                        <!-- Info del médico seleccionado -->
                        <div class="bg-gradient-to-r from-cyan-50 to-blue-50 border border-cyan-200 rounded-lg p-4 mb-6">
                            <div class="flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600">
                                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                                </svg>
                                <div>
                                    <p class="text-sm text-gray-600">Médico seleccionado:</p>
                                    <p id="medicoNombreHorario" class="font-semibold text-gray-800"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Navegación de semana -->
                        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm">
                            <div class="flex items-center justify-between">
                                <button 
                                    type="button" 
                                    id="btnSemanaAnterior" 
                                    class="flex items-center gap-2 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="m15 18-6-6 6-6"/>
                                    </svg>
                                    Anterior
                                </button>
                                
                                <button 
                                    type="button"
                                    onclick="abrirModalSelectorMes()"
                                    class="text-center hover:bg-gray-50 rounded-lg px-4 py-2 transition-colors cursor-pointer"
                                >
                                    <p class="text-sm text-gray-600">Semana actual</p>
                                    <p id="rangoSemana" class="text-lg font-semibold text-gray-800"></p>
                                    <p class="text-xs text-cyan-600 mt-1">▼ Click para cambiar</p>
                                </button>
                                
                                <button 
                                    type="button" 
                                    id="btnSemanaSiguiente" 
                                    class="flex items-center gap-2 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors duration-200"
                                >
                                    Siguiente
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="m9 18 6-6-6-6"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Calendario FullCalendar -->
                        <div id="calendarContainer" class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                            <div id="calendar"></div>
                        </div>

                        <!-- Leyenda -->
                        <div class="mt-4 flex flex-wrap items-center gap-4 text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-green-500 rounded"></div>
                                <span class="text-gray-600">Disponible</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-red-500 rounded"></div>
                                <span class="text-gray-600">Ocupado</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-cyan-500 rounded"></div>
                                <span class="text-gray-600">Seleccionado</span>
                            </div>
                        </div>

                        <!-- Mensaje cuando no hay horarios -->
                        <div id="noHorarios" class="hidden text-center py-8 text-gray-500 mt-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-400 mb-3">
                                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
                            </svg>
                            <p>No hay horarios disponibles para este médico en la semana seleccionada.</p>
                            <p class="text-sm mt-2">Por favor, intenta con otra semana o selecciona otro médico.</p>
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" id="btn-step3-prev" class="bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded-lg hover:bg-gray-300 transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
                            </svg>
                            Atrás
                        </button>
                        <button type="button" id="btn-step3-next" disabled class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                            Continuar
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline ml-2">
                                <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 4: Confirmación -->
                <div id="step4" class="step-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 4: Confirmar tu Cita</h2>

                    <div class="bg-gradient-to-br from-cyan-50 to-blue-50 rounded-xl p-6 mb-6">
                        <h3 class="font-semibold text-lg text-gray-800 mb-4">Resumen de tu Cita</h3>

                        <div class="space-y-3">
                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600 mt-1">
                                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                                </svg>
                                <div>
                                    <p class="text-sm text-gray-600">Especialidad</p>
                                    <p id="resumen-servicio" class="font-semibold text-gray-800"></p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600 mt-1">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                </svg>
                                <div>
                                    <p class="text-sm text-gray-600">Médico</p>
                                    <p id="resumen-medico" class="font-semibold text-gray-800"></p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600 mt-1">
                                    <rect width="18" height="18" x="3" y="4" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/>
                                </svg>
                                <div>
                                    <p class="text-sm text-gray-600">Fecha y Hora</p>
                                    <p id="resumen-fecha" class="font-semibold text-gray-800"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                        <div class="flex">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500 mr-3 flex-shrink-0">
                                <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-blue-800">Importante</p>
                                <p class="text-sm text-blue-700">Por favor, llega 10 minutos antes de tu cita. Trae tu documento de identidad y cualquier resultado médico previo que consideres relevante.</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" id="btn-step4-prev" class="bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded-lg hover:bg-gray-300 transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
                            </svg>
                            Atrás
                        </button>
                        <button type="button" id="btn-confirmar" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-green-600 hover:to-emerald-600 transition-all duration-300 shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            Confirmar Cita
                        </button>
                    </div>
                </div>

            </form>
        </div>

        <!-- Modal de Éxito -->
        <div id="modalExito" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 transform scale-95 transition-transform">
                <div class="text-center">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">¡Cita Confirmada!</h3>
                    <p class="text-gray-600 mb-6">Tu cita ha sido agendada exitosamente. Recibirás un recordatorio antes de tu consulta.</p>
                    <a href="/" class="inline-block bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all duration-300">
                        Volver al Inicio
                    </a>
                </div>
            </div>
        </div>

        <!-- Modal de Detalle de Programación -->
        <div id="modalDetalleProgramacion" onclick="cerrarModalDetalleClick(event)" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div onclick="event.stopPropagation()" class="bg-white rounded-2xl shadow-2xl max-w-lg w-full transform scale-95 transition-transform">
                <div class="bg-gradient-to-r from-cyan-500 to-blue-500 p-6 rounded-t-2xl">
                    <div class="flex items-center justify-between">
                        <h3 class="text-2xl font-bold text-white">Detalle de Programación</h3>
                        <button onclick="cerrarModalDetalle()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="space-y-4">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-cyan-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600">
                                    <rect width="18" height="18" x="3" y="4" rx="2"/>
                                    <path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-500">Fecha</p>
                                <p id="detalleFecha" class="text-lg font-semibold text-gray-800"></p>
                            </div>
                        </div>

                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-600">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-500">Horario</p>
                                <p id="detalleHorario" class="text-lg font-semibold text-gray-800"></p>
                            </div>
                        </div>

                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-green-600">
                                    <path d="M9 11l3 3L22 4"/>
                                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-500">Servicio</p>
                                <p id="detalleServicio" class="text-lg font-semibold text-gray-800"></p>
                            </div>
                        </div>

                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-purple-600">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-500">Estado</p>
                                <p id="detalleEstado" class="text-lg font-semibold"></p>
                            </div>
                        </div>

                        <div id="detalleInfoAdicional" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600"></p>
                        </div>
                    </div>
                </div>

                <div id="modalDetalleFooter" class="bg-gray-50 p-6 rounded-b-2xl flex gap-3">
                    <!-- Los botones se generan dinámicamente según disponibilidad -->
                </div>
            </div>
        </div>

        <!-- Modal de Selector de Mes -->
        <div id="modalSelectorMes" onclick="cerrarModalSelectorMesClick(event)" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div onclick="event.stopPropagation()" class="bg-white rounded-lg shadow-2xl w-[440px] transform scale-95 transition-transform">
                <div class="p-6">
                    <!-- Navegación de mes -->
                    <div class="flex items-center justify-between mb-6">
                        <button id="btnMesAnterior" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="m15 18-6-6 6-6"/>
                            </svg>
                        </button>
                        <h4 id="nombreMesSelector" class="text-xl font-bold text-gray-800"></h4>
                        <button id="btnMesSiguiente" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="m9 18 6-6-6-6"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Calendario mensual -->
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px;" class="mb-4">
                        <div class="text-center text-sm font-semibold text-gray-600 py-2">L</div>
                        <div class="text-center text-sm font-semibold text-gray-600 py-2">M</div>
                        <div class="text-center text-sm font-semibold text-gray-600 py-2">X</div>
                        <div class="text-center text-sm font-semibold text-gray-600 py-2">J</div>
                        <div class="text-center text-sm font-semibold text-gray-600 py-2">V</div>
                        <div class="text-center text-sm font-semibold text-gray-600 py-2">S</div>
                        <div class="text-center text-sm font-semibold text-gray-600 py-2">D</div>
                    </div>
                    <div id="diasMesSelector" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px;"></div>
                </div>
            </div>
        </div>

    </div>

    {% include 'footer.html' %}

    <script>
        // Variables globales para el formulario
        let currentStep = 1;
        let formData = {
            id_especialidad: null,
            especialidad_nombre: '',
            id_empleado: null,
            empleado_nombre: '',
            id_programacion: null,
            fecha: '',
            hora_inicio: '',
            hora_fin: '',
            dia_semana: ''
        };

        // Configurar y cargar especialidades al iniciar
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[NuevaCita] Iniciando sistema de reservas');
            
            // Verificar si viene con médico y especialidad desde la URL (desde lista de médicos)
            const urlParams = new URLSearchParams(window.location.search);
            const idMedico = urlParams.get('medico');
            const idEspecialidad = urlParams.get('especialidad');
            
            if (idMedico && idEspecialidad) {
                // Si viene con médico y especialidad, saltar directamente al paso 3
                console.log('[NuevaCita] Detectado médico y especialidad en URL, saltando al paso 3');
                await preseleccionarMedicoYEspecialidad(idMedico, idEspecialidad);
                return; // Salir temprano, no cargar especialidades ni mostrar paso 1
            }
            
            await cargarEspecialidades();
            
            // Configurar fecha mínima en los buscadores de fecha (hoy)
            const fechaInicioEl = document.getElementById('fechaInicio');
            const fechaFinEl = document.getElementById('fechaFin');
            const hoy = new Date().toISOString().split('T')[0];
            
            if (fechaInicioEl) {
                fechaInicioEl.setAttribute('min', hoy);
                
                // Event listener para validar que fecha inicio <= fecha fin
                fechaInicioEl.addEventListener('change', function() {
                    if (fechaFinEl && fechaFinEl.value && this.value > fechaFinEl.value) {
                        fechaFinEl.value = this.value;
                    }
                    if (fechaFinEl) {
                        fechaFinEl.setAttribute('min', this.value || hoy);
                    }
                });
                
                // Event listener para Enter en el input de fecha inicio
                fechaInicioEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const btnBuscar = document.getElementById('btnBuscarFecha');
                        if (btnBuscar) btnBuscar.click();
                    }
                });
            }
            
            if (fechaFinEl) {
                fechaFinEl.setAttribute('min', hoy);
                
                // Event listener para validar que fecha fin >= fecha inicio
                fechaFinEl.addEventListener('change', function() {
                    if (fechaInicioEl && fechaInicioEl.value && this.value < fechaInicioEl.value) {
                        alert('La fecha fin debe ser mayor o igual a la fecha inicio.');
                        this.value = fechaInicioEl.value;
                    }
                });
                
                // Event listener para Enter en el input de fecha fin
                fechaFinEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const btnBuscar = document.getElementById('btnBuscarFecha');
                        if (btnBuscar) btnBuscar.click();
                    }
                });
            }
            
            // Event listener para buscar rango de fechas
            const btnBuscarFecha = document.getElementById('btnBuscarFecha');
            if (btnBuscarFecha) {
                btnBuscarFecha.addEventListener('click', async function() {
                    const fechaInicio = fechaInicioEl ? fechaInicioEl.value : null;
                    const fechaFin = fechaFinEl ? fechaFinEl.value : null;
                    
                    if (!fechaInicio || !fechaFin) {
                        alert('Por favor, selecciona ambas fechas (inicio y fin) para buscar.');
                        return;
                    }
                    
                    if (fechaInicio > fechaFin) {
                        alert('La fecha inicio debe ser menor o igual a la fecha fin.');
                        return;
                    }
                    
                    const hoyStr = new Date().toISOString().split('T')[0];
                    if (fechaInicio < hoyStr) {
                        alert('No puedes buscar horarios de fechas pasadas. Por favor, selecciona fechas desde hoy en adelante.');
                        return;
                    }
                    
                    console.log('[Paso3] Buscando horarios desde:', fechaInicio, 'hasta:', fechaFin);
                    await cargarHorariosSemanales(fechaInicio, fechaFin);
                });
            }
            
            // Event listener para limpiar fechas y volver a la semana actual
            const btnLimpiarFecha = document.getElementById('btnLimpiarFecha');
            if (btnLimpiarFecha) {
                btnLimpiarFecha.addEventListener('click', async function() {
                    if (fechaInicioEl) {
                        fechaInicioEl.value = '';
                    }
                    if (fechaFinEl) {
                        fechaFinEl.value = '';
                    }
                    
                    // Reiniciar a la semana actual
                    semanaActual = new Date();
                    actualizarRangoSemana();
                    
                    console.log('[Paso3] Regresando a la semana actual');
                    await cargarHorariosSemanales();
                });
            }

            // Navegación entre pasos
            const btnStep1Next = document.getElementById('btn-step1-next');
            if (btnStep1Next) {
                btnStep1Next.addEventListener('click', async () => {
                    goToStep(2);
                    await cargarMedicos();
                });
            }

            const btnStep2Prev = document.getElementById('btn-step2-prev');
            if (btnStep2Prev) {
                btnStep2Prev.addEventListener('click', () => goToStep(1));
            }

            const btnStep2Next = document.getElementById('btn-step2-next');
            if (btnStep2Next) {
                btnStep2Next.addEventListener('click', async () => {
                    goToStep(3);
                    
                    // Inicializar el calendario si no existe
                    if (!calendar) {
                        inicializarCalendario();
                    }
                    
                    // Cargar horarios de la semana actual
                    await cargarHorariosSemanales();
                });
            }
            
            const btnStep3Prev = document.getElementById('btn-step3-prev');
            if (btnStep3Prev) {
                btnStep3Prev.addEventListener('click', () => goToStep(2));
            }

            // Función para manejar el click en el botón continuar
            function handleContinuarClick(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                console.log('[Paso3] ========== Click en botón Continuar detectado ==========');
                console.log('[Paso3] formData al hacer click:', JSON.stringify(formData));
                
                // Validar que se haya seleccionado un horario antes de continuar
                if (!formData.id_programacion) {
                    console.error('[Paso3] Error: No hay id_programacion en formData');
                    alert('Por favor, seleccione un horario antes de continuar');
                    return false;
                }
                
                if (!formData.fecha) {
                    console.error('[Paso3] Error: No hay fecha en formData');
                    alert('Por favor, seleccione un horario antes de continuar');
                    return false;
                }
                
                if (!formData.hora_inicio) {
                    console.error('[Paso3] Error: No hay hora_inicio en formData');
                    alert('Por favor, seleccione un horario antes de continuar');
                    return false;
                }
                
                console.log('[Paso3] Validación pasada. Datos completos:', {
                    id_programacion: formData.id_programacion,
                    fecha: formData.fecha,
                    hora_inicio: formData.hora_inicio,
                    empleado_nombre: formData.empleado_nombre,
                    especialidad_nombre: formData.especialidad_nombre
                });
                
                console.log('[Paso3] Llamando a mostrarResumen()...');
                
                try {
                    mostrarResumen();
                    console.log('[Paso3] mostrarResumen() ejecutado correctamente');
                    
                    console.log('[Paso3] Llamando a goToStep(4)...');
                    goToStep(4);
                    console.log('[Paso3] goToStep(4) ejecutado correctamente');
                } catch (error) {
                    console.error('[Paso3] ERROR CAPTURADO al continuar al paso 4:', error);
                    console.error('[Paso3] Stack trace:', error.stack);
                    alert('Error al continuar: ' + (error.message || error));
                }
                
                return false;
            }
            
            const btnStep3Next = document.getElementById('btn-step3-next');
            if (btnStep3Next) {
                console.log('[Paso3] Botón Continuar encontrado, registrando evento click');
                
                // Registrar usando addEventListener
                btnStep3Next.addEventListener('click', handleContinuarClick);
                
                // También asignar onclick como fallback
                btnStep3Next.onclick = handleContinuarClick;
                
                console.log('[Paso3] Event listeners registrados correctamente');
            } else {
                console.error('[Paso3] ERROR: No se encontró el botón btn-step3-next en el DOM');
            }

            const btnStep4Prev = document.getElementById('btn-step4-prev');
            if (btnStep4Prev) {
                btnStep4Prev.addEventListener('click', () => goToStep(3));
            }

            // Confirmar cita
            const btnConfirmar = document.getElementById('btn-confirmar');
            if (btnConfirmar) {
                btnConfirmar.addEventListener('click', async function() {
                    try {
                        this.disabled = true;
                        this.innerHTML = '<span class="inline-block animate-spin mr-2">⏳</span> Procesando...';

                        // Preparar datos - Enviar id_programacion
                        const requestData = {
                            id_programacion: formData.id_programacion
                        };
                        
                        // Solo incluir id_servicio si existe (para reserva de SERVICIO)
                        if (formData.id_servicio) {
                            requestData.id_servicio = formData.id_servicio;
                        }

                        const response = await fetch('/reservas/paciente/crear-reserva', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });

                        const data = await response.json();

                        if (data.success) {
                            // Mostrar modal de éxito
                            const modalExito = document.getElementById('modalExito');
                            if (modalExito) {
                                modalExito.classList.remove('hidden');
                                const transform = modalExito.querySelector('.transform');
                                if (transform) {
                                    transform.classList.add('scale-100');
                                    transform.classList.remove('scale-95');
                                }
                            }
                        } else {
                            alert(data.error || 'Error al crear la reserva. Por favor, intenta nuevamente.');
                            this.disabled = false;
                            this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2"><polyline points="20 6 9 17 4 12"/></svg>Confirmar Cita';
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error al procesar la solicitud. Por favor, intenta nuevamente.');
                        this.disabled = false;
                        this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2"><polyline points="20 6 9 17 4 12"/></svg>Confirmar Cita';
                    }
                });
            }
            
            // Event listeners para navegación de semanas
            const btnSemanaAnterior = document.getElementById('btnSemanaAnterior');
            if (btnSemanaAnterior) {
                btnSemanaAnterior.addEventListener('click', () => {
                    navegarSemanaAnterior();
                });
            }

            const btnSemanaSiguiente = document.getElementById('btnSemanaSiguiente');
            if (btnSemanaSiguiente) {
                btnSemanaSiguiente.addEventListener('click', () => {
                    navegarSemanaSiguiente();
                });
            }

            // Event listeners para modal de selector de mes
            const btnMesAnterior = document.getElementById('btnMesAnterior');
            if (btnMesAnterior) {
                btnMesAnterior.addEventListener('click', () => {
                    cambiarMesSelector(-1);
                });
            }

            const btnMesSiguiente = document.getElementById('btnMesSiguiente');
            if (btnMesSiguiente) {
                btnMesSiguiente.addEventListener('click', () => {
                    cambiarMesSelector(1);
                });
            }

            // Validar estado inicial de botón anterior
            validarBotonSemanaAnterior();
        });

        // PASO 1: Cargar especialidades desde la BD
        async function cargarEspecialidades() {
            try {
                console.log('[Paso1] Cargando especialidades...');
                console.log('[Paso1] URL:', '/reservas/api/especialidades-activas');
                
                const response = await fetch('/reservas/api/especialidades-activas');
                console.log('[Paso1] Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('[Paso1] Datos recibidos:', data);

                const container = document.getElementById('especialidadesContainer');
                
                if (!container) {
                    console.error('[Paso1] ERROR: Container especialidadesContainer no encontrado');
                    return;
                }
                
                container.innerHTML = '';

                if (data.especialidades && data.especialidades.length > 0) {
                    console.log('[Paso1] Cargando', data.especialidades.length, 'especialidades...');
                    
                    data.especialidades.forEach(esp => {
                        const card = document.createElement('div');
                        card.className = 'border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-cyan-500 hover:bg-cyan-50 transition-all duration-300';
                        card.onclick = () => seleccionarEspecialidad(esp.id_especialidad, esp.nombre, card);
                        card.innerHTML = `
                            <div class="flex items-start gap-3">
                                <div class="w-12 h-12 bg-cyan-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600">
                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">${esp.nombre}</h4>
                                    <p class="text-sm text-gray-600">${esp.descripcion || 'Especialidad médica'}</p>
                                    ${esp.estado ? `<p class="text-xs text-gray-400 mt-1">Estado: ${esp.estado}</p>` : ''}
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                    console.log('[Paso1] ✓ Cargadas', data.especialidades.length, 'especialidades exitosamente');
                } else {
                    console.warn('[Paso1] No hay especialidades disponibles');
                    container.innerHTML = `
                        <div class="col-span-2 text-center py-8">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto text-gray-300 mb-3">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                            </svg>
                            <p class="text-gray-500 mb-2">No hay especialidades disponibles</p>
                            <p class="text-sm text-gray-400">Por favor, contacta al administrador</p>
                            <button onclick="cargarEspecialidades()" class="mt-4 bg-cyan-500 text-white px-4 py-2 rounded-lg hover:bg-cyan-600">
                                Reintentar
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('[Paso1] ERROR al cargar especialidades:', error);
                console.error('[Paso1] Stack trace:', error.stack);
                
                const container = document.getElementById('especialidadesContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="col-span-2 text-center py-8 border-2 border-red-200 rounded-lg bg-red-50">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto text-red-400 mb-3">
                                <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                            <p class="text-red-600 font-semibold mb-2">Error al cargar especialidades</p>
                            <p class="text-sm text-red-500 mb-4">${error.message}</p>
                            <button onclick="cargarEspecialidades()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                Reintentar
                            </button>
                        </div>
                    `;
                }
                
                alert('Error al cargar las especialidades. Por favor, revisa la consola (F12) para más detalles.');
            }
        }

        function seleccionarEspecialidad(id, nombre, elemento) {
            // Remover selección previa
            document.querySelectorAll('#especialidadesContainer > div').forEach(el => {
                el.classList.remove('border-cyan-500', 'bg-cyan-50');
                el.classList.add('border-gray-200');
            });

            // Marcar como seleccionado
            elemento.classList.add('border-cyan-500', 'bg-cyan-50');
            elemento.classList.remove('border-gray-200');

            formData.id_especialidad = id;
            formData.especialidad_nombre = nombre;

            console.log('[Paso1] Especialidad seleccionada:', nombre, '(ID:', id, ')');
            document.getElementById('btn-step1-next').disabled = false;
        }

        // PASO 2: Cargar médicos por especialidad (id_rol=2)
        async function cargarMedicos() {
            try {
                console.log('[Paso2] Cargando médicos para especialidad ID:', formData.id_especialidad);
                const response = await fetch(`/reservas/api/medicos-por-especialidad/${formData.id_especialidad}`);
                const data = await response.json();

                const container = document.getElementById('medicosContainer');
                container.innerHTML = '';

                document.getElementById('especialidadSeleccionada').textContent = formData.especialidad_nombre;

                if (data.medicos && data.medicos.length > 0) {
                    data.medicos.forEach(medico => {
                        const card = document.createElement('div');
                        card.className = 'border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-cyan-500 hover:bg-cyan-50 transition-all duration-300';
                        card.onclick = () => seleccionarMedico(medico.id_empleado, `Dr(a). ${medico.nombres} ${medico.apellidos}`, card);
                        card.innerHTML = `
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xl">
                                    ${medico.nombres.charAt(0)}${medico.apellidos.charAt(0)}
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">Dr(a). ${medico.nombres} ${medico.apellidos}</h4>
                                    <p class="text-sm text-cyan-600">${medico.especialidad}</p>
                                    <p class="text-xs text-gray-500 mt-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline mr-1">
                                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                            <circle cx="8.5" cy="7" r="4"/>
                                        </svg>
                                        ${medico.documento_identidad || 'Sin documento'}
                                    </p>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                    console.log('[Paso2] Cargados', data.medicos.length, 'médicos');
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay médicos disponibles para esta especialidad.</p>';
                }
            } catch (error) {
                console.error('[Paso2] Error al cargar médicos:', error);
                alert('Error al cargar los médicos. Por favor, intenta nuevamente.');
            }
        }

        function seleccionarMedico(id, nombre, elemento) {
            // Remover selección previa
            document.querySelectorAll('#medicosContainer > div').forEach(el => {
                el.classList.remove('border-cyan-500', 'bg-cyan-50');
                el.classList.add('border-gray-200');
            });

            // Marcar como seleccionado
            elemento.classList.add('border-cyan-500', 'bg-cyan-50');
            elemento.classList.remove('border-gray-200');

            formData.id_empleado = id;
            formData.empleado_nombre = nombre;

            console.log('[Paso2] Médico seleccionado:', nombre, '(ID:', id, ')');
            document.getElementById('btn-step2-next').disabled = false;
        }

        // PASO 3: Variables globales para el calendario
        let calendar = null;
        let semanaActual = new Date();
        let horarioSeleccionado = null;

        // Inicializar FullCalendar
        function inicializarCalendario() {
            const calendarEl = document.getElementById('calendar');
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'es',
                headerToolbar: false, // Ocultamos el header por defecto, usaremos nuestro propio control
                allDaySlot: false,
                slotMinTime: '07:00:00',
                slotMaxTime: '20:00:00',
                slotDuration: '00:30:00',
                slotLabelInterval: '01:00',
                height: 'auto',
                contentHeight: 'auto',
                aspectRatio: 1.8,
                expandRows: true,
                stickyHeaderDates: true,
                firstDay: 1, // Lunes
                weekends: true,
                nowIndicator: true, // Línea roja de hora actual
                now: new Date(), // Hora actual actualizada
                selectable: false,
                eventClick: function(info) {
                    mostrarDetallePrograma(info.event);
                },
                eventContent: function(arg) {
                    const disponible = arg.event.extendedProps.disponible;
                    const horaInicio = arg.event.extendedProps.hora_inicio;
                    const horaFin = arg.event.extendedProps.hora_fin;
                    
                    return {
                        html: `
                            <div class="fc-event-main-frame px-1 py-1">
                                <div class="fc-event-title-container">
                                    <div class="fc-event-title fc-sticky text-xs font-semibold">
                                        ${horaInicio}
                                        ${disponible ? '<span class="ml-1">✓</span>' : '<span class="ml-1">✕</span>'}
                                    </div>
                                    <div class="text-xs opacity-90 mt-0.5">
                                        ${disponible ? 'Disponible' : 'Ocupado'}
                                    </div>
                                </div>
                            </div>
                        `
                    };
                }
            });

            calendar.render();
            actualizarRangoSemana();
        }

        // Actualizar el texto del rango de semana
        function actualizarRangoSemana() {
            const inicioSemana = obtenerInicioSemana(semanaActual);
            const finSemana = obtenerFinSemana(semanaActual);
            
            const inicioStr = inicioSemana.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
            const finStr = finSemana.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
            
            document.getElementById('rangoSemana').textContent = `${inicioStr} - ${finStr}`;
        }

        // Obtener inicio de semana (lunes)
        function obtenerInicioSemana(fecha) {
            const d = new Date(fecha);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        // Obtener fin de semana (domingo)
        function obtenerFinSemana(fecha) {
            const inicio = obtenerInicioSemana(fecha);
            return new Date(inicio.getTime() + 6 * 24 * 60 * 60 * 1000);
        }

        // Cargar horarios en el calendario
        async function cargarHorariosSemanales() {
            try {
                const inicioSemana = obtenerInicioSemana(semanaActual);
                const finSemana = obtenerFinSemana(semanaActual);
                
                const fechaInicio = inicioSemana.toISOString().split('T')[0];
                const fechaFin = finSemana.toISOString().split('T')[0];

                console.log('[Paso3] Cargando horarios para médico ID:', formData.id_empleado, 'desde:', fechaInicio, 'hasta:', fechaFin);
                
                document.getElementById('medicoNombreHorario').textContent = formData.empleado_nombre;
                
                // Construir URL
                let url = `/reservas/api/buscar-horarios-disponibles?`;
                const params = [
                    'id_tipo_servicio=1',
                    `id_empleado=${formData.id_empleado}`,
                    `fecha_inicio=${fechaInicio}`,
                    `fecha_fin=${fechaFin}`
                ];
                url += params.join('&');
                
                console.log('[Paso3] URL:', url);
                const response = await fetch(url);
                const data = await response.json();
                console.log('[Paso3] Horarios recibidos:', data.horarios ? data.horarios.length : 0);
                
                // Limpiar eventos anteriores
                calendar.removeAllEvents();
                horarioSeleccionado = null;
                document.getElementById('btn-step3-next').disabled = true;

                const noHorarios = document.getElementById('noHorarios');
                
                // Siempre mostrar el calendario
                document.getElementById('calendarContainer').classList.remove('hidden');
                
                if (data.horarios && data.horarios.length > 0) {
                    noHorarios.classList.add('hidden');
                    
                    // Obtener hora actual para validaciones
                    const ahora = new Date();
                    
                    // Convertir horarios a eventos de FullCalendar
                    const eventos = data.horarios.map(horario => {
                        // El backend envía 'estado_programacion' como string: 'Disponible' o 'Ocupado'
                        const disponible = horario.estado_programacion === 'Disponible';
                        const esReservaPropia = horario.es_reserva_propia === true || horario.es_reserva_propia === 1;
                        
                        // Validar si la programación ya pasó
                        const fechaHoraProgramacion = new Date(`${horario.fecha}T${horario.hora_inicio}`);
                        const yaPaso = fechaHoraProgramacion < ahora;
                        
                        // Determinar color según estado
                        let backgroundColor, borderColor;
                        if (esReservaPropia) {
                            // Amarillo para reservas propias
                            backgroundColor = '#fbbf24';
                            borderColor = '#f59e0b';
                        } else if (disponible) {
                            // Verde para disponibles
                            backgroundColor = '#10b981';
                            borderColor = '#059669';
                        } else {
                            // Rojo para ocupadas
                            backgroundColor = '#ef4444';
                            borderColor = '#dc2626';
                        }
                        
                        return {
                            id: horario.id_programacion,
                            title: esReservaPropia ? 'Tu Reserva' : (disponible ? 'Disponible' : 'Ocupado'),
                            start: `${horario.fecha}T${horario.hora_inicio}`,
                            end: `${horario.fecha}T${horario.hora_fin}`,
                            backgroundColor: backgroundColor,
                            borderColor: borderColor,
                            textColor: '#ffffff',
                            extendedProps: {
                                id_programacion: horario.id_programacion,
                                fecha: horario.fecha,
                                hora_inicio: horario.hora_inicio,
                                hora_fin: horario.hora_fin,
                                disponible: disponible && !yaPaso, // No disponible si ya pasó
                                yaPaso: yaPaso,
                                esReservaPropia: esReservaPropia,
                                servicio_nombre: horario.servicio_nombre || 'Consulta Médica',
                                seleccionado: false
                            }
                        };
                    });
                    
                    // Agregar eventos al calendario
                    calendar.addEventSource(eventos);
                    
                    // Navegar a la fecha de inicio de la semana
                    calendar.gotoDate(inicioSemana);
                } else {
                    // Mostrar mensaje pero mantener calendario visible
                    noHorarios.classList.remove('hidden');
                    // Navegar a la fecha de inicio de la semana aunque no haya eventos
                    calendar.gotoDate(inicioSemana);
                }
            } catch (error) {
                console.error('[Paso3] Error al cargar horarios:', error);
                alert('Error al cargar los horarios. Por favor, intenta nuevamente.');
            }
        }

        function goToStep(step) {
            // Ocultar todos los pasos
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
            }

            // Mostrar paso actual
            document.getElementById(`step${step}`).classList.remove('hidden');
            currentStep = step;

            // Actualizar indicadores
            updateStepIndicators(step);
        }

        function updateStepIndicators(currentStep) {
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                const text = document.getElementById(`step${i}-text`);
                const line = document.getElementById(`line${i}`);

                if (i < currentStep) {
                    indicator.className = 'step-indicator step-completed w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2';
                    text.className = 'text-sm font-medium text-green-600';
                    if (line) line.className = 'flex-1 h-1 bg-green-500 mx-2';
                } else if (i === currentStep) {
                    indicator.className = 'step-indicator step-active w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2';
                    text.className = 'text-sm font-medium text-cyan-600';
                } else {
                    indicator.className = 'step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2';
                    text.className = 'text-sm font-medium text-gray-400';
                    if (line) line.className = 'flex-1 h-1 bg-gray-300 mx-2';
                }
            }
        }

        function mostrarResumen() {
            // Validar que existan los datos necesarios
            if (!formData.especialidad_nombre || !formData.empleado_nombre) {
                console.error('[mostrarResumen] Faltan datos esenciales:', formData);
                alert('Error: Faltan datos del médico o especialidad. Por favor, intente de nuevo.');
                return;
            }
            
            if (!formData.fecha || !formData.hora_inicio || !formData.hora_fin) {
                console.error('[mostrarResumen] Faltan datos del horario:', formData);
                alert('Error: Faltan datos del horario seleccionado. Por favor, seleccione un horario nuevamente.');
                return;
            }
            
            try {
                document.getElementById('resumen-servicio').textContent = formData.especialidad_nombre || 'No especificado';
                document.getElementById('resumen-medico').textContent = formData.empleado_nombre || 'No especificado';
                
                const fechaObj = new Date(formData.fecha + 'T00:00:00');
                
                // Validar que la fecha sea válida
                if (isNaN(fechaObj.getTime())) {
                    throw new Error('Fecha inválida: ' + formData.fecha);
                }
                
                const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric'
                });
                
                document.getElementById('resumen-fecha').textContent = 
                    `${fechaFormateada} - ${formData.hora_inicio} a ${formData.hora_fin}`;
                
                console.log('[mostrarResumen] Resumen actualizado correctamente');
            } catch (error) {
                console.error('[mostrarResumen] Error al mostrar resumen:', error);
                alert('Error al preparar el resumen. Por favor, intente de nuevo.');
            }
        }

        // Función para preseleccionar médico y especialidad desde la URL y saltar al paso 3
        async function preseleccionarMedicoYEspecialidad(idMedico, idEspecialidad) {
            try {
                console.log('[NuevaCita] Preseleccionando médico y especialidad:', idMedico, idEspecialidad);
                
                // Obtener información del médico
                const responseMedico = await fetch(`/reservas/api/medico/${idMedico}`);
                const medico = await responseMedico.json();
                
                if (medico && !medico.error) {
                    // Obtener nombre de la especialidad desde la lista de especialidades activas
                    let nombreEspecialidad = 'Especialidad';
                    try {
                        const responseEspecialidades = await fetch('/reservas/api/especialidades-activas');
                        const dataEspecialidades = await responseEspecialidades.json();
                        if (dataEspecialidades.especialidades) {
                            const especialidadEncontrada = dataEspecialidades.especialidades.find(
                                esp => esp.id_especialidad == idEspecialidad
                            );
                            if (especialidadEncontrada) {
                                nombreEspecialidad = especialidadEncontrada.nombre;
                            }
                        }
                    } catch (e) {
                        console.warn('No se pudo obtener nombre de especialidad, usando el del médico');
                        nombreEspecialidad = medico.especialidad || 'Especialidad';
                    }
                    
                    // Configurar formData con médico y especialidad
                    formData.id_empleado = parseInt(idMedico);
                    formData.empleado_nombre = `Dr(a). ${medico.nombres} ${medico.apellidos}`;
                    formData.id_especialidad = parseInt(idEspecialidad);
                    formData.especialidad_nombre = nombreEspecialidad;
                    
                    // Para citas generales (id_tipo_servicio=1), NO establecemos id_servicio
                    // porque las citas pueden tener id_servicio NULL o un servicio específico
                    // Solo establecemos id_servicio si NO es cita general (por ejemplo, para exámenes)
                    // if (medico.id_servicio && formData.id_tipo_servicio && formData.id_tipo_servicio != 1) {
                    //     formData.id_servicio = medico.id_servicio;
                    //     formData.servicio_nombre = medico.servicio_nombre || 'Consulta Médica';
                    // }
                    
                    console.log('[NuevaCita] Datos configurados:', formData);
                    
                    // Marcar pasos 1 y 2 como completados visualmente
                    const step1Indicator = document.getElementById('step1-indicator');
                    const step1Text = document.getElementById('step1-text');
                    const step2Indicator = document.getElementById('step2-indicator');
                    const step2Text = document.getElementById('step2-text');
                    
                    if (step1Indicator) {
                        step1Indicator.classList.remove('step-inactive');
                        step1Indicator.classList.add('step-completed');
                    }
                    if (step1Text) {
                        step1Text.classList.remove('text-gray-400');
                        step1Text.classList.add('text-green-600');
                    }
                    
                    if (step2Indicator) {
                        step2Indicator.classList.remove('step-inactive');
                        step2Indicator.classList.add('step-completed');
                    }
                    if (step2Text) {
                        step2Text.classList.remove('text-gray-400');
                        step2Text.classList.add('text-green-600');
                    }
                    
                    // Ir directamente al paso 3
                    goToStep(3);
                    
                    // Inicializar el calendario si no existe
                    if (!calendar) {
                        inicializarCalendario();
                    }
                    
                    // Cargar horarios del médico
                    await cargarHorariosSemanales();
                    
                    console.log('[NuevaCita] Saltado al paso 3 con médico y especialidad preseleccionados');
                } else {
                    console.error('[NuevaCita] Error al obtener médico:', medico.error);
                    // Si hay error, cargar normalmente
                    await cargarEspecialidades();
                }
            } catch (error) {
                console.error('[NuevaCita] Error al preseleccionar médico y especialidad:', error);
                // Si hay error, cargar normalmente
                await cargarEspecialidades();
            }
        }

        // Función para preseleccionar médico desde la URL (versión antigua, mantiene compatibilidad)
        async function preseleccionarMedico(idMedico) {
            try {
                console.log('Preseleccionando médico:', idMedico);
                
                // Obtener información del médico
                const response = await fetch(`/reservas/api/medico/${idMedico}`);
                const medico = await response.json();
                
                console.log('Datos del médico:', medico);
                
                if (medico && !medico.error) {
                    // Guardar el ID del médico para preselección posterior
                    const medicoIdParaPreseleccionar = parseInt(idMedico);
                    const medicoNombreCompleto = `Dr(a). ${medico.nombres} ${medico.apellidos}`;
                    
                    // Reserva de CITA - NO necesita servicio
                    // Avanzar directamente al paso 2 (selección ya realizada por especialidad)
                    goToStep(2);
                    await cargarMedicos();
                    
                    // Seleccionar el médico después de cargar la lista
                    setTimeout(() => {
                        formData.id_empleado = medicoIdParaPreseleccionar;
                        formData.empleado_nombre = medicoNombreCompleto;
                        document.getElementById('btn-step2-next').disabled = false;
                        
                        console.log('Médico preseleccionado para CITA:', medicoNombreCompleto);
                        
                        // Marcar visualmente el médico seleccionado
                        const medicosCards = document.querySelectorAll('#medicosContainer > div');
                        medicosCards.forEach(card => {
                            const cardIdMatch = card.getAttribute('data-medico-id');
                            if (cardIdMatch == medicoIdParaPreseleccionar) {
                                card.classList.add('border-cyan-500', 'bg-cyan-50', 'ring-2', 'ring-cyan-200');
                                card.classList.remove('border-gray-200');
                            }
                        });
                    }, 500);
                } else {
                    console.error('Error al obtener médico:', medico.error);
                }
            } catch (error) {
                console.error('Error al preseleccionar médico:', error);
            }
        }

        // ============================================
        // FUNCIONES PARA MODAL DE DETALLE DE PROGRAMACIÓN
        // ============================================
        
        function mostrarDetallePrograma(event) {
            const disponible = event.extendedProps.disponible;
            const fecha = event.extendedProps.fecha;
            const horaInicio = event.extendedProps.hora_inicio;
            const horaFin = event.extendedProps.hora_fin;
            const yaPaso = event.extendedProps.yaPaso;
            const esReservaPropia = event.extendedProps.esReservaPropia;
            const servicioNombre = event.extendedProps.servicio_nombre || 'Consulta Médica';
            
            // Formatear fecha
            const fechaObj = new Date(fecha + 'T00:00:00');
            const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            const diaSemana = diasSemana[fechaObj.getDay()];
            const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            
            // Llenar modal con información
            document.getElementById('detalleFecha').textContent = `${diaSemana}, ${fechaFormateada}`;
            document.getElementById('detalleHorario').textContent = `${horaInicio} - ${horaFin}`;
            
            // Mostrar servicio
            const detalleServicioDiv = document.getElementById('detalleServicio');
            if (detalleServicioDiv) {
                detalleServicioDiv.textContent = servicioNombre;
            }
            
            const estadoElement = document.getElementById('detalleEstado');
            if (esReservaPropia) {
                estadoElement.textContent = '⭐ Tu Reserva Actual';
                estadoElement.className = 'text-lg font-semibold text-yellow-600';
            } else if (yaPaso) {
                estadoElement.textContent = '⏰ Horario Pasado';
                estadoElement.className = 'text-lg font-semibold text-gray-500';
            } else if (disponible) {
                estadoElement.textContent = '✓ Disponible';
                estadoElement.className = 'text-lg font-semibold text-green-600';
            } else {
                estadoElement.textContent = '✗ Ocupado';
                estadoElement.className = 'text-lg font-semibold text-red-600';
            }
            
            // Si está disponible, agregar botón de selección
            const modal = document.getElementById('modalDetalleProgramacion');
            const footer = document.getElementById('modalDetalleFooter');
            
            if (disponible && !yaPaso && !esReservaPropia) {
                footer.innerHTML = `
                    <button onclick="cerrarModalDetalle()" class="flex-1 bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancelar
                    </button>
                    <button onclick="seleccionarHorarioDesdeModal(${event.extendedProps.id_programacion}, '${fecha}', '${horaInicio}', '${horaFin}')" 
                        class="flex-1 bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all duration-300 shadow-md hover:shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline mr-2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Seleccionar Horario
                    </button>
                `;
            } else {
                let mensajeInfo = '';
                if (esReservaPropia) {
                    mensajeInfo = '<p class="text-sm text-yellow-600 mb-3">⭐ Esta es tu reserva actual. No puedes seleccionarla nuevamente.</p>';
                } else if (yaPaso) {
                    mensajeInfo = '<p class="text-sm text-gray-600 mb-3">⏰ Este horario ya pasó y no está disponible.</p>';
                }
                
                footer.innerHTML = `
                    ${mensajeInfo}
                    <button onclick="cerrarModalDetalle()" class="flex-1 bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors">
                        Cerrar
                    </button>
                `;
            }
            
            // Mostrar modal
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.transform').classList.remove('scale-95');
                modal.querySelector('.transform').classList.add('scale-100');
            }, 10);
        }

        function cerrarModalDetalle() {
            const modal = document.getElementById('modalDetalleProgramacion');
            modal.querySelector('.transform').classList.remove('scale-100');
            modal.querySelector('.transform').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        function cerrarModalDetalleClick(event) {
            // Cerrar solo si se hace clic en el fondo oscuro (no en el contenido del modal)
            if (event.target === event.currentTarget) {
                cerrarModalDetalle();
            }
        }

        function seleccionarHorarioDesdeModal(id_programacion, fecha, horaInicio, horaFin) {
            // Remover selección anterior en el calendario
            calendar.getEvents().forEach(event => {
                if (event.extendedProps.seleccionado) {
                    event.setExtendedProp('seleccionado', false);
                    event.setProp('backgroundColor', '#10b981');
                    event.setProp('borderColor', '#059669');
                }
            });

            // Buscar y marcar el evento seleccionado
            const eventos = calendar.getEvents();
            const eventoSeleccionado = eventos.find(e => e.extendedProps.id_programacion === id_programacion);
            
            if (eventoSeleccionado) {
                eventoSeleccionado.setExtendedProp('seleccionado', true);
                eventoSeleccionado.setProp('backgroundColor', '#06b6d4');
                eventoSeleccionado.setProp('borderColor', '#0891b2');
            }

            // Guardar selección
            const fechaObj = new Date(fecha + 'T00:00:00');
            const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            const diaSemana = diasSemana[fechaObj.getDay()];
            
            horarioSeleccionado = {
                id_programacion: id_programacion,
                fecha: fecha,
                hora_inicio: horaInicio,
                hora_fin: horaFin
            };

            formData.id_programacion = id_programacion;
            formData.fecha = fecha;
            formData.hora_inicio = horaInicio;
            formData.hora_fin = horaFin;
            formData.dia_semana = diaSemana;

            console.log('[Paso3] Horario seleccionado:', horarioSeleccionado);
            console.log('[Paso3] formData completo:', formData);
            
            // Habilitar botón siguiente con animación
            const btnSiguiente = document.getElementById('btn-step3-next');
            if (btnSiguiente) {
                try {
                    // Remover atributo disabled y clases de deshabilitado
                    btnSiguiente.disabled = false;
                    btnSiguiente.removeAttribute('disabled');
                    btnSiguiente.classList.remove('opacity-50', 'cursor-not-allowed');
                    btnSiguiente.classList.add('animate-pulse');
                    
                    console.log('[Paso3] Botón Continuar habilitado');
                    console.log('[Paso3] Botón disabled:', btnSiguiente.disabled);
                    console.log('[Paso3] Botón visible:', btnSiguiente.offsetParent !== null);
                    console.log('[Paso3] Botón onclick asignado:', typeof btnSiguiente.onclick);
                    
                    // Asegurar que el botón esté clickeable
                    btnSiguiente.style.pointerEvents = 'auto';
                    btnSiguiente.style.cursor = 'pointer';
                    
                    setTimeout(() => {
                        btnSiguiente.classList.remove('animate-pulse');
                    }, 1000);
                } catch (error) {
                    console.error('[Paso3] Error al habilitar botón:', error);
                }
            } else {
                console.error('[Paso3] ERROR: No se encontró el botón btn-step3-next en el DOM');
            }
            
            // Cerrar modal
            cerrarModalDetalle();
        }

        // ============================================
        // FUNCIONES PARA NAVEGACIÓN DE SEMANAS
        // ============================================
        
        function navegarSemanaAnterior() {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            const inicioSemanaActual = obtenerInicioSemana(semanaActual);
            const inicioSemanaNueva = new Date(inicioSemanaActual);
            inicioSemanaNueva.setDate(inicioSemanaNueva.getDate() - 7);
            
            // Validar que no retroceda a semanas pasadas
            const inicioSemanaHoy = obtenerInicioSemana(hoy);
            
            if (inicioSemanaNueva >= inicioSemanaHoy) {
                semanaActual.setDate(semanaActual.getDate() - 7);
                actualizarRangoSemana();
                cargarHorariosSemanales();
                validarBotonSemanaAnterior();
            } else {
                console.log('[Navegación] No se puede retroceder a semanas anteriores a la actual');
            }
        }

        function navegarSemanaSiguiente() {
            semanaActual.setDate(semanaActual.getDate() + 7);
            actualizarRangoSemana();
            cargarHorariosSemanales();
            validarBotonSemanaAnterior();
        }

        function validarBotonSemanaAnterior() {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            const inicioSemanaActual = obtenerInicioSemana(semanaActual);
            const inicioSemanaHoy = obtenerInicioSemana(hoy);
            
            const btnAnterior = document.getElementById('btnSemanaAnterior');
            if (btnAnterior) {
                if (inicioSemanaActual <= inicioSemanaHoy) {
                    btnAnterior.disabled = true;
                    btnAnterior.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    btnAnterior.disabled = false;
                    btnAnterior.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        // ============================================
        // FUNCIONES PARA MODAL DE SELECTOR DE MES
        // ============================================
        
        let mesActualSelector = new Date();
        let ocupacionPorDia = {};

        async function abrirModalSelectorMes() {
            mesActualSelector = new Date(semanaActual);
            await cargarOcupacionMes();
            renderizarCalendarioMensual();
            
            const modal = document.getElementById('modalSelectorMes');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.transform').classList.remove('scale-95');
                modal.querySelector('.transform').classList.add('scale-100');
            }, 10);
        }

        function cerrarModalSelectorMes() {
            const modal = document.getElementById('modalSelectorMes');
            modal.querySelector('.transform').classList.remove('scale-100');
            modal.querySelector('.transform').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        function cerrarModalSelectorMesClick(event) {
            // Cerrar solo si se hace clic en el fondo oscuro (no en el contenido del modal)
            if (event.target === event.currentTarget) {
                cerrarModalSelectorMes();
            }
        }

        async function cargarOcupacionMes() {
            try {
                const primerDia = new Date(mesActualSelector.getFullYear(), mesActualSelector.getMonth(), 1);
                const ultimoDia = new Date(mesActualSelector.getFullYear(), mesActualSelector.getMonth() + 1, 0);
                
                const fechaInicio = primerDia.toISOString().split('T')[0];
                const fechaFin = ultimoDia.toISOString().split('T')[0];
                
                const url = `/reservas/api/buscar-horarios-disponibles?id_tipo_servicio=1&id_empleado=${formData.id_empleado}&fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                ocupacionPorDia = {};
                
                if (data.horarios && data.horarios.length > 0) {
                    data.horarios.forEach(h => {
                        if (!ocupacionPorDia[h.fecha]) {
                            ocupacionPorDia[h.fecha] = { total: 0, ocupados: 0 };
                        }
                        ocupacionPorDia[h.fecha].total++;
                        // El backend envía 'estado_programacion' como 'Disponible' o 'Ocupado'
                        if (h.estado_programacion === 'Ocupado') {
                            ocupacionPorDia[h.fecha].ocupados++;
                        }
                    });
                }
                
                console.log('[SelectorMes] Ocupación cargada:', ocupacionPorDia);
            } catch (error) {
                console.error('[SelectorMes] Error al cargar ocupación:', error);
            }
        }

        function renderizarCalendarioMensual() {
            const nombreMes = mesActualSelector.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            document.getElementById('nombreMesSelector').textContent = nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1);
            
            const primerDia = new Date(mesActualSelector.getFullYear(), mesActualSelector.getMonth(), 1);
            const ultimoDia = new Date(mesActualSelector.getFullYear(), mesActualSelector.getMonth() + 1, 0);
            let primerDiaSemana = primerDia.getDay();
            // Ajustar para que lunes sea 0 (0=Lun, 1=Mar, ..., 6=Dom)
            primerDiaSemana = primerDiaSemana === 0 ? 6 : primerDiaSemana - 1;
            
            const container = document.getElementById('diasMesSelector');
            container.innerHTML = '';
            
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            // Días vacíos antes del primer día
            for (let i = 0; i < primerDiaSemana; i++) {
                const diaVacio = document.createElement('div');
                diaVacio.className = 'aspect-square';
                container.appendChild(diaVacio);
            }
            
            // Días del mes
            for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
                const fecha = new Date(mesActualSelector.getFullYear(), mesActualSelector.getMonth(), dia);
                const fechaStr = fecha.toISOString().split('T')[0];
                const esPasado = fecha < hoy;
                const esHoy = fecha.toDateString() === hoy.toDateString();
                
                const diaBtn = document.createElement('button');
                diaBtn.type = 'button';
                diaBtn.className = 'w-full aspect-square flex items-center justify-center rounded-full text-base font-semibold transition-all hover:scale-105';
                diaBtn.textContent = dia;
                
                if (esPasado) {
                    diaBtn.className += ' text-gray-300 cursor-not-allowed';
                    diaBtn.disabled = true;
                } else if (esHoy) {
                    // Día actual - círculo azul
                    diaBtn.className += ' bg-blue-500 text-white font-semibold cursor-pointer hover:bg-blue-600';
                    diaBtn.onclick = () => seleccionarFechaDesdeModal(fecha);
                } else {
                    // Calcular color según ocupación
                    let colorClass = 'text-gray-700 hover:bg-gray-100';
                    
                    if (ocupacionPorDia[fechaStr]) {
                        const porcentaje = (ocupacionPorDia[fechaStr].ocupados / ocupacionPorDia[fechaStr].total) * 100;
                        if (porcentaje < 30) {
                            colorClass = 'bg-green-100 text-green-700 hover:bg-green-200';
                        } else if (porcentaje < 70) {
                            colorClass = 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200';
                        } else {
                            colorClass = 'bg-red-100 text-red-700 hover:bg-red-200';
                        }
                    }
                    
                    diaBtn.className += ` ${colorClass} cursor-pointer font-medium`;
                    diaBtn.onclick = () => seleccionarFechaDesdeModal(fecha);
                }
                
                container.appendChild(diaBtn);
            }
        }

        function cambiarMesSelector(direccion) {
            mesActualSelector.setMonth(mesActualSelector.getMonth() + direccion);
            cargarOcupacionMes().then(() => {
                renderizarCalendarioMensual();
            });
        }

        function seleccionarFechaDesdeModal(fecha) {
            // Validar que no sea una fecha pasada
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            if (fecha < hoy) {
                alert('No puedes seleccionar fechas pasadas.');
                return;
            }
            
            // Actualizar semana actual a la semana de la fecha seleccionada
            semanaActual = new Date(fecha);
            actualizarRangoSemana();
            cargarHorariosSemanales();
            validarBotonSemanaAnterior();
            
            // Cerrar modal
            cerrarModalSelectorMes();
        }
    </script>

    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/locales/es.global.min.js'></script>

</body>
</html>
