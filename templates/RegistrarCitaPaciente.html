<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Cita - Cl√≠nica Uni√≥n</title>

    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-active {
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            color: white;
        }
        .step-completed {
            background: #10b981;
            color: white;
        }
        .step-inactive {
            background: #e5e7eb;
            color: #6b7280;
        }
        
        /* Estilos del calendario - dise√±o modal procedimientos */
        .fc {
            font-family: 'Inter', sans-serif;
        }
        .fc .fc-toolbar-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
        }
        .fc .fc-button {
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            border: none;
            font-size: 0.75rem;
            padding: 0.4rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            text-transform: capitalize;
        }
        .fc .fc-button:hover {
            background: linear-gradient(135deg, #0891b2 0%, #2563eb 100%);
        }
        .fc .fc-button-active {
            background: linear-gradient(135deg, #0891b2 0%, #2563eb 100%) !important;
        }
        .fc .fc-col-header-cell-cushion {
            font-weight: 600;
            font-size: 0.75rem;
            color: #4b5563;
            padding: 8px 4px;
        }
        .fc .fc-timegrid-slot-label-cushion {
            font-size: 0.7rem;
            color: #6b7280;
        }
        .fc .fc-event {
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.7rem;
            margin: 1px 2px;
            border-width: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .fc .fc-event:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        }
        .fc-event-main-frame {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .fc .fc-timegrid-col.fc-day-today {
            background-color: rgba(6, 182, 212, 0.05);
        }
        .fc .fc-now-indicator-line {
            border-color: #ef4444;
            border-width: 2px;
        }
        .fc .fc-now-indicator-arrow {
            border-color: #ef4444;
            border-top-color: transparent;
            border-bottom-color: transparent;
        }
        .fc .fc-scrollgrid {
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        /* Header del calendario */
        .fc .fc-header-toolbar {
            margin-bottom: 1rem !important;
            padding: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50">

    {% include 'header.html' %}

    <div class="container mx-auto px-4 pt-24 pb-12">

        <!-- Header Section -->
        <div class="max-w-4xl mx-auto mb-8">
            <a href="/" class="inline-flex items-center text-cyan-600 hover:text-cyan-700 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
                </svg>
                Volver al inicio
            </a>

            <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-2xl flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/>
                            <path d="M3 10h18"/><path d="M10 16h4"/><path d="M12 14v4"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Agendar Nueva Cita</h1>
                        <p class="text-gray-600">Completa los pasos para reservar tu consulta m√©dica</p>
                    </div>
                </div>

                <!-- Step Indicators -->
                <div class="flex items-center justify-between mt-8">
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step1-indicator" class="step-indicator step-active w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">1</div>
                        <span id="step1-text" class="text-sm font-medium text-cyan-600">Especialidad</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2" id="line1"></div>
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step2-indicator" class="step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">2</div>
                        <span id="step2-text" class="text-sm font-medium text-gray-400">M√©dico</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2" id="line2"></div>
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step3-indicator" class="step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">3</div>
                        <span id="step3-text" class="text-sm font-medium text-gray-400">Horario</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2" id="line3"></div>
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step4-indicator" class="step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">4</div>
                        <span id="step4-text" class="text-sm font-medium text-gray-400">Confirmar</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Form Container -->
        <div class="max-w-4xl mx-auto">
            <form id="citaForm" class="bg-white rounded-2xl shadow-lg p-8">

                <!-- Step 1: Seleccionar Especialidad/Servicio -->
                <div id="step1" class="step-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 1: Selecciona la Especialidad</h2>

                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-3">¬øQu√© especialidad m√©dica necesitas?</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="especialidadesContainer">
                            <!-- Las especialidades se cargar√°n din√°micamente aqu√≠ -->
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button type="button" id="btn-step1-next" disabled class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                            Continuar
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline ml-2">
                                <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Seleccionar M√©dico -->
                <div id="step2" class="step-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 2: Selecciona tu M√©dico</h2>

                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-3">M√©dicos disponibles para <span id="especialidadSeleccionada" class="text-cyan-600"></span></label>
                        <div class="grid grid-cols-1 gap-4" id="medicosContainer">
                            <!-- Los m√©dicos se cargar√°n din√°micamente aqu√≠ -->
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" id="btn-step2-prev" class="bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded-lg hover:bg-gray-300 transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
                            </svg>
                            Atr√°s
                        </button>
                        <button type="button" id="btn-step2-next" disabled class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                            Continuar
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline ml-2">
                                <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Seleccionar Horario -->
                <div id="step3" class="step-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 3: Selecciona Fecha y Horario</h2>

                    <div class="mb-6">
                        <!-- Info del m√©dico seleccionado -->
                        <div class="bg-gradient-to-r from-cyan-50 to-blue-50 border border-cyan-200 rounded-lg p-4 mb-6">
                            <div class="flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600">
                                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                                </svg>
                                <div>
                                    <p class="text-sm text-gray-600">M√©dico seleccionado:</p>
                                    <p id="medicoNombreHorario" class="font-semibold text-gray-800"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Calendario FullCalendar (dise√±o modal procedimientos) -->
                        <div id="calendarContainer" class="bg-white border border-gray-200 rounded-2xl shadow-lg overflow-hidden">
                            <div id="calendar" class="p-2"></div>
                        </div>

                        <!-- Leyenda (dise√±o modal procedimientos) -->
                        <div class="mt-4 flex flex-wrap items-center gap-4 text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-green-500 rounded"></div>
                                <span class="text-gray-600">Disponible</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-gray-400 rounded"></div>
                                <span class="text-gray-600">Pasado</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-red-500 rounded"></div>
                                <span class="text-gray-600">Ocupado</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-yellow-400 rounded"></div>
                                <span class="text-gray-600">Tu Reserva</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-cyan-500 rounded"></div>
                                <span class="text-gray-600">Seleccionado</span>
                            </div>
                        </div>

                        <!-- Mensaje cuando no hay horarios -->
                        <div id="noHorarios" class="hidden text-center py-8 text-gray-500 mt-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-400 mb-3">
                                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
                            </svg>
                            <p>No hay horarios disponibles para este m√©dico en la semana seleccionada.</p>
                            <p class="text-sm mt-2">Por favor, intenta con otra semana o selecciona otro m√©dico.</p>
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" id="btn-step3-prev" class="bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded-lg hover:bg-gray-300 transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
                            </svg>
                            Atr√°s
                        </button>
                        <button type="button" id="btn-step3-next" disabled class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                            Continuar
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline ml-2">
                                <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 4: Confirmaci√≥n -->
                <div id="step4" class="step-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 4: Confirmar tu Cita</h2>

                    <div class="bg-gradient-to-br from-cyan-50 to-blue-50 rounded-xl p-6 mb-6">
                        <h3 class="font-semibold text-lg text-gray-800 mb-4">Resumen de tu Cita</h3>

                        <div class="space-y-3">
                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600 mt-1">
                                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                                </svg>
                                <div>
                                    <p class="text-sm text-gray-600">Especialidad</p>
                                    <p id="resumen-servicio" class="font-semibold text-gray-800"></p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600 mt-1">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                </svg>
                                <div>
                                    <p class="text-sm text-gray-600">M√©dico</p>
                                    <p id="resumen-medico" class="font-semibold text-gray-800"></p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600 mt-1">
                                    <rect width="18" height="18" x="3" y="4" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/>
                                </svg>
                                <div>
                                    <p class="text-sm text-gray-600">Fecha y Hora</p>
                                    <p id="resumen-fecha" class="font-semibold text-gray-800"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                        <div class="flex">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500 mr-3 flex-shrink-0">
                                <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-blue-800">Importante</p>
                                <p class="text-sm text-blue-700">Por favor, llega 10 minutos antes de tu cita. Trae tu documento de identidad y cualquier resultado m√©dico previo que consideres relevante.</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" id="btn-step4-prev" class="bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded-lg hover:bg-gray-300 transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
                            </svg>
                            Atr√°s
                        </button>
                        <button type="button" id="btn-confirmar" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-green-600 hover:to-emerald-600 transition-all duration-300 shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            Confirmar Cita
                        </button>
                    </div>
                </div>

            </form>
        </div>

        <!-- Modal de √âxito -->
        <div id="modalExito" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 transform scale-95 transition-transform">
                <div class="text-center">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">¬°Cita Confirmada!</h3>
                    <p class="text-gray-600 mb-6">Tu cita ha sido agendada exitosamente. Recibir√°s un recordatorio antes de tu consulta.</p>
                    <div class="flex flex-col gap-3">
                        <a href="/reservas/paciente/historial" class="inline-block bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all duration-300">
                            Ver Historial de Reservas
                        </a>
                        <a href="/" class="inline-block text-gray-600 hover:text-gray-800 font-medium py-2 transition-colors">
                            Volver al Inicio
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Detalle de Programaci√≥n -->
        <div id="modalDetalleProgramacion" onclick="cerrarModalDetalleClick(event)" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div onclick="event.stopPropagation()" class="bg-white rounded-2xl shadow-2xl max-w-lg w-full transform scale-95 transition-transform">
                <div class="bg-gradient-to-r from-cyan-500 to-blue-500 p-6 rounded-t-2xl">
                    <div class="flex items-center justify-between">
                        <h3 class="text-2xl font-bold text-white">Detalle de Programaci√≥n</h3>
                        <button onclick="cerrarModalDetalle()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="space-y-4">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-cyan-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600">
                                    <rect width="18" height="18" x="3" y="4" rx="2"/>
                                    <path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-500">Fecha</p>
                                <p id="detalleFecha" class="text-lg font-semibold text-gray-800"></p>
                            </div>
                        </div>

                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-600">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-500">Horario</p>
                                <p id="detalleHorario" class="text-lg font-semibold text-gray-800"></p>
                            </div>
                        </div>

                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-green-600">
                                    <path d="M9 11l3 3L22 4"/>
                                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-500">Servicio</p>
                                <p id="detalleServicio" class="text-lg font-semibold text-gray-800"></p>
                            </div>
                        </div>

                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-purple-600">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-500">Estado</p>
                                <p id="detalleEstado" class="text-lg font-semibold"></p>
                            </div>
                        </div>

                        <div id="detalleInfoAdicional" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600"></p>
                        </div>
                    </div>
                </div>

                <div id="modalDetalleFooter" class="bg-gray-50 p-6 rounded-b-2xl flex gap-3">
                    <!-- Los botones se generan din√°micamente seg√∫n disponibilidad -->
                </div>
            </div>
        </div>

    </div>

    {% include 'footer.html' %}

    <script>
        // Variables globales para el formulario
        let currentStep = 1;
        let formData = {
            id_especialidad: null,
            especialidad_nombre: '',
            id_empleado: null,
            empleado_nombre: '',
            id_programacion: null,
            fecha: '',
            hora_inicio: '',
            hora_fin: '',
            dia_semana: ''
        };

        // Configurar y cargar especialidades al iniciar
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[NuevaCita] Iniciando sistema de reservas');
            
            // Verificar si viene con m√©dico y especialidad desde la URL (desde lista de m√©dicos)
            const urlParams = new URLSearchParams(window.location.search);
            const idMedico = urlParams.get('medico');
            const idEspecialidad = urlParams.get('especialidad');
            
            if (idMedico && idEspecialidad) {
                // Si viene con m√©dico y especialidad, saltar directamente al paso 3
                console.log('[NuevaCita] Detectado m√©dico y especialidad en URL, saltando al paso 3');
                await preseleccionarMedicoYEspecialidad(idMedico, idEspecialidad);
                return; // Salir temprano, no cargar especialidades ni mostrar paso 1
            }
            
            await cargarEspecialidades();
            
            // Configurar fecha m√≠nima en los buscadores de fecha (hoy)
            const fechaInicioEl = document.getElementById('fechaInicio');
            const fechaFinEl = document.getElementById('fechaFin');
            const hoy = new Date().toISOString().split('T')[0];
            
            if (fechaInicioEl) {
                fechaInicioEl.setAttribute('min', hoy);
                
                // Event listener para validar que fecha inicio <= fecha fin
                fechaInicioEl.addEventListener('change', function() {
                    if (fechaFinEl && fechaFinEl.value && this.value > fechaFinEl.value) {
                        fechaFinEl.value = this.value;
                    }
                    if (fechaFinEl) {
                        fechaFinEl.setAttribute('min', this.value || hoy);
                    }
                });
                
                // Event listener para Enter en el input de fecha inicio
                fechaInicioEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const btnBuscar = document.getElementById('btnBuscarFecha');
                        if (btnBuscar) btnBuscar.click();
                    }
                });
            }
            
            if (fechaFinEl) {
                fechaFinEl.setAttribute('min', hoy);
                
                // Event listener para validar que fecha fin >= fecha inicio
                fechaFinEl.addEventListener('change', function() {
                    if (fechaInicioEl && fechaInicioEl.value && this.value < fechaInicioEl.value) {
                        alert('La fecha fin debe ser mayor o igual a la fecha inicio.');
                        this.value = fechaInicioEl.value;
                    }
                });
                
                // Event listener para Enter en el input de fecha fin
                fechaFinEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const btnBuscar = document.getElementById('btnBuscarFecha');
                        if (btnBuscar) btnBuscar.click();
                    }
                });
            }
            
            // Event listener para buscar rango de fechas
            const btnBuscarFecha = document.getElementById('btnBuscarFecha');
            if (btnBuscarFecha) {
                btnBuscarFecha.addEventListener('click', async function() {
                    const fechaInicio = fechaInicioEl ? fechaInicioEl.value : null;
                    const fechaFin = fechaFinEl ? fechaFinEl.value : null;
                    
                    if (!fechaInicio || !fechaFin) {
                        alert('Por favor, selecciona ambas fechas (inicio y fin) para buscar.');
                        return;
                    }
                    
                    if (fechaInicio > fechaFin) {
                        alert('La fecha inicio debe ser menor o igual a la fecha fin.');
                        return;
                    }
                    
                    const hoyStr = new Date().toISOString().split('T')[0];
                    if (fechaInicio < hoyStr) {
                        alert('No puedes buscar horarios de fechas pasadas. Por favor, selecciona fechas desde hoy en adelante.');
                        return;
                    }
                    
                    console.log('[Paso3] Buscando horarios desde:', fechaInicio, 'hasta:', fechaFin);
                    await cargarHorariosSemanales(fechaInicio, fechaFin);
                });
            }
            
            // Event listener para limpiar fechas y volver a la semana actual
            const btnLimpiarFecha = document.getElementById('btnLimpiarFecha');
            if (btnLimpiarFecha) {
                btnLimpiarFecha.addEventListener('click', async function() {
                    if (fechaInicioEl) {
                        fechaInicioEl.value = '';
                    }
                    if (fechaFinEl) {
                        fechaFinEl.value = '';
                    }
                    
                    console.log('[Paso3] Regresando al paso 2');
                    await cargarHorariosSemanales();
                });
            }

            // Navegaci√≥n entre pasos
            const btnStep1Next = document.getElementById('btn-step1-next');
            if (btnStep1Next) {
                btnStep1Next.addEventListener('click', async () => {
                    goToStep(2);
                    await cargarMedicos();
                });
            }

            const btnStep2Prev = document.getElementById('btn-step2-prev');
            if (btnStep2Prev) {
                btnStep2Prev.addEventListener('click', () => goToStep(1));
            }

            const btnStep2Next = document.getElementById('btn-step2-next');
            if (btnStep2Next) {
                btnStep2Next.addEventListener('click', async () => {
                    goToStep(3);
                    
                    // Inicializar el calendario si no existe
                    if (!calendar) {
                        inicializarCalendario();
                    }
                    
                    // Cargar horarios de la semana actual
                    await cargarHorariosSemanales();
                });
            }
            
            const btnStep3Prev = document.getElementById('btn-step3-prev');
            if (btnStep3Prev) {
                btnStep3Prev.addEventListener('click', () => goToStep(2));
            }

            // Funci√≥n para manejar el click en el bot√≥n continuar
            function handleContinuarClick(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                console.log('[Paso3] ========== Click en bot√≥n Continuar detectado ==========');
                console.log('[Paso3] formData al hacer click:', JSON.stringify(formData));
                
                // Validar que se haya seleccionado un horario antes de continuar
                if (!formData.id_programacion) {
                    console.error('[Paso3] Error: No hay id_programacion en formData');
                    alert('Por favor, seleccione un horario antes de continuar');
                    return false;
                }
                
                if (!formData.fecha) {
                    console.error('[Paso3] Error: No hay fecha en formData');
                    alert('Por favor, seleccione un horario antes de continuar');
                    return false;
                }
                
                if (!formData.hora_inicio) {
                    console.error('[Paso3] Error: No hay hora_inicio en formData');
                    alert('Por favor, seleccione un horario antes de continuar');
                    return false;
                }
                
                console.log('[Paso3] Validaci√≥n pasada. Datos completos:', {
                    id_programacion: formData.id_programacion,
                    fecha: formData.fecha,
                    hora_inicio: formData.hora_inicio,
                    empleado_nombre: formData.empleado_nombre,
                    especialidad_nombre: formData.especialidad_nombre
                });
                
                console.log('[Paso3] Llamando a mostrarResumen()...');
                
                try {
                    mostrarResumen();
                    console.log('[Paso3] mostrarResumen() ejecutado correctamente');
                    
                    console.log('[Paso3] Llamando a goToStep(4)...');
                    goToStep(4);
                    console.log('[Paso3] goToStep(4) ejecutado correctamente');
                } catch (error) {
                    console.error('[Paso3] ERROR CAPTURADO al continuar al paso 4:', error);
                    console.error('[Paso3] Stack trace:', error.stack);
                    alert('Error al continuar: ' + (error.message || error));
                }
                
                return false;
            }
            
            const btnStep3Next = document.getElementById('btn-step3-next');
            if (btnStep3Next) {
                console.log('[Paso3] Bot√≥n Continuar encontrado, registrando evento click');
                
                // Registrar usando addEventListener
                btnStep3Next.addEventListener('click', handleContinuarClick);
                
                // Tambi√©n asignar onclick como fallback
                btnStep3Next.onclick = handleContinuarClick;
                
                console.log('[Paso3] Event listeners registrados correctamente');
            } else {
                console.error('[Paso3] ERROR: No se encontr√≥ el bot√≥n btn-step3-next en el DOM');
            }

            const btnStep4Prev = document.getElementById('btn-step4-prev');
            if (btnStep4Prev) {
                btnStep4Prev.addEventListener('click', () => goToStep(3));
            }

            // Confirmar cita
            const btnConfirmar = document.getElementById('btn-confirmar');
            if (btnConfirmar) {
                btnConfirmar.addEventListener('click', async function() {
                    try {
                        this.disabled = true;
                        this.innerHTML = '<span class="inline-block animate-spin mr-2">‚è≥</span> Procesando...';

                        // Preparar datos - Enviar id_programacion
                        const requestData = {
                            id_programacion: formData.id_programacion
                        };
                        
                        // Solo incluir id_servicio si existe (para reserva de SERVICIO)
                        if (formData.id_servicio) {
                            requestData.id_servicio = formData.id_servicio;
                        }

                        const response = await fetch('/reservas/paciente/crear-reserva', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });

                        const data = await response.json();

                        if (data.success) {
                            // Mostrar modal de √©xito
                            const modalExito = document.getElementById('modalExito');
                            if (modalExito) {
                                modalExito.classList.remove('hidden');
                                const transform = modalExito.querySelector('.transform');
                                if (transform) {
                                    transform.classList.add('scale-100');
                                    transform.classList.remove('scale-95');
                                }
                            }
                        } else {
                            // Verificar si hay datos de conflicto para mostrar modal detallado
                            if (data.conflicto) {
                                mostrarModalConflicto(data.conflicto);
                            } else {
                                alert(data.error || 'Error al crear la reserva. Por favor, intenta nuevamente.');
                            }
                            this.disabled = false;
                            this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2"><polyline points="20 6 9 17 4 12"/></svg>Confirmar Cita';
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error al procesar la solicitud. Por favor, intenta nuevamente.');
                        this.disabled = false;
                        this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2"><polyline points="20 6 9 17 4 12"/></svg>Confirmar Cita';
                    }
                });
            }
            
        });

        // Funci√≥n para mostrar modal de conflicto de reserva
        function mostrarModalConflicto(conflicto) {
            // Formatear fecha
            let fechaFormateada = 'No especificada';
            if (conflicto.fecha) {
                try {
                    const fecha = new Date(conflicto.fecha + 'T00:00:00');
                    fechaFormateada = fecha.toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } catch(e) {
                    fechaFormateada = conflicto.fecha;
                }
            }
            
            // Determinar icono seg√∫n tipo de servicio
            let iconoServicio = 'üìã';
            let colorGradient = 'from-red-500 to-red-600';
            if (conflicto.tipo_servicio) {
                const tipo = conflicto.tipo_servicio.toLowerCase();
                if (tipo.includes('consulta') || tipo.includes('cita')) {
                    iconoServicio = 'ü©∫';
                    colorGradient = 'from-blue-500 to-blue-600';
                } else if (tipo.includes('examen') || tipo.includes('laboratorio')) {
                    iconoServicio = 'üî¨';
                    colorGradient = 'from-purple-500 to-purple-600';
                } else if (tipo.includes('operaci√≥n') || tipo.includes('cirug')) {
                    iconoServicio = '‚öïÔ∏è';
                    colorGradient = 'from-red-500 to-red-600';
                }
            }
            
            const modalHTML = `
                <div id="modalConflictoReserva" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" style="animation: fadeIn 0.3s ease-out;">
                    <div class="bg-white rounded-2xl max-w-lg w-full shadow-2xl overflow-hidden" style="animation: slideIn 0.3s ease-out;">
                        <!-- Header con gradiente -->
                        <div class="bg-gradient-to-r ${colorGradient} p-6">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                        <span class="text-3xl">‚ö†Ô∏è</span>
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-bold text-white">Conflicto de Horario</h2>
                                        <p class="text-white/80 text-sm">Ya tienes una reserva programada</p>
                                    </div>
                                </div>
                                <button onclick="cerrarModalConflicto()" class="text-white/80 hover:text-white transition-colors p-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Contenido -->
                        <div class="p-6">
                            <!-- Mensaje de alerta -->
                            <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-6 rounded-r-lg">
                                <div class="flex items-start gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-amber-600 flex-shrink-0 mt-0.5">
                                        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                                        <path d="M12 9v4"/><path d="M12 17h.01"/>
                                    </svg>
                                    <div>
                                        <p class="text-sm font-semibold text-amber-800">No se puede completar la reserva</p>
                                        <p class="text-xs text-amber-700 mt-1">El horario seleccionado se cruza con una reserva existente. Por favor, selecciona otro horario disponible.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Card con detalles de la reserva en conflicto -->
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-5 border border-gray-200">
                                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg">
                                    <span class="text-2xl">${iconoServicio}</span>
                                    Reserva Existente
                                </h3>
                                
                                <div class="space-y-3">
                                    <!-- Servicio -->
                                    <div class="flex items-center gap-3 bg-white rounded-lg p-3 shadow-sm">
                                        <div class="w-10 h-10 bg-cyan-100 rounded-lg flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600">
                                                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                                                <polyline points="14 2 14 8 20 8"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500">Servicio</p>
                                            <p class="font-semibold text-gray-800">${conflicto.servicio || 'No especificado'}</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Fecha y Hora -->
                                    <div class="flex items-center gap-3 bg-white rounded-lg p-3 shadow-sm">
                                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-600">
                                                <rect width="18" height="18" x="3" y="4" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500">Fecha</p>
                                            <p class="font-semibold text-gray-800">${fechaFormateada}</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Horario -->
                                    <div class="flex items-center gap-3 bg-white rounded-lg p-3 shadow-sm">
                                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-purple-600">
                                                <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500">Horario</p>
                                            <p class="font-semibold text-gray-800">${conflicto.hora_inicio || '--:--'} - ${conflicto.hora_fin || '--:--'}</p>
                                        </div>
                                    </div>
                                    
                                    <!-- M√©dico -->
                                    <div class="flex items-center gap-3 bg-white rounded-lg p-3 shadow-sm">
                                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-green-600">
                                                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500">M√©dico</p>
                                            <p class="font-semibold text-gray-800">${conflicto.medico ? 'Dr(a). ' + conflicto.medico : 'Por asignar'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer con botones -->
                        <div class="p-6 bg-gray-50 border-t border-gray-200 flex gap-3">
                            <button onclick="cerrarModalConflicto(); goToStep(3);" 
                                    class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect width="18" height="18" x="3" y="4" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/>
                                </svg>
                                Seleccionar Otro Horario
                            </button>
                            <button onclick="cerrarModalConflicto();" 
                                    class="bg-white border-2 border-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-xl hover:bg-gray-50 hover:border-gray-400 transition-all">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Agregar estilos de animaci√≥n si no existen
            if (!document.getElementById('modalConflictoStyles')) {
                const style = document.createElement('style');
                style.id = 'modalConflictoStyles';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { opacity: 0; transform: translateY(-20px) scale(0.95); }
                        to { opacity: 1; transform: translateY(0) scale(1); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function cerrarModalConflicto() {
            const modal = document.getElementById('modalConflictoReserva');
            if (modal) {
                modal.style.animation = 'fadeOut 0.2s ease-out forwards';
                setTimeout(() => modal.remove(), 200);
            }
        }

        // PASO 1: Cargar especialidades desde la BD
        async function cargarEspecialidades() {
            try {
                console.log('[Paso1] Cargando especialidades...');
                console.log('[Paso1] URL:', '/reservas/api/especialidades-activas');
                
                const response = await fetch('/reservas/api/especialidades-activas');
                console.log('[Paso1] Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('[Paso1] Datos recibidos:', data);

                const container = document.getElementById('especialidadesContainer');
                
                if (!container) {
                    console.error('[Paso1] ERROR: Container especialidadesContainer no encontrado');
                    return;
                }
                
                container.innerHTML = '';

                if (data.especialidades && data.especialidades.length > 0) {
                    console.log('[Paso1] Cargando', data.especialidades.length, 'especialidades...');
                    
                    data.especialidades.forEach(esp => {
                        const card = document.createElement('div');
                        card.className = 'border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-cyan-500 hover:bg-cyan-50 transition-all duration-300';
                        card.onclick = () => seleccionarEspecialidad(esp.id_especialidad, esp.nombre, card);
                        card.innerHTML = `
                            <div class="flex items-start gap-3">
                                <div class="w-12 h-12 bg-cyan-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600">
                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">${esp.nombre}</h4>
                                    <p class="text-sm text-gray-600">${esp.descripcion || 'Especialidad m√©dica'}</p>
                                    ${esp.estado ? `<p class="text-xs text-gray-400 mt-1">Estado: ${esp.estado}</p>` : ''}
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                    console.log('[Paso1] ‚úì Cargadas', data.especialidades.length, 'especialidades exitosamente');
                } else {
                    console.warn('[Paso1] No hay especialidades disponibles');
                    container.innerHTML = `
                        <div class="col-span-2 text-center py-8">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto text-gray-300 mb-3">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                            </svg>
                            <p class="text-gray-500 mb-2">No hay especialidades disponibles</p>
                            <p class="text-sm text-gray-400">Por favor, contacta al administrador</p>
                            <button onclick="cargarEspecialidades()" class="mt-4 bg-cyan-500 text-white px-4 py-2 rounded-lg hover:bg-cyan-600">
                                Reintentar
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('[Paso1] ERROR al cargar especialidades:', error);
                console.error('[Paso1] Stack trace:', error.stack);
                
                const container = document.getElementById('especialidadesContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="col-span-2 text-center py-8 border-2 border-red-200 rounded-lg bg-red-50">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto text-red-400 mb-3">
                                <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                            <p class="text-red-600 font-semibold mb-2">Error al cargar especialidades</p>
                            <p class="text-sm text-red-500 mb-4">${error.message}</p>
                            <button onclick="cargarEspecialidades()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                Reintentar
                            </button>
                        </div>
                    `;
                }
                
                alert('Error al cargar las especialidades. Por favor, revisa la consola (F12) para m√°s detalles.');
            }
        }

        function seleccionarEspecialidad(id, nombre, elemento) {
            // Remover selecci√≥n previa
            document.querySelectorAll('#especialidadesContainer > div').forEach(el => {
                el.classList.remove('border-cyan-500', 'bg-cyan-50');
                el.classList.add('border-gray-200');
            });

            // Marcar como seleccionado
            elemento.classList.add('border-cyan-500', 'bg-cyan-50');
            elemento.classList.remove('border-gray-200');

            formData.id_especialidad = id;
            formData.especialidad_nombre = nombre;

            console.log('[Paso1] Especialidad seleccionada:', nombre, '(ID:', id, ')');
            document.getElementById('btn-step1-next').disabled = false;
        }

        // PASO 2: Cargar m√©dicos por especialidad (id_rol=2)
        async function cargarMedicos() {
            try {
                console.log('[Paso2] Cargando m√©dicos para especialidad ID:', formData.id_especialidad);
                const response = await fetch(`/reservas/api/medicos-por-especialidad/${formData.id_especialidad}`);
                const data = await response.json();

                const container = document.getElementById('medicosContainer');
                container.innerHTML = '';

                document.getElementById('especialidadSeleccionada').textContent = formData.especialidad_nombre;

                if (data.medicos && data.medicos.length > 0) {
                    data.medicos.forEach(medico => {
                        const card = document.createElement('div');
                        card.className = 'border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-cyan-500 hover:bg-cyan-50 transition-all duration-300';
                        card.onclick = () => seleccionarMedico(medico.id_empleado, `Dr(a). ${medico.nombres} ${medico.apellidos}`, card);
                        card.innerHTML = `
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xl">
                                    ${medico.nombres.charAt(0)}${medico.apellidos.charAt(0)}
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">Dr(a). ${medico.nombres} ${medico.apellidos}</h4>
                                    <p class="text-sm text-cyan-600">${medico.especialidad}</p>
                                    <p class="text-xs text-gray-500 mt-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline mr-1">
                                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                            <circle cx="8.5" cy="7" r="4"/>
                                        </svg>
                                        ${medico.documento_identidad || 'Sin documento'}
                                    </p>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                    console.log('[Paso2] Cargados', data.medicos.length, 'm√©dicos');
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay m√©dicos disponibles para esta especialidad.</p>';
                }
            } catch (error) {
                console.error('[Paso2] Error al cargar m√©dicos:', error);
                alert('Error al cargar los m√©dicos. Por favor, intenta nuevamente.');
            }
        }

        function seleccionarMedico(id, nombre, elemento) {
            // Remover selecci√≥n previa
            document.querySelectorAll('#medicosContainer > div').forEach(el => {
                el.classList.remove('border-cyan-500', 'bg-cyan-50');
                el.classList.add('border-gray-200');
            });

            // Marcar como seleccionado
            elemento.classList.add('border-cyan-500', 'bg-cyan-50');
            elemento.classList.remove('border-gray-200');

            formData.id_empleado = id;
            formData.empleado_nombre = nombre;

            console.log('[Paso2] M√©dico seleccionado:', nombre, '(ID:', id, ')');
            document.getElementById('btn-step2-next').disabled = false;
        }

        // PASO 3: Variables globales para el calendario
        let calendar = null;
        let horarioSeleccionado = null;

        // Inicializar FullCalendar
        function inicializarCalendario() {
            const calendarEl = document.getElementById('calendar');
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'timeGridWeek,dayGridMonth'
                },
                buttonText: {
                    today: 'today',
                    week: 'week',
                    month: 'month'
                },
                allDaySlot: false,
                slotMinTime: '07:00:00',
                slotMaxTime: '20:00:00',
                slotDuration: '00:30:00',
                slotLabelInterval: '01:00',
                height: 'auto',
                contentHeight: 650,
                aspectRatio: 1.8,
                expandRows: true,
                stickyHeaderDates: true,
                firstDay: 1, // Lunes
                weekends: true,
                nowIndicator: true, // L√≠nea roja de hora actual
                now: new Date(), // Hora actual actualizada
                selectable: false,
                slotLabelFormat: {
                    hour: 'numeric',
                    minute: '2-digit',
                    omitZeroMinute: true,
                    meridiem: false,
                    hour12: false
                },
                dayHeaderFormat: {
                    weekday: 'short',
                    day: '2-digit',
                    month: '2-digit'
                },
                eventClick: function(info) {
                    mostrarDetallePrograma(info.event);
                },
                eventContent: function(arg) {
                    const disponible = arg.event.extendedProps.disponible;
                    const horaInicio = arg.event.extendedProps.hora_inicio;
                    const yaPaso = arg.event.extendedProps.yaPaso;
                    const esReservaPropia = arg.event.extendedProps.esReservaPropia;
                    
                    let estadoTexto, icono;
                    if (esReservaPropia) {
                        estadoTexto = 'Tu Reserva';
                        icono = '‚≠ê';
                    } else if (yaPaso) {
                        estadoTexto = 'Pasado';
                        icono = '‚úï';
                    } else if (disponible) {
                        estadoTexto = 'Disponible';
                        icono = '‚úì';
                    } else {
                        estadoTexto = 'Ocupado';
                        icono = '‚úï';
                    }
                    
                    return {
                        html: `
                            <div class="fc-event-main-frame px-1 py-1">
                                <div class="fc-event-title-container">
                                    <div class="fc-event-title fc-sticky text-xs font-semibold">
                                        ${horaInicio}
                                        <span class="ml-1">${icono}</span>
                                    </div>
                                    <div class="text-xs opacity-90 mt-0.5">
                                        ${estadoTexto}
                                    </div>
                                </div>
                            </div>
                        `
                    };
                }
            });

            calendar.render();
        }

        // Cargar horarios en el calendario (3 meses de programaciones del m√©dico seleccionado)
        async function cargarHorariosSemanales() {
            try {
                // Cargar 3 meses de programaciones desde hoy
                const hoy = new Date();
                const tresMesesDespues = new Date();
                tresMesesDespues.setMonth(tresMesesDespues.getMonth() + 3);
                
                const fechaInicio = hoy.toISOString().split('T')[0];
                const fechaFin = tresMesesDespues.toISOString().split('T')[0];

                console.log('[Paso3] Cargando horarios para m√©dico ID:', formData.id_empleado, 'desde:', fechaInicio, 'hasta:', fechaFin);
                
                document.getElementById('medicoNombreHorario').textContent = formData.empleado_nombre;
                
                // Construir URL
                let url = `/reservas/api/buscar-horarios-disponibles?`;
                const params = [
                    'id_tipo_servicio=1',
                    `id_empleado=${formData.id_empleado}`,
                    `fecha_inicio=${fechaInicio}`,
                    `fecha_fin=${fechaFin}`
                ];
                url += params.join('&');
                
                console.log('[Paso3] URL:', url);
                const response = await fetch(url);
                const data = await response.json();
                console.log('[Paso3] Horarios recibidos:', data.horarios ? data.horarios.length : 0);
                
                // Limpiar eventos anteriores
                calendar.removeAllEvents();
                horarioSeleccionado = null;
                document.getElementById('btn-step3-next').disabled = true;

                const noHorarios = document.getElementById('noHorarios');
                
                // Siempre mostrar el calendario
                document.getElementById('calendarContainer').classList.remove('hidden');
                
                if (data.horarios && data.horarios.length > 0) {
                    noHorarios.classList.add('hidden');
                    
                    // Obtener hora actual para validaciones
                    const ahora = new Date();
                    
                    // Convertir horarios a eventos de FullCalendar
                    const eventos = data.horarios.map(horario => {
                        // El backend env√≠a 'estado_programacion' como string: 'Disponible' o 'Ocupado'
                        const disponible = horario.estado_programacion === 'Disponible';
                        const esReservaPropia = horario.es_reserva_propia === true || horario.es_reserva_propia === 1;
                        
                        // Validar si la programaci√≥n ya pas√≥
                        const fechaHoraProgramacion = new Date(`${horario.fecha}T${horario.hora_inicio}`);
                        const yaPaso = fechaHoraProgramacion < ahora;
                        
                        // Determinar color seg√∫n estado (igual que modal de procedimientos)
                        let backgroundColor, borderColor;
                        if (esReservaPropia) {
                            // Amarillo para reservas propias
                            backgroundColor = '#fbbf24';
                            borderColor = '#f59e0b';
                        } else if (yaPaso) {
                            // Gris para citas que ya pasaron
                            backgroundColor = '#9ca3af';
                            borderColor = '#6b7280';
                        } else if (disponible) {
                            // Verde para disponibles
                            backgroundColor = '#10b981';
                            borderColor = '#059669';
                        } else {
                            // Rojo para ocupadas
                            backgroundColor = '#ef4444';
                            borderColor = '#dc2626';
                        }
                        
                        return {
                            id: horario.id_programacion,
                            title: esReservaPropia ? 'Tu Reserva' : (disponible ? 'Disponible' : 'Ocupado'),
                            start: `${horario.fecha}T${horario.hora_inicio}`,
                            end: `${horario.fecha}T${horario.hora_fin}`,
                            backgroundColor: backgroundColor,
                            borderColor: borderColor,
                            textColor: '#ffffff',
                            extendedProps: {
                                id_programacion: horario.id_programacion,
                                fecha: horario.fecha,
                                hora_inicio: horario.hora_inicio,
                                hora_fin: horario.hora_fin,
                                disponible: disponible && !yaPaso, // No disponible si ya pas√≥
                                yaPaso: yaPaso,
                                esReservaPropia: esReservaPropia,
                                servicio_nombre: horario.servicio_nombre || 'Consulta M√©dica',
                                seleccionado: false
                            }
                        };
                    });
                    
                    // Agregar eventos al calendario
                    calendar.addEventSource(eventos);
                    
                    // Navegar a la fecha actual (hoy)
                    calendar.gotoDate(hoy);
                } else {
                    // Mostrar mensaje pero mantener calendario visible
                    noHorarios.classList.remove('hidden');
                    // Navegar a la fecha actual aunque no haya eventos
                    calendar.gotoDate(hoy);
                }
            } catch (error) {
                console.error('[Paso3] Error al cargar horarios:', error);
                alert('Error al cargar los horarios. Por favor, intenta nuevamente.');
            }
        }

        function goToStep(step) {
            // Ocultar todos los pasos
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
            }

            // Mostrar paso actual
            document.getElementById(`step${step}`).classList.remove('hidden');
            currentStep = step;

            // Actualizar indicadores
            updateStepIndicators(step);
        }

        function updateStepIndicators(currentStep) {
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                const text = document.getElementById(`step${i}-text`);
                const line = document.getElementById(`line${i}`);

                if (i < currentStep) {
                    indicator.className = 'step-indicator step-completed w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2';
                    text.className = 'text-sm font-medium text-green-600';
                    if (line) line.className = 'flex-1 h-1 bg-green-500 mx-2';
                } else if (i === currentStep) {
                    indicator.className = 'step-indicator step-active w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2';
                    text.className = 'text-sm font-medium text-cyan-600';
                } else {
                    indicator.className = 'step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2';
                    text.className = 'text-sm font-medium text-gray-400';
                    if (line) line.className = 'flex-1 h-1 bg-gray-300 mx-2';
                }
            }
        }

        function mostrarResumen() {
            // Validar que existan los datos necesarios
            if (!formData.especialidad_nombre || !formData.empleado_nombre) {
                console.error('[mostrarResumen] Faltan datos esenciales:', formData);
                alert('Error: Faltan datos del m√©dico o especialidad. Por favor, intente de nuevo.');
                return;
            }
            
            if (!formData.fecha || !formData.hora_inicio || !formData.hora_fin) {
                console.error('[mostrarResumen] Faltan datos del horario:', formData);
                alert('Error: Faltan datos del horario seleccionado. Por favor, seleccione un horario nuevamente.');
                return;
            }
            
            try {
                document.getElementById('resumen-servicio').textContent = formData.especialidad_nombre || 'No especificado';
                document.getElementById('resumen-medico').textContent = formData.empleado_nombre || 'No especificado';
                
                const fechaObj = new Date(formData.fecha + 'T00:00:00');
                
                // Validar que la fecha sea v√°lida
                if (isNaN(fechaObj.getTime())) {
                    throw new Error('Fecha inv√°lida: ' + formData.fecha);
                }
                
                const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric'
                });
                
                document.getElementById('resumen-fecha').textContent = 
                    `${fechaFormateada} - ${formData.hora_inicio} a ${formData.hora_fin}`;
                
                console.log('[mostrarResumen] Resumen actualizado correctamente');
            } catch (error) {
                console.error('[mostrarResumen] Error al mostrar resumen:', error);
                alert('Error al preparar el resumen. Por favor, intente de nuevo.');
            }
        }

        // Funci√≥n para preseleccionar m√©dico y especialidad desde la URL y saltar al paso 3
        async function preseleccionarMedicoYEspecialidad(idMedico, idEspecialidad) {
            try {
                console.log('[NuevaCita] Preseleccionando m√©dico y especialidad:', idMedico, idEspecialidad);
                
                // Obtener informaci√≥n del m√©dico
                const responseMedico = await fetch(`/reservas/api/medico/${idMedico}`);
                const medico = await responseMedico.json();
                
                if (medico && !medico.error) {
                    // Obtener nombre de la especialidad desde la lista de especialidades activas
                    let nombreEspecialidad = 'Especialidad';
                    try {
                        const responseEspecialidades = await fetch('/reservas/api/especialidades-activas');
                        const dataEspecialidades = await responseEspecialidades.json();
                        if (dataEspecialidades.especialidades) {
                            const especialidadEncontrada = dataEspecialidades.especialidades.find(
                                esp => esp.id_especialidad == idEspecialidad
                            );
                            if (especialidadEncontrada) {
                                nombreEspecialidad = especialidadEncontrada.nombre;
                            }
                        }
                    } catch (e) {
                        console.warn('No se pudo obtener nombre de especialidad, usando el del m√©dico');
                        nombreEspecialidad = medico.especialidad || 'Especialidad';
                    }
                    
                    // Configurar formData con m√©dico y especialidad
                    formData.id_empleado = parseInt(idMedico);
                    formData.empleado_nombre = `Dr(a). ${medico.nombres} ${medico.apellidos}`;
                    formData.id_especialidad = parseInt(idEspecialidad);
                    formData.especialidad_nombre = nombreEspecialidad;
                    
                    // Para citas generales (id_tipo_servicio=1), NO establecemos id_servicio
                    // porque las citas pueden tener id_servicio NULL o un servicio espec√≠fico
                    // Solo establecemos id_servicio si NO es cita general (por ejemplo, para ex√°menes)
                    // if (medico.id_servicio && formData.id_tipo_servicio && formData.id_tipo_servicio != 1) {
                    //     formData.id_servicio = medico.id_servicio;
                    //     formData.servicio_nombre = medico.servicio_nombre || 'Consulta M√©dica';
                    // }
                    
                    console.log('[NuevaCita] Datos configurados:', formData);
                    
                    // Marcar pasos 1 y 2 como completados visualmente
                    const step1Indicator = document.getElementById('step1-indicator');
                    const step1Text = document.getElementById('step1-text');
                    const step2Indicator = document.getElementById('step2-indicator');
                    const step2Text = document.getElementById('step2-text');
                    
                    if (step1Indicator) {
                        step1Indicator.classList.remove('step-inactive');
                        step1Indicator.classList.add('step-completed');
                    }
                    if (step1Text) {
                        step1Text.classList.remove('text-gray-400');
                        step1Text.classList.add('text-green-600');
                    }
                    
                    if (step2Indicator) {
                        step2Indicator.classList.remove('step-inactive');
                        step2Indicator.classList.add('step-completed');
                    }
                    if (step2Text) {
                        step2Text.classList.remove('text-gray-400');
                        step2Text.classList.add('text-green-600');
                    }
                    
                    // Ir directamente al paso 3
                    goToStep(3);
                    
                    // Inicializar el calendario si no existe
                    if (!calendar) {
                        inicializarCalendario();
                    }
                    
                    // Cargar horarios del m√©dico
                    await cargarHorariosSemanales();
                    
                    console.log('[NuevaCita] Saltado al paso 3 con m√©dico y especialidad preseleccionados');
                } else {
                    console.error('[NuevaCita] Error al obtener m√©dico:', medico.error);
                    // Si hay error, cargar normalmente
                    await cargarEspecialidades();
                }
            } catch (error) {
                console.error('[NuevaCita] Error al preseleccionar m√©dico y especialidad:', error);
                // Si hay error, cargar normalmente
                await cargarEspecialidades();
            }
        }

        // Funci√≥n para preseleccionar m√©dico desde la URL (versi√≥n antigua, mantiene compatibilidad)
        async function preseleccionarMedico(idMedico) {
            try {
                console.log('Preseleccionando m√©dico:', idMedico);
                
                // Obtener informaci√≥n del m√©dico
                const response = await fetch(`/reservas/api/medico/${idMedico}`);
                const medico = await response.json();
                
                console.log('Datos del m√©dico:', medico);
                
                if (medico && !medico.error) {
                    // Guardar el ID del m√©dico para preselecci√≥n posterior
                    const medicoIdParaPreseleccionar = parseInt(idMedico);
                    const medicoNombreCompleto = `Dr(a). ${medico.nombres} ${medico.apellidos}`;
                    
                    // Reserva de CITA - NO necesita servicio
                    // Avanzar directamente al paso 2 (selecci√≥n ya realizada por especialidad)
                    goToStep(2);
                    await cargarMedicos();
                    
                    // Seleccionar el m√©dico despu√©s de cargar la lista
                    setTimeout(() => {
                        formData.id_empleado = medicoIdParaPreseleccionar;
                        formData.empleado_nombre = medicoNombreCompleto;
                        document.getElementById('btn-step2-next').disabled = false;
                        
                        console.log('M√©dico preseleccionado para CITA:', medicoNombreCompleto);
                        
                        // Marcar visualmente el m√©dico seleccionado
                        const medicosCards = document.querySelectorAll('#medicosContainer > div');
                        medicosCards.forEach(card => {
                            const cardIdMatch = card.getAttribute('data-medico-id');
                            if (cardIdMatch == medicoIdParaPreseleccionar) {
                                card.classList.add('border-cyan-500', 'bg-cyan-50', 'ring-2', 'ring-cyan-200');
                                card.classList.remove('border-gray-200');
                            }
                        });
                    }, 500);
                } else {
                    console.error('Error al obtener m√©dico:', medico.error);
                }
            } catch (error) {
                console.error('Error al preseleccionar m√©dico:', error);
            }
        }

        // ============================================
        // FUNCIONES PARA MODAL DE DETALLE DE PROGRAMACI√ìN
        // ============================================
        
        function mostrarDetallePrograma(event) {
            const disponible = event.extendedProps.disponible;
            const fecha = event.extendedProps.fecha;
            const horaInicio = event.extendedProps.hora_inicio;
            const horaFin = event.extendedProps.hora_fin;
            const yaPaso = event.extendedProps.yaPaso;
            const esReservaPropia = event.extendedProps.esReservaPropia;
            const servicioNombre = event.extendedProps.servicio_nombre || 'Consulta M√©dica';
            
            // Formatear fecha
            const fechaObj = new Date(fecha + 'T00:00:00');
            const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const diaSemana = diasSemana[fechaObj.getDay()];
            const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            
            // Llenar modal con informaci√≥n
            document.getElementById('detalleFecha').textContent = `${diaSemana}, ${fechaFormateada}`;
            document.getElementById('detalleHorario').textContent = `${horaInicio} - ${horaFin}`;
            
            // Mostrar servicio
            const detalleServicioDiv = document.getElementById('detalleServicio');
            if (detalleServicioDiv) {
                detalleServicioDiv.textContent = servicioNombre;
            }
            
            const estadoElement = document.getElementById('detalleEstado');
            if (esReservaPropia) {
                estadoElement.textContent = '‚≠ê Tu Reserva Actual';
                estadoElement.className = 'text-lg font-semibold text-yellow-600';
            } else if (yaPaso) {
                estadoElement.textContent = '‚è∞ Horario Pasado';
                estadoElement.className = 'text-lg font-semibold text-gray-500';
            } else if (disponible) {
                estadoElement.textContent = '‚úì Disponible';
                estadoElement.className = 'text-lg font-semibold text-green-600';
            } else {
                estadoElement.textContent = '‚úó Ocupado';
                estadoElement.className = 'text-lg font-semibold text-red-600';
            }
            
            // Si est√° disponible, agregar bot√≥n de selecci√≥n
            const modal = document.getElementById('modalDetalleProgramacion');
            const footer = document.getElementById('modalDetalleFooter');
            
            if (disponible && !yaPaso && !esReservaPropia) {
                footer.innerHTML = `
                    <button onclick="cerrarModalDetalle()" class="flex-1 bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancelar
                    </button>
                    <button onclick="seleccionarHorarioDesdeModal(${event.extendedProps.id_programacion}, '${fecha}', '${horaInicio}', '${horaFin}')" 
                        class="flex-1 bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all duration-300 shadow-md hover:shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline mr-2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Seleccionar Horario
                    </button>
                `;
            } else {
                let mensajeInfo = '';
                if (esReservaPropia) {
                    mensajeInfo = '<p class="text-sm text-yellow-600 mb-3">‚≠ê Esta es tu reserva actual. No puedes seleccionarla nuevamente.</p>';
                } else if (yaPaso) {
                    mensajeInfo = '<p class="text-sm text-gray-600 mb-3">‚è∞ Este horario ya pas√≥ y no est√° disponible.</p>';
                }
                
                footer.innerHTML = `
                    ${mensajeInfo}
                    <button onclick="cerrarModalDetalle()" class="flex-1 bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors">
                        Cerrar
                    </button>
                `;
            }
            
            // Mostrar modal
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.transform').classList.remove('scale-95');
                modal.querySelector('.transform').classList.add('scale-100');
            }, 10);
        }

        function cerrarModalDetalle() {
            const modal = document.getElementById('modalDetalleProgramacion');
            modal.querySelector('.transform').classList.remove('scale-100');
            modal.querySelector('.transform').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        function cerrarModalDetalleClick(event) {
            // Cerrar solo si se hace clic en el fondo oscuro (no en el contenido del modal)
            if (event.target === event.currentTarget) {
                cerrarModalDetalle();
            }
        }

        function seleccionarHorarioDesdeModal(id_programacion, fecha, horaInicio, horaFin) {
            // Remover selecci√≥n anterior en el calendario
            calendar.getEvents().forEach(event => {
                if (event.extendedProps.seleccionado) {
                    event.setExtendedProp('seleccionado', false);
                    event.setProp('backgroundColor', '#10b981');
                    event.setProp('borderColor', '#059669');
                }
            });

            // Buscar y marcar el evento seleccionado
            const eventos = calendar.getEvents();
            const eventoSeleccionado = eventos.find(e => e.extendedProps.id_programacion === id_programacion);
            
            if (eventoSeleccionado) {
                eventoSeleccionado.setExtendedProp('seleccionado', true);
                eventoSeleccionado.setProp('backgroundColor', '#06b6d4');
                eventoSeleccionado.setProp('borderColor', '#0891b2');
            }

            // Guardar selecci√≥n
            const fechaObj = new Date(fecha + 'T00:00:00');
            const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const diaSemana = diasSemana[fechaObj.getDay()];
            
            horarioSeleccionado = {
                id_programacion: id_programacion,
                fecha: fecha,
                hora_inicio: horaInicio,
                hora_fin: horaFin
            };

            formData.id_programacion = id_programacion;
            formData.fecha = fecha;
            formData.hora_inicio = horaInicio;
            formData.hora_fin = horaFin;
            formData.dia_semana = diaSemana;

            console.log('[Paso3] Horario seleccionado:', horarioSeleccionado);
            console.log('[Paso3] formData completo:', formData);
            
            // Habilitar bot√≥n siguiente con animaci√≥n
            const btnSiguiente = document.getElementById('btn-step3-next');
            if (btnSiguiente) {
                try {
                    // Remover atributo disabled y clases de deshabilitado
                    btnSiguiente.disabled = false;
                    btnSiguiente.removeAttribute('disabled');
                    btnSiguiente.classList.remove('opacity-50', 'cursor-not-allowed');
                    btnSiguiente.classList.add('animate-pulse');
                    
                    console.log('[Paso3] Bot√≥n Continuar habilitado');
                    console.log('[Paso3] Bot√≥n disabled:', btnSiguiente.disabled);
                    console.log('[Paso3] Bot√≥n visible:', btnSiguiente.offsetParent !== null);
                    console.log('[Paso3] Bot√≥n onclick asignado:', typeof btnSiguiente.onclick);
                    
                    // Asegurar que el bot√≥n est√© clickeable
                    btnSiguiente.style.pointerEvents = 'auto';
                    btnSiguiente.style.cursor = 'pointer';
                    
                    setTimeout(() => {
                        btnSiguiente.classList.remove('animate-pulse');
                    }, 1000);
                } catch (error) {
                    console.error('[Paso3] Error al habilitar bot√≥n:', error);
                }
            } else {
                console.error('[Paso3] ERROR: No se encontr√≥ el bot√≥n btn-step3-next en el DOM');
            }
            
            // Cerrar modal
            cerrarModalDetalle();
        }
    </script>

    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/locales/es.global.min.js'></script>

</body>
</html>
