<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Cita - Clínica Unión</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-active {
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            color: white;
        }
        .step-completed {
            background: #10b981;
            color: white;
        }
        .step-inactive {
            background: #e5e7eb;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-50">

    {% include 'header.html' %}

    <div class="container mx-auto px-4 pt-24 pb-12">

        <!-- Header Section -->
        <div class="max-w-4xl mx-auto mb-8">
            <a href="/" class="inline-flex items-center text-cyan-600 hover:text-cyan-700 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
                </svg>
                Volver al inicio
            </a>

            <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-2xl flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/>
                            <path d="M3 10h18"/><path d="M10 16h4"/><path d="M12 14v4"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Agendar Nueva Cita</h1>
                        <p class="text-gray-600">Completa los pasos para reservar tu consulta médica</p>
                    </div>
                </div>

                <!-- Step Indicators -->
                <div class="flex items-center justify-between mt-8">
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step1-indicator" class="step-indicator step-active w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">1</div>
                        <span id="step1-text" class="text-sm font-medium text-cyan-600">Especialidad</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2" id="line1"></div>
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step2-indicator" class="step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">2</div>
                        <span id="step2-text" class="text-sm font-medium text-gray-400">Médico</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2" id="line2"></div>
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step3-indicator" class="step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">3</div>
                        <span id="step3-text" class="text-sm font-medium text-gray-400">Horario</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2" id="line3"></div>
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step4-indicator" class="step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">4</div>
                        <span id="step4-text" class="text-sm font-medium text-gray-400">Confirmar</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Form Container -->
        <div class="max-w-4xl mx-auto">
            <form id="citaForm" class="bg-white rounded-2xl shadow-lg p-8">

                <!-- Step 1: Seleccionar Especialidad/Servicio -->
                <div id="step1" class="step-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 1: Selecciona la Especialidad</h2>

                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-3">¿Qué especialidad médica necesitas?</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="especialidadesContainer">
                            <!-- Las especialidades se cargarán dinámicamente aquí -->
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button type="button" id="btn-step1-next" disabled class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                            Continuar
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline ml-2">
                                <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Seleccionar Médico -->
                <div id="step2" class="step-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 2: Selecciona tu Médico</h2>

                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-3">Médicos disponibles para <span id="especialidadSeleccionada" class="text-cyan-600"></span></label>
                        <div class="grid grid-cols-1 gap-4" id="medicosContainer">
                            <!-- Los médicos se cargarán dinámicamente aquí -->
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" id="btn-step2-prev" class="bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded-lg hover:bg-gray-300 transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
                            </svg>
                            Atrás
                        </button>
                        <button type="button" id="btn-step2-next" disabled class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                            Continuar
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline ml-2">
                                <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Seleccionar Horario -->
                <div id="step3" class="step-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 3: Selecciona Fecha y Horario</h2>

                    <div class="mb-6">
                        <!-- Buscador de fecha -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <div class="flex flex-wrap items-end gap-3">
                                <div class="flex-1 min-w-[200px]">
                                    <label for="fechaBusqueda" class="block text-sm font-medium text-gray-700 mb-1">
                                        Buscar horarios desde:
                                    </label>
                                    <input 
                                        type="date" 
                                        id="fechaBusqueda" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    >
                                </div>
                                <button 
                                    type="button" 
                                    id="btnBuscarFecha" 
                                    class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors duration-200 flex items-center gap-2"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                                    </svg>
                                    Buscar
                                </button>
                                <button 
                                    type="button" 
                                    id="btnLimpiarFecha" 
                                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors duration-200 flex items-center gap-2"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                    </svg>
                                    Limpiar
                                </button>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">
                                Mostrando horarios de la semana: <span id="rangoFechas" class="font-semibold text-blue-600"></span>
                            </p>
                        </div>
                        
                        <label class="block text-gray-700 font-semibold mb-3">Horarios disponibles</label>
                        <p class="text-sm text-gray-600 mb-4">Médico: <span id="medicoNombreHorario" class="font-semibold"></span></p>
                        
                        <div id="horariosSemanales" class="space-y-4">
                            <!-- Los horarios agrupados por día se cargarán aquí -->
                        </div>
                        
                        <div id="noHorarios" class="hidden text-center py-8 text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-400 mb-3">
                                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
                            </svg>
                            <p>No hay horarios disponibles para este médico en las fechas seleccionadas.</p>
                            <p class="text-sm mt-2">Por favor, intenta con otra fecha o selecciona otro médico.</p>
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" id="btn-step3-prev" class="bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded-lg hover:bg-gray-300 transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
                            </svg>
                            Atrás
                        </button>
                        <button type="button" id="btn-step3-next" disabled class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                            Continuar
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline ml-2">
                                <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 4: Confirmación -->
                <div id="step4" class="step-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 4: Confirmar tu Cita</h2>

                    <div class="bg-gradient-to-br from-cyan-50 to-blue-50 rounded-xl p-6 mb-6">
                        <h3 class="font-semibold text-lg text-gray-800 mb-4">Resumen de tu Cita</h3>

                        <div class="space-y-3">
                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600 mt-1">
                                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                                </svg>
                                <div>
                                    <p class="text-sm text-gray-600">Especialidad</p>
                                    <p id="resumen-servicio" class="font-semibold text-gray-800"></p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600 mt-1">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                </svg>
                                <div>
                                    <p class="text-sm text-gray-600">Médico</p>
                                    <p id="resumen-medico" class="font-semibold text-gray-800"></p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600 mt-1">
                                    <rect width="18" height="18" x="3" y="4" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/>
                                </svg>
                                <div>
                                    <p class="text-sm text-gray-600">Fecha y Hora</p>
                                    <p id="resumen-fecha" class="font-semibold text-gray-800"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                        <div class="flex">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500 mr-3 flex-shrink-0">
                                <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-blue-800">Importante</p>
                                <p class="text-sm text-blue-700">Por favor, llega 10 minutos antes de tu cita. Trae tu documento de identidad y cualquier resultado médico previo que consideres relevante.</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" id="btn-step4-prev" class="bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded-lg hover:bg-gray-300 transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
                            </svg>
                            Atrás
                        </button>
                        <button type="button" id="btn-confirmar" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-green-600 hover:to-emerald-600 transition-all duration-300 shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            Confirmar Cita
                        </button>
                    </div>
                </div>

            </form>
        </div>

        <!-- Modal de Éxito -->
        <div id="modalExito" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 transform scale-95 transition-transform">
                <div class="text-center">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">¡Cita Confirmada!</h3>
                    <p class="text-gray-600 mb-6">Tu cita ha sido agendada exitosamente. Recibirás un recordatorio antes de tu consulta.</p>
                    <a href="/" class="inline-block bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all duration-300">
                        Volver al Inicio
                    </a>
                </div>
            </div>
        </div>

    </div>

    {% include 'footer.html' %}

    <script>
        // Variables globales para el formulario
        let currentStep = 1;
        let formData = {
            id_especialidad: null,
            especialidad_nombre: '',
            id_empleado: null,
            empleado_nombre: '',
            id_horario: null,
            fecha: '',
            hora_inicio: '',
            hora_fin: '',
            dia_semana: ''
        };

        // Configurar y cargar especialidades al iniciar
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[NuevaCita] Iniciando sistema de reservas');
            await cargarEspecialidades();
            
            // Configurar fecha mínima en el buscador de fecha (hoy)
            const fechaBusquedaEl = document.getElementById('fechaBusqueda');
            if (fechaBusquedaEl) {
                const hoy = new Date().toISOString().split('T')[0];
                fechaBusquedaEl.setAttribute('min', hoy);
                
                // Event listener para Enter en el input de fecha
                fechaBusquedaEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const btnBuscar = document.getElementById('btnBuscarFecha');
                        if (btnBuscar) btnBuscar.click();
                    }
                });
            }
            
            // Event listener para buscar fecha específica
            const btnBuscarFecha = document.getElementById('btnBuscarFecha');
            if (btnBuscarFecha) {
                btnBuscarFecha.addEventListener('click', async function() {
                    const fechaBusqueda = document.getElementById('fechaBusqueda');
                    if (fechaBusqueda && fechaBusqueda.value) {
                        const fechaSeleccionada = fechaBusqueda.value;
                        const hoy = new Date().toISOString().split('T')[0];
                        
                        if (fechaSeleccionada < hoy) {
                            alert('No puedes buscar horarios de fechas pasadas. Por favor, selecciona la fecha de hoy o una fecha futura.');
                            return;
                        }
                        
                        console.log('[Paso3] Buscando horarios desde:', fechaSeleccionada);
                        await cargarHorariosSemanales(fechaSeleccionada);
                    } else {
                        alert('Por favor, selecciona una fecha para buscar.');
                    }
                });
            }
            
            // Event listener para limpiar fecha y volver a la semana actual
            const btnLimpiarFecha = document.getElementById('btnLimpiarFecha');
            if (btnLimpiarFecha) {
                btnLimpiarFecha.addEventListener('click', async function() {
                    const fechaBusqueda = document.getElementById('fechaBusqueda');
                    if (fechaBusqueda) {
                        fechaBusqueda.value = '';
                    }
                    console.log('[Paso3] Regresando a la semana actual');
                    await cargarHorariosSemanales();
                });
            }

            // Navegación entre pasos
            const btnStep1Next = document.getElementById('btn-step1-next');
            if (btnStep1Next) {
                btnStep1Next.addEventListener('click', async () => {
                    goToStep(2);
                    await cargarMedicos();
                });
            }

            const btnStep2Prev = document.getElementById('btn-step2-prev');
            if (btnStep2Prev) {
                btnStep2Prev.addEventListener('click', () => goToStep(1));
            }

            const btnStep2Next = document.getElementById('btn-step2-next');
            if (btnStep2Next) {
                btnStep2Next.addEventListener('click', async () => {
                    goToStep(3);
                    await cargarHorariosSemanales();
                });
            }
            
            const btnStep3Prev = document.getElementById('btn-step3-prev');
            if (btnStep3Prev) {
                btnStep3Prev.addEventListener('click', () => goToStep(2));
            }

            const btnStep3Next = document.getElementById('btn-step3-next');
            if (btnStep3Next) {
                btnStep3Next.addEventListener('click', () => {
                    mostrarResumen();
                    goToStep(4);
                });
            }

            const btnStep4Prev = document.getElementById('btn-step4-prev');
            if (btnStep4Prev) {
                btnStep4Prev.addEventListener('click', () => goToStep(3));
            }

            // Confirmar cita
            const btnConfirmar = document.getElementById('btn-confirmar');
            if (btnConfirmar) {
                btnConfirmar.addEventListener('click', async function() {
                    try {
                        this.disabled = true;
                        this.innerHTML = '<span class="inline-block animate-spin mr-2">⏳</span> Procesando...';

                        // Preparar datos - NO incluir id_servicio para reserva de CITA
                        const requestData = {
                            id_horario: formData.id_horario
                        };
                        
                        // Solo incluir id_servicio si existe (para reserva de SERVICIO)
                        if (formData.id_servicio) {
                            requestData.id_servicio = formData.id_servicio;
                        }

                        const response = await fetch('/reservas/paciente/crear-reserva', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });

                        const data = await response.json();

                        if (data.success) {
                            // Mostrar modal de éxito
                            const modalExito = document.getElementById('modalExito');
                            if (modalExito) {
                                modalExito.classList.remove('hidden');
                                const transform = modalExito.querySelector('.transform');
                                if (transform) {
                                    transform.classList.add('scale-100');
                                    transform.classList.remove('scale-95');
                                }
                            }
                        } else {
                            alert(data.error || 'Error al crear la reserva. Por favor, intenta nuevamente.');
                            this.disabled = false;
                            this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2"><polyline points="20 6 9 17 4 12"/></svg>Confirmar Cita';
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error al procesar la solicitud. Por favor, intenta nuevamente.');
                        this.disabled = false;
                        this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2"><polyline points="20 6 9 17 4 12"/></svg>Confirmar Cita';
                    }
                });
            }
        });

        // PASO 1: Cargar especialidades desde la BD
        async function cargarEspecialidades() {
            try {
                console.log('[Paso1] Cargando especialidades...');
                console.log('[Paso1] URL:', '/reservas/api/especialidades-activas');
                
                const response = await fetch('/reservas/api/especialidades-activas');
                console.log('[Paso1] Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('[Paso1] Datos recibidos:', data);

                const container = document.getElementById('especialidadesContainer');
                
                if (!container) {
                    console.error('[Paso1] ERROR: Container especialidadesContainer no encontrado');
                    return;
                }
                
                container.innerHTML = '';

                if (data.especialidades && data.especialidades.length > 0) {
                    console.log('[Paso1] Cargando', data.especialidades.length, 'especialidades...');
                    
                    data.especialidades.forEach(esp => {
                        const card = document.createElement('div');
                        card.className = 'border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-cyan-500 hover:bg-cyan-50 transition-all duration-300';
                        card.onclick = () => seleccionarEspecialidad(esp.id_especialidad, esp.nombre, card);
                        card.innerHTML = `
                            <div class="flex items-start gap-3">
                                <div class="w-12 h-12 bg-cyan-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600">
                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">${esp.nombre}</h4>
                                    <p class="text-sm text-gray-600">${esp.descripcion || 'Especialidad médica'}</p>
                                    ${esp.estado ? `<p class="text-xs text-gray-400 mt-1">Estado: ${esp.estado}</p>` : ''}
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                    console.log('[Paso1] ✓ Cargadas', data.especialidades.length, 'especialidades exitosamente');
                } else {
                    console.warn('[Paso1] No hay especialidades disponibles');
                    container.innerHTML = `
                        <div class="col-span-2 text-center py-8">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto text-gray-300 mb-3">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                            </svg>
                            <p class="text-gray-500 mb-2">No hay especialidades disponibles</p>
                            <p class="text-sm text-gray-400">Por favor, contacta al administrador</p>
                            <button onclick="cargarEspecialidades()" class="mt-4 bg-cyan-500 text-white px-4 py-2 rounded-lg hover:bg-cyan-600">
                                Reintentar
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('[Paso1] ERROR al cargar especialidades:', error);
                console.error('[Paso1] Stack trace:', error.stack);
                
                const container = document.getElementById('especialidadesContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="col-span-2 text-center py-8 border-2 border-red-200 rounded-lg bg-red-50">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto text-red-400 mb-3">
                                <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                            <p class="text-red-600 font-semibold mb-2">Error al cargar especialidades</p>
                            <p class="text-sm text-red-500 mb-4">${error.message}</p>
                            <button onclick="cargarEspecialidades()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                Reintentar
                            </button>
                        </div>
                    `;
                }
                
                alert('Error al cargar las especialidades. Por favor, revisa la consola (F12) para más detalles.');
            }
        }

        function seleccionarEspecialidad(id, nombre, elemento) {
            // Remover selección previa
            document.querySelectorAll('#especialidadesContainer > div').forEach(el => {
                el.classList.remove('border-cyan-500', 'bg-cyan-50');
                el.classList.add('border-gray-200');
            });

            // Marcar como seleccionado
            elemento.classList.add('border-cyan-500', 'bg-cyan-50');
            elemento.classList.remove('border-gray-200');

            formData.id_especialidad = id;
            formData.especialidad_nombre = nombre;

            console.log('[Paso1] Especialidad seleccionada:', nombre, '(ID:', id, ')');
            document.getElementById('btn-step1-next').disabled = false;
        }

        // PASO 2: Cargar médicos por especialidad (id_rol=2)
        async function cargarMedicos() {
            try {
                console.log('[Paso2] Cargando médicos para especialidad ID:', formData.id_especialidad);
                const response = await fetch(`/reservas/api/medicos-por-especialidad/${formData.id_especialidad}`);
                const data = await response.json();

                const container = document.getElementById('medicosContainer');
                container.innerHTML = '';

                document.getElementById('especialidadSeleccionada').textContent = formData.especialidad_nombre;

                if (data.medicos && data.medicos.length > 0) {
                    data.medicos.forEach(medico => {
                        const card = document.createElement('div');
                        card.className = 'border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-cyan-500 hover:bg-cyan-50 transition-all duration-300';
                        card.onclick = () => seleccionarMedico(medico.id_empleado, `Dr(a). ${medico.nombres} ${medico.apellidos}`, card);
                        card.innerHTML = `
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xl">
                                    ${medico.nombres.charAt(0)}${medico.apellidos.charAt(0)}
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">Dr(a). ${medico.nombres} ${medico.apellidos}</h4>
                                    <p class="text-sm text-cyan-600">${medico.especialidad}</p>
                                    <p class="text-xs text-gray-500 mt-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline mr-1">
                                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                            <circle cx="8.5" cy="7" r="4"/>
                                        </svg>
                                        ${medico.documento_identidad || 'Sin documento'}
                                    </p>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                    console.log('[Paso2] Cargados', data.medicos.length, 'médicos');
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay médicos disponibles para esta especialidad.</p>';
                }
            } catch (error) {
                console.error('[Paso2] Error al cargar médicos:', error);
                alert('Error al cargar los médicos. Por favor, intenta nuevamente.');
            }
        }

        function seleccionarMedico(id, nombre, elemento) {
            // Remover selección previa
            document.querySelectorAll('#medicosContainer > div').forEach(el => {
                el.classList.remove('border-cyan-500', 'bg-cyan-50');
                el.classList.add('border-gray-200');
            });

            // Marcar como seleccionado
            elemento.classList.add('border-cyan-500', 'bg-cyan-50');
            elemento.classList.remove('border-gray-200');

            formData.id_empleado = id;
            formData.empleado_nombre = nombre;

            console.log('[Paso2] Médico seleccionado:', nombre, '(ID:', id, ')');
            document.getElementById('btn-step2-next').disabled = false;
        }

        // PASO 3: Cargar horarios de esta semana del médico seleccionado
        async function cargarHorariosSemanales(fechaInicio = null) {
            try {
                console.log('[Paso3] Cargando horarios para médico ID:', formData.id_empleado, 'desde fecha:', fechaInicio || 'semana actual');
                
                document.getElementById('medicoNombreHorario').textContent = formData.empleado_nombre;
                
                // Construir URL con parámetro de fecha si existe
                let url = `/reservas/api/horarios-semana/${formData.id_empleado}`;
                if (fechaInicio) {
                    url += `?fecha_inicio=${fechaInicio}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                // Actualizar el rango de fechas mostrado
                const rangoFechasSpan = document.getElementById('rangoFechas');
                if (rangoFechasSpan && data.inicio_semana && data.fin_semana) {
                    const inicio = new Date(data.inicio_semana + 'T00:00:00');
                    const fin = new Date(data.fin_semana + 'T00:00:00');
                    const inicioFormateado = inicio.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
                    const finFormateado = fin.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
                    rangoFechasSpan.textContent = `${inicioFormateado} - ${finFormateado}`;
                }

                const container = document.getElementById('horariosSemanales');
                const noHorarios = document.getElementById('noHorarios');
                
                container.innerHTML = '';

                if (data.horarios && data.horarios.length > 0) {
                    noHorarios.classList.add('hidden');
                    
                    // Agrupar horarios por fecha
                    const horariosPorFecha = {};
                    data.horarios.forEach(h => {
                        if (!horariosPorFecha[h.fecha]) {
                            horariosPorFecha[h.fecha] = {
                                dia_semana: h.dia_semana,
                                horarios: []
                            };
                        }
                        horariosPorFecha[h.fecha].horarios.push(h);
                    });

                    // Crear cards por día
                    Object.keys(horariosPorFecha).sort().forEach(fecha => {
                        const info = horariosPorFecha[fecha];
                        const fechaObj = new Date(fecha + 'T00:00:00');
                        const fechaFormateada = fechaObj.toLocaleDateString('es-ES', { 
                            day: '2-digit', 
                            month: 'long', 
                            year: 'numeric' 
                        });
                        
                        const diaCard = document.createElement('div');
                        diaCard.className = 'border rounded-lg p-4 bg-gray-50';
                        diaCard.innerHTML = `
                            <h4 class="font-semibold text-gray-800 mb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline mr-2 text-cyan-600">
                                    <rect width="18" height="18" x="3" y="4" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/>
                                </svg>
                                ${info.dia_semana}, ${fechaFormateada}
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2" data-fecha="${fecha}">
                            </div>
                        `;
                        
                        const horariosGrid = diaCard.querySelector('[data-fecha]');
                        
                        info.horarios.forEach(h => {
                            const horarioBtn = document.createElement('button');
                            horarioBtn.type = 'button';
                            
                            if (h.disponible) {
                                horarioBtn.className = 'border-2 border-gray-300 bg-white rounded-lg p-2 text-sm hover:border-cyan-500 hover:bg-cyan-50 transition-all';
                                horarioBtn.onclick = () => seleccionarHorario(h.id_horario, fecha, h.hora_inicio, h.hora_fin, info.dia_semana, horarioBtn);
                            } else {
                                horarioBtn.className = 'border-2 border-gray-200 bg-gray-100 rounded-lg p-2 text-sm text-gray-400 cursor-not-allowed';
                                horarioBtn.disabled = true;
                            }
                            
                            horarioBtn.innerHTML = `
                                <div class="font-semibold">${h.hora_inicio} - ${h.hora_fin}</div>
                                <div class="text-xs ${h.disponible ? 'text-green-600' : 'text-red-500'}">
                                    ${h.disponible ? '✓ Disponible' : '✗ No Disponible'}
                                </div>
                            `;
                            
                            horariosGrid.appendChild(horarioBtn);
                        });
                        
                        container.appendChild(diaCard);
                    });
                    
                    console.log('[Paso3] Cargados', data.horarios.length, 'horarios');
                } else {
                    noHorarios.classList.remove('hidden');
                    console.log('[Paso3] No hay horarios disponibles');
                }
            } catch (error) {
                console.error('[Paso3] Error al cargar horarios:', error);
                alert('Error al cargar los horarios. Por favor, intenta nuevamente.');
            }
        }

        function seleccionarHorario(id, fecha, horaInicio, horaFin, diaSemana, elemento) {
            // Remover selección previa en todos los horarios
            document.querySelectorAll('#horariosSemanales button').forEach(btn => {
                if (!btn.disabled) {
                    btn.classList.remove('border-cyan-500', 'bg-cyan-50', 'ring-2', 'ring-cyan-300');
                    btn.classList.add('border-gray-300', 'bg-white');
                }
            });

            // Marcar como seleccionado
            elemento.classList.add('border-cyan-500', 'bg-cyan-50', 'ring-2', 'ring-cyan-300');
            elemento.classList.remove('border-gray-300', 'bg-white');

            formData.id_horario = id;
            formData.fecha = fecha;
            formData.hora_inicio = horaInicio;
            formData.hora_fin = horaFin;
            formData.dia_semana = diaSemana;

            console.log('[Paso3] Horario seleccionado:', diaSemana, fecha, horaInicio, '-', horaFin);
            document.getElementById('btn-step3-next').disabled = false;
        }

        function goToStep(step) {
            // Ocultar todos los pasos
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
            }

            // Mostrar paso actual
            document.getElementById(`step${step}`).classList.remove('hidden');
            currentStep = step;

            // Actualizar indicadores
            updateStepIndicators(step);
        }

        function updateStepIndicators(currentStep) {
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                const text = document.getElementById(`step${i}-text`);
                const line = document.getElementById(`line${i}`);

                if (i < currentStep) {
                    indicator.className = 'step-indicator step-completed w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2';
                    text.className = 'text-sm font-medium text-green-600';
                    if (line) line.className = 'flex-1 h-1 bg-green-500 mx-2';
                } else if (i === currentStep) {
                    indicator.className = 'step-indicator step-active w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2';
                    text.className = 'text-sm font-medium text-cyan-600';
                } else {
                    indicator.className = 'step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2';
                    text.className = 'text-sm font-medium text-gray-400';
                    if (line) line.className = 'flex-1 h-1 bg-gray-300 mx-2';
                }
            }
        }

        function mostrarResumen() {
            document.getElementById('resumen-servicio').textContent = formData.especialidad_nombre;
            document.getElementById('resumen-medico').textContent = formData.empleado_nombre;
            
            const fechaObj = new Date(formData.fecha + 'T00:00:00');
            const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
                weekday: 'long',
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            
            document.getElementById('resumen-fecha').textContent = 
                `${fechaFormateada} - ${formData.hora_inicio} a ${formData.hora_fin}`;
        }

        // Función para preseleccionar médico desde la URL
        async function preseleccionarMedico(idMedico) {
            try {
                console.log('Preseleccionando médico:', idMedico);
                
                // Obtener información del médico
                const response = await fetch(`/reservas/api/medico/${idMedico}`);
                const medico = await response.json();
                
                console.log('Datos del médico:', medico);
                
                if (medico && !medico.error) {
                    // Guardar el ID del médico para preselección posterior
                    const medicoIdParaPreseleccionar = parseInt(idMedico);
                    const medicoNombreCompleto = `Dr(a). ${medico.nombres} ${medico.apellidos}`;
                    
                    // Reserva de CITA - NO necesita servicio
                    // Avanzar directamente al paso 2 (selección ya realizada por especialidad)
                    goToStep(2);
                    await cargarMedicos();
                    
                    // Seleccionar el médico después de cargar la lista
                    setTimeout(() => {
                        formData.id_empleado = medicoIdParaPreseleccionar;
                        formData.empleado_nombre = medicoNombreCompleto;
                        document.getElementById('btn-step2-next').disabled = false;
                        
                        console.log('Médico preseleccionado para CITA:', medicoNombreCompleto);
                        
                        // Marcar visualmente el médico seleccionado
                        const medicosCards = document.querySelectorAll('#medicosContainer > div');
                        medicosCards.forEach(card => {
                            const cardIdMatch = card.getAttribute('data-medico-id');
                            if (cardIdMatch == medicoIdParaPreseleccionar) {
                                card.classList.add('border-cyan-500', 'bg-cyan-50', 'ring-2', 'ring-cyan-200');
                                card.classList.remove('border-gray-200');
                            }
                        });
                    }, 500);
                } else {
                    console.error('Error al obtener médico:', medico.error);
                }
            } catch (error) {
                console.error('Error al preseleccionar médico:', error);
            }
        }
    </script>

</body>
</html>
