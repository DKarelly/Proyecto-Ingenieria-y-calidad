<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Cita - Clínica Unión</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-active {
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            color: white;
        }
        .step-completed {
            background: #10b981;
            color: white;
        }
        .step-inactive {
            background: #e5e7eb;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-50">

    {% include 'header.html' %}

    <div class="container mx-auto px-4 pt-24 pb-12">

        <!-- Header Section -->
        <div class="max-w-4xl mx-auto mb-8">
            <a href="/" class="inline-flex items-center text-cyan-600 hover:text-cyan-700 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
                </svg>
                Volver al inicio
            </a>

            <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-2xl flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/>
                            <path d="M3 10h18"/><path d="M10 16h4"/><path d="M12 14v4"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Agendar Nueva Cita</h1>
                        <p class="text-gray-600">Completa los pasos para reservar tu consulta médica</p>
                    </div>
                </div>

                <!-- Step Indicators -->
                <div class="flex items-center justify-between mt-8">
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step1-indicator" class="step-indicator step-active w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">1</div>
                        <span id="step1-text" class="text-sm font-medium text-cyan-600">Especialidad</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2" id="line1"></div>
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step2-indicator" class="step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">2</div>
                        <span id="step2-text" class="text-sm font-medium text-gray-400">Médico</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2" id="line2"></div>
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step3-indicator" class="step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">3</div>
                        <span id="step3-text" class="text-sm font-medium text-gray-400">Horario</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-300 mx-2" id="line3"></div>
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step4-indicator" class="step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2">4</div>
                        <span id="step4-text" class="text-sm font-medium text-gray-400">Confirmar</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Form Container -->
        <div class="max-w-4xl mx-auto">
            <form id="citaForm" class="bg-white rounded-2xl shadow-lg p-8">

                <!-- Step 1: Seleccionar Especialidad/Servicio -->
                <div id="step1" class="step-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 1: Selecciona la Especialidad</h2>

                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-3">¿Qué tipo de consulta necesitas?</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="serviciosContainer">
                            <!-- Los servicios se cargarán dinámicamente aquí -->
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button type="button" id="btn-step1-next" disabled class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                            Continuar
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline ml-2">
                                <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Seleccionar Médico -->
                <div id="step2" class="step-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 2: Selecciona tu Médico</h2>

                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-3">Médicos disponibles para <span id="servicioSeleccionado" class="text-cyan-600"></span></label>
                        <div class="grid grid-cols-1 gap-4" id="medicosContainer">
                            <!-- Los médicos se cargarán dinámicamente aquí -->
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" id="btn-step2-prev" class="bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded-lg hover:bg-gray-300 transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
                            </svg>
                            Atrás
                        </button>
                        <button type="button" id="btn-step2-next" disabled class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                            Continuar
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline ml-2">
                                <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Seleccionar Horario -->
                <div id="step3" class="step-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 3: Selecciona Fecha y Horario</h2>

                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-3">Selecciona una fecha</label>
                        <input type="date" id="fechaCita" min="" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                    </div>

                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-3">Horarios disponibles</label>
                        <div id="horariosContainer" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- Los horarios se cargarán dinámicamente aquí -->
                        </div>
                        <div id="noHorarios" class="hidden text-center py-8 text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-400 mb-3">
                                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
                            </svg>
                            <p>No hay horarios disponibles para la fecha seleccionada.</p>
                            <p class="text-sm mt-2">Por favor, selecciona otra fecha.</p>
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" id="btn-step3-prev" class="bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded-lg hover:bg-gray-300 transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
                            </svg>
                            Atrás
                        </button>
                        <button type="button" id="btn-step3-next" disabled class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                            Continuar
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline ml-2">
                                <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 4: Confirmación -->
                <div id="step4" class="step-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 4: Confirmar tu Cita</h2>

                    <div class="bg-gradient-to-br from-cyan-50 to-blue-50 rounded-xl p-6 mb-6">
                        <h3 class="font-semibold text-lg text-gray-800 mb-4">Resumen de tu Cita</h3>

                        <div class="space-y-3">
                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600 mt-1">
                                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                                </svg>
                                <div>
                                    <p class="text-sm text-gray-600">Especialidad</p>
                                    <p id="resumen-servicio" class="font-semibold text-gray-800"></p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600 mt-1">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                </svg>
                                <div>
                                    <p class="text-sm text-gray-600">Médico</p>
                                    <p id="resumen-medico" class="font-semibold text-gray-800"></p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600 mt-1">
                                    <rect width="18" height="18" x="3" y="4" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/>
                                </svg>
                                <div>
                                    <p class="text-sm text-gray-600">Fecha y Hora</p>
                                    <p id="resumen-fecha" class="font-semibold text-gray-800"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                        <div class="flex">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500 mr-3 flex-shrink-0">
                                <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-blue-800">Importante</p>
                                <p class="text-sm text-blue-700">Por favor, llega 10 minutos antes de tu cita. Trae tu documento de identidad y cualquier resultado médico previo que consideres relevante.</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" id="btn-step4-prev" class="bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded-lg hover:bg-gray-300 transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
                            </svg>
                            Atrás
                        </button>
                        <button type="button" id="btn-confirmar" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-green-600 hover:to-emerald-600 transition-all duration-300 shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            Confirmar Cita
                        </button>
                    </div>
                </div>

            </form>
        </div>

        <!-- Modal de Éxito -->
        <div id="modalExito" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 transform scale-95 transition-transform">
                <div class="text-center">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">¡Cita Confirmada!</h3>
                    <p class="text-gray-600 mb-6">Tu cita ha sido agendada exitosamente. Recibirás un recordatorio antes de tu consulta.</p>
                    <a href="/" class="inline-block bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all duration-300">
                        Volver al Inicio
                    </a>
                </div>
            </div>
        </div>

    </div>

    {% include 'footer.html' %}

    <script>
        // Variables globales para el formulario
        let currentStep = 1;
        let formData = {
            id_servicio: null,
            servicio_nombre: '',
            id_empleado: null,
            empleado_nombre: '',
            id_horario: null,
            fecha: '',
            hora_inicio: '',
            hora_fin: ''
        };

        // Obtener parámetros de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const medicoPreseleccionado = urlParams.get('medico');

        // Configurar fecha mínima (hoy)
        document.addEventListener('DOMContentLoaded', async function() {
            const fechaInput = document.getElementById('fechaCita');
            const today = new Date().toISOString().split('T')[0];
            fechaInput.min = today;

            // Cargar servicios siempre
            await cargarServicios();
            console.log('Servicios cargados en el paso 1');
            
            // Si hay médico preseleccionado, intentar procesarlo
            if (medicoPreseleccionado) {
                console.log('Intentando preseleccionar médico:', medicoPreseleccionado);
                await preseleccionarMedico(medicoPreseleccionado);
            }
        });

        // Cargar servicios disponibles
        async function cargarServicios() {
            try {
                const response = await fetch('/reservas/api/servicios-activos');
                const data = await response.json();

                const container = document.getElementById('serviciosContainer');
                container.innerHTML = '';

                if (data.servicios && data.servicios.length > 0) {
                    data.servicios.forEach(servicio => {
                        const card = document.createElement('div');
                        card.className = 'border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-cyan-500 hover:bg-cyan-50 transition-all duration-300';
                        card.onclick = () => seleccionarServicio(servicio.id_servicio, servicio.nombre, card);
                        card.innerHTML = `
                            <div class="flex items-start gap-3">
                                <div class="w-12 h-12 bg-cyan-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600">
                                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">${servicio.nombre}</h4>
                                    <p class="text-sm text-gray-600">${servicio.especialidad || 'Consulta General'}</p>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                } else {
                    container.innerHTML = '<p class="text-gray-500 col-span-2 text-center py-4">No hay servicios disponibles en este momento.</p>';
                }
            } catch (error) {
                console.error('Error al cargar servicios:', error);
                alert('Error al cargar los servicios. Por favor, intenta nuevamente.');
            }
        }

        function seleccionarServicio(id, nombre, elemento) {
            // Remover selección previa
            document.querySelectorAll('#serviciosContainer > div').forEach(el => {
                el.classList.remove('border-cyan-500', 'bg-cyan-50');
                el.classList.add('border-gray-200');
            });

            // Marcar como seleccionado
            elemento.classList.add('border-cyan-500', 'bg-cyan-50');
            elemento.classList.remove('border-gray-200');

            formData.id_servicio = id;
            formData.servicio_nombre = nombre;

            document.getElementById('btn-step1-next').disabled = false;
        }

        async function cargarMedicos() {
            try {
                const response = await fetch(`/reservas/api/medicos-por-servicio/${formData.id_servicio}`);
                const data = await response.json();

                const container = document.getElementById('medicosContainer');
                container.innerHTML = '';

                document.getElementById('servicioSeleccionado').textContent = formData.servicio_nombre;

                if (data.medicos && data.medicos.length > 0) {
                    data.medicos.forEach(medico => {
                        const card = document.createElement('div');
                        card.className = 'border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-cyan-500 hover:bg-cyan-50 transition-all duration-300';
                        card.setAttribute('data-medico-id', medico.id_empleado);
                        card.onclick = () => seleccionarMedico(medico.id_empleado, `${medico.nombres} ${medico.apellidos}`, card);
                        card.innerHTML = `
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full flex items-center justify-center text-white text-xl font-bold">
                                    ${medico.nombres.charAt(0)}${medico.apellidos.charAt(0)}
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800">Dr(a). ${medico.nombres} ${medico.apellidos}</h4>
                                    <p class="text-sm text-gray-600">${medico.especialidad || 'Médico General'}</p>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay médicos disponibles para este servicio.</p>';
                }
            } catch (error) {
                console.error('Error al cargar médicos:', error);
                alert('Error al cargar los médicos. Por favor, intenta nuevamente.');
            }
        }

        function seleccionarMedico(id, nombre, elemento) {
            // Remover selección previa
            document.querySelectorAll('#medicosContainer > div').forEach(el => {
                el.classList.remove('border-cyan-500', 'bg-cyan-50');
                el.classList.add('border-gray-200');
            });

            // Marcar como seleccionado
            elemento.classList.add('border-cyan-500', 'bg-cyan-50');
            elemento.classList.remove('border-gray-200');

            formData.id_empleado = id;
            formData.empleado_nombre = nombre;

            document.getElementById('btn-step2-next').disabled = false;
        }

        async function cargarHorarios() {
            const fecha = document.getElementById('fechaCita').value;
            if (!fecha) return;

            formData.fecha = fecha;

            try {
                const response = await fetch(`/reservas/api/horarios-disponibles?fecha=${fecha}&id_empleado=${formData.id_empleado}`);
                const data = await response.json();

                const container = document.getElementById('horariosContainer');
                const noHorarios = document.getElementById('noHorarios');
                container.innerHTML = '';

                if (data.horarios && data.horarios.length > 0) {
                    noHorarios.classList.add('hidden');
                    container.classList.remove('hidden');

                    data.horarios.forEach(horario => {
                        const card = document.createElement('div');
                        card.className = 'border-2 border-gray-200 rounded-lg p-3 cursor-pointer hover:border-cyan-500 hover:bg-cyan-50 transition-all duration-300 text-center';
                        card.onclick = () => seleccionarHorario(horario.id_horario, horario.hora_inicio, horario.hora_fin, card);
                        card.innerHTML = `
                            <div class="flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-600">
                                    <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                                </svg>
                                <span class="font-semibold text-gray-800">${horario.hora_inicio} - ${horario.hora_fin}</span>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                } else {
                    noHorarios.classList.remove('hidden');
                    container.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error al cargar horarios:', error);
                alert('Error al cargar los horarios. Por favor, intenta nuevamente.');
            }
        }

        function seleccionarHorario(id, hora_inicio, hora_fin, elemento) {
            // Remover selección previa
            document.querySelectorAll('#horariosContainer > div').forEach(el => {
                el.classList.remove('border-cyan-500', 'bg-cyan-50');
                el.classList.add('border-gray-200');
            });

            // Marcar como seleccionado
            elemento.classList.add('border-cyan-500', 'bg-cyan-50');
            elemento.classList.remove('border-gray-200');

            formData.id_horario = id;
            formData.hora_inicio = hora_inicio;
            formData.hora_fin = hora_fin;

            document.getElementById('btn-step3-next').disabled = false;
        }

        // Event listener para cambio de fecha
        document.getElementById('fechaCita').addEventListener('change', function() {
            formData.id_horario = null;
            document.getElementById('btn-step3-next').disabled = true;
            cargarHorarios();
        });

        // Navegación entre pasos
        document.getElementById('btn-step1-next').addEventListener('click', async () => {
            goToStep(2);
            await cargarMedicos();
            
            // Verificar si hay un médico preseleccionado en sessionStorage
            const medicoId = sessionStorage.getItem('medicoPreseleccionado');
            const medicoNombre = sessionStorage.getItem('medicoNombre');
            
            if (medicoId && medicoNombre) {
                // Preseleccionar el médico después de cargar la lista
                setTimeout(() => {
                    formData.id_empleado = parseInt(medicoId);
                    formData.empleado_nombre = medicoNombre;
                    document.getElementById('btn-step2-next').disabled = false;
                    
                    console.log('Médico preseleccionado desde sessionStorage:', medicoNombre);
                    
                    // Marcar visualmente el médico seleccionado
                    const medicosCards = document.querySelectorAll('#medicosContainer > div');
                    medicosCards.forEach(card => {
                        const cardIdMatch = card.getAttribute('data-medico-id');
                        if (cardIdMatch == medicoId) {
                            card.classList.add('border-cyan-500', 'bg-cyan-50', 'ring-2', 'ring-cyan-200');
                            card.classList.remove('border-gray-200');
                        }
                    });
                    
                    // Limpiar sessionStorage
                    sessionStorage.removeItem('medicoPreseleccionado');
                    sessionStorage.removeItem('medicoNombre');
                }, 500);
            }
        });

        document.getElementById('btn-step2-prev').addEventListener('click', () => goToStep(1));
        document.getElementById('btn-step2-next').addEventListener('click', () => goToStep(3));
        document.getElementById('btn-step3-prev').addEventListener('click', () => goToStep(2));
        document.getElementById('btn-step3-next').addEventListener('click', () => {
            mostrarResumen();
            goToStep(4);
        });
        document.getElementById('btn-step4-prev').addEventListener('click', () => goToStep(3));

        function goToStep(step) {
            // Ocultar todos los pasos
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
            }

            // Mostrar paso actual
            document.getElementById(`step${step}`).classList.remove('hidden');
            currentStep = step;

            // Actualizar indicadores
            updateStepIndicators(step);
        }

        function updateStepIndicators(currentStep) {
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                const text = document.getElementById(`step${i}-text`);
                const line = document.getElementById(`line${i}`);

                if (i < currentStep) {
                    indicator.className = 'step-indicator step-completed w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2';
                    text.className = 'text-sm font-medium text-green-600';
                    if (line) line.className = 'flex-1 h-1 bg-green-500 mx-2';
                } else if (i === currentStep) {
                    indicator.className = 'step-indicator step-active w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2';
                    text.className = 'text-sm font-medium text-cyan-600';
                } else {
                    indicator.className = 'step-indicator step-inactive w-12 h-12 rounded-full flex items-center justify-center font-bold mb-2';
                    text.className = 'text-sm font-medium text-gray-400';
                    if (line) line.className = 'flex-1 h-1 bg-gray-300 mx-2';
                }
            }
        }

        function mostrarResumen() {
            document.getElementById('resumen-servicio').textContent = formData.servicio_nombre;
            document.getElementById('resumen-medico').textContent = formData.empleado_nombre;

            // Formatear fecha
            const fecha = new Date(formData.fecha + 'T00:00:00');
            const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const fechaFormateada = fecha.toLocaleDateString('es-ES', opciones);

            document.getElementById('resumen-fecha').textContent = `${fechaFormateada} a las ${formData.hora_inicio}`;
        }

        // Confirmar cita
        document.getElementById('btn-confirmar').addEventListener('click', async function() {
            try {
                this.disabled = true;
                this.innerHTML = '<span class="inline-block animate-spin mr-2">⏳</span> Procesando...';

                const response = await fetch('/reservas/paciente/crear-reserva', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id_servicio: formData.id_servicio,
                        id_horario: formData.id_horario
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Mostrar modal de éxito
                    document.getElementById('modalExito').classList.remove('hidden');
                    document.getElementById('modalExito').querySelector('.transform').classList.add('scale-100');
                    document.getElementById('modalExito').querySelector('.transform').classList.remove('scale-95');
                } else {
                    alert(data.error || 'Error al crear la reserva. Por favor, intenta nuevamente.');
                    this.disabled = false;
                    this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2"><polyline points="20 6 9 17 4 12"/></svg>Confirmar Cita';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al procesar la solicitud. Por favor, intenta nuevamente.');
                this.disabled = false;
                this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2"><polyline points="20 6 9 17 4 12"/></svg>Confirmar Cita';
            }
        });

        // Función para preseleccionar médico desde la URL
        async function preseleccionarMedico(idMedico) {
            try {
                console.log('Preseleccionando médico:', idMedico);
                
                // Obtener información del médico
                const response = await fetch(`/reservas/api/medico/${idMedico}`);
                const medico = await response.json();
                
                console.log('Datos del médico:', medico);
                
                if (medico && !medico.error) {
                    // Guardar el ID del médico para preselección posterior
                    const medicoIdParaPreseleccionar = parseInt(idMedico);
                    const medicoNombreCompleto = `Dr(a). ${medico.nombres} ${medico.apellidos}`;
                    
                    // Si el médico tiene un servicio asociado, seleccionarlo automáticamente
                    if (medico.id_servicio) {
                        formData.id_servicio = medico.id_servicio;
                        formData.servicio_nombre = medico.servicio_nombre;
                        console.log('Servicio preseleccionado:', formData.servicio_nombre);
                        
                        // Avanzar al paso 2 y cargar médicos filtrados por servicio
                        goToStep(2);
                        await cargarMedicos();
                        
                        // Seleccionar el médico después de cargar la lista
                        setTimeout(() => {
                            formData.id_empleado = medicoIdParaPreseleccionar;
                            formData.empleado_nombre = medicoNombreCompleto;
                            document.getElementById('btn-step2-next').disabled = false;
                            
                            console.log('Médico preseleccionado:', medicoNombreCompleto);
                            
                            // Marcar visualmente el médico seleccionado
                            const medicosCards = document.querySelectorAll('#medicosContainer > div');
                            medicosCards.forEach(card => {
                                const cardIdMatch = card.getAttribute('data-medico-id');
                                if (cardIdMatch == medicoIdParaPreseleccionar) {
                                    card.classList.add('border-cyan-500', 'bg-cyan-50', 'ring-2', 'ring-cyan-200');
                                    card.classList.remove('border-gray-200');
                                }
                            });
                        }, 500);
                    } else {
                        // Si no tiene servicio, el usuario debe seleccionar primero en el paso 1
                        console.log('El médico no tiene servicio asociado. Usuario debe seleccionar el servicio primero.');
                        
                        // Guardar el médico en sessionStorage para preselección después
                        sessionStorage.setItem('medicoPreseleccionado', medicoIdParaPreseleccionar);
                        sessionStorage.setItem('medicoNombre', medicoNombreCompleto);
                        
                        // Asegurarse de que estamos en el paso 1
                        goToStep(1);
                        
                        // Agregar un indicador visual en el encabezado del paso 1
                        const step1Header = document.querySelector('#step1 h3');
                        if (step1Header) {
                            const medicoInfo = document.createElement('div');
                            medicoInfo.className = 'mt-3 p-3 bg-cyan-50 border-l-4 border-cyan-500 rounded text-sm';
                            medicoInfo.innerHTML = `
                                <p class="text-cyan-800 font-medium">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline mr-1">
                                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                                    </svg>
                                    Agendar cita con: ${medicoNombreCompleto}
                                </p>
                                <p class="text-cyan-700 mt-1">Por favor, seleccione el tipo de servicio que desea para continuar.</p>
                            `;
                            step1Header.after(medicoInfo);
                        }
                        
                        console.log('Usuario en paso 1. Debe seleccionar servicio para continuar con:', medicoNombreCompleto);
                    }
                } else {
                    console.error('Error al obtener médico:', medico.error);
                }
            } catch (error) {
                console.error('Error al preseleccionar médico:', error);
            }
        }
    </script>

</body>
</html>
