
# ==================== ENDPOINTS DE CANCELACIÓN Y REPROGRAMACIÓN ====================

@reservas_bp.route('/api/horarios-disponibles-reprogramacion', methods=['POST'])
def api_horarios_disponibles_reprogramacion():
    """API para obtener horarios disponibles para reprogramar, excluyendo el horario actual"""
    if 'usuario_id' not in session:
        return jsonify({'error': 'No autenticado'}), 401

    if session.get('tipo_usuario') != 'paciente':
        return jsonify({'error': 'Acceso no autorizado'}), 403

    data = request.get_json() or {}
    id_reserva = data.get('id_reserva')
    id_servicio = data.get('id_servicio')
    fecha = data.get('fecha')

    if not all([id_reserva, id_servicio, fecha]):
        return jsonify({'error': 'Faltan datos requeridos'}), 400

    conexion = None
    try:
        usuario_id = session.get('usuario_id')
        paciente = Paciente.obtener_por_usuario(usuario_id)
        
        if not paciente:
            return jsonify({'error': 'Paciente no encontrado'}), 404
        
        id_paciente = paciente.get('id_paciente')

        conexion = obtener_conexion()
        with conexion.cursor() as cursor:
            sql_verificar = """
                SELECT r.id_reserva, p.id_horario, h.hora_inicio, h.hora_fin
                FROM RESERVA r
                INNER JOIN PROGRAMACION p ON r.id_programacion = p.id_programacion
                INNER JOIN HORARIO h ON p.id_horario = h.id_horario
                WHERE r.id_reserva = %s AND r.id_paciente = %s
            """
            cursor.execute(sql_verificar, (id_reserva, id_paciente))
            reserva_actual = cursor.fetchone()
            
            if not reserva_actual:
                return jsonify({'error': 'Reserva no encontrada'}), 404
            
            hora_actual_inicio = reserva_actual['hora_inicio']
            hora_actual_fin = reserva_actual['hora_fin']

            sql_horarios = """
                SELECT DISTINCT
                    h.id_horario,
                    h.hora_inicio,
                    h.hora_fin,
                    h.disponibilidad
                FROM HORARIO h
                INNER JOIN PROGRAMACION p ON h.id_horario = p.id_horario
                WHERE h.fecha = %s
                AND p.id_servicio = %s
                AND h.estado = 'Activo'
                AND h.disponibilidad = 'Disponible'
                AND NOT (h.hora_inicio = %s AND h.hora_fin = %s)
                ORDER BY h.hora_inicio ASC
            """
            cursor.execute(sql_horarios, (fecha, id_servicio, hora_actual_inicio, hora_actual_fin))
            horarios = cursor.fetchall()

            horarios_disponibles = []
            for horario in horarios:
                hora_inicio = horario['hora_inicio']
                hora_fin = horario['hora_fin']
                
                if isinstance(hora_inicio, str):
                    from datetime import datetime
                    hora_inicio = datetime.strptime(hora_inicio, '%H:%M:%S').time()
                if isinstance(hora_fin, str):
                    from datetime import datetime
                    hora_fin = datetime.strptime(hora_fin, '%H:%M:%S').time()
                
                hora_str = hora_inicio.strftime('%H:%M')
                horarios_disponibles.append(hora_str)

            return jsonify({
                'success': True,
                'horarios': list(set(horarios_disponibles)),
                'hora_actual': hora_actual_inicio.strftime('%H:%M') if hasattr(hora_actual_inicio, 'strftime') else str(hora_actual_inicio)
            }), 200

    except Exception as e:
        print(f"[API horarios-reprogramacion] ERROR: {str(e)}")
        import traceback
        traceback.print_exc()
        return jsonify({'error': f'Error al obtener horarios: {str(e)}'}), 500
    finally:
        if conexion:
            try:
                conexion.close()
            except:
                pass


@reservas_bp.route('/api/reprogramar', methods=['POST'])
def api_reprogramar_reserva():
    """API para reprogramar una reserva cambiando su horario"""
    if 'usuario_id' not in session:
        return jsonify({'error': 'No autenticado'}), 401

    if session.get('tipo_usuario') != 'paciente':
        return jsonify({'error': 'Acceso no autorizado'}), 403

    data = request.get_json() or {}
    id_reserva = data.get('id_reserva')
    nueva_fecha = data.get('nueva_fecha')
    nueva_hora = data.get('nueva_hora')
    id_servicio = data.get('id_servicio')

    if not all([id_reserva, nueva_fecha, nueva_hora, id_servicio]):
        return jsonify({'error': 'Faltan datos requeridos'}), 400

    conexion = None
    try:
        usuario_id = session.get('usuario_id')
        paciente = Paciente.obtener_por_usuario(usuario_id)
        
        if not paciente:
            return jsonify({'error': 'Paciente no encontrado'}), 404
        
        id_paciente = paciente.get('id_paciente')

        conexion = obtener_conexion()
        with conexion.cursor() as cursor:
            sql_verificar = """
                SELECT r.id_reserva, r.id_programacion, r.tipo
                FROM RESERVA r
                WHERE r.id_reserva = %s AND r.id_paciente = %s
            """
            cursor.execute(sql_verificar, (id_reserva, id_paciente))
            reserva = cursor.fetchone()
            
            if not reserva:
                return jsonify({'error': 'Reserva no encontrada'}), 404
            
            id_programacion_actual = reserva['id_programacion']
            tipo_reserva = reserva['tipo']

            sql_horario = """
                SELECT id_horario FROM HORARIO 
                WHERE fecha = %s 
                AND hora_inicio <= %s 
                AND hora_fin >= %s
                AND estado = 'Activo'
                AND disponibilidad = 'Disponible'
                LIMIT 1
            """
            cursor.execute(sql_horario, (nueva_fecha, nueva_hora, nueva_hora))
            horario_nuevo = cursor.fetchone()
            
            if not horario_nuevo:
                return jsonify({'error': 'Horario no disponible'}), 400
            
            id_horario_nuevo = horario_nuevo['id_horario']

            from datetime import datetime, timedelta
            hora_obj = datetime.strptime(nueva_hora, '%H:%M')
            hora_fin_obj = hora_obj + timedelta(hours=1)
            hora_fin = hora_fin_obj.strftime('%H:%M')

            sql_nueva_prog = """
                INSERT INTO PROGRAMACION (fecha, hora_inicio, hora_fin, estado, id_servicio, id_horario)
                VALUES (%s, %s, %s, 'Activo', %s, %s)
            """
            cursor.execute(sql_nueva_prog, (nueva_fecha, nueva_hora, hora_fin, id_servicio, id_horario_nuevo))
            id_programacion_nueva = cursor.lastrowid

            sql_actualizar = """
                UPDATE RESERVA 
                SET id_programacion = %s,
                    estado = 'Confirmada',
                    estado_cancelacion = 'Ninguna',
                    motivo_cancelacion = NULL,
                    fecha_solicitud_cancelacion = NULL
                WHERE id_reserva = %s
            """
            cursor.execute(sql_actualizar, (id_programacion_nueva, id_reserva))

            if tipo_reserva == 1:
                sql_actualizar_cita = """
                    UPDATE CITA 
                    SET fecha_cita = %s, hora_cita = %s 
                    WHERE id_reserva = %s
                """
                cursor.execute(sql_actualizar_cita, (nueva_fecha, nueva_hora, id_reserva))
            elif tipo_reserva == 3:
                sql_actualizar_examen = """
                    UPDATE EXAMEN 
                    SET fecha_examen = %s, hora_examen = %s 
                    WHERE id_reserva = %s
                """
                cursor.execute(sql_actualizar_examen, (nueva_fecha, nueva_hora, id_reserva))
            elif tipo_reserva == 2:
                sql_actualizar_operacion = """
                    UPDATE OPERACION 
                    SET fecha_operacion = %s, hora_inicio = %s 
                    WHERE id_reserva = %s
                """
                cursor.execute(sql_actualizar_operacion, (nueva_fecha, nueva_hora, id_reserva))

            conexion.commit()

            return jsonify({
                'success': True,
                'message': 'Reserva reprogramada exitosamente'
            }), 200

    except Exception as e:
        if conexion:
            conexion.rollback()
        print(f"[API reprogramar] ERROR: {str(e)}")
        import traceback
        traceback.print_exc()
        return jsonify({'error': f'Error al reprogramar: {str(e)}'}), 500
    finally:
        if conexion:
            try:
                conexion.close()
            except:
                pass


@reservas_bp.route('/api/solicitar-cancelacion', methods=['POST'])
def api_solicitar_cancelacion():
    """API para solicitar la cancelación de una reserva"""
    if 'usuario_id' not in session:
        return jsonify({'error': 'No autenticado'}), 401

    if session.get('tipo_usuario') != 'paciente':
        return jsonify({'error': 'Acceso no autorizado'}), 403

    data = request.get_json() or {}
    id_reserva = data.get('id_reserva')
    motivo = data.get('motivo', '')

    if not id_reserva:
        return jsonify({'error': 'ID de reserva es requerido'}), 400

    if not motivo or len(motivo.strip()) < 10:
        return jsonify({'error': 'Debe proporcionar un motivo válido (mínimo 10 caracteres)'}), 400

    conexion = None
    try:
        usuario_id = session.get('usuario_id')
        paciente = Paciente.obtener_por_usuario(usuario_id)
        
        if not paciente:
            return jsonify({'error': 'Paciente no encontrado'}), 404
        
        id_paciente = paciente.get('id_paciente')

        conexion = obtener_conexion()
        with conexion.cursor() as cursor:
            sql_verificar = """
                SELECT id_reserva, estado, estado_cancelacion 
                FROM RESERVA 
                WHERE id_reserva = %s AND id_paciente = %s
            """
            cursor.execute(sql_verificar, (id_reserva, id_paciente))
            reserva = cursor.fetchone()
            
            if not reserva:
                return jsonify({'error': 'Reserva no encontrada'}), 404
            
            if reserva['estado_cancelacion'] in ['Solicitada', 'Cancelada']:
                return jsonify({'error': 'Esta reserva ya tiene una solicitud de cancelación activa'}), 400

            from datetime import datetime
            fecha_solicitud = datetime.now()

            sql_actualizar = """
                UPDATE RESERVA 
                SET estado_cancelacion = 'Solicitada',
                    motivo_cancelacion = %s,
                    fecha_solicitud_cancelacion = %s
                WHERE id_reserva = %s
            """
            cursor.execute(sql_actualizar, (motivo, fecha_solicitud, id_reserva))
            conexion.commit()

            return jsonify({
                'success': True,
                'message': 'Solicitud de cancelación enviada. Un trabajador la revisará pronto.'
            }), 200

    except Exception as e:
        if conexion:
            conexion.rollback()
        print(f"[API solicitar-cancelacion] ERROR: {str(e)}")
        import traceback
        traceback.print_exc()
        return jsonify({'error': f'Error al solicitar cancelación: {str(e)}'}), 500
    finally:
        if conexion:
            try:
                conexion.close()
            except:
                pass
